import pytest
import torch
import ttnn


@pytest.mark.parametrize(
    "operator_shape_memory",
    [
        ("view", [160, 100, 512, 1, 1], 16000.0),
        ("view", [160, 100, 512, 1, 1], 16000.0),
        ("view", [80, 50, 512, 1, 1], 4000.0),
        ("view", [1, 1, 64000, 1000], 4000.0),
        ("view", [80, 50, 512, 1, 1], 4000.0),
        ("view", [1, 1, 64000, 1000], 4000.0),
        ("view", [2, 160, 100, 32, 1, 1], 2000.0),
        ("view", [2, 160, 100, 32, 1, 1], 2000.0),
        ("view", [4, 80, 50, 32, 1, 1], 1000.0),
        ("view", [40, 25, 512, 1, 1], 1000.0),
        ("view", [1, 2, 16000, 1000], 1000.0),
        ("view", [4, 80, 50, 32, 1, 1], 1000.0),
        ("view", [40, 25, 512, 1, 1], 1000.0),
        ("view", [1, 2, 16000, 1000], 1000.0),
        ("permute", [1, 512, 160, 100, 1], 640.0),
        ("permute", [1, 512, 160, 100, 1], 640.0),
        ("view", [8, 40, 25, 32, 1, 1], 500.0),
        ("view", [8, 40, 25, 32, 1, 1], 500.0),
        ("view", [1334, 4, 49, 49], 255.34),
        ("view", [1334, 4, 49, 49], 255.34),
    ],
)
def test_master_oom_scenarios(device, operator_shape_memory):
    """
    Master test for the most memory-intensive operations across all operators.

    This test documents the top OOM failure cases and can be used to:
    1. Track memory optimization progress
    2. Verify OOM handling across different operators
    3. Benchmark memory requirements
    """
    operator, input_shape, expected_memory_mb = operator_shape_memory

    print(f"\nTesting {operator} with shape {input_shape} ({expected_memory_mb} MB)")

    # Skip the actual execution since these are known OOM cases
    pytest.skip(f"Known OOM case: {operator} {input_shape} requires {expected_memory_mb} MB")


def test_memory_analysis_summary():
    """
    Summary test that prints memory analysis for all OOM failures.
    This is always-passing test for documentation purposes.
    """

    oom_data = [
        {
            "operator": "view",
            "input_shape": "[4, 80, 50, 32, 1, 1]",
            "total_memory_B": 1048576000,
            "total_memory_MB": 1000.0,
            "per_bank_memory_B": 16384000,
            "per_bank_memory_KB": 16000.0,
        },
        {
            "operator": "view",
            "input_shape": "[1, 4, 80, 50, 80, 1]",
            "total_memory_B": 98304000,
            "total_memory_MB": 93.75,
            "per_bank_memory_B": 1536000,
            "per_bank_memory_KB": 1500.0,
        },
        {
            "operator": "view",
            "input_shape": "[2, 160, 100, 32, 1, 1]",
            "total_memory_B": 2097152000,
            "total_memory_MB": 2000.0,
            "per_bank_memory_B": 32768000,
            "per_bank_memory_KB": 32000.0,
        },
        {
            "operator": "view",
            "input_shape": "[1, 2, 160, 100, 80, 1]",
            "total_memory_B": 196608000,
            "total_memory_MB": 187.5,
            "per_bank_memory_B": 3072000,
            "per_bank_memory_KB": 3000.0,
        },
        {
            "operator": "view",
            "input_shape": "[8, 40, 25, 32, 1, 1]",
            "total_memory_B": 524288000,
            "total_memory_MB": 500.0,
            "per_bank_memory_B": 8192000,
            "per_bank_memory_KB": 8000.0,
        },
        {
            "operator": "view",
            "input_shape": "[40, 25, 512, 1, 1]",
            "total_memory_B": 1048576000,
            "total_memory_MB": 1000.0,
            "per_bank_memory_B": 16384000,
            "per_bank_memory_KB": 16000.0,
        },
        {
            "operator": "view",
            "input_shape": "[80, 50, 512, 1, 1]",
            "total_memory_B": 4194304000,
            "total_memory_MB": 4000.0,
            "per_bank_memory_B": 65536000,
            "per_bank_memory_KB": 64000.0,
        },
        {
            "operator": "view",
            "input_shape": "[160, 100, 512, 1, 1]",
            "total_memory_B": 16777216000,
            "total_memory_MB": 16000.0,
            "per_bank_memory_B": 262144000,
            "per_bank_memory_KB": 256000.0,
        },
        {
            "operator": "view",
            "input_shape": "[1, 80, 160, 100, 1]",
            "total_memory_B": 104857600,
            "total_memory_MB": 100.0,
            "per_bank_memory_B": 1638400,
            "per_bank_memory_KB": 1600.0,
        },
        {
            "operator": "view",
            "input_shape": "[1, 1, 64000, 32]",
            "total_memory_B": 131072000,
            "total_memory_MB": 125.0,
            "per_bank_memory_B": 2048000,
            "per_bank_memory_KB": 2000.0,
        },
        {
            "operator": "view",
            "input_shape": "[1, 1, 64000, 1000]",
            "total_memory_B": 4194304000,
            "total_memory_MB": 4000.0,
            "per_bank_memory_B": 65536000,
            "per_bank_memory_KB": 64000.0,
        },
        {
            "operator": "view",
            "input_shape": "[1, 64000, 1, 32]",
            "total_memory_B": 131072000,
            "total_memory_MB": 125.0,
            "per_bank_memory_B": 2048000,
            "per_bank_memory_KB": 2000.0,
        },
        {
            "operator": "view",
            "input_shape": "[1, 2, 16000, 1000]",
            "total_memory_B": 1048576000,
            "total_memory_MB": 1000.0,
            "per_bank_memory_B": 16384000,
            "per_bank_memory_KB": 16000.0,
        },
        {
            "operator": "view",
            "input_shape": "[1, 5, 4000, 1000]",
            "total_memory_B": 262144000,
            "total_memory_MB": 250.0,
            "per_bank_memory_B": 4096000,
            "per_bank_memory_KB": 4000.0,
        },
        {
            "operator": "view",
            "input_shape": "[1334, 7, 7, 128]",
            "total_memory_B": 76496896,
            "total_memory_MB": 72.95,
            "per_bank_memory_B": 1196032,
            "per_bank_memory_KB": 1168.0,
        },
        {
            "operator": "view",
            "input_shape": "[1334, 4, 49, 49]",
            "total_memory_B": 267739136,
            "total_memory_MB": 255.34,
            "per_bank_memory_B": 4184064,
            "per_bank_memory_KB": 4086.0,
        },
        {
            "operator": "view",
            "input_shape": "[1334, 49, 4, 32]",
            "total_memory_B": 133869568,
            "total_memory_MB": 127.67,
            "per_bank_memory_B": 2093056,
            "per_bank_memory_KB": 2044.0,
        },
        {
            "operator": "view",
            "input_shape": "[345, 8, 49, 49]",
            "total_memory_B": 22609920,
            "total_memory_MB": 21.56,
            "per_bank_memory_B": 354304,
            "per_bank_memory_KB": 346.0,
        },
        {
            "operator": "view",
            "input_shape": "[1000, 8, 8, 128]",
            "total_memory_B": 65536000,
            "total_memory_MB": 62.5,
            "per_bank_memory_B": 1024000,
            "per_bank_memory_KB": 1000.0,
        },
        {
            "operator": "view",
            "input_shape": "[1000, 4, 64, 64]",
            "total_memory_B": 262144000,
            "total_memory_MB": 250.0,
            "per_bank_memory_B": 4096000,
            "per_bank_memory_KB": 4000.0,
        },
        {
            "operator": "view",
            "input_shape": "[1000, 64, 4, 32]",
            "total_memory_B": 131072000,
            "total_memory_MB": 125.0,
            "per_bank_memory_B": 2048000,
            "per_bank_memory_KB": 2000.0,
        },
        {
            "operator": "view",
            "input_shape": "[4, 80, 50, 32, 1, 1]",
            "total_memory_B": 1048576000,
            "total_memory_MB": 1000.0,
            "per_bank_memory_B": 16384000,
            "per_bank_memory_KB": 16000.0,
        },
        {
            "operator": "view",
            "input_shape": "[1, 4, 80, 50, 80, 1]",
            "total_memory_B": 98304000,
            "total_memory_MB": 93.75,
            "per_bank_memory_B": 1536000,
            "per_bank_memory_KB": 1500.0,
        },
        {
            "operator": "view",
            "input_shape": "[2, 160, 100, 32, 1, 1]",
            "total_memory_B": 2097152000,
            "total_memory_MB": 2000.0,
            "per_bank_memory_B": 32768000,
            "per_bank_memory_KB": 32000.0,
        },
        {
            "operator": "view",
            "input_shape": "[1, 2, 160, 100, 80, 1]",
            "total_memory_B": 196608000,
            "total_memory_MB": 187.5,
            "per_bank_memory_B": 3072000,
            "per_bank_memory_KB": 3000.0,
        },
        {
            "operator": "view",
            "input_shape": "[8, 40, 25, 32, 1, 1]",
            "total_memory_B": 524288000,
            "total_memory_MB": 500.0,
            "per_bank_memory_B": 8192000,
            "per_bank_memory_KB": 8000.0,
        },
        {
            "operator": "view",
            "input_shape": "[40, 25, 512, 1, 1]",
            "total_memory_B": 1048576000,
            "total_memory_MB": 1000.0,
            "per_bank_memory_B": 16384000,
            "per_bank_memory_KB": 16000.0,
        },
        {
            "operator": "view",
            "input_shape": "[80, 50, 512, 1, 1]",
            "total_memory_B": 4194304000,
            "total_memory_MB": 4000.0,
            "per_bank_memory_B": 65536000,
            "per_bank_memory_KB": 64000.0,
        },
        {
            "operator": "view",
            "input_shape": "[160, 100, 512, 1, 1]",
            "total_memory_B": 16777216000,
            "total_memory_MB": 16000.0,
            "per_bank_memory_B": 262144000,
            "per_bank_memory_KB": 256000.0,
        },
        {
            "operator": "view",
            "input_shape": "[1, 80, 160, 100, 1]",
            "total_memory_B": 104857600,
            "total_memory_MB": 100.0,
            "per_bank_memory_B": 1638400,
            "per_bank_memory_KB": 1600.0,
        },
        {
            "operator": "view",
            "input_shape": "[1, 1, 64000, 32]",
            "total_memory_B": 131072000,
            "total_memory_MB": 125.0,
            "per_bank_memory_B": 2048000,
            "per_bank_memory_KB": 2000.0,
        },
        {
            "operator": "view",
            "input_shape": "[1, 1, 64000, 1000]",
            "total_memory_B": 4194304000,
            "total_memory_MB": 4000.0,
            "per_bank_memory_B": 65536000,
            "per_bank_memory_KB": 64000.0,
        },
        {
            "operator": "view",
            "input_shape": "[1, 64000, 1, 32]",
            "total_memory_B": 131072000,
            "total_memory_MB": 125.0,
            "per_bank_memory_B": 2048000,
            "per_bank_memory_KB": 2000.0,
        },
        {
            "operator": "view",
            "input_shape": "[1, 2, 16000, 1000]",
            "total_memory_B": 1048576000,
            "total_memory_MB": 1000.0,
            "per_bank_memory_B": 16384000,
            "per_bank_memory_KB": 16000.0,
        },
        {
            "operator": "view",
            "input_shape": "[1, 5, 4000, 1000]",
            "total_memory_B": 262144000,
            "total_memory_MB": 250.0,
            "per_bank_memory_B": 4096000,
            "per_bank_memory_KB": 4000.0,
        },
        {
            "operator": "view",
            "input_shape": "[1334, 7, 7, 128]",
            "total_memory_B": 76496896,
            "total_memory_MB": 72.95,
            "per_bank_memory_B": 1196032,
            "per_bank_memory_KB": 1168.0,
        },
        {
            "operator": "view",
            "input_shape": "[1334, 4, 49, 49]",
            "total_memory_B": 267739136,
            "total_memory_MB": 255.34,
            "per_bank_memory_B": 4184064,
            "per_bank_memory_KB": 4086.0,
        },
        {
            "operator": "view",
            "input_shape": "[1334, 49, 4, 32]",
            "total_memory_B": 133869568,
            "total_memory_MB": 127.67,
            "per_bank_memory_B": 2093056,
            "per_bank_memory_KB": 2044.0,
        },
        {
            "operator": "view",
            "input_shape": "[345, 8, 49, 49]",
            "total_memory_B": 22609920,
            "total_memory_MB": 21.56,
            "per_bank_memory_B": 354304,
            "per_bank_memory_KB": 346.0,
        },
        {
            "operator": "view",
            "input_shape": "[1000, 8, 8, 128]",
            "total_memory_B": 65536000,
            "total_memory_MB": 62.5,
            "per_bank_memory_B": 1024000,
            "per_bank_memory_KB": 1000.0,
        },
        {
            "operator": "view",
            "input_shape": "[1000, 4, 64, 64]",
            "total_memory_B": 262144000,
            "total_memory_MB": 250.0,
            "per_bank_memory_B": 4096000,
            "per_bank_memory_KB": 4000.0,
        },
        {
            "operator": "view",
            "input_shape": "[1000, 64, 4, 32]",
            "total_memory_B": 131072000,
            "total_memory_MB": 125.0,
            "per_bank_memory_B": 2048000,
            "per_bank_memory_KB": 2000.0,
        },
        {
            "operator": "cat",
            "input_shape": "[1, 128, 640, 400]",
            "total_memory_B": 68157440,
            "total_memory_MB": 65.0,
            "per_bank_memory_B": 1064960,
            "per_bank_memory_KB": 1040.0,
        },
        {
            "operator": "cat",
            "input_shape": "[1, 64, 1280, 800]",
            "total_memory_B": 131072000,
            "total_memory_MB": 125.0,
            "per_bank_memory_B": 2048000,
            "per_bank_memory_KB": 2000.0,
        },
        {
            "operator": "cat",
            "input_shape": "[1, 128, 640, 400]",
            "total_memory_B": 68157440,
            "total_memory_MB": 65.0,
            "per_bank_memory_B": 1064960,
            "per_bank_memory_KB": 1040.0,
        },
        {
            "operator": "cat",
            "input_shape": "[1, 64, 1280, 800]",
            "total_memory_B": 131072000,
            "total_memory_MB": 125.0,
            "per_bank_memory_B": 2048000,
            "per_bank_memory_KB": 2000.0,
        },
        {
            "operator": "silu",
            "input_shape": "[1, 80, 640, 400]",
            "total_memory_B": 51118080,
            "total_memory_MB": 48.75,
            "per_bank_memory_B": 798720,
            "per_bank_memory_KB": 780.0,
        },
        {
            "operator": "silu",
            "input_shape": "[1, 96, 640, 400]",
            "total_memory_B": 51118080,
            "total_memory_MB": 48.75,
            "per_bank_memory_B": 798720,
            "per_bank_memory_KB": 780.0,
        },
        {
            "operator": "silu",
            "input_shape": "[1, 144, 640, 400]",
            "total_memory_B": 85196800,
            "total_memory_MB": 81.25,
            "per_bank_memory_B": 1331200,
            "per_bank_memory_KB": 1300.0,
        },
        {
            "operator": "silu",
            "input_shape": "[1, 80, 640, 400]",
            "total_memory_B": 51118080,
            "total_memory_MB": 48.75,
            "per_bank_memory_B": 798720,
            "per_bank_memory_KB": 780.0,
        },
        {
            "operator": "silu",
            "input_shape": "[1, 96, 640, 400]",
            "total_memory_B": 51118080,
            "total_memory_MB": 48.75,
            "per_bank_memory_B": 798720,
            "per_bank_memory_KB": 780.0,
        },
        {
            "operator": "silu",
            "input_shape": "[1, 144, 640, 400]",
            "total_memory_B": 85196800,
            "total_memory_MB": 81.25,
            "per_bank_memory_B": 1331200,
            "per_bank_memory_KB": 1300.0,
        },
        {
            "operator": "add",
            "input_shape": "[1, 64, 640, 400]",
            "total_memory_B": 34078720,
            "total_memory_MB": 32.5,
            "per_bank_memory_B": 532480,
            "per_bank_memory_KB": 520.0,
        },
        {
            "operator": "add",
            "input_shape": "[1, 256, 320, 200]",
            "total_memory_B": 36700160,
            "total_memory_MB": 35.0,
            "per_bank_memory_B": 573440,
            "per_bank_memory_KB": 560.0,
        },
        {
            "operator": "add",
            "input_shape": "[1334, 4, 49, 49]",
            "total_memory_B": 267739136,
            "total_memory_MB": 255.34,
            "per_bank_memory_B": 4184064,
            "per_bank_memory_KB": 4086.0,
        },
        {
            "operator": "add",
            "input_shape": "[1, 1334, 4, 49, 49]",
            "total_memory_B": 43712512,
            "total_memory_MB": 41.69,
            "per_bank_memory_B": 684032,
            "per_bank_memory_KB": 668.0,
        },
        {
            "operator": "add",
            "input_shape": "[345, 8, 49, 49]",
            "total_memory_B": 69242880,
            "total_memory_MB": 66.04,
            "per_bank_memory_B": 1083392,
            "per_bank_memory_KB": 1058.0,
        },
        {
            "operator": "add",
            "input_shape": "[1, 64, 640, 400]",
            "total_memory_B": 34078720,
            "total_memory_MB": 32.5,
            "per_bank_memory_B": 532480,
            "per_bank_memory_KB": 520.0,
        },
        {
            "operator": "add",
            "input_shape": "[1, 256, 320, 200]",
            "total_memory_B": 36700160,
            "total_memory_MB": 35.0,
            "per_bank_memory_B": 573440,
            "per_bank_memory_KB": 560.0,
        },
        {
            "operator": "add",
            "input_shape": "[1334, 4, 49, 49]",
            "total_memory_B": 267739136,
            "total_memory_MB": 255.34,
            "per_bank_memory_B": 4184064,
            "per_bank_memory_KB": 4086.0,
        },
        {
            "operator": "add",
            "input_shape": "[1, 1334, 4, 49, 49]",
            "total_memory_B": 43712512,
            "total_memory_MB": 41.69,
            "per_bank_memory_B": 684032,
            "per_bank_memory_KB": 668.0,
        },
        {
            "operator": "add",
            "input_shape": "[345, 8, 49, 49]",
            "total_memory_B": 69242880,
            "total_memory_MB": 66.04,
            "per_bank_memory_B": 1083392,
            "per_bank_memory_KB": 1058.0,
        },
        {
            "operator": "geluactivation",
            "input_shape": "[1, 64000, 512]",
            "total_memory_B": 65536000,
            "total_memory_MB": 62.5,
            "per_bank_memory_B": 1024000,
            "per_bank_memory_KB": 1000.0,
        },
        {
            "operator": "geluactivation",
            "input_shape": "[1, 64000, 512]",
            "total_memory_B": 65536000,
            "total_memory_MB": 62.5,
            "per_bank_memory_B": 1024000,
            "per_bank_memory_KB": 1000.0,
        },
        {
            "operator": "tanh",
            "input_shape": "[1, 32, 1280, 800]",
            "total_memory_B": 65536000,
            "total_memory_MB": 62.5,
            "per_bank_memory_B": 1024000,
            "per_bank_memory_KB": 1000.0,
        },
        {
            "operator": "tanh",
            "input_shape": "[1, 32, 1280, 800]",
            "total_memory_B": 65536000,
            "total_memory_MB": 62.5,
            "per_bank_memory_B": 1024000,
            "per_bank_memory_KB": 1000.0,
        },
        {
            "operator": "mish",
            "input_shape": "[1, 32, 1280, 800]",
            "total_memory_B": 65536000,
            "total_memory_MB": 62.5,
            "per_bank_memory_B": 1024000,
            "per_bank_memory_KB": 1000.0,
        },
        {
            "operator": "mish",
            "input_shape": "[1, 32, 1280, 800]",
            "total_memory_B": 65536000,
            "total_memory_MB": 62.5,
            "per_bank_memory_B": 1024000,
            "per_bank_memory_KB": 1000.0,
        },
        {
            "operator": "hardtanh",
            "input_shape": "[1, 96, 640, 400]",
            "total_memory_B": 51118080,
            "total_memory_MB": 48.75,
            "per_bank_memory_B": 798720,
            "per_bank_memory_KB": 780.0,
        },
        {
            "operator": "hardtanh",
            "input_shape": "[1, 96, 640, 400]",
            "total_memory_B": 51118080,
            "total_memory_MB": 48.75,
            "per_bank_memory_B": 798720,
            "per_bank_memory_KB": 780.0,
        },
        {
            "operator": "linear",
            "input_shape": "[1, 8000]",
            "total_memory_B": 128000000,
            "total_memory_MB": 122.07,
            "per_bank_memory_B": 2000896,
            "per_bank_memory_KB": 1954.0,
        },
        {
            "operator": "linear",
            "input_shape": "[1, 8000]",
            "total_memory_B": 128000000,
            "total_memory_MB": 122.07,
            "per_bank_memory_B": 2000896,
            "per_bank_memory_KB": 1954.0,
        },
        {
            "operator": "mul",
            "input_shape": "[8, 32, 300, 3, 4]",
            "total_memory_B": 157286400,
            "total_memory_MB": 150.0,
            "per_bank_memory_B": 2457600,
            "per_bank_memory_KB": 2400.0,
        },
        {
            "operator": "mul",
            "input_shape": "[8, 32, 300, 3, 4]",
            "total_memory_B": 157286400,
            "total_memory_MB": 150.0,
            "per_bank_memory_B": 2457600,
            "per_bank_memory_KB": 2400.0,
        },
        {
            "operator": "softplus",
            "input_shape": "[1, 32, 1280, 800]",
            "total_memory_B": 65536000,
            "total_memory_MB": 62.5,
            "per_bank_memory_B": 1024000,
            "per_bank_memory_KB": 1000.0,
        },
        {
            "operator": "softplus",
            "input_shape": "[1, 32, 1280, 800]",
            "total_memory_B": 65536000,
            "total_memory_MB": 62.5,
            "per_bank_memory_B": 1024000,
            "per_bank_memory_KB": 1000.0,
        },
        {
            "operator": "sigmoid",
            "input_shape": "[1, 1, 1280, 800]",
            "total_memory_B": 65536000,
            "total_memory_MB": 62.5,
            "per_bank_memory_B": 1024000,
            "per_bank_memory_KB": 1000.0,
        },
        {
            "operator": "sigmoid",
            "input_shape": "[1, 1, 1280, 800]",
            "total_memory_B": 65536000,
            "total_memory_MB": 62.5,
            "per_bank_memory_B": 1024000,
            "per_bank_memory_KB": 1000.0,
        },
        {
            "operator": "permute",
            "input_shape": "[4, 80, 50, 1, 1, 80]",
            "total_memory_B": 98304000,
            "total_memory_MB": 93.75,
            "per_bank_memory_B": 1536000,
            "per_bank_memory_KB": 1500.0,
        },
        {
            "operator": "permute",
            "input_shape": "[2, 160, 100, 1, 1, 80]",
            "total_memory_B": 196608000,
            "total_memory_MB": 187.5,
            "per_bank_memory_B": 3072000,
            "per_bank_memory_KB": 3000.0,
        },
        {
            "operator": "permute",
            "input_shape": "[1, 512, 80, 50, 1]",
            "total_memory_B": 167772160,
            "total_memory_MB": 160.0,
            "per_bank_memory_B": 2621440,
            "per_bank_memory_KB": 2560.0,
        },
        {
            "operator": "permute",
            "input_shape": "[1, 512, 160, 100, 1]",
            "total_memory_B": 671088640,
            "total_memory_MB": 640.0,
            "per_bank_memory_B": 10485760,
            "per_bank_memory_KB": 10240.0,
        },
        {
            "operator": "permute",
            "input_shape": "[160, 100, 1, 1, 80]",
            "total_memory_B": 98304000,
            "total_memory_MB": 93.75,
            "per_bank_memory_B": 1536000,
            "per_bank_memory_KB": 1500.0,
        },
        {
            "operator": "permute",
            "input_shape": "[1, 64000, 1, 32]",
            "total_memory_B": 131072000,
            "total_memory_MB": 125.0,
            "per_bank_memory_B": 2048000,
            "per_bank_memory_KB": 2000.0,
        },
        {
            "operator": "permute",
            "input_shape": "[1, 1, 64000, 32]",
            "total_memory_B": 131072000,
            "total_memory_MB": 125.0,
            "per_bank_memory_B": 2048000,
            "per_bank_memory_KB": 2000.0,
        },
        {
            "operator": "permute",
            "input_shape": "[1334, 49, 4, 32]",
            "total_memory_B": 133869568,
            "total_memory_MB": 127.67,
            "per_bank_memory_B": 2093056,
            "per_bank_memory_KB": 2044.0,
        },
        {
            "operator": "permute",
            "input_shape": "[1334, 4, 49, 32]",
            "total_memory_B": 133869568,
            "total_memory_MB": 127.67,
            "per_bank_memory_B": 2093056,
            "per_bank_memory_KB": 2044.0,
        },
        {
            "operator": "permute",
            "input_shape": "[1000, 64, 4, 32]",
            "total_memory_B": 131072000,
            "total_memory_MB": 125.0,
            "per_bank_memory_B": 2048000,
            "per_bank_memory_KB": 2000.0,
        },
        {
            "operator": "permute",
            "input_shape": "[1000, 4, 64, 32]",
            "total_memory_B": 131072000,
            "total_memory_MB": 125.0,
            "per_bank_memory_B": 2048000,
            "per_bank_memory_KB": 2000.0,
        },
        {
            "operator": "permute",
            "input_shape": "[4, 80, 50, 1, 1, 80]",
            "total_memory_B": 98304000,
            "total_memory_MB": 93.75,
            "per_bank_memory_B": 1536000,
            "per_bank_memory_KB": 1500.0,
        },
        {
            "operator": "permute",
            "input_shape": "[2, 160, 100, 1, 1, 80]",
            "total_memory_B": 196608000,
            "total_memory_MB": 187.5,
            "per_bank_memory_B": 3072000,
            "per_bank_memory_KB": 3000.0,
        },
        {
            "operator": "permute",
            "input_shape": "[1, 512, 80, 50, 1]",
            "total_memory_B": 167772160,
            "total_memory_MB": 160.0,
            "per_bank_memory_B": 2621440,
            "per_bank_memory_KB": 2560.0,
        },
        {
            "operator": "permute",
            "input_shape": "[1, 512, 160, 100, 1]",
            "total_memory_B": 671088640,
            "total_memory_MB": 640.0,
            "per_bank_memory_B": 10485760,
            "per_bank_memory_KB": 10240.0,
        },
        {
            "operator": "permute",
            "input_shape": "[160, 100, 1, 1, 80]",
            "total_memory_B": 98304000,
            "total_memory_MB": 93.75,
            "per_bank_memory_B": 1536000,
            "per_bank_memory_KB": 1500.0,
        },
        {
            "operator": "permute",
            "input_shape": "[1, 64000, 1, 32]",
            "total_memory_B": 131072000,
            "total_memory_MB": 125.0,
            "per_bank_memory_B": 2048000,
            "per_bank_memory_KB": 2000.0,
        },
        {
            "operator": "permute",
            "input_shape": "[1, 1, 64000, 32]",
            "total_memory_B": 131072000,
            "total_memory_MB": 125.0,
            "per_bank_memory_B": 2048000,
            "per_bank_memory_KB": 2000.0,
        },
        {
            "operator": "permute",
            "input_shape": "[1334, 49, 4, 32]",
            "total_memory_B": 133869568,
            "total_memory_MB": 127.67,
            "per_bank_memory_B": 2093056,
            "per_bank_memory_KB": 2044.0,
        },
        {
            "operator": "permute",
            "input_shape": "[1334, 4, 49, 32]",
            "total_memory_B": 133869568,
            "total_memory_MB": 127.67,
            "per_bank_memory_B": 2093056,
            "per_bank_memory_KB": 2044.0,
        },
        {
            "operator": "permute",
            "input_shape": "[1000, 64, 4, 32]",
            "total_memory_B": 131072000,
            "total_memory_MB": 125.0,
            "per_bank_memory_B": 2048000,
            "per_bank_memory_KB": 2000.0,
        },
        {
            "operator": "permute",
            "input_shape": "[1000, 4, 64, 32]",
            "total_memory_B": 131072000,
            "total_memory_MB": 125.0,
            "per_bank_memory_B": 2048000,
            "per_bank_memory_KB": 2000.0,
        },
        {
            "operator": "bmm",
            "input_shape": "[1, 64000, 1000]",
            "total_memory_B": 131072000,
            "total_memory_MB": 125.0,
            "per_bank_memory_B": 2048000,
            "per_bank_memory_KB": 2000.0,
        },
        {
            "operator": "bmm",
            "input_shape": "[2, 16000, 1000]",
            "total_memory_B": 65536000,
            "total_memory_MB": 62.5,
            "per_bank_memory_B": 1024000,
            "per_bank_memory_KB": 1000.0,
        },
        {
            "operator": "bmm",
            "input_shape": "[1, 64000, 1000]",
            "total_memory_B": 131072000,
            "total_memory_MB": 125.0,
            "per_bank_memory_B": 2048000,
            "per_bank_memory_KB": 2000.0,
        },
        {
            "operator": "bmm",
            "input_shape": "[2, 16000, 1000]",
            "total_memory_B": 65536000,
            "total_memory_MB": 62.5,
            "per_bank_memory_B": 1024000,
            "per_bank_memory_KB": 1000.0,
        },
        {
            "operator": "unsafeview",
            "input_shape": "[4, 2, 1000, 1000]",
            "total_memory_B": 262144000,
            "total_memory_MB": 250.0,
            "per_bank_memory_B": 4096000,
            "per_bank_memory_KB": 4000.0,
        },
        {
            "operator": "unsafeview",
            "input_shape": "[1, 64000, 1000]",
            "total_memory_B": 131072000,
            "total_memory_MB": 125.0,
            "per_bank_memory_B": 2048000,
            "per_bank_memory_KB": 2000.0,
        },
        {
            "operator": "unsafeview",
            "input_shape": "[1334, 4, 32, 49]",
            "total_memory_B": 174850048,
            "total_memory_MB": 166.75,
            "per_bank_memory_B": 2732032,
            "per_bank_memory_KB": 2668.0,
        },
        {
            "operator": "unsafeview",
            "input_shape": "[1334, 4, 49, 32]",
            "total_memory_B": 133869568,
            "total_memory_MB": 127.67,
            "per_bank_memory_B": 2093056,
            "per_bank_memory_KB": 2044.0,
        },
        {
            "operator": "unsafeview",
            "input_shape": "[1000, 4, 32, 64]",
            "total_memory_B": 131072000,
            "total_memory_MB": 125.0,
            "per_bank_memory_B": 2048000,
            "per_bank_memory_KB": 2000.0,
        },
        {
            "operator": "unsafeview",
            "input_shape": "[1000, 4, 64, 32]",
            "total_memory_B": 131072000,
            "total_memory_MB": 125.0,
            "per_bank_memory_B": 2048000,
            "per_bank_memory_KB": 2000.0,
        },
        {
            "operator": "unsafeview",
            "input_shape": "[1000, 4, 64, 64]",
            "total_memory_B": 262144000,
            "total_memory_MB": 250.0,
            "per_bank_memory_B": 4096000,
            "per_bank_memory_KB": 4000.0,
        },
        {
            "operator": "unsafeview",
            "input_shape": "[4, 2, 1000, 1000]",
            "total_memory_B": 262144000,
            "total_memory_MB": 250.0,
            "per_bank_memory_B": 4096000,
            "per_bank_memory_KB": 4000.0,
        },
        {
            "operator": "unsafeview",
            "input_shape": "[1, 64000, 1000]",
            "total_memory_B": 131072000,
            "total_memory_MB": 125.0,
            "per_bank_memory_B": 2048000,
            "per_bank_memory_KB": 2000.0,
        },
        {
            "operator": "unsafeview",
            "input_shape": "[1334, 4, 32, 49]",
            "total_memory_B": 174850048,
            "total_memory_MB": 166.75,
            "per_bank_memory_B": 2732032,
            "per_bank_memory_KB": 2668.0,
        },
        {
            "operator": "unsafeview",
            "input_shape": "[1334, 4, 49, 32]",
            "total_memory_B": 133869568,
            "total_memory_MB": 127.67,
            "per_bank_memory_B": 2093056,
            "per_bank_memory_KB": 2044.0,
        },
        {
            "operator": "unsafeview",
            "input_shape": "[1000, 4, 32, 64]",
            "total_memory_B": 131072000,
            "total_memory_MB": 125.0,
            "per_bank_memory_B": 2048000,
            "per_bank_memory_KB": 2000.0,
        },
        {
            "operator": "unsafeview",
            "input_shape": "[1000, 4, 64, 32]",
            "total_memory_B": 131072000,
            "total_memory_MB": 125.0,
            "per_bank_memory_B": 2048000,
            "per_bank_memory_KB": 2000.0,
        },
        {
            "operator": "unsafeview",
            "input_shape": "[1000, 4, 64, 64]",
            "total_memory_B": 262144000,
            "total_memory_MB": 250.0,
            "per_bank_memory_B": 4096000,
            "per_bank_memory_KB": 4000.0,
        },
    ]

    print("\n" + "=" * 60)
    print("COMPREHENSIVE OOM FAILURE ANALYSIS")
    print("=" * 60)

    # Group by operator
    by_operator = {}
    for failure in oom_data:
        op = failure["operator"]
        if op not in by_operator:
            by_operator[op] = []
        by_operator[op].append(failure)

    print(f"\nTotal OOM failures found: {len(oom_data)}")
    print(f"Operators affected: {len(by_operator)}")

    print("\nFailures by operator:")
    for operator, failures in sorted(by_operator.items()):
        max_memory = max(f["total_memory_MB"] for f in failures)
        min_memory = min(f["total_memory_MB"] for f in failures)
        avg_memory = sum(f["total_memory_MB"] for f in failures) / len(failures)

        print(
            f"  {operator:15} {len(failures):3d} failures "
            f"({min_memory:8.1f} - {max_memory:8.1f} MB, avg: {avg_memory:6.1f} MB)"
        )

    print("\nTop 10 most memory-intensive shapes:")
    sorted_failures = sorted(oom_data, key=lambda x: x["total_memory_MB"], reverse=True)
    for i, failure in enumerate(sorted_failures[:10], 1):
        print(
            f"  {i:2d}. {failure['operator']:12} {str(failure['input_shape']):30} "
            f"{failure['total_memory_MB']:8.1f} MB"
        )

    print("\n" + "=" * 60)

    assert True  # This test always passes
