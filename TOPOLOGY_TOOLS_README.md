# TT-Metal Topology Visualization and Generation Tools

This directory contains tools for visualizing and generating topology descriptors for TT-Metal mesh devices.

## üéØ Quick Start

### 1. Visualize Your Physical Topology (3D Interactive)

```bash
./visualize_topology.py --cluster t3k_phys_topology.yaml --both
```

This creates:
- `topology_3d.html` - Interactive 3D visualization (open in browser)
- `topology_2d.png` - 2D static image

### 2. Generate Mesh Graph Descriptor

```bash
./generate_mesh_descriptor.py \\
    --cluster t3k_phys_topology.yaml \\
    --shape 2,4 \\
    --output my_t3k_mesh.yaml \\
    --compare
```

### 3. Visualize with Mesh Overlay

```bash
./visualize_topology.py \\
    --cluster t3k_phys_topology.yaml \\
    --mesh my_t3k_mesh.yaml \\
    --both
```

## üì¶ Tools Overview

### `visualize_topology.py`

**Purpose**: Create interactive 3D and 2D visualizations of physical chip topology

**Features**:
- üìä Interactive 3D view with Plotly (pan, zoom, rotate)
- üñºÔ∏è High-quality 2D PNG export
- üîó Shows ethernet connections with channel numbers
- üé® Mesh overlay visualization

**Usage**:
```bash
# 3D only (default)
./visualize_topology.py --cluster my_cluster.yaml

# 2D and 3D
./visualize_topology.py --cluster my_cluster.yaml --both

# With mesh overlay
./visualize_topology.py \\
    --cluster physical_topology.yaml \\
    --mesh mesh_descriptor.yaml \\
    --both
```

**Dependencies**:
```bash
pip install plotly networkx matplotlib
```

### `generate_mesh_descriptor.py`

**Purpose**: Generate logical mesh graph descriptors from physical cluster topology

**Features**:
- üîç Auto-analyzes ethernet connectivity
- üìê Infers channels per neighbor
- üèóÔ∏è Detects architecture and board type
- ‚úÖ Validates consistency between physical and logical

**Usage**:
```bash
# Specify shape explicitly
./generate_mesh_descriptor.py \\
    --cluster my_cluster.yaml \\
    --shape 2,4 \\
    --output my_mesh.yaml

# Auto-infer shape from chip count
./generate_mesh_descriptor.py \\
    --cluster my_cluster.yaml \\
    --auto \\
    --output my_mesh.yaml

# With comparison report
./generate_mesh_descriptor.py \\
    --cluster my_cluster.yaml \\
    --shape 2,4 \\
    --output my_mesh.yaml \\
    --compare
```

### `simple_link_check.py`

**Purpose**: Test ethernet connectivity on actual hardware

**Features**:
- ‚úÖ Opens mesh device with custom topology
- üîó Tests inter-device communication
- üìä Validates physical links work

**Usage**:
```bash
# Use custom physical topology
./simple_link_check.py --yaml t3k_phys_topology.yaml

# Auto-detect
./simple_link_check.py
```

## üóÇÔ∏è File Formats

### Cluster Descriptor (Physical Topology)

Old format used by UMD, describes actual hardware connections:

```yaml
arch:
  0: wormhole_b0
  1: wormhole_b0
chips:
  0: [2, 0, 0, 0]  # [shelf, rack_x, rack_y, adapter]
  1: [2, 1, 0, 0]
ethernet_connections:
  - - {chip: 0, chan: 0}
    - {chip: 1, chan: 0}
chip_to_boardtype:
  0: n300
  1: n300
```

**Generated by**: `build/tools/umd/topology`
**Environment variable**: `TT_METAL_CLUSTER_DESC_PATH`

### Mesh Graph Descriptor (Logical Topology)

New format used by fabric layer, describes logical mesh:

```yaml
ChipSpec:
  arch: wormhole_b0
  ethernet_ports:
    N: 2
    E: 2
    S: 2
    W: 2

Board:
  - name: T3K
    type: Mesh
    topology: [2, 4]

Mesh:
  - id: 0
    board: T3K
    device_topology: [2, 4]
    host_topology: [1, 1]

Graph: []
```

**Generated by**: `generate_mesh_descriptor.py`
**Environment variable**: `TT_MESH_GRAPH_DESC_PATH`

## üîÑ Workflow

### Complete Workflow for Custom Topology

```bash
# Step 1: Generate physical topology from hardware
./build/tools/umd/topology -f my_cluster.yaml

# Step 2: Visualize physical topology
./visualize_topology.py --cluster my_cluster.yaml --output-3d phys_topo.html

# Step 3: Generate logical mesh descriptor
./generate_mesh_descriptor.py \\
    --cluster my_cluster.yaml \\
    --auto \\
    --output my_mesh.yaml \\
    --compare

# Step 4: Visualize with mesh overlay
./visualize_topology.py \\
    --cluster my_cluster.yaml \\
    --mesh my_mesh.yaml \\
    --both

# Step 5: Test on hardware
./simple_link_check.py --yaml my_cluster.yaml

# Step 6: Use in your application
export TT_METAL_CLUSTER_DESC_PATH=my_cluster.yaml
export TT_MESH_GRAPH_DESC_PATH=my_mesh.yaml
python your_app.py
```

## üé® Visualization Examples

### 3D Interactive Visualization

The 3D view shows:
- **Blue spheres**: Individual chips
- **Gray lines**: Ethernet connections
- **Red dashed box**: Logical mesh boundary (when overlay enabled)
- **Hover info**: Chip details, connection channels

**Controls**:
- Left click + drag: Rotate
- Scroll: Zoom
- Right click + drag: Pan

### 2D Topology Visualization

The 2D view shows:
- **Blue boxes**: Chips with IDs
- **Gray arrows**: Bidirectional ethernet links
- **Channel labels**: Ethernet channel numbers
- **Red dashed box**: Mesh overlay (when enabled)

## üìä Existing Visualization Tools

### Ethernet Bandwidth Visualization

For post-processing bandwidth test results:

```bash
cd tests/tt_metal/microbenchmarks/ethernet/post_processing
python visualize_bw.py \\
    --topology topology.csv \\
    --bandwidth bandwidth.csv \\
    --output mesh_bandwidth.png
```

## üîß Troubleshooting

### "Plotly not installed"

```bash
pip install plotly networkx
```

### "Matplotlib not installed"

```bash
pip install matplotlib
```

### "MeshGraph: Expecting yaml to define a ChipSpec as a Map"

You're using a cluster descriptor where a mesh graph descriptor is expected.

**Solution**:
```bash
# Generate the mesh descriptor first
./generate_mesh_descriptor.py --cluster my_cluster.yaml --auto --output my_mesh.yaml

# Then use both
export TT_METAL_CLUSTER_DESC_PATH=my_cluster.yaml
export TT_MESH_GRAPH_DESC_PATH=my_mesh.yaml
```

### Mesh shape doesn't match physical topology

Use `--compare` flag to see the difference:

```bash
./generate_mesh_descriptor.py \\
    --cluster my_cluster.yaml \\
    --shape 2,4 \\
    --output my_mesh.yaml \\
    --compare
```

## üìö Additional Resources

- **Mesh Graph Descriptor Protobuf**: `tt_metal/fabric/protobuf/mesh_graph_descriptor.proto`
- **Example Descriptors**: `tt_metal/fabric/mesh_graph_descriptors/`
- **UMD Topology Tool**: `build/tools/umd/topology`
- **Programming Guide**: `tech_reports/Programming_Mesh_of_Devices/Programming_Mesh_of_Devices_with_TT-NN.md`

## üÜò Getting Help

If you encounter issues:

1. Check that both descriptors are valid YAML
2. Verify chip counts match between physical and logical
3. Use `--compare` flag to see differences
4. Visualize to see the actual topology
5. Test with `simple_link_check.py` on hardware

## üéØ Summary

| Tool | Input | Output | Purpose |
|------|-------|--------|---------|
| `topology` (UMD) | Hardware | Cluster YAML | Scan physical connections |
| `generate_mesh_descriptor.py` | Cluster YAML + Shape | Mesh YAML | Create logical topology |
| `visualize_topology.py` | Both YAMLs | HTML/PNG | View and verify topology |
| `simple_link_check.py` | Both YAMLs | Test report | Validate on hardware |

Happy topology visualization! üéâ
