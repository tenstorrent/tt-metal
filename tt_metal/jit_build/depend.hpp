// SPDX-FileCopyrightText: Â© 2025 Tenstorrent AI ULC
//
// SPDX-License-Identifier: Apache-2.0

#pragma once

#include <bitset>
#include <string>
#include <unordered_map>
#include <vector>

namespace tt::jit_build {

using ParsedDependencies = std::unordered_map<std::string, std::vector<std::string>>;

// Parses a Makefile-style dependency file (generated by gcc -MMD)
ParsedDependencies parse_dependency_file(std::istream& file);

// Single-file inverted dependency cache.
//
// File format (one line per dependency):
//   <absolute_dep_path>\t<fnv1a_hash>\t<target1>\t<target2>\t...\n
//
// Each target is a name like "brisc.o" or "brisc.elf".
class DependencyCache {
public:
    static constexpr size_t MAX_TARGETS = 64;
    using TargetMask = std::bitset<MAX_TARGETS>;

    struct DepEntry {
        std::string dep_path;    // absolute path to the dependency file
        uint64_t hash;           // FNV1a hash of file content
        TargetMask target_mask;  // bit i set = targets_[i] depends on this
    };

    // Loads from dephash file, mapping target names to indices in current_targets.
    // Entries referencing targets not in current_targets are silently dropped.
    // Current targets with no deps are naturally stale.
    DependencyCache(const std::string& dephash_path, const std::vector<std::string>& current_targets);

    const std::vector<std::string>& targets() const { return targets_; }
    const std::vector<DepEntry>& entries() const { return entries_; }

    // Check phase: hash each dep once, return bitset of stale targets.
    // Targets with no deps in cache are also marked stale.
    TargetMask find_stale_targets(const std::string& out_dir) const;

    // Update entries with new_deps and atomically write the dephash file.
    // Clears recompiled bits, merges new_deps (target_name -> [dep_paths]), then writes.
    // On update failure (unhashable dep), deletes the existing dephash file.
    // On write failure (I/O error), deletes the partially written file.
    void write_updated(
        const std::string& dephash_path,
        const TargetMask& recompiled_mask,
        const std::string& out_dir,
        const ParsedDependencies& new_deps);

private:
    std::vector<std::string> targets_;
    std::unordered_map<std::string, size_t> target_index_;  // target name -> index in targets_
    std::vector<DepEntry> entries_;
};

}  // namespace tt::jit_build
