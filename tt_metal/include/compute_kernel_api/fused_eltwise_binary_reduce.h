/*
The algorithm is as follows:

// Initialize eltwise binary operation (sets up ALU for binary ops)
binary_op_init_common(cb_inp0, cb_inp1, cb_intermediate);

// Initialize binary tiles (conditional compilation from original eltwise_binary.cpp)
binary_tiles_init<true, ELTWISE_OP_TYPE>(cb_in0, cb_in1);

mul_tiles

mul_tiles is called with the last argument being 0, meaning the index of the result in dest register.

after this we should call: eltwise_binary_reuse_dest_as_src, moving the result to srcA, so the exact call should look
like: <EltwiseBinaryReuseDestType::DEST_TO_SRCA>eltwise_binary_reuse_dest_as_src().

after reusing dest, we should overwrite the first tile in dest with ones and move that tile to srcB. the code should
look like this:
  // populate dest with ones, something like the method bellow (generated by deep-wiki)
  inline void _populate_first_tile_with_ones_()
  {
    // Second tile starts at offset 64 (32x32 tile = 64 rows in dest layout)
    constexpr uint first_tile_offset = 0;

    // Populate the entire first tile with LCONST_1 (value 1.0)
    for (uint row = 0; row < 32; row += 4) {
        // Store LCONST_1 to all positions in the first tile
        TT_SFPSTORE(p_sfpu::LCONST_1, 0, ADDR_MOD_3, first_tile_offset + row);
        TT_SFPSTORE(p_sfpu::LCONST_1, 0, ADDR_MOD_3, first_tile_offset + row + 2);
        TT_SFPSTORE(p_sfpu::LCONST_1, 0, ADDR_MOD_3, first_tile_offset + row + 32);
        TT_SFPSTORE(p_sfpu::LCONST_1, 0, ADDR_MOD_3, first_tile_offset + row + 34);
    }
  }

after this we should call: eltwise_binary_reuse_dest_as_src, moving the result to srcB, so the exact call should look
like: <EltwiseBinaryReuseDestType::DEST_TO_SRCB>eltwise_binary_reuse_dest_as_src().

the remainig part of the algorithm should be reduce_init, reduce, reduce_uninit.

Claude should figure out the best interface for the algorithm and generate this file (without deleting this comment)
*/

#pragma once

#include "compute_kernel_api/common.h"
#include "compute_kernel_api/eltwise_binary.h"
#include "compute_kernel_api/reduce.h"

#ifdef TRISC_MATH
#include "llk_math_eltwise_binary.h"
#include "llk_math_reduce_api.h"
#include "ckernel_sfpu.h"
#endif

namespace ckernel {

// clang-format off
/**
 * Simplified interface that handles the complete fused operation
 * Following the exact algorithm step by step as specified
 *
 * | Argument       | Description                                                   | Type     | Valid Range | Required |
 * |----------------|---------------------------------------------------------------|----------|-------------|----------|
 * | cb_inp0        | Input circular buffer 0                                       | uint32_t | 0 to 31     | True     |
 * | cb_inp1        | Input circular buffer 1                                       | uint32_t | 0 to 31     | True     |
 * | cb_intermediate| Intermediate circular buffer                                  | uint32_t | 0 to 31     | True     |
 * | cb_scaler      | Scaler circular buffer                                        | uint32_t | 0 to 31     | True     |
 * | cb_out         | Output circular buffer                                        | uint32_t | 0 to 31     | True     |
 * | itile0         | Input tile 0 index                                           | uint32_t | 0+          | True     |
 * | itile1         | Input tile 1 index                                           | uint32_t | 0+          | True     |
 * | iscaler        | Scaler tile index                                             | uint32_t | 0+          | True     |
 * | idst           | Destination tile index                                        | uint32_t | 0+          | True     |
 */
// clang-format on
// =============================================================================
// PHASE 1: ELTWISE BINARY INITIALIZATION
// =============================================================================
template <EltwiseBinaryType eltwise_binary_type = ELTWISE_OP_TYPE>
ALWI void fused_eltwise_binary_init(uint32_t cb_inp0, uint32_t cb_inp1, uint32_t cb_intermediate) {
    // 1. binary_op_init_common (sets up ALU for binary ops)
    binary_op_init_common(cb_inp0, cb_inp1, cb_intermediate);

    // 2. binary_tiles_init (conditional compilation from original eltwise_binary.cpp)
    binary_tiles_init<true, eltwise_binary_type>(cb_inp0, cb_inp1);
}

// =============================================================================
// PHASE 2: ELTWISE BINARY OPERATION
// =============================================================================
template <EltwiseBinaryType eltwise_binary_type = ELTWISE_OP_TYPE>
ALWI void fused_eltwise_binary_compute(
    uint32_t cb_inp0, uint32_t cb_inp1, uint32_t itile0, uint32_t itile1, uint32_t idst) {
    // 3. mul_tiles (with last argument being 0, meaning the index of the result in dest register)
    static_assert(idst == 0, "idst must be 0");  // since we are reusing dest as srcA
    ELTWISE_OP(cb_inp0, cb_inp1, itile0, itile1, idst);
}

// =============================================================================
// PHASE 3: DESTINATION REUSE
// =============================================================================
ALWI void fused_eltwise_binary_reuse_dest() {
    // 4. eltwise_binary_reuse_dest_as_src, moving the result to srcA
    eltwise_binary_reuse_dest_as_src<EltwiseBinaryReuseDestType::DEST_TO_SRCA>();

    // 5. populate dest with ones
    ckernel::sfpu::_populate_first_tile_with_ones_();

    // 6. eltwise_binary_reuse_dest_as_src, moving the result to srcB
    eltwise_binary_reuse_dest_as_src<EltwiseBinaryReuseDestType::DEST_TO_SRCB>();
}

// =============================================================================
// PHASE 4: REDUCE INITIALIZATION
// =============================================================================
template <PoolType reduce_type = REDUCE_OP, ReduceDim reduce_dim = REDUCE_DIM>
ALWI void fused_reduce_init(uint32_t cb_intermediate, uint32_t cb_scaler, uint32_t cb_out) {
    // 7. reduce_init (ONLY after mul_tiles - serves the purpose of setting the hardware for reduce op, not eltwise mul)
    reduce_init<reduce_type, reduce_dim>(cb_intermediate, cb_scaler, cb_out);
}

// =============================================================================
// PHASE 5: REDUCE OPERATION
// =============================================================================
template <PoolType reduce_type = REDUCE_OP, ReduceDim reduce_dim = REDUCE_DIM>
ALWI void fused_reduce_compute(uint32_t cb_intermediate, uint32_t cb_scaler, uint32_t iscaler, uint32_t idst) {
    // 8. reduce operation
    reduce_tile<reduce_type, reduce_dim>(cb_intermediate, cb_scaler, iscaler, iscaler, idst);
}

// =============================================================================
// PHASE 6: REDUCE CLEANUP
// =============================================================================
ALWI void fused_reduce_uninit() {
    // 9. reduce_uninit
    reduce_uninit();
}

// =============================================================================
// COMPLETE FUSED OPERATION (for convenience), idk
// =============================================================================
template <
    EltwiseBinaryType eltwise_binary_type = ELTWISE_OP_TYPE,
    PoolType reduce_type = REDUCE_OP,
    ReduceDim reduce_dim = REDUCE_DIM>
ALWI void fused_eltwise_binary_reduce_tile(
    uint32_t cb_inp0,
    uint32_t cb_inp1,
    uint32_t cb_intermediate,
    uint32_t cb_scaler,
    uint32_t cb_out,
    uint32_t itile0,
    uint32_t itile1,
    uint32_t iscaler,
    uint32_t idst) {
    // Phase 1: Initialize eltwise binary
    fused_eltwise_binary_init<eltwise_binary_type>(cb_inp0, cb_inp1, cb_intermediate);

    // Phase 2: Compute eltwise binary
    fused_eltwise_binary_compute<eltwise_binary_type>(cb_inp0, cb_inp1, itile0, itile1, idst);

    // Phase 3: Prepare destination reuse
    fused_eltwise_binary_reuse_dest();

    // Phase 4: Initialize reduce
    fused_reduce_init<reduce_type, reduce_dim>(cb_intermediate, cb_scaler, cb_out);

    // Phase 5: Compute reduce
    fused_reduce_compute<reduce_type, reduce_dim>(cb_intermediate, cb_scaler, iscaler, idst);

    // Phase 6: Cleanup reduce
    fused_reduce_uninit();
}

}  // namespace ckernel
