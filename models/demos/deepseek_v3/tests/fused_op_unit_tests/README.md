# DeepSeek v3 fused-op unit tests

This table enumerates pytest tests under this folder and the cases they cover.

| Module | Operation | Unit test exists | Decode | Prefill 128 | Prefill 1k | Prefill 8k | Prefill 32k | Prefill 128k | ATOL D | ATOL P-128 | E2E Perf D (us) | E2E Perf P-128 (us) | Device Perf D (us) | Device Perf P-128 (us) | PCC D | PCC P-128 | Single device test | Random weights | Program_cache on/off | Tracing on/off | 100 iterations | Added to CI | Perf shown in superset | Path to test file | Notes |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| moe | ds_moe_op | ✅ | ✅ | ✅ | ✅ | ❌ | ⛔️ | ☑️ |  |  |  |  |  |  |  |  | ☑️ | ✅ | ✅ | ✅ | ⛔️ | ✅ |  | `models/demos/deepseek_v3/tests/fused_op_unit_tests/moe/test_ds_moe_op.py` | Prefill 131072 gated by `DEEPSEEK_V3_LONG_SEQ_TESTS`; prefill 8192 is failing; no 32k prefill. |
| moe | ds_moe_fwd_moe | ✅ | ✅ | ✅ | ✅ | ❌ | ⛔️ | ☑️ |  |  |  |  |  |  |  |  | ☑️ | ✅ | ✅ | ✅ | ⛔️ | ✅ |  | `models/demos/deepseek_v3/tests/fused_op_unit_tests/moe/test_ds_moe_fwd_moe.py` | Mirrors ds_moe_op but reuses `MoE._fwd_moe`; decode verified on TG with `DEEPSEEK_V3_CACHE=/tmp/deepseek-v3-cache`; prefill 131072 gated by `DEEPSEEK_V3_LONG_SEQ_TESTS`; prefill 8192 status not revalidated. |
| moe | ds_moe_gate_projection_sigmoid | ✅ | ✅ | ✅ | ✅ | ✅ | ☑️ | ☑️ | 0.2 | 0.2 | 229.800 | 1037.366 | k=228.541/op2op=821.123 | k=84.189/op2op=632.061 | 0.9968 | 0.99999 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |  | `models/demos/deepseek_v3/tests/fused_op_unit_tests/moe/test_ds_moe_gate_projection_sigmoid.py` | Prefill 32768/131072 gated by `DEEPSEEK_V3_LONG_SEQ_TESTS`; config-compare and single-device perf compare reports under `models/demos/deepseek_v3/tests/fused_op_unit_tests/moe/test_results/verification/ds_moe_gate_projection_sigmoid`. |
| moe | ds_moe_add_score_correction_bias | ✅ | ✅ | ✅ | ✅ | ✅ | ☑️ | ☑️ | 0.2 | 0.2 | 15.874 | 455.005 | k=15.326/op2op=978.213 | k=13.926/op2op=407.632 | 0.9948 | 0.9984 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |  | `models/demos/deepseek_v3/tests/fused_op_unit_tests/moe/test_ds_moe_add_score_correction_bias.py` | Prefill 32768/131072 gated by `DEEPSEEK_V3_LONG_SEQ_TESTS`; config-compare and single-device perf compare reports under `models/demos/deepseek_v3/tests/fused_op_unit_tests/moe/test_results/verification/ds_moe_add_score_correction_bias`. |
| moe | ds_moe_expert_selection | ✅ | ✅ | ✅ | ✅ | ✅ | ☑️ | ☑️ | 0.2 | 0.2 | 237119.722 | 236679.265 | k=120.884/op2op=84292.847 | k=127.346/op2op=83854.761 | 0.9603 | 0.9667 | ✅ | ✅ | ✅ | ⛔️ | ✅ | ✅ |  | `models/demos/deepseek_v3/tests/fused_op_unit_tests/moe/test_ds_moe_expert_selection.py` | Trace unsupported because topk_fallback uses host reads; prefill 32768/131072 are CI-skipped only; config-compare and single-device perf compare reports under `models/demos/deepseek_v3/tests/fused_op_unit_tests/moe/test_results/verification/ds_moe_expert_selection`. |
| moe | ds_moe_all_gather | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | 0.2 | 0.2 | 813.828 | 892.701 | k=75.134/op2op=1054.593 | k=76.200/op2op=886.623 | 1.0 | 1.0 | ☑️ | ✅ | ✅ | ✅ | ⛔️ | ✅ |  | `models/demos/deepseek_v3/tests/fused_op_unit_tests/moe/test_ds_moe_all_gather.py` | Focused matrix on CI only: decode + prefill 128 with program_cache + trace + real weights; all other params are collection-time skips only when `CI=true`; single-device variants not applicable (CCL all-gather). |
| moe | ds_moe_reduce_scatter | ✅ | ✅ | ✅ | ☑️ | ☑️ | ☑️ | ☑️ |  |  |  |  |  |  |  |  | ☑️ | ✅ | ✅ | ✅ | ✅ | ✅ |  | `models/demos/deepseek_v3/tests/fused_op_unit_tests/moe/test_ds_moe_reduce_scatter.py` | Decode + prefill 128/1024/8192 verified on TG with `DEEPSEEK_V3_CACHE=/tmp/deepseek-v3-cache`; device-perf + module-test CSVs and config-compare report captured in `test_results`; long seq still gated by `DEEPSEEK_V3_LONG_SEQ_TESTS`. |
| moe | ds_moe_repeat_permute_expert_weights | ✅ | ✅ | ✅ | ✅ | ✅ | ☑️ | ☑️ |  |  |  |  |  |  |  |  | ✅ | ✅ | ✅ | ✅ | ✅ |  |  | `models/demos/deepseek_v3/tests/fused_op_unit_tests/moe/test_ds_moe_repeat_permute_expert_weights.py` | Prefill 32768/131072 gated by `DEEPSEEK_V3_LONG_SEQ_TESTS`; perf baselines TODO. |
| embedding | ds_embedding_fwd_embedding | ✅ | ✅ | ✅ | ☑️ | ☑️ | ☑️ | ☑️ |  |  |  |  |  |  |  |  | ☑️ | ✅ | ✅ | ✅ | ✅ |  |  | `models/demos/deepseek_v3/tests/fused_op_unit_tests/embedding/test_ds_embedding_fwd_embedding.py` | Decode (seq 32) + prefill 128 verified on TG with `DEEPSEEK_V3_CACHE=/proj_sw/user_dev/deepseek-v3-cache2`; device-perf + module-test CSVs and config-compare report captured in `test_results`; long seq gated by `DEEPSEEK_V3_LONG_SEQ_TESTS`. |
| embedding | ds_embedding_fwd_typecast | ✅ | ✅ | ✅ | ✅ | ✅ | ☑️ | ☑️ |  |  |  |  |  |  |  |  | ☑️ | ✅ | ✅ | ✅ | ✅ |  |  | `models/demos/deepseek_v3/tests/fused_op_unit_tests/embedding/test_ds_embedding_fwd_typecast.py` | Decode (seq 32) + prefill 128/1024/8192 verified on TG with `DEEPSEEK_V3_CACHE=/proj_sw/user_dev/deepseek-v3-cache2`; device-perf + module-test CSVs and config-compare report captured in `test_results`; long seq gated by `DEEPSEEK_V3_LONG_SEQ_TESTS`. |
| embedding | ds_embedding_fwd_all_gather | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | 0.2 | 0.2 | 1073.942 | 1279.149 | k=34.528/op2op=100.704 | k=44.702/op2op=1660.231 | 1.0 | 1.0 | ☑️ | ✅ | ✅ | ✅ | ✅ |  |  | `models/demos/deepseek_v3/tests/fused_op_unit_tests/embedding/test_ds_embedding_fwd_all_gather.py` | Decode (seq 1) + prefill 128/1024/8192/32768/131072 verified on TG with `DEEPSEEK_V3_CACHE=/proj_sw/user_dev/deepseek-v3-cache2`; device-perf + module-test CSVs and config-compare report captured in `test_results`; long seq gated by `DEEPSEEK_V3_LONG_SEQ_TESTS` on CI only. |
| embedding | ds_embedding_fwd_reduce_scatter | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |  |  |  |  |  |  |  |  | ☑️ | ✅ | ✅ | ✅ | ✅ |  |  | `models/demos/deepseek_v3/tests/fused_op_unit_tests/embedding/test_ds_embedding_fwd_reduce_scatter.py` | Reduce-scatter + scale from Embedding2D; long seq gated by `DEEPSEEK_V3_LONG_SEQ_TESTS`; decode uses seq_len=128. |
| embedding | ds_embedding_fwd_slice | ✅ | ✅ | ☑️ | ☑️ | ☑️ | ☑️ | ☑️ |  |  |  |  |  |  |  |  | ✅ | ✅ | ✅ | ✅ | ✅ |  |  | `models/demos/deepseek_v3/tests/fused_op_unit_tests/embedding/test_ds_embedding_fwd_slice.py` | Decode uses seq_len=1 to exercise padding/slice; prefill lengths are not applicable because slice is only used when padding is required. |
| lm_head | ds_lm_head_fwd_mesh_scatter | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | 0.2 | 0.2 | 314.016 | 1364.877 | k=143.843/op2op=3936.990 | k=588.452/op2op=3322.758 | 1.0 | 1.0 | ☑️ | ✅ | ✅ | ✅ | ✅ | ✅ |  | `models/demos/deepseek_v3/tests/fused_op_unit_tests/lm_head/test_ds_lm_head_fwd_mesh_scatter.py` | Mesh scatter uses point-to-point; single-device variants not applicable; long seq gated by `DEEPSEEK_V3_LONG_SEQ_TESTS`; device/module config compare report in `models/demos/deepseek_v3/tests/fused_op_unit_tests/lm_head/test_results/config_compare_ds_lm_head_fwd_mesh_scatter_20260124_080952/config_compare_report.txt`. |
| lm_head | ds_lm_head_projection_decode | ✅ | ✅ | ⛔️ | ⛔️ | ⛔️ | ⛔️ | ⛔️ | 4.0 |  | 94.550 |  | k=90.649/op2op=978.210 |  | 0.993 |  | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |  | `models/demos/deepseek_v3/tests/fused_op_unit_tests/lm_head/test_ds_lm_head_projection_decode.py` | Decode-only op; prefill uses a different op sequence. |
| lm_head | ds_lm_head_projection_prefill | ✅ | ⛔️ | ✅ | ✅ | ✅ | ✅ | ✅ |  | 4.5 |  | 225.797 |  | k=221.711/op2op=1619.060 |  | 0.993 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |  | `models/demos/deepseek_v3/tests/fused_op_unit_tests/lm_head/test_ds_lm_head_projection_prefill.py` | Prefill-only op; long seq gated by `DEEPSEEK_V3_LONG_SEQ_TESTS`; config compare report in `models/demos/deepseek_v3/tests/fused_op_unit_tests/lm_head/test_results/verification/config_compare_ds_lm_head_projection_prefill_20260124_142604/config_compare_report.txt`; single-device perf compare report in `models/demos/deepseek_v3/tests/fused_op_unit_tests/lm_head/test_results/verification/ds_lm_head_projection_prefill/single_device_config_compare_report.txt`. |
| mlp | ds_mlp_fwd_all_gather | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | 0.2 | 0.2 | 671.926 | 920.434 | k=75.411/op2op=71.467 | k=166.621/op2op=641.653 | 1.0 | 1.0 | ☑️ | ✅ | ✅ | ✅ | ✅ | ✅ |  | `models/demos/deepseek_v3/tests/fused_op_unit_tests/mlp/test_ds_mlp_fwd_all_gather.py` | Prefill 32768/131072 gated by `DEEPSEEK_V3_LONG_SEQ_TESTS` on CI only; single-device variants not applicable (CCL all-gather); config-compare report under `models/demos/deepseek_v3/tests/fused_op_unit_tests/mlp/test_results/ds_mlp_fwd_all_gather/verification/config_compare_report.txt`. |
| mla | paged_update_cache | ✅ | ✅ | ☑️ | ☑️ | ☑️ | ⛔️ | ☑️ |  |  |  |  |  |  |  |  | ⛔️ | ⛔️ | ✅ | ✅ | ⛔️ | ✅ |  | `models/demos/deepseek_v3/tests/fused_op_unit_tests/mla/test_paged_update_cache.py` | Prefill cases are explicitly skipped (op used only in decode); device-perf `test_path` points to a non-existent file (missing `/mla/`). |
| mla | ds_mla_norm_and_rope | ✅ | ✅ | ⛔️ | ⛔️ | ⛔️ | ⛔️ | ⛔️ |  |  |  |  |  |  |  |  | ⛔️ | ⛔️ | ✅ | ✅ | ⛔️ | ✅ |  | `models/demos/deepseek_v3/tests/fused_op_unit_tests/mla/test_ds_mla_norm_and_rope.py` | Decode-only op; device-perf `test_path` points to a non-existent file (missing `/mla/`). |
| mla | ds_ag_reshape | ✅ | ✅ | ⛔️ | ⛔️ | ⛔️ | ⛔️ | ⛔️ |  |  |  |  |  |  |  |  | ⛔️ | ⛔️ | ✅ | ✅ | ⛔️ | ✅ |  | `models/demos/deepseek_v3/tests/fused_op_unit_tests/mla/test_ds_ag_reshape.py` | Decode-only op; device-perf `test_path` points to a non-existent file (missing `/mla/`). |
| mla | ds_mla_all_to_all_before_flash_mla | ✅ | ✅ | ⛔️ | ⛔️ | ⛔️ | ⛔️ | ⛔️ |  |  |  |  |  |  |  |  | ⛔️ | ⛔️ | ✅ | ✅ | ⛔️ | ✅ |  | `models/demos/deepseek_v3/tests/fused_op_unit_tests/mla/test_ds_mla_all_to_all_before_flash_mla.py` | Decode-only op; device-perf `test_path` points to a non-existent file (missing `/mla/`). |
| mla | ds_flash_mla | ✅ | ✅ | ⛔️ | ⛔️ | ⛔️ | ⛔️ | ⛔️ |  |  |  |  |  |  |  |  | ⛔️ | ⛔️ | ✅ | ✅ | ⛔️ | ✅ |  | `models/demos/deepseek_v3/tests/fused_op_unit_tests/mla/test_ds_flash_mla.py` | Decode-only op; device-perf `test_path` points to a non-existent file (missing `/mla/`). |
| mla | ds_wo | ✅ | ✅ | ⛔️ | ⛔️ | ⛔️ | ⛔️ | ⛔️ |  |  |  |  |  |  |  |  | ✅ | ⛔️ | ✅ | ✅ | ⛔️ | ✅ |  | `models/demos/deepseek_v3/tests/fused_op_unit_tests/mla/test_ds_wo.py` | Decode-only op; device-perf `test_path` points to a non-existent file (missing `/mla/`). |
| mla | ds_fused_wqkva | ✅ | ✅ | ✅ | ✅ | ✅ | ⛔️ | ☑️ |  |  |  |  |  |  |  |  | ☑️ | ⛔️ | ✅ | ✅ | ⛔️ | ✅ |  | `models/demos/deepseek_v3/tests/fused_op_unit_tests/mla/test_ds_fused_wqkva.py` | Prefill 131072 gated by `DEEPSEEK_V3_LONG_SEQ_TESTS`; no 32k prefill; device-perf `test_path` points to a non-existent file (missing `/mla/` and `test_` prefix). |
| mla | ds_linear_with_input_dim | ✅ | ✅ | ⛔️ | ⛔️ | ⛔️ | ⛔️ | ⛔️ |  |  |  |  |  |  |  |  | ⛔️ | ⛔️ | ✅ | ✅ | ⛔️ | ✅ |  | `models/demos/deepseek_v3/tests/fused_op_unit_tests/mla/test_ds_linear_with_input_dim.py` | Decode-only op; device-perf `test_path` points to a non-existent file (missing `/mla/`). |
| mla | ds_fused_q_rope_nope | ✅ | ✅ | ⛔️ | ⛔️ | ⛔️ | ⛔️ | ⛔️ |  |  |  |  |  |  |  |  | ✅ | ✅ | ✅ | ✅ | ⛔️ | ✅ |  | `models/demos/deepseek_v3/tests/fused_op_unit_tests/mla/test_ds_fused_q_rope_nope.py` | Decode-only op; prefill TODO in test body. |

Each row referrs to a fused op and it's related unit tests.

Legend
✅: indicates the test case exists and is passing
❌: indicates the test case exists but is failing
☑️: indicates the test case does not exist but is not applicable (e.g. single device tests for ops with CCLs)
⛔️: indicates the test case does not exist

Test cases / features:
- Unit test exists: whether the unit tests exists
- Decode: whether decode setting is tested
- Prefill (128,1k,8k,32k,128k): whether prefill is tested with the specified seqquence length
- ATOL D/P-128: latest reported ATOL target from logs or config for decode/prefill-128
- E2E Perf D/P-128 (us): latest e2e perf values from logs for decode/prefill-128
- Device Perf D/P-128 (us): latest device perf totals from logs (kernel/op-to-op) for decode/prefill-128
- PCC D/P-128: latest reported PCC from logs for decode/prefill-128
- Single deivce test: single device test that tests the first device's chunk of the workload (only for non-CCL ops)
- Random weights: random weight option available for tests
- Program_cache on/off: option available
- Tracing on/off: option available
- 100 iterations: does the test run 100 iterations when checking PCC/ATOL
- Added to CI: whether it's added to any CI pipeline
- Perf shown in superset: whether any superset dashboard cisualizes the data
- Path to test file: path to the test file

"Added to CI" reflects `pytest models/demos/deepseek_v3/tests --ignore=models/demos/deepseek_v3/tests/unit` in `.github/workflows/galaxy-deepseek-tests-impl.yaml`.

Superset dashboard: https://superset.tenstorrent.com/superset/dashboard/4fa0fef8-cced-4a8e-8819-48aeed75dcee/?permalink_key=6JbY9pNEQaZ
