============================= test session starts ==============================
platform linux -- Python 3.10.12, pytest-8.4.2, pluggy-1.6.0 -- /home/container_app_user/tt-metal/python_env/bin/python3
cachedir: .pytest_cache
benchmark: 5.1.0 (defaults: timer=time.perf_counter disable_gc=False min_rounds=5 min_time=0.000005 max_time=1.0 calibration_precision=10 warmup=False warmup_iterations=100000)
rootdir: /home/container_app_user/tt-metal
configfile: pytest.ini
plugins: dash-2.15.0, anyio-4.11.0, timeout-2.4.0, benchmark-5.1.0, github-actions-annotate-failures-0.3.0, xdist-3.8.0, split-0.10.0
timeout: 300.0s
timeout method: signal
timeout func_only: False
collecting ... 2025-11-26 03:34:32.360 | info     |             UMD | Established cluster ETH FW version: 7.1.0 (topology_discovery_wormhole.cpp:359)
2025-11-26 03:34:32.400 | info     |          Device | Opening user mode device driver (tt_cluster.cpp:209)
2025-11-26 03:34:32.423 | info     |             UMD | Established cluster ETH FW version: 7.1.0 (topology_discovery_wormhole.cpp:359)
2025-11-26 03:34:32.523 | info     |             UMD | Established cluster ETH FW version: 7.1.0 (topology_discovery_wormhole.cpp:359)
2025-11-26 03:34:32.601 | info     |             UMD | Harvesting mask for chip 3 is 0x201 (NOC0: 0x201, simulated harvesting mask: 0x0). (cluster.cpp:413)
2025-11-26 03:34:32.641 | info     |             UMD | Harvesting mask for chip 2 is 0x44 (NOC0: 0x44, simulated harvesting mask: 0x0). (cluster.cpp:413)
2025-11-26 03:34:32.653 | info     |             UMD | Harvesting mask for chip 1 is 0x6 (NOC0: 0x6, simulated harvesting mask: 0x0). (cluster.cpp:413)
2025-11-26 03:34:32.666 | info     |             UMD | Harvesting mask for chip 0 is 0x300 (NOC0: 0x300, simulated harvesting mask: 0x0). (cluster.cpp:413)
2025-11-26 03:34:32.678 | info     |             UMD | Harvesting mask for chip 7 is 0x202 (NOC0: 0x202, simulated harvesting mask: 0x0). (cluster.cpp:413)
2025-11-26 03:34:32.694 | info     |             UMD | Harvesting mask for chip 6 is 0x11 (NOC0: 0x11, simulated harvesting mask: 0x0). (cluster.cpp:413)
2025-11-26 03:34:32.710 | info     |             UMD | Harvesting mask for chip 5 is 0x204 (NOC0: 0x204, simulated harvesting mask: 0x0). (cluster.cpp:413)
2025-11-26 03:34:32.727 | info     |             UMD | Harvesting mask for chip 4 is 0x140 (NOC0: 0x140, simulated harvesting mask: 0x0). (cluster.cpp:413)
2025-11-26 03:34:32.743 | info     |             UMD | Opening local chip ids/PCIe ids: {0, 1, 2, 3}/[1, 2, 0, 3] and remote chip ids {4, 5, 6, 7} (cluster.cpp:257)
2025-11-26 03:34:32.743 | warning  |             UMD | Firmware version 18.12.0 on the system is newer than the maximum supported version 18.10.0 for wormhole_b0 architecture. New features may not be supported. (cluster.cpp:215)
2025-11-26 03:34:32.743 | info     |             UMD | All devices in cluster running firmware version: 18.12.0 (cluster.cpp:235)
2025-11-26 03:34:32.743 | info     |             UMD | IOMMU: disabled (cluster.cpp:177)
2025-11-26 03:34:32.743 | info     |             UMD | KMD version: 2.4.1 (cluster.cpp:180)
2025-11-26 03:34:32.751 | info     |             UMD | Pinning pages for Hugepage: virtual address 0x7f2200000000 and size 0x40000000 pinned to physical address 0x3e00000000 (pci_device.cpp:536)
2025-11-26 03:34:32.751 | info     |             UMD | Pinning pages for Hugepage: virtual address 0x7f21c0000000 and size 0x40000000 pinned to physical address 0x3dc0000000 (pci_device.cpp:536)
2025-11-26 03:34:32.752 | info     |             UMD | Pinning pages for Hugepage: virtual address 0x7f2180000000 and size 0x40000000 pinned to physical address 0x3d80000000 (pci_device.cpp:536)
2025-11-26 03:34:32.753 | info     |             UMD | Pinning pages for Hugepage: virtual address 0x7f2140000000 and size 0x30000000 pinned to physical address 0x3d40000000 (pci_device.cpp:536)
2025-11-26 03:34:32.754 | info     |             UMD | Pinning pages for Hugepage: virtual address 0x7f2300000000 and size 0x40000000 pinned to physical address 0x7e00000000 (pci_device.cpp:536)
2025-11-26 03:34:32.754 | info     |             UMD | Pinning pages for Hugepage: virtual address 0x7f22c0000000 and size 0x40000000 pinned to physical address 0x7dc0000000 (pci_device.cpp:536)
2025-11-26 03:34:32.755 | info     |             UMD | Pinning pages for Hugepage: virtual address 0x7f2280000000 and size 0x40000000 pinned to physical address 0x7d80000000 (pci_device.cpp:536)
2025-11-26 03:34:32.756 | info     |             UMD | Pinning pages for Hugepage: virtual address 0x7f2240000000 and size 0x30000000 pinned to physical address 0x7d40000000 (pci_device.cpp:536)
2025-11-26 03:34:32.757 | info     |             UMD | Pinning pages for Hugepage: virtual address 0x7f2440000000 and size 0x40000000 pinned to physical address 0x3f00000000 (pci_device.cpp:536)
2025-11-26 03:34:32.757 | info     |             UMD | Pinning pages for Hugepage: virtual address 0x7f2400000000 and size 0x40000000 pinned to physical address 0x3ec0000000 (pci_device.cpp:536)
2025-11-26 03:34:32.758 | info     |             UMD | Pinning pages for Hugepage: virtual address 0x7f23c0000000 and size 0x40000000 pinned to physical address 0x3e80000000 (pci_device.cpp:536)
2025-11-26 03:34:32.759 | info     |             UMD | Pinning pages for Hugepage: virtual address 0x7f2380000000 and size 0x30000000 pinned to physical address 0x3e40000000 (pci_device.cpp:536)
2025-11-26 03:34:32.760 | info     |             UMD | Pinning pages for Hugepage: virtual address 0x7f2540000000 and size 0x40000000 pinned to physical address 0x7f00000000 (pci_device.cpp:536)
2025-11-26 03:34:32.760 | info     |             UMD | Pinning pages for Hugepage: virtual address 0x7f2500000000 and size 0x40000000 pinned to physical address 0x7ec0000000 (pci_device.cpp:536)
2025-11-26 03:34:32.761 | info     |             UMD | Pinning pages for Hugepage: virtual address 0x7f24c0000000 and size 0x40000000 pinned to physical address 0x7e80000000 (pci_device.cpp:536)
2025-11-26 03:34:32.762 | info     |             UMD | Pinning pages for Hugepage: virtual address 0x7f2480000000 and size 0x30000000 pinned to physical address 0x7e40000000 (pci_device.cpp:536)
collected 1 item

tests/test_mlp.py::test_mlp_inference[wormhole_b0-device_params0-1-14336-8] 2025-11-26 03:34:32.990 | info     |          Fabric | TopologyMapper mapping start (mesh=0): n_log=8, n_phys=8, log_deg_hist={2:4, 3:4}, phys_deg_hist={2:4, 3:4} (topology_mapper.cpp:475)
2025-11-26 03:34:34.297 | warning  |           Metal | Got num_routing_planes: 1, which is less than current value: 255, ignoring the override (metal_context.cpp:507)
2025-11-26 03:34:34.297 | info     |           Metal | Dispatch on FabricConfig::FABRIC_1D with 1 Command Queues
 (device_pool.cpp:327)
2025-11-26 03:34:34.327 | info     |           Metal | Profiler started on device 0 (device_pool.cpp:203)
2025-11-26 03:34:34.327 | info     |           Metal | Profiler started on remote device 4 (device_pool.cpp:214)
2025-11-26 03:34:34.327 | info     |           Metal | Profiler started on device 1 (device_pool.cpp:203)
2025-11-26 03:34:34.327 | info     |           Metal | Profiler started on remote device 5 (device_pool.cpp:214)
2025-11-26 03:34:34.327 | info     |           Metal | Profiler started on device 2 (device_pool.cpp:203)
2025-11-26 03:34:34.327 | info     |           Metal | Profiler started on remote device 6 (device_pool.cpp:214)
2025-11-26 03:34:34.327 | info     |           Metal | Profiler started on device 3 (device_pool.cpp:203)
2025-11-26 03:34:34.327 | info     |           Metal | Profiler started on remote device 7 (device_pool.cpp:214)
2025-11-26 03:34:34.327 | info     |           Metal | Initializing Fabric (device_pool.cpp:396)
2025-11-26 03:34:37.963 | info     |           Metal | Fabric initialized on Device 0 (device.cpp:398)
2025-11-26 03:34:37.964 | info     |           Metal | Fabric initialized on Device 1 (device.cpp:398)
2025-11-26 03:34:37.965 | info     |           Metal | Fabric initialized on Device 2 (device.cpp:398)
2025-11-26 03:34:37.965 | info     |           Metal | Fabric initialized on Device 3 (device.cpp:398)
2025-11-26 03:34:37.968 | info     |           Metal | Fabric initialized on Device 4 (device.cpp:398)
2025-11-26 03:34:37.974 | info     |           Metal | Fabric initialized on Device 5 (device.cpp:398)
2025-11-26 03:34:37.976 | info     |           Metal | Fabric initialized on Device 6 (device.cpp:398)
2025-11-26 03:34:37.983 | info     |           Metal | Fabric initialized on Device 7 (device.cpp:398)
2025-11-26 03:34:37.983 | info     |           Metal | Fabric Initialized with config FabricConfig::FABRIC_1D (device_pool.cpp:401)
2025-11-26 03:34:41.927 | info     |           Metal | Command Queue initialized on Device 4 (device_pool.cpp:481)
2025-11-26 03:34:41.955 | info     |           Metal | Command Queue initialized on Device 5 (device_pool.cpp:481)
2025-11-26 03:34:41.985 | info     |           Metal | Command Queue initialized on Device 6 (device_pool.cpp:481)
2025-11-26 03:34:42.012 | info     |           Metal | Command Queue initialized on Device 7 (device_pool.cpp:481)
2025-11-26 03:34:42.017 | INFO     | models.tt_transformers.tt.model_config:__init__:474 - Inferring device name: T3K
2025-11-26 03:34:42.017 | INFO     | models.tt_transformers.tt.model_config:__init__:537 - Checkpoint directory: /home/container_app_user/readonly_weights_mount/Qwen3-VL-32B-Instruct/snapshots/0cfaf48183f594c314753d30a4c4974bc75f3ccb
2025-11-26 03:34:42.017 | INFO     | models.tt_transformers.tt.model_config:__init__:538 - Tokenizer file: /home/container_app_user/readonly_weights_mount/Qwen3-VL-32B-Instruct/snapshots/0cfaf48183f594c314753d30a4c4974bc75f3ccb/tokenizer.model
2025-11-26 03:34:42.017 | INFO     | models.tt_transformers.tt.model_config:__init__:539 - Cache directory: /home/container_app_user/cache_root/tt_metal_cache/cache_Qwen3-VL-32B-Instruct/T3K/T3K
2025-11-26 03:34:42.017 | INFO     | models.tt_transformers.tt.model_config:__init__:540 - Model name: 0cfaf48183f594c314753d30a4c4974bc75f3ccb
/home/container_app_user/readonly_weights_mount/Qwen3-VL-32B-Instruct/snapshots/0cfaf48183f594c314753d30a4c4974bc75f3ccb
FAILED

=================================== FAILURES ===================================
___________ test_mlp_inference[wormhole_b0-device_params0-1-14336-8] ___________

rows = 14336, batch_size = 1, mesh_device = MeshDevice(1x8 grid, 8 devices)
reset_seeds = None, ensure_gc = None

    @torch.no_grad()
    @pytest.mark.parametrize(
        "mesh_device",
        [
            {"N150": (1, 1), "N300": (1, 2), "T3K": (1, 8), "TG": (8, 4)}.get(
                os.environ.get("MESH_DEVICE"), len(ttnn.get_device_ids())
            )
        ],
        indirect=True,
    )
    @pytest.mark.parametrize(
        "rows",
        (
            14336,  # TODO: fix padding issues
            # 14308, # from 3B test image
        ),
    )
    @pytest.mark.parametrize(
        "batch_size",
        (1,),
    )
    @pytest.mark.parametrize("device_params", [{"fabric_config": True}], indirect=True)
    def test_mlp_inference(rows, batch_size, mesh_device, reset_seeds, ensure_gc):
        dtype = ttnn.bfloat8_b
        mode = "prefill"  # Vision processing is prefill only (generating token embeddings)
    
>       model_args = VisionModelArgs(mesh_device, dummy_weights=True, max_batch_size=batch_size, max_seq_len=rows)

tests/test_mlp.py:44: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
tt/model_config.py:25: in __init__
    super().__init__(*args, **kwargs)
../../tt_transformers/tt/model_config.py:565: in __init__
    self._set_hf_params(self.CKPT_DIR)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <[AttributeError("'VisionModelArgs' object has no attribute 'dim'") raised in repr()] VisionModelArgs object at 0x7f25d4774130>
checkpoint_dir = '/home/container_app_user/readonly_weights_mount/Qwen3-VL-32B-Instruct/snapshots/0cfaf48183f594c314753d30a4c4974bc75f3ccb'

    def _set_hf_params(self, checkpoint_dir):
        print(checkpoint_dir)
>       print(self.LOCAL_HF_PARAMS[self.model_name])
E       KeyError: '0cfaf48183f594c314753d30a4c4974bc75f3ccb'

../../tt_transformers/tt/model_config.py:1790: KeyError
=============================== warnings summary ===============================
../../../python_env/lib/python3.10/site-packages/llama_models/llama3/api/datatypes.py:44
  /home/container_app_user/tt-metal/python_env/lib/python3.10/site-packages/llama_models/llama3/api/datatypes.py:44: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class ImageMedia(BaseModel):

../../../python_env/lib/python3.10/site-packages/llama_models/llama3/api/datatypes.py:120
  /home/container_app_user/tt-metal/python_env/lib/python3.10/site-packages/llama_models/llama3/api/datatypes.py:120: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    @validator("tool_name", pre=True)

../../../python_env/lib/python3.10/site-packages/llama_models/llama3/api/datatypes.py:137
  /home/container_app_user/tt-metal/python_env/lib/python3.10/site-packages/llama_models/llama3/api/datatypes.py:137: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    @validator("tool_name", pre=True)

../../../python_env/lib/python3.10/site-packages/llama_models/llama3/api/datatypes.py:162
  /home/container_app_user/tt-metal/python_env/lib/python3.10/site-packages/llama_models/llama3/api/datatypes.py:162: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    @validator("tool_name", pre=True)

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
- generated xml file: /home/container_app_user/tt-metal/models/demos/qwen3_vl/generated/test_reports/most_recent_tests.xml -
============================== slowest durations ===============================
9.20s setup    models/demos/qwen3_vl/tests/test_mlp.py::test_mlp_inference[wormhole_b0-device_params0-1-14336-8]
0.18s teardown models/demos/qwen3_vl/tests/test_mlp.py::test_mlp_inference[wormhole_b0-device_params0-1-14336-8]
0.00s call     models/demos/qwen3_vl/tests/test_mlp.py::test_mlp_inference[wormhole_b0-device_params0-1-14336-8]
=========================== short test summary info ============================
FAILED tests/test_mlp.py::test_mlp_inference[wormhole_b0-device_params0-1-14336-8] - KeyError: '0cfaf48183f594c314753d30a4c4974bc75f3ccb'
======================== 1 failed, 4 warnings in 10.07s ========================
2025-11-26 03:34:43.866 | info     |          Device | Closing user mode device drivers (tt_cluster.cpp:425)
