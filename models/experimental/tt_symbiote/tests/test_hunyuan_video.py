# SPDX-FileCopyrightText: Â© 2025 Tenstorrent AI ULC

# SPDX-License-Identifier: Apache-2.0

"""Test for HunyuanVideo model with TTNN backend."""

import torch
from diffusers import HunyuanVideo15Pipeline
from torch import nn
from tqdm import tqdm

from models.experimental.tt_symbiote.core.run_config import DispatchManager
from models.experimental.tt_symbiote.modules.activation import TTNNSilu
from models.experimental.tt_symbiote.modules.linear import TTNNLinearLLama
from models.experimental.tt_symbiote.utils.device_management import set_device
from models.experimental.tt_symbiote.utils.module_replacement import register_module_replacement_dict


def test_hunyuan_video(device):
    """Test HunyuanVideo model with TTNN acceleration."""
    nn_to_ttnn = {
        nn.Linear: TTNNLinearLLama,
        nn.SiLU: TTNNSilu,
    }

    # **Load the pre-converted diffusers version**
    pipe = HunyuanVideo15Pipeline.from_pretrained(
        "hunyuanvideo-community/HunyuanVideo-1.5-Diffusers-480p_t2v",
        torch_dtype=torch.bfloat16,
    )
    # pipe.enable_model_cpu_offload()
    pipe.vae.enable_tiling()
    all_modules = register_module_replacement_dict(pipe.text_encoder, nn_to_ttnn, model_config=None)
    all_modules.update(register_module_replacement_dict(pipe.text_encoder_2, nn_to_ttnn, model_config=None))
    all_modules.update(register_module_replacement_dict(pipe.transformer, nn_to_ttnn, model_config=None))
    # all_modules.update(register_module_replacement_dict(pipe.vae, nn_to_ttnn, model_config=None))
    set_device(pipe.text_encoder, device)
    set_device(pipe.text_encoder_2, device)
    set_device(pipe.transformer, device)
    # set_device(pipe.vae, device)
    print(f"Preprocessing {len(all_modules)} TTNN modules weights...")
    to_device_list = [
        "layers.3.mlp.up_proj",
        "layers.8.mlp.down_proj",
        "layers.6.mlp.down_proj",
        "layers.19.mlp.down_proj",
        "layers.4.mlp.down_proj",
        "layers.3.mlp.down_proj",
        "layers.1.mlp.down_proj",
        "layers.20.mlp.down_proj",
        "layers.4.mlp.up_proj",
        "layers.22.mlp.down_proj",
        "layers.15.mlp.down_proj",
        "layers.2.mlp.down_proj",
        "layers.23.mlp.down_proj",
        "layers.1.mlp.up_proj",
        "layers.27.mlp.down_proj",
        "layers.18.mlp.down_proj",
        "layers.9.mlp.down_proj",
        "layers.17.mlp.down_proj",
        "layers.0.mlp.down_proj",
        "layers.10.mlp.down_proj",
        "layers.5.mlp.down_proj",
        "layers.15.mlp.up_proj",
        "layers.21.mlp.down_proj",
        "layers.26.mlp.down_proj",
        "layers.8.mlp.up_proj",
        "layers.12.mlp.down_proj",
        "layers.10.mlp.up_proj",
        "layers.7.mlp.down_proj",
        "layers.21.mlp.gate_proj",
        "layers.23.mlp.gate_proj",
        "layers.25.mlp.gate_proj",
        "layers.16.mlp.gate_proj",
        "layers.11.mlp.down_proj",
        "layers.22.mlp.up_proj",
        "layers.24.mlp.down_proj",
        "layers.4.mlp.gate_proj",
        "layers.16.mlp.up_proj",
        "layers.27.mlp.gate_proj",
        "layers.14.mlp.up_proj",
        "layers.24.mlp.gate_proj",
        "layers.18.mlp.up_proj",
        "layers.9.mlp.up_proj",
        "layers.5.mlp.up_proj",
        "layers.26.mlp.up_proj",
        "layers.13.mlp.down_proj",
        "layers.22.mlp.gate_proj",
        "layers.17.mlp.up_proj",
        "layers.7.mlp.up_proj",
        "layers.26.mlp.gate_proj",
        "layers.18.mlp.gate_proj",
        "layers.9.mlp.gate_proj",
        "layers.6.mlp.up_proj",
        "layers.14.mlp.down_proj",
        "layers.19.mlp.gate_proj",
        "layers.2.mlp.up_proj",
        "layers.11.mlp.gate_proj",
        "layers.25.mlp.down_proj",
        "layers.25.mlp.up_proj",
        "layers.3.mlp.gate_proj",
        "layers.8.mlp.gate_proj",
        "layers.6.mlp.gate_proj",
        "layers.10.mlp.gate_proj",
        "layers.20.mlp.gate_proj",
        "layers.19.mlp.up_proj",
        "layers.12.mlp.gate_proj",
        "layers.15.mlp.gate_proj",
        "layers.12.mlp.up_proj",
        "layers.11.mlp.up_proj",
        "layers.2.mlp.gate_proj",
        "layers.1.mlp.gate_proj",
        "layers.0.mlp.gate_proj",
        "layers.20.mlp.up_proj",
        "layers.7.mlp.gate_proj",
        "layers.5.mlp.gate_proj",
        "layers.14.mlp.gate_proj",
        "layers.13.mlp.up_proj",
        "layers.13.mlp.gate_proj",
        "layers.27.mlp.up_proj",
        "layers.23.mlp.up_proj",
        "layers.0.mlp.up_proj",
        "layers.21.mlp.up_proj",
        "layers.24.mlp.up_proj",
        "layers.17.mlp.gate_proj",
        "context_embedder.token_refiner.refiner_blocks.0.ff.net.0.proj",
        "context_embedder.token_refiner.refiner_blocks.0.ff.net.2",
        "transformer_blocks.51.norm1.linear",
        "transformer_blocks.32.norm1_context.linear",
        "transformer_blocks.16.norm1_context.linear",
        "transformer_blocks.22.norm1_context.linear",
        "transformer_blocks.18.norm1_context.linear",
        "transformer_blocks.4.norm1.linear",
        "transformer_blocks.24.norm1_context.linear",
        "transformer_blocks.17.norm1_context.linear",
        "transformer_blocks.39.norm1.linear",
        "transformer_blocks.2.norm1_context.linear",
        "transformer_blocks.33.norm1.linear",
        "transformer_blocks.37.norm1.linear",
        "transformer_blocks.23.norm1_context.linear",
        "transformer_blocks.17.norm1.linear",
        "transformer_blocks.47.norm1_context.linear",
        "transformer_blocks.29.norm1.linear",
        "transformer_blocks.18.norm1.linear",
        "transformer_blocks.16.norm1.linear",
        "transformer_blocks.3.norm1_context.linear",
        "transformer_blocks.5.norm1_context.linear",
        "transformer_blocks.24.norm1.linear",
        "transformer_blocks.49.norm1.linear",
        "transformer_blocks.20.norm1_context.linear",
        "transformer_blocks.40.norm1.linear",
        "transformer_blocks.32.norm1.linear",
        "transformer_blocks.45.norm1.linear",
        "transformer_blocks.5.norm1.linear",
        "transformer_blocks.27.norm1_context.linear",
        "transformer_blocks.19.norm1.linear",
        "transformer_blocks.46.norm1_context.linear",
        "transformer_blocks.51.norm1_context.linear",
        "transformer_blocks.19.norm1_context.linear",
        "transformer_blocks.15.norm1_context.linear",
        "transformer_blocks.28.norm1_context.linear",
        "transformer_blocks.2.norm1.linear",
        "transformer_blocks.44.norm1_context.linear",
        "transformer_blocks.41.norm1_context.linear",
        "transformer_blocks.21.norm1_context.linear",
        "transformer_blocks.29.norm1_context.linear",
        "transformer_blocks.14.norm1.linear",
        "transformer_blocks.25.norm1_context.linear",
        "transformer_blocks.13.norm1.linear",
        "transformer_blocks.46.norm1.linear",
        "transformer_blocks.11.norm1_context.linear",
        "transformer_blocks.6.norm1_context.linear",
        "transformer_blocks.44.norm1.linear",
        "transformer_blocks.43.norm1.linear",
        "transformer_blocks.12.norm1.linear",
        "transformer_blocks.22.norm1.linear",
        "transformer_blocks.43.norm1_context.linear",
        "transformer_blocks.39.norm1_context.linear",
        "transformer_blocks.48.norm1_context.linear",
        "transformer_blocks.50.norm1_context.linear",
        "transformer_blocks.8.norm1.linear",
        "transformer_blocks.21.norm1.linear",
        "transformer_blocks.28.norm1.linear",
        "transformer_blocks.35.norm1_context.linear",
        "transformer_blocks.40.norm1_context.linear",
        "transformer_blocks.7.norm1_context.linear",
        "transformer_blocks.1.norm1_context.linear",
        "transformer_blocks.49.norm1_context.linear",
        "transformer_blocks.48.norm1.linear",
        "transformer_blocks.4.norm1_context.linear",
        "transformer_blocks.15.norm1.linear",
        "transformer_blocks.6.norm1.linear",
        "transformer_blocks.14.norm1_context.linear",
        "transformer_blocks.25.norm1.linear",
        "transformer_blocks.20.norm1.linear",
        "transformer_blocks.35.norm1.linear",
        "transformer_blocks.26.norm1.linear",
        "transformer_blocks.7.norm1.linear",
        "transformer_blocks.11.norm1.linear",
        "transformer_blocks.13.norm1_context.linear",
        "transformer_blocks.38.norm1_context.linear",
        "transformer_blocks.12.norm1_context.linear",
        "transformer_blocks.50.norm1.linear",
        "transformer_blocks.31.norm1.linear",
        "transformer_blocks.30.norm1.linear",
        "transformer_blocks.37.norm1_context.linear",
        "transformer_blocks.53.norm1_context.linear",
        "transformer_blocks.52.norm1.linear",
        "transformer_blocks.0.norm1_context.linear",
        "transformer_blocks.31.norm1_context.linear",
        "transformer_blocks.38.norm1.linear",
        "transformer_blocks.23.norm1.linear",
        "transformer_blocks.3.norm1.linear",
        "transformer_blocks.3.norm1.linear",
        "transformer_blocks.52.norm1_context.linear",
        "transformer_blocks.34.norm1_context.linear",
        "transformer_blocks.36.norm1_context.linear",
        "transformer_blocks.53.norm1.linear",
        "transformer_blocks.27.norm1.linear",
        "transformer_blocks.1.norm1.linear",
        "transformer_blocks.36.norm1.linear",
        "transformer_blocks.42.norm1.linear",
        "transformer_blocks.33.norm1_context.linear",
        "transformer_blocks.10.norm1_context.linear",
        "transformer_blocks.41.norm1.linear",
        "transformer_blocks.34.norm1.linear",
        "transformer_blocks.30.norm1_context.linear",
        "transformer_blocks.34.norm1.linear",
        "transformer_blocks.30.norm1_context.linear",
        "transformer_blocks.42.norm1_context.linear",
        "transformer_blocks.26.norm1_context.linear",
        "transformer_blocks.0.norm1.linear",
        "transformer_blocks.45.norm1_context.linear",
        "layers.0.self_attn.o_proj",
        "layers.16.mlp.down_proj",
        "transformer_blocks.44.ff.net.2",
        "transformer_blocks.17.ff_context.net.2",
        "transformer_blocks.49.ff_context.net.2",
        "transformer_blocks.0.ff_context.net.2",
        "transformer_blocks.19.ff_context.net.2",
        "transformer_blocks.16.ff.net.2",
        "transformer_blocks.27.ff_context.net.2",
        "transformer_blocks.34.ff.net.2",
        "transformer_blocks.3.ff_context.net.2",
        "transformer_blocks.16.ff_context.net.2",
        "transformer_blocks.4.ff_context.net.2",
        "transformer_blocks.19.ff.net.2",
        "transformer_blocks.36.ff.net.2",
        "transformer_blocks.42.ff_context.net.2",
        "transformer_blocks.23.ff_context.net.2",
        "transformer_blocks.52.ff_context.net.2",
        "transformer_blocks.3.ff.net.2",
        "transformer_blocks.7.ff_context.net.2",
        "transformer_blocks.23.ff.net.0.proj",
        "transformer_blocks.14.ff_context.net.2",
        "transformer_blocks.18.ff.net.2",
        "transformer_blocks.10.ff_context.net.2",
        "transformer_blocks.20.ff.net.2",
        "transformer_blocks.45.ff_context.net.2",
        "transformer_blocks.41.ff.net.2",
        "transformer_blocks.1.ff_context.net.2",
        "transformer_blocks.28.ff_context.net.2",
        "transformer_blocks.20.ff_context.net.2",
        "transformer_blocks.51.ff_context.net.2",
        "transformer_blocks.41.ff.net.0.proj",
        "transformer_blocks.32.ff.net.2",
        "transformer_blocks.28.ff.net.2",
        "transformer_blocks.18.ff_context.net.0.proj",
        "transformer_blocks.6.ff_context.net.2",
        "transformer_blocks.18.ff_context.net.2",
        "transformer_blocks.34.norm1.linear",
        "transformer_blocks.30.norm1_context.linear",
        "transformer_blocks.6.norm1.linear",
        "transformer_blocks.14.norm1.linear",
        "transformer_blocks.13.norm1.linear",
        "transformer_blocks.23.norm1_context.linear",
        "transformer_blocks.26.norm1.linear",
        "transformer_blocks.16.norm1.linear",
        "transformer_blocks.23.norm1.linear",
        "transformer_blocks.24.norm1.linear",
        "transformer_blocks.19.norm1.linear",
        "transformer_blocks.5.norm1.linear",
        "transformer_blocks.17.norm1.linear",
        "transformer_blocks.15.norm1.linear",
        "transformer_blocks.20.norm1.linear",
        "transformer_blocks.21.norm1.linear",
        "transformer_blocks.13.norm1_context.linear",
        "transformer_blocks.26.norm1_context.linear",
        "transformer_blocks.4.norm1.linear",
        "transformer_blocks.11.norm1.linear",
        "layers.14.mlp.up_proj",
        "layers.9.mlp.up_proj",
        "layers.5.mlp.up_proj",
        "layers.8.mlp.up_proj",
        "layers.2.mlp.up_proj",
        "layers.6.mlp.up_proj",
        "layers.13.mlp.up_proj",
        "layers.26.mlp.up_proj",
        "layers.10.mlp.up_proj",
        "transformer_blocks.1.norm1_context.linear",
        "layers.4.mlp.up_proj",
        "layers.27.mlp.up_proj",
        "layers.10.mlp.down_proj",
        "layers.12.mlp.up_proj",
        "layers.7.mlp.up_proj",
        "layers.24.mlp.up_proj",
        "layers.17.mlp.up_proj",
        "layers.23.mlp.up_proj",
        "layers.15.mlp.up_proj",
        "layers.11.mlp.up_proj",
        "layers.3.mlp.up_proj",
        "layers.18.mlp.up_proj",
        "transformer_blocks.14.norm1_context.linear",
        "layers.1.mlp.up_proj",
        "transformer_blocks.6.norm1_context.linear",
        "layers.4.mlp.down_proj",
        "layers.3.mlp.down_proj",
        "transformer_blocks.24.norm1_context.linear",
        "transformer_blocks.10.norm1_context.linear",
        "transformer_blocks.18.norm1.linear",
        "layers.1.mlp.gate_proj",
        "transformer_blocks.19.norm1_context.linear",
        "transformer_blocks.16.norm1_context.linear",
        "layers.24.mlp.gate_proj",
        "layers.19.mlp.down_proj",
        "transformer_blocks.4.norm1_context.linear",
        "transformer_blocks.15.norm1_context.linear",
        "transformer_blocks.18.norm1_context.linear",
        "layers.4.mlp.gate_proj",
        "transformer_blocks.2.norm1.linear",
        "transformer_blocks.1.norm1.linear",
        "transformer_blocks.25.norm1_context.linear",
        "layers.11.mlp.gate_proj",
        "layers.23.mlp.down_proj",
        "layers.6.mlp.gate_proj",
        "layers.25.mlp.gate_proj",
        "layers.16.mlp.up_proj",
        "transformer_blocks.2.norm1_context.linear",
        "transformer_blocks.7.norm1.linear",
        "layers.23.mlp.gate_proj",
        "layers.26.mlp.down_proj",
        "layers.9.mlp.gate_proj",
        "layers.5.mlp.down_proj",
        "layers.11.mlp.down_proj",
        "layers.20.mlp.up_proj",
        "layers.22.mlp.down_proj",
        "layers.10.mlp.gate_proj",
        "layers.27.mlp.gate_proj",
        "layers.0.mlp.gate_proj",
        "layers.16.mlp.down_proj",
        "transformer_blocks.11.norm1_context.linear",
        "layers.25.mlp.up_proj",
        "layers.17.mlp.gate_proj",
        "layers.22.mlp.up_proj",
        "transformer_blocks.22.norm1.linear",
        "layers.5.mlp.gate_proj",
        "layers.21.mlp.gate_proj",
        "transformer_blocks.22.norm1_context.linear",
        "layers.2.mlp.down_proj",
        "layers.2.mlp.gate_proj",
        "transformer_blocks.12.norm1_context.linear",
        "layers.15.mlp.gate_proj",
        "transformer_blocks.7.norm1_context.linear",
        "layers.26.mlp.gate_proj",
        "layers.0.mlp.down_proj",
        "layers.0.mlp.up_proj",
        "layers.18.mlp.gate_proj",
        "layers.13.mlp.down_proj",
        "layers.12.mlp.gate_proj",
        "layers.14.mlp.gate_proj",
        "layers.8.mlp.gate_proj",
        "layers.15.mlp.down_proj",
        "transformer_blocks.25.norm1.linear",
        "layers.12.mlp.down_proj",
        "layers.1.mlp.down_proj",
        "layers.21.mlp.up_proj",
        "layers.9.mlp.down_proj",
        "layers.8.mlp.down_proj",
        "transformer_blocks.12.norm1.linear",
        "transformer_blocks.21.norm1_context.linear",
        "transformer_blocks.17.norm1_context.linear",
        "layers.16.mlp.gate_proj",
        "layers.3.mlp.gate_proj",
        "layers.25.mlp.down_proj",
        "layers.22.mlp.gate_proj",
        "layers.20.mlp.down_proj",
        "transformer_blocks.5.norm1_context.linear",
        "layers.7.mlp.gate_proj",
        "layers.7.mlp.down_proj",
        "layers.13.mlp.gate_proj",
        "layers.20.mlp.gate_proj",
        "layers.19.mlp.gate_proj",
        "transformer_blocks.3.norm1_context.linear",
        "layers.6.mlp.down_proj",
        "transformer_blocks.0.norm1.linear",
        "transformer_blocks.0.norm1_context.linear",
        "layers.18.mlp.down_proj",
        "transformer_blocks.20.norm1_context.linear",
        "layers.24.mlp.down_proj",
        "layers.17.mlp.down_proj",
        "layers.27.mlp.down_proj",
        "layers.14.mlp.down_proj",
        "layers.21.mlp.down_proj",
        "layers.19.mlp.up_proj",
        "transformer_blocks.39.ff_context.net.2",
        "transformer_blocks.15.ff_context.net.2",
        "transformer_blocks.33.ff_context.net.2",
        "transformer_blocks.36.ff_context.net.2",
        "transformer_blocks.32.ff_context.net.2",
        "transformer_blocks.35.ff_context.net.2",
        "transformer_blocks.40.ff_context.net.2",
        "transformer_blocks.38.ff_context.net.2",
        "transformer_blocks.37.ff_context.net.2",
        "transformer_blocks.25.ff_context.net.2",
        "transformer_blocks.30.ff_context.net.2",
        "transformer_blocks.24.ff_context.net.2",
        "transformer_blocks.34.ff_context.net.2",
        "transformer_blocks.44.ff_context.net.2",
        "transformer_blocks.22.ff_context.net.2",
        "transformer_blocks.26.ff_context.net.2",
        "transformer_blocks.43.ff_context.net.2",
        "transformer_blocks.29.ff_context.net.2",
        "transformer_blocks.50.ff_context.net.2",
        "transformer_blocks.13.ff_context.net.2",
        "transformer_blocks.21.ff_context.net.2",
        "transformer_blocks.47.ff_context.net.2",
        "transformer_blocks.53.ff_context.net.2",
        "transformer_blocks.46.ff_context.net.2",
        "transformer_blocks.48.ff_context.net.2",
        "transformer_blocks.15.ff_context.net.0.proj",
        "transformer_blocks.4.ff_context.net.2",
        "transformer_blocks.44.ff_context.net.0.proj",
        "transformer_blocks.34.ff.net.0.proj",
        "transformer_blocks.14.ff_context.net.2",
        "transformer_blocks.31.ff_context.net.0.proj",
        "transformer_blocks.34.ff_context.net.0.proj",
        "transformer_blocks.20.ff_context.net.2",
        "transformer_blocks.51.ff_context.net.0.proj",
        "transformer_blocks.35.ff_context.net.0.proj",
        "transformer_blocks.19.ff_context.net.2",
        "transformer_blocks.32.ff_context.net.0.proj",
        "transformer_blocks.45.ff.net.2",
        "transformer_blocks.52.ff.net.2",
        "transformer_blocks.50.ff_context.net.0.proj",
        "transformer_blocks.35.ff.net.0.proj",
        "transformer_blocks.40.ff.net.0.proj",
        "transformer_blocks.49.ff_context.net.0.proj",
        "transformer_blocks.48.ff_context.net.0.proj",
        "transformer_blocks.16.ff_context.net.2",
        "transformer_blocks.39.ff_context.net.0.proj",
        "transformer_blocks.53.ff.net.2",
        "transformer_blocks.47.ff.net.0.proj",
        "transformer_blocks.26.ff.net.2",
        "transformer_blocks.52.ff.net.0.proj",
        "transformer_blocks.36.ff.net.0.proj",
        "transformer_blocks.31.ff.net.2",
        "transformer_blocks.48.ff.net.0.proj",
        "transformer_blocks.46.ff.net.0.proj",
        "transformer_blocks.46.ff_context.net.0.proj",
        "transformer_blocks.43.ff.net.0.proj",
        "transformer_blocks.21.ff.net.2",
        "transformer_blocks.17.ff_context.net.0.proj",
        "transformer_blocks.38.ff_context.net.0.proj",
        "transformer_blocks.14.ff_context.net.0.proj",
        "transformer_blocks.32.ff.net.0.proj",
        "transformer_blocks.33.ff.net.0.proj",
        "transformer_blocks.37.ff_context.net.0.proj",
        "transformer_blocks.33.ff_context.net.0.proj",
        "transformer_blocks.30.ff.net.0.proj",
        "transformer_blocks.23.ff.net.2",
        "transformer_blocks.51.ff.net.0.proj",
        "transformer_blocks.19.ff_context.net.0.proj",
        "transformer_blocks.13.ff_context.net.0.proj",
        "transformer_blocks.35.ff.net.2",
        "transformer_blocks.53.ff_context.net.0.proj",
        "transformer_blocks.14.ff.net.2",
        "transformer_blocks.31.ff.net.0.proj",
        "transformer_blocks.30.ff_context.net.0.proj",
        "transformer_blocks.46.ff.net.2",
        "transformer_blocks.50.ff.net.0.proj",
        "transformer_blocks.49.ff.net.2",
        "transformer_blocks.16.ff_context.net.0.proj",
        "transformer_blocks.44.ff.net.0.proj",
        "transformer_blocks.29.ff.net.0.proj",
        "transformer_blocks.45.ff.net.0.proj",
        "transformer_blocks.21.ff_context.net.0.proj",
        "transformer_blocks.43.ff_context.net.0.proj",
        "transformer_blocks.39.ff.net.0.proj",
        "transformer_blocks.36.ff_context.net.0.proj",
        "transformer_blocks.43.ff.net.2",
        "transformer_blocks.47.ff.net.2",
        "transformer_blocks.31.ff_context.net.2",
        "transformer_blocks.47.ff_context.net.0.proj",
        "transformer_blocks.42.ff.net.2",
        "transformer_blocks.13.ff.net.2",
        "transformer_blocks.45.ff_context.net.0.proj",
        "transformer_blocks.20.ff_context.net.0.proj",
        "transformer_blocks.53.ff.net.0.proj",
        "transformer_blocks.25.ff_context.net.0.proj",
        "transformer_blocks.24.ff_context.net.0.proj",
        "transformer_blocks.37.ff.net.0.proj",
        "transformer_blocks.52.ff_context.net.0.proj",
        "transformer_blocks.51.ff.net.2",
        "transformer_blocks.25.ff.net.2",
        "transformer_blocks.42.ff.net.0.proj",
        "transformer_blocks.49.ff.net.0.proj",
        "transformer_blocks.25.ff.net.0.proj",
        "transformer_blocks.37.ff.net.2",
        "transformer_blocks.40.ff_context.net.0.proj",
        "transformer_blocks.41.ff_context.net.0.proj",
        "transformer_blocks.39.ff.net.2",
        "transformer_blocks.20.ff.net.0.proj",
        "transformer_blocks.42.ff_context.net.0.proj",
        "transformer_blocks.26.ff.net.0.proj",
        "transformer_blocks.38.ff.net.0.proj",
        "transformer_blocks.40.ff.net.2",
        "transformer_blocks.16.ff.net.0.proj",
        "transformer_blocks.28.ff_context.net.0.proj",
        "transformer_blocks.17.ff.net.2",
        "transformer_blocks.48.ff.net.2",
        "transformer_blocks.27.ff_context.net.0.proj",
        "transformer_blocks.22.ff_context.net.0.proj",
        "transformer_blocks.27.ff.net.2",
        "transformer_blocks.22.ff.net.2",
        "transformer_blocks.30.ff.net.2",
        "transformer_blocks.33.ff.net.2",
        "transformer_blocks.19.ff.net.0.proj",
        "transformer_blocks.15.ff.net.2",
        "transformer_blocks.41.ff_context.net.2",
        "transformer_blocks.18.ff.net.0.proj",
        "transformer_blocks.17.ff.net.0.proj",
        "transformer_blocks.24.ff.net.0.proj",
        "transformer_blocks.14.ff.net.0.proj",
        "transformer_blocks.24.ff.net.2",
        "transformer_blocks.27.ff.net.0.proj",
        "transformer_blocks.38.ff.net.2",
        "transformer_blocks.50.ff.net.2",
        "transformer_blocks.15.ff.net.0.proj",
        "transformer_blocks.28.ff.net.0.proj",
        "transformer_blocks.22.ff.net.0.proj",
        "transformer_blocks.21.ff.net.0.proj",
        "transformer_blocks.29.ff.net.2",
        "transformer_blocks.29.ff_context.net.0.proj",
        "transformer_blocks.23.ff_context.net.0.proj",
        "transformer_blocks.26.ff_context.net.0.proj",
        "context_embedder.token_refiner.refiner_blocks.0.ff.net.0.proj",
        "transformer_blocks.1.ff_context.net.2",
        "transformer_blocks.18.ff_context.net.0.proj",
        "transformer_blocks.3.ff_context.net.2",
        "transformer_blocks.23.ff.net.0.proj",
        "transformer_blocks.20.ff.net.2",
        "transformer_blocks.16.ff.net.2",
        "transformer_blocks.0.ff_context.net.2",
        "transformer_blocks.19.ff.net.2",
        "transformer_blocks.10.ff_context.net.2",
        "transformer_blocks.7.ff_context.net.2",
        "transformer_blocks.3.ff.net.2",
        "transformer_blocks.18.ff.net.2",
        "transformer_blocks.6.ff_context.net.2",
        "context_embedder.token_refiner.refiner_blocks.0.ff.net.2",
        "transformer_blocks.17.ff_context.net.2",
        "transformer_blocks.23.ff_context.net.2",
        "transformer_blocks.18.ff_context.net.2",
        "transformer_blocks.10.norm1.linear",
        "transformer_blocks.8.norm1_context.linear",
        "transformer_blocks.9.norm1.linear",
        "transformer_blocks.3.norm1.linear",
        "transformer_blocks.9.norm1_context.linear",
        "layers.6.self_attn.q_proj",
        "layers.8.self_attn.q_proj",
        "layers.7.self_attn.q_proj",
        "layers.16.self_attn.q_proj",
        "transformer_blocks.29.norm1_context.linear",
        "transformer_blocks.28.norm1.linear",
        "layers.18.self_attn.q_proj",
        "transformer_blocks.28.norm1_context.linear",
        "transformer_blocks.30.norm1.linear",
        "transformer_blocks.29.norm1.linear",
        "layers.17.self_attn.q_proj",
        "transformer_blocks.27.norm1.linear",
        "transformer_blocks.31.norm1.linear",
        "transformer_blocks.27.norm1_context.linear",
        "transformer_blocks.31.norm1_context.linear",
        "layers.15.self_attn.o_proj",
        "layers.17.self_attn.o_proj",
        "layers.18.self_attn.o_proj",
        "layers.16.self_attn.o_proj",
        "layers.12.self_attn.q_proj",
        "layers.26.self_attn.o_proj",
        "transformer_blocks.42.norm1_context.linear",
        "layers.24.self_attn.o_proj",
        "layers.23.self_attn.o_proj",
        "layers.27.self_attn.o_proj",
        "layers.27.self_attn.q_proj",
        "layers.25.self_attn.o_proj",
        "layers.25.self_attn.q_proj",
        "layers.14.self_attn.q_proj",
        "layers.23.self_attn.q_proj",
        "transformer_blocks.46.norm1.linear",
        "layers.26.self_attn.q_proj",
        "layers.24.self_attn.q_proj",
        "layers.15.self_attn.q_proj",
        "layers.11.self_attn.q_proj",
        "transformer_blocks.45.norm1.linear",
        "transformer_blocks.46.norm1_context.linear",
        "layers.19.self_attn.q_proj",
        "transformer_blocks.52.norm1_context.linear",
        "layers.22.self_attn.q_proj",
        "layers.9.self_attn.q_proj",
        "transformer_blocks.53.norm1_context.linear",
        "transformer_blocks.45.norm1_context.linear",
        "layers.10.self_attn.q_proj",
        "layers.21.self_attn.q_proj",
        "layers.22.self_attn.o_proj",
        "layers.20.self_attn.q_proj",
        "transformer_blocks.48.norm1.linear",
        "layers.13.self_attn.q_proj",
    ]
    for k, v in tqdm(all_modules.items()):
        v.preprocess_weights()
        if k in to_device_list:
            v.move_weights_to_device()
    torch.set_grad_enabled(False)  # Disables autograd overhead
    prompt = "A magical forest with glowing trees at dusk"

    # Generate
    result = pipe(
        prompt=prompt,
        num_frames=1,  # number of frames
        num_inference_steps=1,  # trade quality for speed
        output_type="latent",  # Skip VAE decoding
    )
    DispatchManager.save_stats_to_file("hunyuan_video_timing_stats.csv")
    # Latents are in result.frames - no video conversion needed when skipping VAE
    print(f"Generated latent shape: {result.frames[0].shape}")
