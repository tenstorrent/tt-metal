# Grid Sample Split Reader Performance Analysis

This branch contains a comprehensive performance analysis setup for testing the grid sample operation with split reader enabled vs disabled across different architectures.

## Overview

This analysis tests grid sample performance across:
- **Channels**: 32, 64, 96, 128, 160, 192, 224, 256
- **Grid Types**: Regular grid vs Precomputed grid
- **Batch Output Channels**: True/False
- **Split Reader**: ON vs OFF

## Files Included

### Analysis Scripts
- `analyze_grid_sample_perf.py` - Main performance data extraction and analysis
- `final_comparison_analysis.py` - Creates side-by-side comparison table
- `grid_sample_perf_test.py` - Alternative test runner (if needed)

### Data Files
- `grid_sample_raw_data_split_reader_off.json` - Baseline performance data
- `grid_sample_performance_split_reader_off.csv` - Processed baseline results
- `grid_sample_split_reader_comparison_final.csv` - Final comparison table

### Test Files
- `test_grid_sample_sharding_debug.py` - Main test file with parametrized tests

### Code Configuration
- `ttnn/cpp/ttnn/operations/pool/grid_sample/device/grid_sample_program_factory.cpp` - Split reader configuration (line 28)

## Quick Start Instructions

### 1. Build with Profiler
```bash
./build_metal.sh -p
```

### 2. Test Split Reader OFF
```bash
# Set split reader to false in grid_sample_program_factory.cpp line 28:
# constexpr bool enable_split_reader = false;

# Rebuild
./build_metal.sh -p

# Run tests
TT_METAL_CORE_GRID_OVERRIDE_TODEPRECATE="4,3" python -m tracy -r -m pytest test_grid_sample_sharding_debug.py::test_grid_sample_sharded_grid_batching -v
```

### 3. Test Split Reader ON
```bash
# Set split reader to true in grid_sample_program_factory.cpp line 28:
# constexpr bool enable_split_reader = true;

# Rebuild
./build_metal.sh -p

# Run tests
TT_METAL_CORE_GRID_OVERRIDE_TODEPRECATE="4,3" python -m tracy -r -m pytest test_grid_sample_sharding_debug.py::test_grid_sample_sharded_grid_batching -v
```

### 4. Generate Analysis
```bash
python final_comparison_analysis.py
```

## Expected Results Structure

The CSV files generated by Tracy profiler will be in:
```
./generated/profiler/reports/YYYY_MM_DD_HH_MM_SS/ops_perf_results_YYYY_MM_DD_HH_MM_SS.csv
```

## Key Performance Insights from x86 Architecture

### Regular Grid Operations (precomputed=False):
- **Consistent ~49.7% improvement** with split reader ON
- Split reader OFF: ~1652-1658 μs
- Split reader ON: ~832-834 μs

### Precomputed Grid Operations (precomputed=True):
- **Performance benefit decreases as channel count increases**
- 32-64 channels: ~49% improvement
- 128 channels: ~36% improvement
- 192 channels: ~14% improvement
- 256 channels: **-6.3% degradation**

## Architecture Comparison Notes

When testing on different architectures, pay attention to:
1. **Scaling behavior** - Does the channel count threshold change?
2. **Baseline performance** - Are absolute timings different?
3. **Split reader effectiveness** - Does the crossover point shift?
4. **Memory architecture impact** - How do different memory subsystems affect results?

## Files to Modify for Your Architecture

1. Update CSV file paths in `final_comparison_analysis.py` (lines 18-26)
2. Ensure proper core grid override for your hardware in test commands
3. Adjust timeout values if needed for slower/faster hardware

## Test Parameters Covered

All combinations of:
- **Input shapes**: (1, C, 48, 160) where C ∈ {32, 64, 96, 128, 160, 192, 224, 256}
- **Grid shapes**: (1, 1, 2000*8, 2) and (1, 1, 2000, 48)
- **Grid batching factors**: 8 and 1
- **Use precomputed grid**: True/False
- **Batch output channels**: True/False
- **Split reader**: ON/OFF

## Troubleshooting

### Common Issues:
1. **CSV parsing errors**: Check column names in Tracy output files
2. **Empty results**: Verify test execution completed successfully
3. **Build failures**: Ensure proper environment setup for profiler builds
4. **Memory issues**: Monitor memory usage during large channel tests

### Debug Commands:
```bash
# Check available ops in CSV
python -c "import pandas as pd; df=pd.read_csv('path/to/ops_file.csv'); print(df['OP CODE'].unique())"

# Verify test discovery
pytest --collect-only test_grid_sample_sharding_debug.py::test_grid_sample_sharded_grid_batching
```

## Contact

This analysis was created for cross-architecture performance comparison. Compare your results with the baseline x86 results to understand architectural differences in split reader effectiveness.
