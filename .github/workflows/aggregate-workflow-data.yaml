name: Aggregate Workflow Data
on:
  push:
    branches:
      - mchiou/0-update-aggregate-workflow
  schedule:
    - cron: '0 * * * *' # every hour
  workflow_dispatch:
    inputs:
      days:
        description: 'Number of days to look back for workflow runs'
        required: false
        default: '15'
      clear-cache:
        description: 'Clear existing cache and fetch fresh data'
        required: false
        default: false
        type: boolean

jobs:
  fetch-data:
    runs-on: ubuntu-latest
    outputs:
      cache-path: ${{ steps.fetch.outputs.cache-path }}
      workflow_configs: ${{ steps.set-configs.outputs.workflow_configs }}
    steps:
      - uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 #@v3

      - name: Install fetch-workflow-data dependencies
        shell: bash
        working-directory: .github/actions/fetch-workflow-data
        run: npm install

      - name: Set workflow configs
        id: set-configs
        run: |
          cat << 'EOF' > workflow_configs.json
          [
            {"display": "All post-commit tests", "wkflw_name": "All post-commit tests"},
            {"display": "Blackhole post-commit tests", "wkflw_name": "Blackhole post-commit tests"},
            {"display": "(Blackhole) prefix", "wkflw_prefix": "(Blackhole)"},
            {"display": "(TG) prefix", "wkflw_prefix": "(TG)"},
            {"display": "Galaxy prefix", "wkflw_prefix": "Galaxy"},
            {"display": "(T3K) prefix", "wkflw_prefix": "(T3K)"},
            {"display": "(Single-card) prefix", "wkflw_prefix": "(Single-card)"},
            {"display": "Nightly tt-metal L2 tests", "wkflw_name": "Nightly tt-metal L2 tests"},
            {"display": "ttnn - Run sweeps", "wkflw_name": "ttnn - Run sweeps"},
            {"display": "vLLM nightly tests", "wkflw_name": "vLLM nightly tests"},
            {"display": "Metal microbenchmarks", "wkflw_name": "metal - Run microbenchmarks"},
            {"display": "APC nightly debug run", "wkflw_name": "apc nightly debug run"}
          ]
          EOF
          echo "workflow_configs<<EOF" >> $GITHUB_OUTPUT
          cat workflow_configs.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Try to restore cache
        if: ${{ github.event.inputs.clear-cache != 'true' }}
        uses: actions/cache/restore@5a3ec84eff668545956fd18022155c47e93e2684 #@v4
        with:
          path: ${{ github.workspace }}/workflow-data.json
          key: metal-workflow-data-${{ github.ref }}-${{ github.run_id }}
          restore-keys: |
            metal-workflow-data-${{ github.ref }}-
            metal-workflow-data-

      - name: Fetch workflow data
        id: fetch
        uses: ./.github/actions/fetch-workflow-data
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          cache-path: ${{ github.workspace }}/workflow-data.json
          days: ${{ github.event.inputs.days || 15 }}
          workflow_configs: ${{ steps.set-configs.outputs.workflow_configs }}
          clear-cache: 'true'

      - name: Save to rolling cache indices
        uses: actions/cache/save@5a3ec84eff668545956fd18022155c47e93e2684 #@v4
        with:
          path: ${{ github.workspace }}/workflow-data.json
          key: metal-workflow-data-${{ github.ref }}-${{ github.run_id }}

      - name: Upload complete workflow data
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 #@v4
        with:
          name: workflow-data-complete
          path: ${{ github.workspace }}/workflow-data.json
          retention-days: 1

      - name: Upload filtered workflow data for analysis
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 #@v4
        with:
          name: workflow-data
          path: ${{ github.workspace }}/workflow-data-upload.json
          retention-days: 1

  analyze-data:
    needs: fetch-data
    if: ${{ always() && needs.fetch-data.result == 'success' }}
    runs-on: ubuntu-latest
    outputs:
      failed_workflows: ${{ steps.analyze.outputs.failed_workflows }}
      report: ${{ steps.analyze.outputs.report }}
    steps:
      - uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 #@v3
      - name: Install analyze-workflow-data dependencies
        shell: bash
        working-directory: .github/actions/analyze-workflow-data
        run: npm install
      - name: Download workflow data
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 #@v4
        with:
          name: workflow-data
          path: ${{ github.workspace }}
      - name: Analyze workflow data
        id: analyze
        uses: ./.github/actions/analyze-workflow-data
        with:
          days: ${{ github.event.inputs.days || 15 }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          cache-path: ${{ github.workspace }}/workflow-data-upload.json
          workflow_configs: ${{ needs.fetch-data.outputs.workflow_configs }}

  handle-failures:
    needs: analyze-data
    if: ${{ needs.analyze-data.outputs.failed_workflows != '' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 #@v3

      - name: Install post-slack-message dependencies
        shell: bash
        working-directory: .github/actions/post-slack-message
        run: npm install

      - name: Send Slack Notification
        uses: ./.github/actions/post-slack-message
        with:
          slack-webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          message-title: "ðŸš¨ Workflow Failures Detected"
          message-data: |
            {
              "failed_workflows": ${{ needs.analyze-data.outputs.failed_workflows }},
              "repository": "${{ github.repository }}",
              "branch": "${{ github.ref_name }}",
              "workflow_run": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }
