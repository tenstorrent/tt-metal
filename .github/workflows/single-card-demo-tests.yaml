name: "(Single-card) Demo tests"

on:
  workflow_dispatch:
    inputs:
      requested-models:
        description: "List of requested models as JSON array, for example: [\"resnet\", \"sdxl\"]. Default is 'all'"
        default: "all"
        type: string
      run-perf-tests:
        description: "Run perf variants"
        type: boolean
        default: true
  schedule:
    - cron: "0 13,18 * * 0,1,2,3,4,5,6" # frequency of functional models
    - cron: "0 5 * * 1,3,6" # frequency of perf models

run-name: "(Single-card) Demo tests${{ (inputs.run-perf-tests || (github.event_name != 'workflow_dispatch' && github.event.schedule == '0 5 * * 1,3,6')) && ' (with perf runs)' || ' (no perf)' }}"
jobs:
  build-artifact:
    uses: ./.github/workflows/build-artifact.yaml
    permissions:
      packages: write
    secrets: inherit
    with:
      build-wheel: true
      version: 22.04
  single-card-demo-tests:
    needs: build-artifact
    secrets: inherit
    uses: ./.github/workflows/single-card-demo-tests-impl.yaml
    with:
      docker-image: ${{ needs.build-artifact.outputs.dev-docker-image }}
      build-artifact-name: ${{ needs.build-artifact.outputs.build-artifact-name }}
      wheel-artifact-name: ${{ needs.build-artifact.outputs.wheel-artifact-name }}
      arch: wormhole_b0
      requested-models: ${{ inputs.requested-models || 'all' }}
      # Using || true after is dangerous since that will always be passed in if first value is falsy
      # which it can be if inputs.run-perf-tests isn't clicked. So, scope the default true to only
      # when we're not using workflow_dispatch and can't possibly have an input anyway
      run-perf-tests: ${{ inputs.run-perf-tests || (github.event_name != 'workflow_dispatch' && github.event.schedule == '0 5 * * 1,3,6') }}
