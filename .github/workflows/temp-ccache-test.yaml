name: "[temp] CCache cross-commit test"

on:
  workflow_dispatch:

jobs:
  build-artifact-1:
    name: Build Artifact 1
    uses: ./.github/workflows/build-artifact.yaml
    permissions:
      packages: write
    secrets: inherit
    with:
      build-type: Release
      build-wheel: true
      tracy: true
      version: "22.04"
      name-suffix: "run1"

  build-artifact-2:
    name: Build Artifact 2
    uses: ./.github/workflows/build-artifact.yaml
    permissions:
      packages: write
    secrets: inherit
    with:
      build-type: Release
      build-wheel: true
      tracy: true
      version: "22.04"
      name-suffix: "run2"

  ttnn-ccache-test-run1:
    environment: ccache-kernel-redis-test
    needs: build-artifact-1
    name: TTNN CCache Test - Run 1 (Build Artifact 1)
    runs-on: tt-ubuntu-2204-N150-stable
    container:
      image: ${{ needs.build-artifact-1.outputs.dev-docker-image }}
      env:
        TT_METAL_HOME: /work
        TT_METAL_RUNTIME_ROOT: /work
        LD_LIBRARY_PATH: /work/build/lib
        PYTHONPATH: /work
        ARCH_NAME: wormhole_b0
        CCACHE_BASEDIR: /
        CCACHE_TEMPDIR: /tmp/ccache
        CCACHE_NOINODECACHE: 1
        CCACHE_REMOTE_ONLY: 1
        CCACHE_NOHASHDIR: "true"
        TT_METAL_CCACHE_KERNEL_SUPPORT: 1
        TT_METAL_LOGGER_LEVEL: Debug
        TT_METAL_LOGGER_TYPES: BuildKernels
        TT_METAL_LOG_KERNELS_COMPILE_COMMANDS: 1
      volumes:
        - ${{ github.workspace }}/docker-job:/work
        - /dev/hugepages-1G:/dev/hugepages-1G
        - /home/ubuntu/.ccache-ci:/github/home/.ccache
      options: "--device /dev/tenstorrent"
    defaults:
      run:
        shell: bash
        working-directory: /work
    steps:
      - name: Check Redis credentials
        if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false }}
        run: |
          if [ -z "${{ secrets.REDIS_PASSWORD }}" ]; then
            echo "Redis password is missing. Did you forget 'secrets: inherit'?"
            exit 1
          fi
          CCACHE_REMOTE_STORAGE="redis://${{ vars.REDIS_USER }}:${{ secrets.REDIS_PASSWORD }}@${{ vars.REDIS_HOST }}:${{ vars.REDIS_PORT }}/1|read-only=false"
          echo "CCACHE_REMOTE_STORAGE=${CCACHE_REMOTE_STORAGE}" >> $GITHUB_ENV
          echo "=== Redis Configuration ==="
          echo "REDIS_USER: ${{ vars.REDIS_USER }}"
          echo "REDIS_HOST: ${{ vars.REDIS_HOST }}"
          echo "REDIS_PORT: ${{ vars.REDIS_PORT }}"
          echo "REDIS_IS_READONLY: false (hardcoded)"
          echo "Using database: 1 (for kernel cache testing)"

      - name: Create ccache tmpdir
        run: mkdir -p /tmp/ccache

      - name: Test Redis auth on build pod
        if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false }}
        run: |
          echo "=== Testing Redis Auth on Build Pod ==="
          REDIS_HOST="${{ vars.REDIS_HOST }}"
          REDIS_PORT="${{ vars.REDIS_PORT }}"
          REDIS_PASS="${{ secrets.REDIS_PASSWORD }}"
          REDIS_USER="${{ vars.REDIS_USER }}"

          echo "Build pod Redis connection details:"
          echo "Host: ${REDIS_HOST}"
          echo "Port: ${REDIS_PORT}"
          echo "User: ${REDIS_USER}"
          echo "Password length: ${#REDIS_PASS} characters"
          echo "Password starts with: ${REDIS_PASS:0:3}..."
          echo "Hostname: $(hostname)"
          echo "Pod IP: $(hostname -i 2>/dev/null || echo 'unknown')"

          if [ -n "$REDIS_HOST" ] && [ -n "$REDIS_PASS" ]; then
            echo "=== Testing Redis auth methods on build pod ==="

            # Test basic connectivity
            echo "1. Testing basic connectivity..."
            if timeout 5 bash -c "echo > /dev/tcp/$REDIS_HOST/$REDIS_PORT"; then
              echo "âœ… Network connectivity to Redis works"
            else
              echo "âŒ Network connectivity to Redis failed"
              exit 1
            fi

            # Install tools for Redis testing
            echo "2. Installing Redis testing tools..."
            if ! command -v redis-cli &> /dev/null; then
              echo "Installing redis-cli..."
              apt-get update -qq && apt-get install -y -qq redis-tools 2>&1 | grep -v "^Selecting\|^Preparing\|^Unpacking" || true
            fi

            # Test auth with redis-cli
            echo "3. Testing Redis auth with redis-cli..."
            if [ -n "$REDIS_USER" ]; then
              echo "Testing with user and password..."
              if redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" --user "$REDIS_USER" --pass "$REDIS_PASS" ping 2>&1 | grep -q "PONG"; then
                echo "âœ… User+password auth works on build pod"
                AUTH_METHOD="--user $REDIS_USER --pass $REDIS_PASS"
              else
                echo "âŒ User+password auth failed on build pod"
              fi
            fi

            if [ -z "${AUTH_METHOD:-}" ]; then
              echo "Testing with password only..."
              if redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" -a "$REDIS_PASS" ping 2>&1 | grep -q "PONG"; then
                echo "âœ… Password-only auth works on build pod"
                AUTH_METHOD="-a $REDIS_PASS"
              else
                echo "âŒ Password-only auth failed on build pod"
                echo "Redis response:"
                redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" -a "$REDIS_PASS" ping 2>&1
              fi
            fi

            # Test writing to default DB (used by build)
            if [ -n "${AUTH_METHOD:-}" ]; then
              echo "4. Testing write to default DB (used by build ccache)..."
              BUILD_TEST_KEY="build-test-$(date +%s)"
              BUILD_TEST_VALUE="build-pod-test-$(hostname)"

              if redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" -n 1 $AUTH_METHOD SET "$BUILD_TEST_KEY" "$BUILD_TEST_VALUE" EX 300 2>&1 | grep -q "OK"; then
                echo "âœ… Successfully wrote test key to Redis default DB from build pod"

                # Verify we can read it back
                READ_VALUE=$(redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" -n 1 $AUTH_METHOD GET "$BUILD_TEST_KEY" 2>/dev/null || echo "")
                if [ "$READ_VALUE" = "$BUILD_TEST_VALUE" ]; then
                  echo "âœ… Successfully read back test key from Redis default DB"
                else
                  echo "âš ï¸  Read back different value: $READ_VALUE"
                fi

                # Clean up
                redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" -n 1 $AUTH_METHOD DEL "$BUILD_TEST_KEY" >/dev/null 2>&1
              else
                echo "âŒ Failed to write test key to Redis default DB from build pod"
                redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" -n 1 $AUTH_METHOD SET "$BUILD_TEST_KEY" "$BUILD_TEST_VALUE" EX 300
              fi
            else
              echo "âŒ No working authentication method found on build pod"
            fi

          else
            echo "âš ï¸  Redis credentials not available on build pod"
          fi


      - name: ðŸ§¬ Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          path: docker-job

      - name: Setup Job (Build 1 - Original Commit)
        uses: ./docker-job/.github/actions/setup-job
        with:
          build-artifact-name: ${{ needs.build-artifact-1.outputs.build-artifact-name }}
          wheel-artifact-name: ${{ needs.build-artifact-1.outputs.wheel-artifact-name }}

      - name: Initial ccache setup
        run: |
          echo "========================================="
          echo "=== Initial ccache configuration ===="
          echo "========================================="
          echo "Current commit: $(git rev-parse --short=10 HEAD)"
          git rev-parse HEAD > /tmp/ttnn_commit.txt
          echo ""
          echo "=== TTNN RUN 1: Initial ccache configuration ===="
          ccache --show-config | head -40
          echo ""
          echo "=== Redis Remote Storage Configuration ==="
          echo "CCACHE_REMOTE_STORAGE: ${CCACHE_REMOTE_STORAGE:-not set}"
          echo "CCACHE_REMOTE_ONLY: ${CCACHE_REMOTE_ONLY:-not set}"
          echo "CCACHE_TEMPDIR: ${CCACHE_TEMPDIR:-not set}"
          echo ""
          echo "=== Git commit info ==="
          echo "Git commit: $(git rev-parse HEAD)"
          echo "Git commit short: $(git rev-parse --short=10 HEAD)"          git rev-parse HEAD > /tmp/ttnn_original_commit.txt          echo ""
          echo "=== Zeroing ccache stats ==="
          ccache -z
          echo "=== Initial ccache stats ==="
          ccache -s

      - name: Clear kernel caches to force fresh compilation
        run: |
          echo "=== Clearing all kernel caches to force JIT compilation ==="
          rm -rf /tmp/ttnn_cache/ /tmp/tt_metal_cache/ || true
          rm -rf ~/.cache/tt-metal-cache/ /tmp/tt-metal-cache/ || true
          find /work -name "*.elf" -path "*/kernels/*" -delete 2>/dev/null || true
          find /work -name "*.bin" -path "*/kernels/*" -delete 2>/dev/null || true
          echo "Kernel caches cleared"

      - name: Run TTNN tests (First run)
        timeout-minutes: 30
        env:
          CCACHE_DEBUG: "true"
          CCACHE_LOGFILE: /tmp/ttnn_ccache_run1.log
        run: |
          echo "========================================="
          echo "=== TTNN RUN 1: Populate cache from older commit ===="
          echo "=========================================="
          pytest --timeout 300 tests/ttnn/unit_tests/operations/matmul/test_matmul.py -k "test_tutorial_matmul or test_matmul_1d or test_matmul_2d" -xv 2>&1 | tee /tmp/ttnn_first_run.log

      - name: Capture ccache hash keys after Run 1
        run: |
          echo "=== TTNN RUN 1: Capturing ccache hash information ==="
          echo ""
          echo "=== Checking if ccache debug log was created ==="
          ls -lh /tmp/ttnn_ccache_run1.log 2>&1 || echo "âŒ Log file not found at /tmp/ttnn_ccache_run1.log"
          echo ""
          echo "=== Checking ccache config (debug settings) ==="
          ccache --show-config | grep -i "debug\|log" || echo "No debug config found"
          echo ""
          echo "=== Looking for ccache logs in common locations ==="
          find /tmp -name "*ccache*.log" -type f 2>/dev/null | head -10 || echo "No ccache log files found in /tmp"
          find ~/.cache/ccache -name "*.log" -type f 2>/dev/null | head -10 || echo "No log files in ~/.cache/ccache"
          echo ""
          echo "=== Analyzing ccache debug log for cache keys ==="
          if [ -f /tmp/ttnn_ccache_run1.log ]; then
            echo "âœ… Log file exists!"
            echo "Log size: $(wc -l /tmp/ttnn_ccache_run1.log | awk '{print $1}') lines"
            echo ""
            echo "=== First 50 lines of ccache debug log ==="
            head -50 /tmp/ttnn_ccache_run1.log
            echo ""
            echo "=== Result keys (ccache primary hash) - first 30 ==="
            grep -E "(Result key|Primary hash|Hash key)" /tmp/ttnn_ccache_run1.log | head -30 | tee /tmp/ttnn_run1_ccache_keys.txt || true
            echo ""
            echo "=== Files included in hash - sample ==="
            grep -E "Hashing.*\.(cpp|hpp|h):" /tmp/ttnn_ccache_run1.log | head -20 || true
            echo ""
            echo "=== Compiler command lines - sample ==="
            grep -E "Command line|Compiler:" /tmp/ttnn_ccache_run1.log | head -10 || true
          else
            echo "âš ï¸  ccache debug log not found - CCACHE_DEBUG and CCACHE_LOGFILE may not be working"
            echo "This could mean:"
            echo "  1. Ccache is not being invoked during kernel compilation"
            echo "  2. Environment variables are not propagated to subprocess"
            echo "  3. Ccache debug logging is not enabled properly"
          fi
          echo ""
          echo "=== Git commit information ==="
          git rev-parse HEAD | tee /tmp/ttnn_run1_git_commit.txt
          echo ""
          echo "=== Environment variables affecting cache ==="
          env | grep -E "(TT_METAL|ARCH_NAME|CCACHE)" | sort | tee /tmp/ttnn_run1_env.txt

      - name: Analyze ccache after Run 1
        run: |
          echo "=== TTNN RUN 1: ccache statistics after test ==="
          ccache -s
          echo ""
          echo "=== Detailed ccache statistics (verbose) ==="
          ccache --print-stats --verbose 2>&1 | head -100
          echo ""
          echo "=== Kernel cache locations ==="
          echo "Checking ~/.cache/tt-metal-cache/:"
          find ~/.cache/tt-metal-cache/ -type f -name "*.elf" -o -name "*.bin" 2>/dev/null | wc -l || echo "0"
          echo ""
          echo "=== Redis Key Check ==="
          REDIS_HOST="${{ vars.REDIS_HOST }}"
          REDIS_PORT="${{ vars.REDIS_PORT }}"
          REDIS_PASS="${{ secrets.REDIS_PASSWORD }}"

          if [ -n "$REDIS_HOST" ] && [ -n "$REDIS_PASS" ]; then
            if ! command -v redis-cli &> /dev/null; then
              echo "Installing redis-cli..."
              apt-get update -qq && apt-get install -y -qq redis-tools 2>&1 | grep -v "^Selecting\|^Preparing\|^Unpacking" || true
            fi

            TOTAL_KEYS=$(redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" --no-auth-warning -a "$REDIS_PASS" DBSIZE 2>/dev/null | grep -oE '[0-9]+' || echo "0")
            echo "Total keys in Redis after TTNN Run 1: ${TOTAL_KEYS}"
          fi

  ttnn-ccache-test-run2:
    environment: ccache-kernel-redis-test
    needs: [build-artifact-2, ttnn-ccache-test-run1]
    name: TTNN CCache Test - Run 2 (Build Artifact 2)
    runs-on: tt-ubuntu-2204-N150-stable
    container:
      image: ${{ needs.build-artifact-2.outputs.dev-docker-image }}
      env:
        TT_METAL_HOME: /work
        TT_METAL_RUNTIME_ROOT: /work
        LD_LIBRARY_PATH: /work/build/lib
        PYTHONPATH: /work
        ARCH_NAME: wormhole_b0
        CCACHE_BASEDIR: /
        CCACHE_TEMPDIR: /tmp/ccache
        CCACHE_NOINODECACHE: 1
        CCACHE_REMOTE_ONLY: 1
        CCACHE_NOHASHDIR: "true"
        TT_METAL_CCACHE_KERNEL_SUPPORT: 1
        TT_METAL_LOGGER_LEVEL: Debug
        TT_METAL_LOGGER_TYPES: BuildKernels
        TT_METAL_LOG_KERNELS_COMPILE_COMMANDS: 1
      volumes:
        - ${{ github.workspace }}/docker-job:/work
        - /dev/hugepages-1G:/dev/hugepages-1G
        - /home/ubuntu/.ccache-ci:/github/home/.ccache
      options: "--device /dev/tenstorrent"
    defaults:
      run:
        shell: bash
        working-directory: /work
    steps:
      - name: Check Redis credentials
        if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false }}
        run: |
          if [ -z "${{ secrets.REDIS_PASSWORD }}" ]; then
            echo "Redis password is missing. Did you forget 'secrets: inherit'?"
            exit 1
          fi
          CCACHE_REMOTE_STORAGE="redis://${{ vars.REDIS_USER }}:${{ secrets.REDIS_PASSWORD }}@${{ vars.REDIS_HOST }}:${{ vars.REDIS_PORT }}/1|read-only=false"
          echo "CCACHE_REMOTE_STORAGE=${CCACHE_REMOTE_STORAGE}" >> $GITHUB_ENV
          echo "=== Redis Configuration ==="
          echo "REDIS_USER: ${{ vars.REDIS_USER }}"
          echo "REDIS_HOST: ${{ vars.REDIS_HOST }}"
          echo "REDIS_PORT: ${{ vars.REDIS_PORT }}"
          echo "REDIS_IS_READONLY: false (hardcoded)"
          echo "Using database: 1 (for kernel cache testing)"

      - name: Create ccache tmpdir
        run: mkdir -p /tmp/ccache

      - name: ðŸ§¬ Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          path: docker-job

      - name: Setup Build 2 artifacts before Run 2
        uses: ./docker-job/.github/actions/setup-job
        with:
          build-artifact-name: ${{ needs.build-artifact-2.outputs.build-artifact-name }}
          wheel-artifact-name: ${{ needs.build-artifact-2.outputs.wheel-artifact-name }}

      - name: Install diffoscope for build comparison
        run: |
          apt-get update -qq
          apt-get install -y -qq diffoscope 2>&1 | grep -v "^Selecting\|^Preparing\|^Unpacking" || true
          diffoscope --version

      - name: Compare build artifacts with diffoscope
        run: |
          echo "========================================="
          echo "=== Comparing Build Artifacts with diffoscope ===="
          echo "========================================="
          echo "Comparing build-artifact-1 (run1) vs build-artifact-2 (run2)"
          echo ""

          # Compare key binaries and libraries
          echo "=== Comparing hardware libraries ===="
          if [ -d "build/lib" ]; then
            for lib in build/lib/*.a build/lib/*.so; do
              if [ -f "$lib" ]; then
                echo "Analyzing: $lib"
                diffoscope --text /tmp/diffoscope_$(basename $lib).txt "$lib" "$lib" 2>&1 || true
                if [ -f "/tmp/diffoscope_$(basename $lib).txt" ]; then
                  echo "Differences in $(basename $lib):"
                  head -50 "/tmp/diffoscope_$(basename $lib).txt" || true
                fi
              fi
            done
          fi

          echo ""
          echo "=== Comparing TTNN shared libraries ===="
          if [ -d "ttnn/ttnn" ]; then
            for so in ttnn/ttnn/*.so; do
              if [ -f "$so" ]; then
                echo "Analyzing: $so"
                diffoscope --text /tmp/diffoscope_$(basename $so).txt "$so" "$so" 2>&1 || true
                if [ -f "/tmp/diffoscope_$(basename $so).txt" ]; then
                  echo "Differences in $(basename $so):"
                  head -50 "/tmp/diffoscope_$(basename $so).txt" || true
                fi
              fi
            done
          fi

          echo ""
          echo "Note: diffoscope detailed reports saved to /tmp/diffoscope_*.txt"

      - name: Clear kernel caches for Run 2
        run: |
          echo ""
          echo "========================================="
          echo "=== Preparing TTNN RUN 2: Clear kernel caches before testing with different build artifact ===="
          echo "=========================================="
          echo "Current build artifact: build-artifact-2"
          echo ""
          echo "Clearing kernel binaries to force recompilation (testing if different build affects cache)"
          rm -rf ~/.cache/tt-metal-cache/*/*/kernels/ /tmp/tt-metal-cache/*/*/kernels/ || true
          find /work -name "*.elf" -path "*/kernels/*" -delete 2>/dev/null || true
          find /work -name "*.bin" -path "*/kernels/*" -delete 2>/dev/null || true
          echo "Kernel binaries cleared, ccache intact"
          echo ""
          echo "=== Current ccache stats before Run 2 (different build artifact) ===="
          ccache -s

      - name: Run TTNN tests (Second run - different build artifact)
        timeout-minutes: 30
        env:
          CCACHE_DEBUG: "true"
          CCACHE_LOGFILE: /tmp/ttnn_ccache_run2.log
        run: |
          echo "=== Running TTNN unit tests (RUN 2 - different build artifact, testing if build differences affect cache) ===="
          pytest --timeout 300 tests/ttnn/unit_tests/operations/matmul/test_matmul.py -k "test_tutorial_matmul or test_matmul_1d or test_matmul_2d" -xv 2>&1 | tee /tmp/ttnn_second_run.log

      - name: Capture kernel hashes after Run 2 and compare
        run: |
          echo "=== TTNN RUN 2: Capturing ccache hash information ==="
          echo ""
          echo "=== Analyzing ccache debug log for cache keys ==="
          if [ -f /tmp/ttnn_ccache_run2.log ]; then
            echo "Log size: $(wc -l /tmp/ttnn_ccache_run2.log | awk '{print $1}') lines"
            echo ""
            echo "=== Result keys (ccache primary hash) - first 30 ==="
            grep -E "(Result key|Primary hash|Hash key)" /tmp/ttnn_ccache_run2.log | head -30 | tee /tmp/ttnn_run2_ccache_keys.txt || true
          fi
          echo ""
          echo "=== Git commit information ==="
          git rev-parse HEAD | tee /tmp/ttnn_run2_git_commit.txt
          echo ""
          echo "=== Build environment that affects cache keys ==="
          env | grep -E "(TT_METAL|ARCH_NAME|CCACHE)" | sort | tee /tmp/ttnn_run2_env.txt
          echo ""
          echo "=== Comparing Run 1 vs Run 2 ===="
          echo "--- Build artifacts (same commit, different builds) ---"
          echo "Run 1 build: build-artifact-1 (with suffix 'run1')"
          echo "Run 2 build: build-artifact-2 (with suffix 'run2')"
          echo "Testing if different build artifacts of same commit affect ccache keys..."
          echo ""

      - name: Analyze ccache after Run 2
        run: |
          echo "=== TTNN RUN 2: ccache statistics after test ==="
          ccache -s
          echo ""
          STATS=$(ccache -s)
          CACHE_HITS=$(echo "$STATS" | grep -i "cache hit" | grep -oE '[0-9]+' | head -1 || echo "0")
          CACHE_MISS=$(echo "$STATS" | grep -i "cache miss" | grep -oE '[0-9]+' | head -1 || echo "0")
          TOTAL=$((CACHE_HITS + CACHE_MISS))

          echo "=== Cache Hit Analysis ==="
          if [ "$TOTAL" -gt 0 ]; then
            HIT_RATE=$((CACHE_HITS * 100 / TOTAL))
            echo "Cache hit rate: ${HIT_RATE}% (${CACHE_HITS} hits / ${TOTAL} total)"

            if [ "$CACHE_HITS" -eq 0 ]; then
              echo "ðŸ”´ ZERO CACHE HITS - ccache not working for TTNN tests!"
            elif [ "$HIT_RATE" -gt 70 ]; then
              echo "âœ… Good cache hit rate!"
            else
              echo "âš ï¸  Lower than expected cache hit rate"
            fi
          else
            echo "â„¹ï¸  No cache activity detected"
          fi

      - name: Upload diffoscope comparison reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: diffoscope-reports-run2-${{ github.run_id }}
          path: /tmp/diffoscope_*.txt
          if-no-files-found: ignore
          retention-days: 14

  ttnn-ccache-test-run3:
    environment: ccache-kernel-redis-test
    needs: [build-artifact-1, ttnn-ccache-test-run1]
    name: TTNN CCache Test - Run 3 (Back to Build Artifact 1)
    runs-on: tt-ubuntu-2204-N150-stable
    container:
      image: ${{ needs.build-artifact-1.outputs.dev-docker-image }}
      env:
        TT_METAL_HOME: /work
        TT_METAL_RUNTIME_ROOT: /work
        LD_LIBRARY_PATH: /work/build/lib
        PYTHONPATH: /work
        ARCH_NAME: wormhole_b0
        CCACHE_BASEDIR: /
        CCACHE_TEMPDIR: /tmp/ccache
        CCACHE_NOINODECACHE: 1
        CCACHE_REMOTE_ONLY: 1
        CCACHE_NOHASHDIR: "true"
        TT_METAL_CCACHE_KERNEL_SUPPORT: 1
        TT_METAL_LOGGER_LEVEL: Debug
        TT_METAL_LOGGER_TYPES: BuildKernels
        TT_METAL_LOG_KERNELS_COMPILE_COMMANDS: 1
      volumes:
        - ${{ github.workspace }}/docker-job:/work
        - /dev/hugepages-1G:/dev/hugepages-1G
        - /home/ubuntu/.ccache-ci:/github/home/.ccache
      options: "--device /dev/tenstorrent"
    defaults:
      run:
        shell: bash
        working-directory: /work
    steps:
      - name: Check Redis credentials
        if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false }}
        run: |
          if [ -z "${{ secrets.REDIS_PASSWORD }}" ]; then
            echo "Redis password is missing. Did you forget 'secrets: inherit'?"
            exit 1
          fi
          CCACHE_REMOTE_STORAGE="redis://${{ vars.REDIS_USER }}:${{ secrets.REDIS_PASSWORD }}@${{ vars.REDIS_HOST }}:${{ vars.REDIS_PORT }}/1|read-only=false"
          echo "CCACHE_REMOTE_STORAGE=${CCACHE_REMOTE_STORAGE}" >> $GITHUB_ENV
          echo "=== Redis Configuration ==="
          echo "REDIS_USER: ${{ vars.REDIS_USER }}"
          echo "REDIS_HOST: ${{ vars.REDIS_HOST }}"
          echo "REDIS_PORT: ${{ vars.REDIS_PORT }}"
          echo "REDIS_IS_READONLY: false (hardcoded)"
          echo "Using database: 1 (for kernel cache testing)"

      - name: Create ccache tmpdir
        run: mkdir -p /tmp/ccache

      - name: ðŸ§¬ Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          path: docker-job

      - name: Setup Build 1 artifacts again before Run 3
        uses: ./docker-job/.github/actions/setup-job
        with:
          build-artifact-name: ${{ needs.build-artifact-1.outputs.build-artifact-name }}
          wheel-artifact-name: ${{ needs.build-artifact-1.outputs.wheel-artifact-name }}

      - name: Clear kernel caches for Run 3
        run: |
          echo ""
          echo "========================================="
          echo "=== Preparing TTNN RUN 3: Return to Build 1 artifacts ===="
          echo "========================================="
          echo "Current build artifact: build-artifact-1 (same as Run 1)"
          echo "Testing if returning to same build restores cache hits"
          echo ""
          echo "Clearing kernel binaries for third test"
          rm -rf ~/.cache/tt-metal-cache/*/*/kernels/ /tmp/tt-metal-cache/*/*/kernels/ || true
          find /work -name "*.elf" -path "*/kernels/*" -delete 2>/dev/null || true
          find /work -name "*.bin" -path "*/kernels/*" -delete 2>/dev/null || true
          echo ""
          echo "=== Current ccache stats before Run 3 (back to build-artifact-1) ===="
          ccache -s

      - name: Run TTNN tests (Third run - back to build artifact 1)
        timeout-minutes: 30
        env:
          CCACHE_DEBUG: "true"
          CCACHE_LOGFILE: /tmp/ttnn_ccache_run3.log
        run: |
          echo "=== Running TTNN unit tests (RUN 3 - back to build-artifact-1, should hit cache from Run 1) ===="
          pytest --timeout 300 tests/ttnn/unit_tests/operations/matmul/test_matmul.py -k "test_tutorial_matmul or test_matmul_1d or test_matmul_2d" -xv 2>&1 | tee /tmp/ttnn_third_run.log

      - name: Capture kernel hashes after Run 3 and final comparison
        run: |
          echo "=== TTNN RUN 3: Final ccache analysis and cross-commit comparison ==="
          echo ""
          echo "=== Analyzing ccache debug log for cache keys ==="
          if [ -f /tmp/ttnn_ccache_run3.log ]; then
            echo "Log size: $(wc -l /tmp/ttnn_ccache_run3.log | awk '{print $1}') lines"
            echo ""
            echo "=== Result keys (ccache primary hash) - first 30 ==="
            grep -E "(Result key|Primary hash|Hash key)" /tmp/ttnn_ccache_run3.log | head -30 | tee /tmp/ttnn_run3_ccache_keys.txt || true
          fi
          echo ""
          echo "=== Git commit information ==="
          git rev-parse HEAD | tee /tmp/ttnn_run3_git_commit.txt
          echo ""
          echo "=== Build environment that affects cache keys ==="
          env | grep -E "(TT_METAL|ARCH_NAME|CCACHE)" | sort | tee /tmp/ttnn_run3_env.txt
          echo ""
          echo "=== Final Comparison: Same Commit, Different Build Artifacts Test Results ===="
          echo "--- Git commits (all should be identical) ---"
          echo "Run 1 commit: $(cat /tmp/ttnn_run1_git_commit.txt)"
          echo "Run 2 commit: $(cat /tmp/ttnn_run2_git_commit.txt)"
          echo "Run 3 commit: $(cat /tmp/ttnn_run3_git_commit.txt)"

          echo ""
          echo "=== Sample from ccache debug log (cache decisions) ==="
          grep -E "(cache hit|cache miss|No such file|Result|Hash)" /tmp/ttnn_ccache_run3.log | head -30 || echo "No hit/miss lines found"

      - name: Analyze final ccache stats
        run: |
          echo "=== TTNN RUN 3: Final ccache statistics ==="
          ccache -s

      - name: Publish ccache summary
        run: |
          echo '## CCache TTNN Unit Tests Results' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo 'This test checks ccache behavior for TTNN unit tests using the same commit with different build artifacts. Tests whether kernel cache keys are affected by build artifact differences (name suffixes) when source code is identical.' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY

          STATS=$(ccache -s)
          echo '### Final CCache Stats (TTNN Run 3)' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$STATS" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          CACHE_HITS=$(echo "$STATS" | grep -i "cache hit" | grep -oE '[0-9]+' | head -1 || echo "0")
          CACHE_MISS=$(echo "$STATS" | grep -i "cache miss" | grep -oE '[0-9]+' | head -1 || echo "0")
          TOTAL=$((CACHE_HITS + CACHE_MISS))

          if [ "$TOTAL" -gt 0 ]; then
            HIT_RATE=$((CACHE_HITS * 100 / TOTAL))
            echo "- Cache hits: ${CACHE_HITS}" >> $GITHUB_STEP_SUMMARY
            echo "- Cache misses: ${CACHE_MISS}" >> $GITHUB_STEP_SUMMARY
            echo "- Hit rate: ${HIT_RATE}%" >> $GITHUB_STEP_SUMMARY
            echo '' >> $GITHUB_STEP_SUMMARY

            if [ "$HIT_RATE" -lt 30 ]; then
              echo 'ðŸ”´ **ISSUE CONFIRMED**: Very low cache hit rate indicates ccache is not working effectively for TTNN kernel compilation with Redis.' >> $GITHUB_STEP_SUMMARY
            elif [ "$HIT_RATE" -lt 70 ]; then
              echo 'ðŸŸ¡ **PARTIAL ISSUE**: Moderate cache hit rate suggests some cache busting may be occurring with Redis backend.' >> $GITHUB_STEP_SUMMARY
            else
              echo 'ðŸŸ¢ **GOOD**: High cache hit rate indicates ccache with Redis is working well for TTNN kernel compilation.' >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo 'âšª **NO DATA**: No cache activity detected. Redis remote storage may not be configured properly.' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload TTNN debug logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ttnn-ccache-debug-logs-${{ github.run_id }}
          path: |
            /tmp/ttnn_first_run.log
            /tmp/ttnn_second_run.log
            /tmp/ttnn_third_run.log
            /tmp/ttnn_ccache_run1.log
            /tmp/ttnn_ccache_run2.log
            /tmp/ttnn_ccache_run3.log
            /tmp/ttnn_run1_ccache_keys.txt
            /tmp/ttnn_run2_ccache_keys.txt
            /tmp/ttnn_run3_ccache_keys.txt
            /tmp/ttnn_run1_git_commit.txt
            /tmp/ttnn_run2_git_commit.txt
            /tmp/ttnn_run3_git_commit.txt
            /tmp/ttnn_run1_env.txt
            /tmp/ttnn_run2_env.txt
            /tmp/ttnn_run3_env.txt
          retention-days: 14

      - uses: tenstorrent/tt-metal/.github/actions/slack-report@main
        if: ${{ failure() }}
        with:
          slack_webhook_url: ${{ secrets.SLACK_METAL_INFRA_PIPELINE_STATUS_ALERT }}
          owner: U07ASPTGJTS

      - uses: tenstorrent/tt-metal/.github/actions/upload-artifact-with-job-uuid@main
        timeout-minutes: 10
        if: ${{ !cancelled() }}
        with:
          path: /work/generated/test_reports/
          prefix: "ttnn_test_reports_"
