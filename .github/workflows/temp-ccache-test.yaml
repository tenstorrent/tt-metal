name: "[temp] CCache test"

on:
  workflow_dispatch:

jobs:
  build-artifact:
    name: "ðŸ› ï¸ Build Release ubuntu 22.04"
    timeout-minutes: 100
    runs-on: tt-ubuntu-2204-large-stable
    environment: ${{ github.ref == 'refs/heads/main' && 'mainline' || '' }}
    outputs:
      build_artifact_name: ${{ steps.set_build_artifact_name.outputs.build_artifact_name }}
      wheel_artifact_name: ${{ steps.set_wheel_artifact_name.outputs.wheel_artifact_name }}
    container:
      image: harbor.ci.tenstorrent.net/ghcr.io/tenstorrent/tt-metal/tt-metalium/ubuntu-22.04-ci-build-amd64:d8ab8ee3fe4d35256b675bd6f47c0d48f7cada78
      env:
        CCACHE_REMOTE_ONLY: "true"
        CCACHE_TEMPDIR: /tmp/ccache
        TRACY_NO_INVARIANT_CHECK: 1
        TRACY_NO_ISA_EXTENSIONS: 1
      volumes:
        - ${{ github.workspace }}/docker-job:/work
        - /home/ubuntu/.ccache-ci:/github/home/.ccache
      options: >
        --group-add 1457
        --tmpfs /tmp
    defaults:
      run:
        shell: bash
        working-directory: /work
    steps:
      - name: Check Redis credentials
        if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false }}
        run: |
          if [ -z "${{ secrets.REDIS_PASSWORD }}" ]; then
            echo "Redis password is missing. Did you forget 'secrets: inherit'?"
            exit 1
          fi
          CCACHE_REMOTE_STORAGE="redis://${{ vars.REDIS_USER }}:${{ secrets.REDIS_PASSWORD }}@${{ vars.REDIS_HOST }}:${{ vars.REDIS_PORT }}|read-only=${{ vars.REDIS_IS_READONLY }}"
          echo "CCACHE_REMOTE_STORAGE=${CCACHE_REMOTE_STORAGE}" >> $GITHUB_ENV

      - name: â¬‡ï¸ Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 500
          fetch-tags: true
          path: docker-job

      - name: Create ccache tmpdir
        run: mkdir -p /tmp/ccache

      - name: Prepare ccache
        run: ccache -z

      - name: ðŸ”§ CMake configure
        run: |
          ./build_metal.sh --build-dir build --build-type Release --toolchain-path cmake/x86_64-linux-clang-17-libstdcpp-toolchain.cmake --build-metal-tests --build-ttnn-tests --build-programming-examples --enable-ccache --configure-only

      - name: ðŸ› ï¸ Compile
        run: cmake --build build --target install

      - name: ðŸ“¦ Package
        run: cmake --build build --target package

      - name: Publish ccache summary
        run: |
          echo '## Build CCache Summary' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ccache -s >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: 'Tar build files'
        run: |
          ARTIFACT_PATHS="ttnn/ttnn/*.so build/lib build/programming_examples build/test build/tools runtime"
          tar --zstd -cvf ttm_any.tar.zst $ARTIFACT_PATHS

      - name: Set build artifact name
        id: set_build_artifact_name
        run: |
          ARTIFACT_NAME="ttm-build-any-Release-${{ github.sha }}-${{ github.run_id }}"
          echo "build_artifact_name=${ARTIFACT_NAME}" >> $GITHUB_OUTPUT

      - name: â˜ï¸ Upload build tarball
        uses: actions/upload-artifact@v4
        timeout-minutes: 10
        with:
          name: ${{ steps.set_build_artifact_name.outputs.build_artifact_name }}
          path: /work/ttm_any.tar.zst
          if-no-files-found: error
          retention-days: 1

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Fix pip cache permissions
        run: |
          mkdir -p /github/home/.cache/pip
          chmod -R 777 /github/home/.cache

      - name: ðŸ Build wheel
        uses: pypa/cibuildwheel@v2.23.2
        env:
          CIBW_BUILD: "cp310-manylinux_x86_64*"
          CIBW_SKIP: "*-musllinux_*"
          CIBW_BUILD_FRONTEND: build
          CIBW_ENVIRONMENT: >-
            CCACHE_REMOTE_ONLY=true
            CCACHE_TEMPDIR=/tmp/ccache
            CCACHE_REMOTE_STORAGE=${{ env.CCACHE_REMOTE_STORAGE }}
            CIBW_ENABLE_TRACY=ON
            CIBW_BUILD_TYPE=Release
          CIBW_BEFORE_BUILD: "mkdir -p /tmp/ccache && ccache -z && ccache -p"
          CIBW_BEFORE_TEST: ccache -s
          CIBW_TEST_COMMAND: 'python -c "import ttnn"'
          CIBW_MANYLINUX_X86_64_IMAGE: harbor.ci.tenstorrent.net/ghcr.io/tenstorrent/tt-metal/tt-metalium/manylinux-amd64:4b5109cda67b90f295ef687f30d1a759d6b42075

      - name: Set wheel artifact name
        id: set_wheel_artifact_name
        run: |
          ARTIFACT_NAME="ttnn-dist-cp310-Release-${{ github.sha }}-${{ github.run_id }}"
          echo "wheel_artifact_name=${ARTIFACT_NAME}" >> $GITHUB_OUTPUT

      - name: â˜ï¸ Upload wheel
        uses: actions/upload-artifact@v4
        timeout-minutes: 10
        with:
          name: ${{ steps.set_wheel_artifact_name.outputs.wheel_artifact_name }}
          path: wheelhouse
          if-no-files-found: error
          retention-days: 1

  ttnn-ccache-test:
    needs: build-artifact
    name: TTNN CCache Test (3 runs on same machine)
    runs-on: tt-ubuntu-2204-N150-stable
    environment: ${{ github.ref == 'refs/heads/main' && 'mainline' || '' }}
    container:
      image: harbor.ci.tenstorrent.net/ghcr.io/tenstorrent/tt-metal/tt-metalium/ubuntu-22.04-dev-amd64:d8ab8ee3fe4d35256b675bd6f47c0d48f7cada78
      env:
        TT_METAL_HOME: /work
        TT_METAL_RUNTIME_ROOT: /work
        LD_LIBRARY_PATH: /work/build/lib
        PYTHONPATH: /work
        ARCH_NAME: wormhole_b0
        CCACHE_REMOTE_ONLY: "false"
        CCACHE_TEMPDIR: /tmp/ccache
        TT_METAL_CCACHE_KERNEL_SUPPORT: 1
        TT_METAL_LOGGER_LEVEL: Debug
        TT_METAL_LOGGER_TYPES: BuildKernels
        TT_METAL_LOG_KERNELS_COMPILE_COMMANDS: 1
      volumes:
        - ${{ github.workspace }}/docker-job:/work
        - /dev/hugepages-1G:/dev/hugepages-1G
        - /home/ubuntu/.ccache-ci:/github/home/.ccache
      options: "--device /dev/tenstorrent"
    defaults:
      run:
        shell: bash
        working-directory: /work
    steps:
      - name: Check Redis credentials
        if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false }}
        run: |
          if [ -z "${{ secrets.REDIS_PASSWORD }}" ]; then
            echo "Redis password is missing. Did you forget 'secrets: inherit'?"
            exit 1
          fi
          CCACHE_REMOTE_STORAGE="redis://${{ vars.REDIS_USER }}:${{ secrets.REDIS_PASSWORD }}@${{ vars.REDIS_HOST }}:${{ vars.REDIS_PORT }}|read-only=${{ vars.REDIS_IS_READONLY }}"
          echo "CCACHE_REMOTE_STORAGE=${CCACHE_REMOTE_STORAGE}" >> $GITHUB_ENV

      - name: Create ccache tmpdir
        run: mkdir -p /tmp/ccache

      - name: ðŸ§¬ Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          path: docker-job

      - name: ðŸ“¦ Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build-artifact.outputs.build_artifact_name }}
          path: docker-job

      - name: ðŸ“‚ Extract Build Files
        working-directory: docker-job
        run: tar --zstd -xf ttm_any.tar.zst

      - name: ðŸ§ª Download Python Wheel
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build-artifact.outputs.wheel_artifact_name }}
          path: docker-job

      - name: ðŸ’¿ Install Wheel
        working-directory: docker-job
        run: |
          WHEEL_FILENAME=$(ls -1 *.whl)
          echo "ðŸ“¦ Installing $WHEEL_FILENAME"
          pip3 install "$WHEEL_FILENAME"

      - name: Initial ccache configuration and stats
        run: |
          echo "=== TTNN RUN 1: Initial ccache configuration ==="
          ccache --show-config | head -40
          echo ""
          echo "=== Redis Remote Storage Configuration ==="
          echo "CCACHE_REMOTE_STORAGE: ${CCACHE_REMOTE_STORAGE:-not set}"
          echo "CCACHE_REMOTE_ONLY: ${CCACHE_REMOTE_ONLY:-not set}"
          echo "CCACHE_TEMPDIR: ${CCACHE_TEMPDIR:-not set}"
          echo ""
          echo "=== Git commit info ==="
          echo "Git commit: $(git rev-parse HEAD)"
          echo "Git commit short: $(git rev-parse --short=10 HEAD)"
          echo ""
          echo "=== Zeroing ccache stats ==="
          ccache -z
          echo "=== Initial ccache stats ==="
          ccache -s

      - name: Clear kernel caches to force fresh compilation
        run: |
          echo "=== Clearing all kernel caches to force JIT compilation ==="
          rm -rf /tmp/ttnn_cache/ /tmp/tt_metal_cache/ || true
          rm -rf ~/.cache/tt-metal-cache/ /tmp/tt-metal-cache/ || true
          find /work -name "*.elf" -path "*/kernels/*" -delete 2>/dev/null || true
          find /work -name "*.bin" -path "*/kernels/*" -delete 2>/dev/null || true
          echo "Kernel caches cleared"

      - name: Run TTNN tests (First run)
        timeout-minutes: 30
        env:
          CCACHE_DEBUG: "true"
          CCACHE_LOGFILE: /tmp/ttnn_ccache_run1.log
        run: |
          echo "========================================="
          echo "=== TTNN RUN 1: First ccache population ===="
          echo "========================================="
          pytest -n auto --timeout 300 tests/ttnn/unit_tests/operations/matmul -xv -m "not disable_fast_runtime_mode" 2>&1 | tee /tmp/ttnn_first_run.log

      - name: Capture ccache hash keys after Run 1
        run: |
          echo "=== TTNN RUN 1: Capturing ccache hash information ==="
          echo ""
          echo "=== Checking if ccache debug log was created ==="
          ls -lh /tmp/ttnn_ccache_run1.log 2>&1 || echo "âŒ Log file not found at /tmp/ttnn_ccache_run1.log"
          echo ""
          echo "=== Checking ccache config (debug settings) ==="
          ccache --show-config | grep -i "debug\|log" || echo "No debug config found"
          echo ""
          echo "=== Looking for ccache logs in common locations ==="
          find /tmp -name "*ccache*.log" -type f 2>/dev/null | head -10 || echo "No ccache log files found in /tmp"
          find ~/.cache/ccache -name "*.log" -type f 2>/dev/null | head -10 || echo "No log files in ~/.cache/ccache"
          echo ""
          echo "=== Analyzing ccache debug log for cache keys ==="
          if [ -f /tmp/ttnn_ccache_run1.log ]; then
            echo "âœ… Log file exists!"
            echo "Log size: $(wc -l /tmp/ttnn_ccache_run1.log | awk '{print $1}') lines"
            echo ""
            echo "=== First 50 lines of ccache debug log ==="
            head -50 /tmp/ttnn_ccache_run1.log
            echo ""
            echo "=== Result keys (ccache primary hash) - first 30 ==="
            grep -E "(Result key|Primary hash|Hash key)" /tmp/ttnn_ccache_run1.log | head -30 | tee /tmp/ttnn_run1_ccache_keys.txt || true
            echo ""
            echo "=== Files included in hash - sample ==="
            grep -E "Hashing.*\.(cpp|hpp|h):" /tmp/ttnn_ccache_run1.log | head -20 || true
            echo ""
            echo "=== Compiler command lines - sample ==="
            grep -E "Command line|Compiler:" /tmp/ttnn_ccache_run1.log | head -10 || true
          else
            echo "âš ï¸  ccache debug log not found - CCACHE_DEBUG and CCACHE_LOGFILE may not be working"
            echo "This could mean:"
            echo "  1. Ccache is not being invoked during kernel compilation"
            echo "  2. Environment variables are not propagated to subprocess"
            echo "  3. Ccache debug logging is not enabled properly"
          fi
          echo ""
          echo "=== Git commit information ==="
          git rev-parse HEAD | tee /tmp/ttnn_run1_git_commit.txt
          echo ""
          echo "=== Environment variables affecting cache ==="
          env | grep -E "(TT_METAL|ARCH_NAME|CCACHE)" | sort | tee /tmp/ttnn_run1_env.txt

      - name: Analyze ccache after Run 1
        run: |
          echo "=== TTNN RUN 1: ccache statistics after test ==="
          ccache -s
          echo ""
          echo "=== Detailed ccache statistics (verbose) ==="
          ccache --print-stats --verbose 2>&1 | head -100
          echo ""
          echo "=== Kernel cache locations ==="
          echo "Checking ~/.cache/tt-metal-cache/:"
          find ~/.cache/tt-metal-cache/ -type f -name "*.elf" -o -name "*.bin" 2>/dev/null | wc -l || echo "0"
          echo ""
          echo "=== Redis Key Check ==="
          REDIS_HOST="${{ vars.REDIS_HOST }}"
          REDIS_PORT="${{ vars.REDIS_PORT }}"
          REDIS_PASS="${{ secrets.REDIS_PASSWORD }}"

          if [ -n "$REDIS_HOST" ] && [ -n "$REDIS_PASS" ]; then
            if ! command -v redis-cli &> /dev/null; then
              echo "Installing redis-cli..."
              apt-get update -qq && apt-get install -y -qq redis-tools 2>&1 | grep -v "^Selecting\|^Preparing\|^Unpacking" || true
            fi

            TOTAL_KEYS=$(redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" --no-auth-warning -a "$REDIS_PASS" DBSIZE 2>/dev/null | grep -oE '[0-9]+' || echo "0")
            echo "Total keys in Redis after TTNN Run 1: ${TOTAL_KEYS}"
          fi

      - name: Clear kernel caches for Run 2 (but keep ccache)
        run: |
          echo ""
          echo "========================================="
          echo "=== Preparing TTNN RUN 2: Test ccache hits ==="
          echo "========================================="
          echo "Clearing kernel binaries to force recompilation (ccache should provide hits)"
          rm -rf ~/.cache/tt-metal-cache/*/*/kernels/ /tmp/tt-metal-cache/*/*/kernels/ || true
          find /work -name "*.elf" -path "*/kernels/*" -delete 2>/dev/null || true
          find /work -name "*.bin" -path "*/kernels/*" -delete 2>/dev/null || true
          echo "Kernel binaries cleared, ccache intact"
          echo ""
          echo "=== Zeroing ccache stats for Run 2 ==="
          ccache -z
          ccache -s

      - name: Run TTNN tests (Second run - expect ccache hits)
        timeout-minutes: 30
        env:
          CCACHE_DEBUG: "true"
          CCACHE_LOGFILE: /tmp/ttnn_ccache_run2.log
        run: |
          echo "=== Running TTNN unit tests (RUN 2 - should hit ccache) ==="
          pytest -n auto --timeout 300 tests/ttnn/unit_tests/operations/matmul -xv -m "not disable_fast_runtime_mode" 2>&1 | tee /tmp/ttnn_second_run.log

      - name: Capture kernel hashes after Run 2 and compare
        run: |
          echo "=== TTNN RUN 2: Capturing ccache hash information ==="
          echo ""
          echo "=== Analyzing ccache debug log for cache keys ==="
          if [ -f /tmp/ttnn_ccache_run2.log ]; then
            echo "Log size: $(wc -l /tmp/ttnn_ccache_run2.log | awk '{print $1}') lines"
            echo ""
            echo "=== Result keys (ccache primary hash) - first 30 ==="
            grep -E "(Result key|Primary hash|Hash key)" /tmp/ttnn_ccache_run2.log | head -30 | tee /tmp/ttnn_run2_ccache_keys.txt || true
          fi
          echo ""
          echo "=== Git commit information ==="
          git rev-parse HEAD | tee /tmp/ttnn_run2_git_commit.txt
          echo ""
          echo "=== Build environment that affects cache keys ==="
          env | grep -E "(TT_METAL|ARCH_NAME|CCACHE)" | sort | tee /tmp/ttnn_run2_env.txt
          echo ""
          echo "=== Comparing Run 1 vs Run 2 ==="
          echo "--- Git commits ---"
          if diff -u /tmp/ttnn_run1_git_commit.txt /tmp/ttnn_run2_git_commit.txt; then
            echo "âœ… Git commits are identical"
          else
            echo "ðŸ”´ Git commits differ!"
          fi
          echo ""
          echo "--- Build environment ---"
          if diff -u /tmp/ttnn_run1_env.txt /tmp/ttnn_run2_env.txt; then
            echo "âœ… Build environment is identical"
          else
            echo "ðŸ”´ Build environment differs!"
          fi
          echo ""
          echo "--- Ccache keys (first 30) ---"
          if [ -f /tmp/ttnn_run1_ccache_keys.txt ] && [ -f /tmp/ttnn_run2_ccache_keys.txt ]; then
            if diff -u /tmp/ttnn_run1_ccache_keys.txt /tmp/ttnn_run2_ccache_keys.txt; then
              echo "âœ… Ccache keys are identical"
            else
              echo "ðŸ”´ Ccache keys differ! Cache keys changed between runs!"
            fi
          else
            echo "âš ï¸  Cannot compare ccache keys - files not found"
          fi

      - name: Analyze ccache after Run 2
        run: |
          echo "=== TTNN RUN 2: ccache statistics after test ==="
          ccache -s
          echo ""
          STATS=$(ccache -s)
          CACHE_HITS=$(echo "$STATS" | grep -i "cache hit" | grep -oE '[0-9]+' | head -1 || echo "0")
          CACHE_MISS=$(echo "$STATS" | grep -i "cache miss" | grep -oE '[0-9]+' | head -1 || echo "0")
          TOTAL=$((CACHE_HITS + CACHE_MISS))

          echo "=== Cache Hit Analysis ==="
          if [ "$TOTAL" -gt 0 ]; then
            HIT_RATE=$((CACHE_HITS * 100 / TOTAL))
            echo "Cache hit rate: ${HIT_RATE}% (${CACHE_HITS} hits / ${TOTAL} total)"

            if [ "$CACHE_HITS" -eq 0 ]; then
              echo "ðŸ”´ ZERO CACHE HITS - ccache not working for TTNN tests!"
            elif [ "$HIT_RATE" -gt 70 ]; then
              echo "âœ… Good cache hit rate!"
            else
              echo "âš ï¸  Lower than expected cache hit rate"
            fi
          else
            echo "â„¹ï¸  No cache activity detected"
          fi

      - name: Clear kernel caches for Run 3
        run: |
          echo ""
          echo "========================================="
          echo "=== Preparing TTNN RUN 3: Verify consistency ==="
          echo "========================================="
          echo "Clearing kernel binaries for third test"
          rm -rf ~/.cache/tt-metal-cache/*/*/kernels/ /tmp/tt-metal-cache/*/*/kernels/ || true
          find /work -name "*.elf" -path "*/kernels/*" -delete 2>/dev/null || true
          find /work -name "*.bin" -path "*/kernels/*" -delete 2>/dev/null || true
          echo ""
          echo "=== Zeroing ccache stats for Run 3 ==="
          ccache -z
          ccache -s

      - name: Run TTNN tests (Third run)
        timeout-minutes: 30
        env:
          CCACHE_DEBUG: "true"
          CCACHE_LOGFILE: /tmp/ttnn_ccache_run3.log
        run: |
          echo "=== Running TTNN unit tests (RUN 3) ==="
          pytest -n auto --timeout 300 tests/ttnn/unit_tests/operations/matmul -xv -m "not disable_fast_runtime_mode" 2>&1 | tee /tmp/ttnn_third_run.log

      - name: Capture kernel hashes after Run 3 and final comparison
        run: |
          echo "=== TTNN RUN 3: Final ccache analysis and three-way comparison ==="
          echo ""
          echo "=== Analyzing ccache debug log for cache keys ==="
          if [ -f /tmp/ttnn_ccache_run3.log ]; then
            echo "Log size: $(wc -l /tmp/ttnn_ccache_run3.log | awk '{print $1}') lines"
            echo ""
            echo "=== Result keys (ccache primary hash) - first 30 ==="
            grep -E "(Result key|Primary hash|Hash key)" /tmp/ttnn_ccache_run3.log | head -30 | tee /tmp/ttnn_run3_ccache_keys.txt || true
          fi
          echo ""
          echo "=== Git commit information ==="
          git rev-parse HEAD | tee /tmp/ttnn_run3_git_commit.txt
          echo ""
          echo "=== Build environment that affects cache keys ==="
          env | grep -E "(TT_METAL|ARCH_NAME|CCACHE)" | sort | tee /tmp/ttnn_run3_env.txt
          echo ""
          echo "=== Final Comparison: Run 1 vs Run 2 vs Run 3 ==="
          echo "--- Git commits consistency ---"
          if diff -q /tmp/ttnn_run1_git_commit.txt /tmp/ttnn_run2_git_commit.txt /tmp/ttnn_run3_git_commit.txt >/dev/null 2>&1; then
            echo "âœ… All git commits are identical across 3 runs"
          else
            echo "ðŸ”´ Git commits differ between runs!"
            echo "Run 1 commit:"
            cat /tmp/ttnn_run1_git_commit.txt
            echo "Run 2 commit:"
            cat /tmp/ttnn_run2_git_commit.txt
            echo "Run 3 commit:"
            cat /tmp/ttnn_run3_git_commit.txt
          fi
          echo ""
          echo "--- Build environment consistency ---"
          if diff -q /tmp/ttnn_run1_env.txt /tmp/ttnn_run2_env.txt /tmp/ttnn_run3_env.txt >/dev/null 2>&1; then
            echo "âœ… Build environment is identical across 3 runs"
          else
            echo "ðŸ”´ Build environment differs between runs!"
            echo "Diff Run1 vs Run2:"
            diff -u /tmp/ttnn_run1_env.txt /tmp/ttnn_run2_env.txt || true
            echo "Diff Run2 vs Run3:"
            diff -u /tmp/ttnn_run2_env.txt /tmp/ttnn_run3_env.txt || true
          fi
          echo ""
          echo "--- Ccache key consistency ---"
          if diff -q /tmp/ttnn_run1_ccache_keys.txt /tmp/ttnn_run2_ccache_keys.txt /tmp/ttnn_run3_ccache_keys.txt >/dev/null 2>&1; then
            echo "âœ… Ccache keys are identical across 3 runs - cache should be hitting!"
          else
            echo "ðŸ”´ Ccache keys differ between runs! This explains cache misses!"
            echo "Diff Run1 vs Run2:"
            diff -u /tmp/ttnn_run1_ccache_keys.txt /tmp/ttnn_run2_ccache_keys.txt || true
            echo "Diff Run2 vs Run3:"
            diff -u /tmp/ttnn_run2_ccache_keys.txt /tmp/ttnn_run3_ccache_keys.txt || true
          fi
          echo ""
          echo "=== Sample from ccache debug log (cache decisions) ==="
          grep -E "(cache hit|cache miss|No such file|Result|Hash)" /tmp/ttnn_ccache_run3.log | head -30 || echo "No hit/miss lines found"

      - name: Analyze final ccache stats
        run: |
          echo "=== TTNN RUN 3: Final ccache statistics ==="
          ccache -s

      - name: Publish ccache summary
        run: |
          echo '## CCache TTNN Unit Tests Results' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo 'This test checks if ccache works consistently for TTNN unit tests across rebuilds from the same commit using Redis as the remote storage backend.' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY

          STATS=$(ccache -s)
          echo '### Final CCache Stats (TTNN Run 3)' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$STATS" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          CACHE_HITS=$(echo "$STATS" | grep -i "cache hit" | grep -oE '[0-9]+' | head -1 || echo "0")
          CACHE_MISS=$(echo "$STATS" | grep -i "cache miss" | grep -oE '[0-9]+' | head -1 || echo "0")
          TOTAL=$((CACHE_HITS + CACHE_MISS))

          if [ "$TOTAL" -gt 0 ]; then
            HIT_RATE=$((CACHE_HITS * 100 / TOTAL))
            echo "- Cache hits: ${CACHE_HITS}" >> $GITHUB_STEP_SUMMARY
            echo "- Cache misses: ${CACHE_MISS}" >> $GITHUB_STEP_SUMMARY
            echo "- Hit rate: ${HIT_RATE}%" >> $GITHUB_STEP_SUMMARY
            echo '' >> $GITHUB_STEP_SUMMARY

            if [ "$HIT_RATE" -lt 30 ]; then
              echo 'ðŸ”´ **ISSUE CONFIRMED**: Very low cache hit rate indicates ccache is not working effectively for TTNN kernel compilation with Redis.' >> $GITHUB_STEP_SUMMARY
            elif [ "$HIT_RATE" -lt 70 ]; then
              echo 'ðŸŸ¡ **PARTIAL ISSUE**: Moderate cache hit rate suggests some cache busting may be occurring with Redis backend.' >> $GITHUB_STEP_SUMMARY
            else
              echo 'ðŸŸ¢ **GOOD**: High cache hit rate indicates ccache with Redis is working well for TTNN kernel compilation.' >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo 'âšª **NO DATA**: No cache activity detected. Redis remote storage may not be configured properly.' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload TTNN debug logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ttnn-ccache-debug-logs-${{ github.run_id }}
          path: |
            /tmp/ttnn_first_run.log
            /tmp/ttnn_second_run.log
            /tmp/ttnn_third_run.log
            /tmp/ttnn_ccache_run1.log
            /tmp/ttnn_ccache_run2.log
            /tmp/ttnn_ccache_run3.log
            /tmp/ttnn_run1_ccache_keys.txt
            /tmp/ttnn_run2_ccache_keys.txt
            /tmp/ttnn_run3_ccache_keys.txt
            /tmp/ttnn_run1_git_commit.txt
            /tmp/ttnn_run2_git_commit.txt
            /tmp/ttnn_run3_git_commit.txt
            /tmp/ttnn_run1_env.txt
            /tmp/ttnn_run2_env.txt
            /tmp/ttnn_run3_env.txt
          retention-days: 14

      - uses: tenstorrent/tt-metal/.github/actions/slack-report@main
        if: ${{ failure() }}
        with:
          slack_webhook_url: ${{ secrets.SLACK_METAL_INFRA_PIPELINE_STATUS_ALERT }}
          owner: U07ASPTGJTS

      - uses: tenstorrent/tt-metal/.github/actions/upload-artifact-with-job-uuid@main
        timeout-minutes: 10
        if: ${{ !cancelled() }}
        with:
          path: /work/generated/test_reports/
          prefix: "ttnn_test_reports_"

  tt-train-ccache-test:
    needs: build-artifact
    name: tt-train CCache Test (3 runs on same machine)
    runs-on: tt-ubuntu-2204-N150-stable
    environment: ${{ github.ref == 'refs/heads/main' && 'mainline' || '' }}
    container:
      image: harbor.ci.tenstorrent.net/ghcr.io/tenstorrent/tt-metal/tt-metalium/ubuntu-22.04-dev-amd64:d8ab8ee3fe4d35256b675bd6f47c0d48f7cada78
      env:
        TT_METAL_HOME: /work
        TT_METAL_RUNTIME_ROOT: /work
        LD_LIBRARY_PATH: /work/build/lib
        TEST_DATA_DIR: /work/data
        ENABLE_CI_ONLY_TT_TRAIN_TESTS: 1
        CCACHE_REMOTE_ONLY: "false"
        CCACHE_TEMPDIR: /tmp/ccache
        TT_METAL_CCACHE_KERNEL_SUPPORT: 1
        TT_METAL_LOGGER_LEVEL: Debug
        TT_METAL_LOGGER_TYPES: BuildKernels
        TT_METAL_LOG_KERNELS_COMPILE_COMMANDS: 1
      volumes:
        - ${{ github.workspace }}/docker-job:/work
        - /dev/hugepages-1G:/dev/hugepages-1G
        - /home/ubuntu/.ccache-ci:/github/home/.ccache
      options: "--device /dev/tenstorrent"
    defaults:
      run:
        shell: bash
        working-directory: /work
    steps:
      - name: Check Redis credentials
        if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false }}
        run: |
          if [ -z "${{ secrets.REDIS_PASSWORD }}" ]; then
            echo "Redis password is missing. Did you forget 'secrets: inherit'?"
            exit 1
          fi
          CCACHE_REMOTE_STORAGE="redis://${{ vars.REDIS_USER }}:${{ secrets.REDIS_PASSWORD }}@${{ vars.REDIS_HOST }}:${{ vars.REDIS_PORT }}|read-only=${{ vars.REDIS_IS_READONLY }}"
          echo "CCACHE_REMOTE_STORAGE=${CCACHE_REMOTE_STORAGE}" >> $GITHUB_ENV

      - name: Create ccache tmpdir
        run: mkdir -p /tmp/ccache

      - name: ðŸ§¬ Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          path: docker-job

      - name: ðŸ“¦ Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build-artifact.outputs.build_artifact_name }}
          path: docker-job

      - name: ðŸ“‚ Extract Build Files
        working-directory: docker-job
        run: tar --zstd -xf ttm_any.tar.zst

      - name: Initial ccache configuration and stats
        run: |
          echo "=== RUN 1: Initial ccache configuration ==="
          ccache --show-config | head -40
          echo ""
          echo "=== Redis Remote Storage Configuration ==="
          echo "CCACHE_REMOTE_STORAGE: ${CCACHE_REMOTE_STORAGE:-not set}"
          echo "CCACHE_REMOTE_ONLY: ${CCACHE_REMOTE_ONLY:-not set}"
          echo "CCACHE_TEMPDIR: ${CCACHE_TEMPDIR:-not set}"
          echo ""
          echo "=== Redis Connection Details ==="
          ccache --show-config | grep -i redis || echo "No Redis config found"
          ccache --show-config | grep -E "(remote_storage|remote_only|redis)" || true
          echo ""
          echo "=== Git commit info ==="
          echo "Git commit: $(git rev-parse HEAD)"
          echo "Git commit short: $(git rev-parse --short=10 HEAD)"
          echo ""
          echo "=== Zeroing ccache stats ==="
          ccache -z
          echo "=== Initial ccache stats ==="
          ccache -s

      - name: Clear kernel caches to force fresh compilation
        run: |
          echo "=== Clearing all kernel caches to force JIT compilation ==="
          rm -rf /tmp/ttnn_cache/ /tmp/tt_metal_cache/ || true
          rm -rf ~/.cache/tt-metal-cache/ /tmp/tt-metal-cache/ || true
          find /work -name "*.elf" -path "*/kernels/*" -delete 2>/dev/null || true
          find /work -name "*.bin" -path "*/kernels/*" -delete 2>/dev/null || true
          echo "Kernel caches cleared"

      - name: Run tt-train tests (First run)
        timeout-minutes: 30
        run: |
          cd /work/build/tt-train
          mkdir -p generated/test_reports
          echo "=== Running tt-train tests (RUN 1) ==="
          ctest -E NIGHTLY --no-tests=error --output-on-failure --output-junit generated/test_reports/ctest_report.xml

      - name: Analyze ccache debug logs (Run 1)
        run: |
          echo "=== RUN 1: Analyzing ccache debug log ==="
          if [ -f /tmp/ccache_run1.log ]; then
            echo "Log file size: $(wc -l /tmp/ccache_run1.log | awk '{print $1}') lines"
            echo ""
            echo "=== Sample cache operations (first 30 lines) ==="
            head -30 /tmp/ccache_run1.log
            echo ""
            echo "=== Checking for cache key patterns ==="
            grep -E "(Hash|Result key|Storing|Writing)" /tmp/ccache_run1.log | head -20 || echo "No hash patterns found"
            echo ""
            echo "=== Checking for remote storage operations ==="
            grep -iE "(redis|remote)" /tmp/ccache_run1.log | head -20 || echo "No remote storage operations logged"
            echo ""
            echo "=== Checking for any errors ==="
            grep -iE "(error|failed|warning)" /tmp/ccache_run1.log | head -10 || echo "No errors found"
          else
            echo "âš ï¸  WARNING: ccache debug log not found at /tmp/ccache_run1.log"
            echo "CCACHE_DEBUG and CCACHE_LOGFILE may not be working"
          fi

      - name: Analyze ccache and kernel cache locations (Run 1)
        run: |
          echo "=== RUN 1: ccache statistics after test ==="
          ccache -s
          echo ""
          echo "=== Redis Remote Storage Stats ==="
          echo "Remote storage is $(ccache --show-config | grep remote_storage | awk '{print $3}')"
          echo "Remote only mode: ${CCACHE_REMOTE_ONLY:-not set}"
          echo ""
          echo "=== Detailed ccache stats with remote storage info ==="
          ccache -s | grep -E "(cache hit|cache miss|remote|local|files|size)" || ccache -s
          echo ""
          echo "=== Redis Key Inspection ==="
          REDIS_HOST="${{ vars.REDIS_HOST }}"
          REDIS_PORT="${{ vars.REDIS_PORT }}"
          REDIS_PASS="${{ secrets.REDIS_PASSWORD }}"

          if [ -n "$REDIS_HOST" ] && [ -n "$REDIS_PASS" ]; then
            echo "Connecting to Redis at ${REDIS_HOST}:${REDIS_PORT}..."

            # Install redis-cli if needed
            if ! command -v redis-cli &> /dev/null; then
              echo "Installing redis-cli..."
              apt-get update -qq && apt-get install -y -qq redis-tools 2>&1 | grep -v "^Selecting\|^Preparing\|^Unpacking" || true
            fi

            GIT_HASH=$(git rev-parse --short=10 HEAD)
            echo "Git hash: $GIT_HASH"

            # Count total keys in Redis
            TOTAL_KEYS=$(redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" --no-auth-warning -a "$REDIS_PASS" DBSIZE 2>/dev/null | grep -oE '[0-9]+' || echo "0")
            echo "Total keys in Redis after Run 1: ${TOTAL_KEYS}"

            # Sample some keys
            if [ "$TOTAL_KEYS" -gt 0 ]; then
              echo "Sample Redis keys (first 20):"
              redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" --no-auth-warning -a "$REDIS_PASS" --scan --count 20 2>/dev/null | head -20 || echo "Could not fetch keys"

              # Check key structure
              echo ""
              echo "Inspecting key structure (first key):"
              FIRST_KEY=$(redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" --no-auth-warning -a "$REDIS_PASS" --scan --count 1 2>/dev/null | head -1)
              if [ -n "$FIRST_KEY" ]; then
                echo "Key: $FIRST_KEY"
                redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" --no-auth-warning -a "$REDIS_PASS" TYPE "$FIRST_KEY" 2>/dev/null || true
              fi
            else
              echo "âš ï¸  WARNING: Redis appears empty after Run 1 - ccache may not be writing to Redis!"
            fi
          else
            echo "Redis credentials not available"
          fi
          echo ""
          echo "=== Kernel cache locations ==="
          echo "Checking ~/.cache/tt-metal-cache/:"
          find ~/.cache/tt-metal-cache/ -type f -name "*.elf" -o -name "*.bin" 2>/dev/null | head -20 || echo "No kernel files in ~/.cache/tt-metal-cache/"
          echo ""
          echo "Checking /tmp/tt-metal-cache/:"
          find /tmp/tt-metal-cache/ -type f -name "*.elf" -o -name "*.bin" 2>/dev/null | head -20 || echo "No kernel files in /tmp/tt-metal-cache/"
          echo ""
          echo "=== Disk usage of kernel caches ==="
          du -sh ~/.cache/tt-metal-cache/ 2>/dev/null || echo "~/.cache/tt-metal-cache/ not found"
          du -sh /tmp/tt-metal-cache/ 2>/dev/null || echo "/tmp/tt-metal-cache/ not found"
          echo ""
          echo "=== Local ccache directory (should be minimal with REMOTE_ONLY) ==="
          du -sh /github/home/.ccache 2>/dev/null || echo "/github/home/.ccache not found"
          ls -la /github/home/.ccache 2>/dev/null | head -20 || echo "Cannot list /github/home/.ccache"

      - name: Clear kernel caches for Run 2 (but keep ccache)
        run: |
          echo ""
          echo "========================================="
          echo "=== Preparing tt-train RUN 2: Test ccache hits ==="
          echo "========================================="
          echo "=== RUN 2: ccache configuration ==="
          ccache --show-config | grep -E "(remote_storage|remote_only|cache_dir)" || true
          echo ""
          echo "=== Redis Remote Storage Configuration ==="
          echo "CCACHE_REMOTE_STORAGE: ${CCACHE_REMOTE_STORAGE:-not set}"
          echo "CCACHE_REMOTE_ONLY: ${CCACHE_REMOTE_ONLY:-not set}"
          echo "CCACHE_TEMPDIR: ${CCACHE_TEMPDIR:-not set}"
          echo ""
          echo "=== Redis Key Check Before Run 2 ==="
          REDIS_HOST="${{ vars.REDIS_HOST }}"
          REDIS_PORT="${{ vars.REDIS_PORT }}"
          REDIS_PASS="${{ secrets.REDIS_PASSWORD }}"

          if [ -n "$REDIS_HOST" ] && [ -n "$REDIS_PASS" ]; then
            # Install redis-cli if needed
            if ! command -v redis-cli &> /dev/null; then
              echo "Installing redis-cli..."
              apt-get update -qq && apt-get install -y -qq redis-tools 2>&1 | grep -v "^Selecting\|^Preparing\|^Unpacking" || true
            fi

            GIT_HASH=$(git rev-parse --short=10 HEAD)
            echo "Git hash: $GIT_HASH"
            TOTAL_KEYS=$(redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" --no-auth-warning -a "$REDIS_PASS" DBSIZE 2>/dev/null | grep -oE '[0-9]+' || echo "0")
            echo "Total keys in Redis before Run 2: ${TOTAL_KEYS}"

            if [ "$TOTAL_KEYS" -gt 0 ]; then
              echo "âœ… Redis has ${TOTAL_KEYS} cached entries from Run 1"
              echo "Sample keys (first 10):"
              redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" --no-auth-warning -a "$REDIS_PASS" --scan --count 10 2>/dev/null | head -10
            else
              echo "âš ï¸  WARNING: Redis appears empty - ccache may not have persisted from Run 1"
              echo "This means Run 2 will NOT get cache hits!"
            fi
          fi
          echo ""
          echo "Clearing kernel binaries to force recompilation (ccache should provide hits)"
          rm -rf ~/.cache/tt-metal-cache/*/*/kernels/ /tmp/tt-metal-cache/*/*/kernels/ || true
          find /work -name "*.elf" -path "*/kernels/*" -delete 2>/dev/null || true
          find /work -name "*.bin" -path "*/kernels/*" -delete 2>/dev/null || true
          echo "Kernel binaries cleared, ccache intact"
          echo ""
          echo "=== Zeroing ccache stats for Run 2 ==="
          ccache -z
          ccache -s


      - name: Run tt-train tests (Second run - expect ccache hits)
        timeout-minutes: 30
        run: |
          cd /work/build/tt-train
          mkdir -p generated/test_reports
          echo "=== Running tt-train tests (RUN 2 - should hit ccache) ==="
          ctest -E NIGHTLY --no-tests=error --output-on-failure --output-junit generated/test_reports/ctest_report.xml 2>&1 | tee /tmp/tt_train_second_run.log

      - name: Analyze ccache after Run 2
        run: |
          echo "=== tt-train RUN 2: ccache statistics after test ==="
          ccache -s
          echo ""
          STATS=$(ccache -s)
          CACHE_HITS=$(echo "$STATS" | grep -i "cache hit" | grep -oE '[0-9]+' | head -1 || echo "0")
          CACHE_MISS=$(echo "$STATS" | grep -i "cache miss" | grep -oE '[0-9]+' | head -1 || echo "0")
          TOTAL=$((CACHE_HITS + CACHE_MISS))

          echo "=== Cache Hit Analysis ==="
          if [ "$TOTAL" -gt 0 ]; then
            HIT_RATE=$((CACHE_HITS * 100 / TOTAL))
            echo "Cache hit rate: ${HIT_RATE}% (${CACHE_HITS} hits / ${TOTAL} total)"

            if [ "$CACHE_HITS" -eq 0 ]; then
              echo "ðŸ”´ ZERO CACHE HITS - ccache not working for tt-train tests!"
            elif [ "$HIT_RATE" -gt 70 ]; then
              echo "âœ… Good cache hit rate!"
            else
              echo "âš ï¸  Lower than expected cache hit rate"
            fi
          else
            echo "â„¹ï¸  No cache activity detected"
          fi

      - name: Clear kernel caches for Run 3
        run: |
          echo ""
          echo "========================================="
          echo "=== Preparing tt-train RUN 3: Verify consistency ==="
          echo "========================================="
          echo "Clearing kernel binaries for third test"
          rm -rf ~/.cache/tt-metal-cache/*/*/kernels/ /tmp/tt-metal-cache/*/*/kernels/ || true
          find /work -name "*.elf" -path "*/kernels/*" -delete 2>/dev/null || true
          find /work -name "*.bin" -path "*/kernels/*" -delete 2>/dev/null || true
          echo ""
          echo "=== Zeroing ccache stats for Run 3 ==="
          ccache -z
          ccache -s

      - name: Run tt-train tests (Third run)
        timeout-minutes: 30
        run: |
          cd /work/build/tt-train
          echo "=== Running tt-train tests (RUN 3) ==="
          ctest -E NIGHTLY --no-tests=error --output-on-failure --output-junit generated/test_reports/ctest_report.xml 2>&1 | tee /tmp/tt_train_third_run.log

      - name: Analyze final ccache stats
        run: |
          echo "=== tt-train RUN 3: Final ccache statistics ==="
          ccache -s

      - name: Publish ccache summary
        run: |
          echo '## CCache tt-train Tests Results' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo 'This test checks if ccache works consistently for tt-train tests across rebuilds from the same commit using Redis as the remote storage backend.' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY

          STATS=$(ccache -s)
          echo '### Final CCache Stats (tt-train Run 3)' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$STATS" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          CACHE_HITS=$(echo "$STATS" | grep -i "cache hit" | grep -oE '[0-9]+' | head -1 || echo "0")
          CACHE_MISS=$(echo "$STATS" | grep -i "cache miss" | grep -oE '[0-9]+' | head -1 || echo "0")
          TOTAL=$((CACHE_HITS + CACHE_MISS))

          if [ "$TOTAL" -gt 0 ]; then
            HIT_RATE=$((CACHE_HITS * 100 / TOTAL))
            echo "- Cache hits: ${CACHE_HITS}" >> $GITHUB_STEP_SUMMARY
            echo "- Cache misses: ${CACHE_MISS}" >> $GITHUB_STEP_SUMMARY
            echo "- Hit rate: ${HIT_RATE}%" >> $GITHUB_STEP_SUMMARY
            echo '' >> $GITHUB_STEP_SUMMARY

            if [ "$HIT_RATE" -lt 30 ]; then
              echo 'ðŸ”´ **ISSUE CONFIRMED**: Very low cache hit rate indicates ccache is not working effectively for tt-train tests with Redis.' >> $GITHUB_STEP_SUMMARY
            elif [ "$HIT_RATE" -lt 70 ]; then
              echo 'ðŸŸ¡ **PARTIAL ISSUE**: Moderate cache hit rate suggests some cache busting may be occurring with Redis backend.' >> $GITHUB_STEP_SUMMARY
            else
              echo 'ðŸŸ¢ **GOOD**: High cache hit rate indicates ccache with Redis is working well for tt-train tests.' >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo 'âšª **NO DATA**: No cache activity detected. Redis remote storage may not be configured properly.' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload tt-train debug logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: tt-train-ccache-debug-logs-${{ github.run_id }}
          path: |
            /tmp/tt_train_first_run.log
            /tmp/tt_train_second_run.log
            /tmp/tt_train_third_run.log
          retention-days: 14

      - uses: tenstorrent/tt-metal/.github/actions/slack-report@main
        if: ${{ failure() }}
        with:
          slack_webhook_url: ${{ secrets.SLACK_METAL_INFRA_PIPELINE_STATUS_ALERT }}
          owner: U07ASPTGJTS

      - uses: tenstorrent/tt-metal/.github/actions/upload-artifact-with-job-uuid@main
        timeout-minutes: 10
        if: ${{ !cancelled() }}
        with:
          path: /work/build/tt-train/generated/test_reports/
          prefix: "tt_train_test_reports_"
