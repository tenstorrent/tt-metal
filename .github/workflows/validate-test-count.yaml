name: "Validate Test Count"

on:
  workflow_call:
    inputs:
      wheel-artifact-name:
        required: true
        type: string
        default: "wheel-artifact-unresolved!"
      package-artifact-name:
        required: true
        type: string
        default: "package-artifact-unresolved!"
      docker-image:
        required: true
        type: string
        default: "ghcr.io/tenstorrent/tt-metal/tt-metalium/ubuntu-22.04-basic-dev-amd64:7c703d657df3754df3882f93fa908fedab02fa15"
  pull_request:
    paths:
      - 'tests/ttnn/unit_tests/operations/eltwise/**'
      - 'tests/ttnn/unit_tests/operations/conv/**'
      - 'tests/ttnn/unit_tests/operations/matmul/**'
      - 'tests/ttnn/unit_tests/operations/pool/**'
      - 'tests/ttnn/unit_tests/operations/fused/**'
      - 'tests/ttnn/unit_tests/operations/transformers/**'
      - 'tests/ttnn/unit_tests/operations/reduce/**'
      - 'tests/ttnn/unit_tests/tensor/**'
      - 'tests/ttnn/unit_tests/operations/debug/**'
      - 'tests/ttnn/unit_tests/base_functionality/**'
      - 'tests/ttnn/unit_tests/benchmarks/**'
jobs:
  check-test-count:
    runs-on: ubuntu-latest
    name: "Ensure no new tests added to locked directories"
    container:
      #image: ${{ format('harbor.ci.tenstorrent.net/{0}', inputs.docker-image) }}
      image: ghcr.io/tenstorrent/tt-metal/tt-metalium/ubuntu-22.04-basic-dev-amd64:7c703d657df3754df3882f93fa908fedab02fa15
      env:
        LOGURU_LEVEL: INFO
        PYTHONPATH: /work
        GIT_DISCOVERY_ACROSS_FILESYSTEM: 1
      volumes:
        - ${{ github.workspace }}:/work # Subdir to workaround https://github.com/actions/runner/issues/691
        - /dev/hugepages-1G:/dev/hugepages-1G
      #options: "--device /dev/tenstorrent -e TT_GH_CI_INFRA"
    defaults:
      run:
        shell: bash
        working-directory: /work
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history so we can checkout main later

      - name: Debug git setup
        run: |
          echo "PWD: $(pwd)"
          echo "Checking for .git:"
          ls -la /work/.git 2>&1 || echo ".git directory not found"
          echo "Listing /work:"
          ls -la /work | head -20

      # Python is already installed in the container image
      # - name: Set up Python
      #   uses: actions/setup-python@v5
      #   with:
      #     python-version: '3.10'

      - name: Download built wheel
        if: ${{ inputs.wheel-artifact-name != '' }}
        uses: dawidd6/action-download-artifact@v6
        with:
          name: ${{ inputs.wheel-artifact-name }}
          path: wheels
          run_id: 20788440471
          github_token: ${{ secrets.GITHUB_TOKEN }}
      # - name: Download built wheel
      #   if: ${{ inputs.wheel-artifact-name != '' }}
      #   uses: actions/download-artifact@v4
      #   with:
      #     name: ${{ inputs.wheel-artifact-name }}
      #     path: ./wheels

      # - name: Install tt-metal wheel and dependencies
      #   if: ${{ inputs.wheel-artifact-name != '' }}
      #   run: |
      #     pip install pytest torch loguru transformers
      #     pip install ./wheels/*.whl

      # - name: Download build packages
      #   if: ${{ inputs.package-artifact-name != '' }}
      #   uses: actions/download-artifact@v4
      #   with:
      #     name: ${{ inputs.package-artifact-name }}
      #     path: ./packages
      # - name: Download built packages
      #   if: ${{ inputs.package-artifact-name != '' }}
      #   uses: dawidd6/action-download-artifact@v6
      #   with:
      #     name: packages-ubuntu-22.04-amd64-Release-x86_64-linux-clang-17-libstdcpp-no-distributed-7f5ee7b1d03e6570a27680cabb2f0e662aa87be3-20796940884
      #     path: ./packages
      #     run_id: 20796940884
      #     github_token: ${{ secrets.GITHUB_TOKEN }}

      # - name: Download built wheel
      #   if: ${{ inputs.wheel-artifact-name != '' }}
      #   uses: actions/download-artifact@v4
      #   with:
      #     name: ${{ inputs.wheel-artifact-name }}
      #     path: ./wheels

      # - name: Install tt-metal packages (for models source code)
      #   if: ${{ inputs.package-artifact-name != '' }}
      #   run: |
      #     sudo apt update
      #     sudo apt install -y ./packages/*.deb

      - name: Install pip
        run: |
          apt-get update
          apt-get install -y python3-pip git

      - name: Install Python dependencies
        run: |
          python3 -m pip install pytest torch loguru transformers
          # pip install pytest torch loguru transformers

      - name: Install tt-metal wheel (for ttnn Python module)
        if: ${{ inputs.wheel-artifact-name != '' }}
        run: |
          python3 -m pip install ./wheels/*.whl
          # pip install ./wheels/*.whl

      - name: Count and compare tests
        run: |
          # Define the paths to check for test counts
          declare -a PATHS=(
            "tests/ttnn/unit_tests/operations/eltwise"
            "tests/ttnn/unit_tests/operations/conv"
            "tests/ttnn/unit_tests/operations/matmul"
            "tests/ttnn/unit_tests/operations/pool"
            "tests/ttnn/unit_tests/operations/fused"
            "tests/ttnn/unit_tests/operations/transformers"
            "tests/ttnn/unit_tests/operations/reduce"
            "tests/ttnn/unit_tests/tensor"
            "tests/ttnn/unit_tests/operations/debug"
            "tests/ttnn/unit_tests/base_functionality"
            "tests/ttnn/unit_tests/benchmarks"
          )
          
          # Function to count test functions using pytest collect-only
          count_tests() {
            local dir=$1
            echo "Collecting from: $dir" >&2
            output=$(pytest --collect-only -q "$dir" --noconftest 2>&1)
            echo "Pytest output:" >&2
            # echo "$output" >&2
            count=$(echo "$output" | tail -1 | grep -oE '[0-9]+' | head -1)
            if [ -z "$count" ]; then
              echo "0"
            else
              echo "$count"
            fi
          }
          
          # Count tests in PR branch
          echo "=== PR branch test counts ==="
          declare -A pr_counts
          for path in "${PATHS[@]}"; do
            count=$(count_tests "$path")
            pr_counts[$path]=$count
            echo "  $path: $count"
          done
          
          # Configure git and checkout base branch
          git config --global --add safe.directory /work
          git fetch origin main
          git checkout origin/main
          
          # Count tests in base branch
          echo "=== Base branch test counts ==="
          declare -A base_counts
          for path in "${PATHS[@]}"; do
            count=$(count_tests "$path")
            base_counts[$path]=$count
            echo "  $path: $count"
          done
          
          # Compare and generate report
          FAILED=0
          
          echo "## Test Count Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Directory | Base | PR | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|------|-------|--------|" >> $GITHUB_STEP_SUMMARY
          
          for path in "${PATHS[@]}"; do
            pr_count=${pr_counts[$path]}
            base_count=${base_counts[$path]}
            
            if [ "$pr_count" -gt "$base_count" ]; then
              echo "| $path | $base_count | $pr_count | ❌ New tests added (+$((pr_count - base_count))) |" >> $GITHUB_STEP_SUMMARY
              echo "::error::New tests detected in $path/ ($base_count → $pr_count)"
              FAILED=1
            else
              echo "| $path | $base_count | $pr_count | ✅ No new tests |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          if [ "$FAILED" -eq 1 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "❌ **This PR adds new tests to APC.**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "These test directories are locked to maintain stable APC runtime." >> $GITHUB_STEP_SUMMARY
            echo "Please look into removing existing lower priority tests to add new tests." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **No new tests added - validation passed**" >> $GITHUB_STEP_SUMMARY
