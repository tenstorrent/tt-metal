name: "Validate Test Count"

on:
  workflow_call:
    inputs:
      wheel-artifact-name:
        required: true
        type: string
  # push:
  #   branches: [ "kkabilar-APC-limit" ]
  pull_request:
    paths:
      - 'tests/ttnn/unit_tests/operations/eltwise/**'
      - 'tests/ttnn/unit_tests/operations/conv/**'
      - 'tests/ttnn/unit_tests/operations/matmul/**'
      - 'tests/ttnn/unit_tests/operations/pool/**'
      - 'tests/ttnn/unit_tests/operations/fused/**'
      - 'tests/ttnn/unit_tests/operations/transformers/**'
      - 'tests/ttnn/unit_tests/operations/reduce/**'
      - 'tests/ttnn/unit_tests/tensor/**'
      - 'tests/ttnn/unit_tests/operations/debug/**'
      - 'tests/ttnn/unit_tests/base_functionality/**'
      - 'tests/ttnn/unit_tests/benchmarks/**'
jobs:
  # build:
  #   uses: ./.github/workflows/build-artifact.yaml
  #   permissions:
  #     packages: write
  #   secrets: inherit
  #   with:
  #     version: "22.04"
  #     toolchain: cmake/x86_64-linux-clang-17-libstdcpp-toolchain.cmake
  #     # Cannot do a Sanitizer build as that's not compatible with the downstream test.
  #     # Also cannot be Release if the other build was chosen to be Release as the GitHub artifact
  #     # name clashes.
  #     build-type: ${{ (inputs.build-type == 'Release' && 'Debug') || 'Release' }}
  #     build-wheel: true
  #     publish-artifact: false
  #     skip-tt-train: true
  #     distributed: false
  #     ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || '' }}
  check-test-count:
    # needs: build
    runs-on: ubuntu-latest
    name: "Ensure no new tests added to locked directories"
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        # Default fetch-depth: 1 - just PR branch

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Download built wheel
        if: ${{ inputs.wheel-artifact-name != '' }}
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.wheel-artifact-name }}
          path: ./wheels

      - name: Install tt-metal wheel and dependencies
        if: ${{ inputs.wheel-artifact-name != '' }}
        run: |
          pip install pytest torch numpy
          # Install other common test dependencies
          pip install multiprocess psutil loguru transformers
          pip install ./wheels/*.whl

      - name: Count and compare tests
        run: |
          # Add current directory to PYTHONPATH so models stub can be found
          export PYTHONPATH="${PYTHONPATH}:${PWD}"
          
          # Define locked directories to check (matching paths from workflow trigger)
          declare -a PATHS=(
            "tests/ttnn/unit_tests/operations/eltwise"
            "tests/ttnn/unit_tests/operations/conv"
            "tests/ttnn/unit_tests/operations/matmul"
            "tests/ttnn/unit_tests/operations/pool"
            "tests/ttnn/unit_tests/operations/fused"
            "tests/ttnn/unit_tests/operations/transformers"
            "tests/ttnn/unit_tests/operations/reduce"
            "tests/ttnn/unit_tests/tensor"
            "tests/ttnn/unit_tests/operations/debug"
            "tests/ttnn/unit_tests/base_functionality"
            "tests/ttnn/unit_tests/benchmarks"
          )
          
          # Function to count test functions using pytest
          count_tests() {
            local dir=$1
            echo "Collecting from: $dir" >&2
            output=$(pytest "$dir" --collect-only -q --noconftest 2>&1)
            echo "Pytest output:" >&2
            echo "$output" >&2
            count=$(echo "$output" | tail -1 | grep -oE '[0-9]+' | head -1)
            if [ -z "$count" ]; then
              echo "0"
            else
              echo "$count"
            fi
          }
          
          # Count tests in PR branch
          echo "=== PR branch test counts ==="
          declare -A pr_counts
          for path in "${PATHS[@]}"; do
            count=$(count_tests "$path")
            pr_counts[$path]=$count
            echo "  $path: $count"
          done
          
          # Checkout base branch
          git fetch origin main
          git checkout origin/main
          
          # Count tests in base branch
          echo "=== Base branch test counts ==="
          declare -A base_counts
          for path in "${PATHS[@]}"; do
            count=$(count_tests "$path")
            base_counts[$path]=$count
            echo "  $path: $count"
          done
          
          # Compare and generate report
          FAILED=0
          
          echo "## Test Count Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Directory | Base | PR | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|------|-------|--------|" >> $GITHUB_STEP_SUMMARY
          
          for path in "${PATHS[@]}"; do
            pr_count=${pr_counts[$path]}
            base_count=${base_counts[$path]}
            
            if [ "$pr_count" -gt "$base_count" ]; then
              echo "| $path | $base_count | $pr_count | ❌ New tests added (+$((pr_count - base_count))) |" >> $GITHUB_STEP_SUMMARY
              echo "::error::New tests detected in $path/ ($base_count → $pr_count)"
              FAILED=1
            else
              echo "| $path | $base_count | $pr_count | ✅ No new tests |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          if [ "$FAILED" -eq 1 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "❌ **This PR adds new tests to locked directories.**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "These test directories are locked to maintain stable APC runtime." >> $GITHUB_STEP_SUMMARY
            echo "Please contact @tenstorrent/metalium-developers-infra for approval to add new tests." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **No new tests added - validation passed**" >> $GITHUB_STEP_SUMMARY

      - name: Comment on PR if validation fails
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '❌ **Test Count Validation Failed**\n\nThis PR adds new tests to the ttnn job in APC. These jobs have a fixed test count to maintain stable APC runtime.\n\nIf you need to add new tests, please:\n1. Please look through the current list of test and check if a lower priority test can be removed to add your new test. \n2. Contact @tenstorrent/metalium-developers-infra and explain why the new tests are necessary\n3. Consider adding tests to the ttnn/nightly directory to run in L2-nightly pipeline\n\nSee the workflow summary for details.'
            })
