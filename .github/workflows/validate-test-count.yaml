name: "Validate Test Count"

on:
  workflow_dispatch:
  push:
    branches: [ "kkabilar-APC-limit" ]
  pull_request:
    paths:
      - 'tests/ttnn/unit_tests/operations/eltwise/**'
      - 'tests/ttnn/unit_tests/operations/conv/**'
      - 'tests/ttnn/unit_tests/operations/matmul/**'
      - 'tests/ttnn/unit_tests/operations/pool/**'
      - 'tests/ttnn/unit_tests/operations/fused/**'
      - 'tests/ttnn/unit_tests/operations/transformers/**'
      - 'tests/ttnn/unit_tests/operations/reduce/**'
      - 'tests/ttnn/unit_tests/operations/tensor/**'
      - 'tests/ttnn/unit_tests/operations/debug/**'
      - 'tests/ttnn/unit_tests/operations/base_functionality/**'
      - 'tests/ttnn/unit_tests/operations/benchmarks/**'
jobs:
  check-test-count:
    runs-on: ubuntu-latest
    name: "Ensure no new tests added to locked directories"
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        # Default fetch-depth: 1 - just PR branch

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies for test collection
        run: |
          pip install pytest multiprocess psutil loguru
          # Install common dependencies that tests might import
          pip install torch numpy || true
          
          # Create stub modules for tt-metal specific imports
          mkdir -p stub_modules
          
          # Create ttnn stub with better handling of special methods
          cat > stub_modules/ttnn.py << 'EOF'
          import sys
          from types import ModuleType
          
          class _Stub:
              def __getattr__(self, name):
                  return _Stub()
              def __call__(self, *args, **kwargs):
                  return _Stub()
              def __iter__(self):
                  return iter([])
              def __bool__(self):
                  return True
          
          def __getattr__(name):
              # Create sub-modules dynamically
              mod = ModuleType(f'ttnn.{name}')
              mod.__dict__.update({k: _Stub() for k in dir(_Stub)})
              sys.modules[f'ttnn.{name}'] = mod
              return mod
          
          # Pre-populate common submodules
          for submod in ['device', 'operations', 'core']:
              sys.modules[f'ttnn.{submod}'] = ModuleType(f'ttnn.{submod}')
              sys.modules[f'ttnn.{submod}'].__dict__['__getattr__'] = lambda n: _Stub()
          EOF
          
          # Create tt_lib stub
          cat > stub_modules/tt_lib.py << 'EOF'
          class _Stub:
              def __getattr__(self, name):
                  return _Stub()
              def __call__(self, *args, **kwargs):
                  return _Stub()
          
          def __getattr__(name):
              return _Stub()
          EOF
          
          # Add to PYTHONPATH
          echo "PYTHONPATH=$PWD/stub_modules:$PYTHONPATH" >> $GITHUB_ENV
          
      - name: Count and compare tests
        run: |
          # Define locked directories to check
          DIRS="eltwise conv matmul pool fused transformers reduce tensor debug base_functionality benchmarks"
          
          # Function to count test functions using pytest
          count_tests() {
            local dir=$1
            echo "Collecting from: $dir"
            
            # Show first error to see what's missing
            pytest "$dir" --collect-only --noconftest 2>&1 | head -50
            
            # Count using simple pattern - look for ".py::" which indicates a collected test
            count=$(pytest "$dir" --collect-only -q --noconftest 2>&1 | grep -c "\.py::" || echo "0")
            echo "Count: $count"
            echo "$count"
          }
          
          # Count tests in PR branch
          echo "=== PR branch test counts ==="
          declare -A pr_counts
          for dir in $DIRS; do
            count=$(count_tests "tests/ttnn/unit_tests/operations/$dir")
            pr_counts[$dir]=$count
            echo "  $dir: $count"
          done
          
          # Checkout base branch
          git fetch origin main
          git checkout origin/main
          
          # Count tests in base branch
          echo "=== Base branch test counts ==="
          declare -A base_counts
          for dir in $DIRS; do
            count=$(count_tests "tests/ttnn/unit_tests/operations/$dir")
            base_counts[$dir]=$count
            echo "  $dir: $count"
          done
          
          # Compare and generate report
          FAILED=0
          
          echo "## Test Count Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Directory | Base | PR | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|------|-------|--------|" >> $GITHUB_STEP_SUMMARY
          
          for dir in $DIRS; do
            pr_count=${pr_counts[$dir]}
            base_count=${base_counts[$dir]}
            
            if [ "$pr_count" -gt "$base_count" ]; then
              echo "| $dir | $base_count | $pr_count | ❌ New tests added (+$((pr_count - base_count))) |" >> $GITHUB_STEP_SUMMARY
              echo "::error::New tests detected in tests/ttnn/unit_tests/operations/$dir/ ($base_count → $pr_count)"
              FAILED=1
            else
              echo "| $dir | $base_count | $pr_count | ✅ No new tests |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          if [ "$FAILED" -eq 1 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "❌ **This PR adds new tests to locked directories.**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "These test directories are locked to maintain stable CI runtime." >> $GITHUB_STEP_SUMMARY
            echo "Please contact @tenstorrent/metalium-developers-infra for approval to add new tests." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **No new tests added - validation passed**" >> $GITHUB_STEP_SUMMARY

      - name: Comment on PR if validation fails
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '❌ **Test Count Validation Failed**\n\nThis PR adds new tests to locked test directories. These directories have a fixed test count to maintain stable CI runtime.\n\nIf you need to add new tests, please:\n1. Contact @tenstorrent/metalium-developers-infra\n2. Explain why the new tests are necessary\n3. Consider adding tests to a different directory\n\nSee the workflow summary for details.'
            })
