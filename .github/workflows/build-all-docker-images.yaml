name: "Build all Docker images"
# =============================================================================
# This workflow builds ALL Docker images needed by the CI pipeline in parallel.
# It should be called once at the start of the pipeline (e.g., by merge-gate.yaml),
# and all subsequent jobs should use the pre-built images via the outputs.
#
# NAMING CONVENTION: Outputs use "ubuntu-XXXX-*-tag" format to distinguish
# platform-specific images. These map to build-artifact.yaml inputs like:
#   ci-build-docker-image: ${{ needs.docker-images.outputs.ubuntu-2204-ci-build-tag }}
# =============================================================================

on:
  workflow_call:
    outputs:
      # Ubuntu 22.04 images
      ubuntu-2204-ci-build-tag:
        description: "Docker tag for Ubuntu 22.04 CI Build image"
        value: ${{ jobs.check-images.outputs.ubuntu-2204-ci-build-tag }}
      ubuntu-2204-ci-test-tag:
        description: "Docker tag for Ubuntu 22.04 CI Test image"
        value: ${{ jobs.check-images.outputs.ubuntu-2204-ci-test-tag }}
      ubuntu-2204-dev-tag:
        description: "Docker tag for Ubuntu 22.04 Dev image"
        value: ${{ jobs.check-images.outputs.ubuntu-2204-dev-tag }}
      ubuntu-2204-basic-dev-tag:
        description: "Docker tag for Ubuntu 22.04 Basic Dev image"
        value: ${{ jobs.check-images.outputs.ubuntu-2204-basic-dev-tag }}
      ubuntu-2204-basic-ttnn-runtime-tag:
        description: "Docker tag for Ubuntu 22.04 Basic TTNN Runtime image"
        value: ${{ jobs.check-images.outputs.ubuntu-2204-basic-ttnn-runtime-tag }}
      # Ubuntu 24.04 images
      ubuntu-2404-ci-build-tag:
        description: "Docker tag for Ubuntu 24.04 CI Build image"
        value: ${{ jobs.check-images.outputs.ubuntu-2404-ci-build-tag }}
      ubuntu-2404-ci-test-tag:
        description: "Docker tag for Ubuntu 24.04 CI Test image"
        value: ${{ jobs.check-images.outputs.ubuntu-2404-ci-test-tag }}
      ubuntu-2404-dev-tag:
        description: "Docker tag for Ubuntu 24.04 Dev image"
        value: ${{ jobs.check-images.outputs.ubuntu-2404-dev-tag }}
      ubuntu-2404-basic-dev-tag:
        description: "Docker tag for Ubuntu 24.04 Basic Dev image"
        value: ${{ jobs.check-images.outputs.ubuntu-2404-basic-dev-tag }}
      ubuntu-2404-basic-ttnn-runtime-tag:
        description: "Docker tag for Ubuntu 24.04 Basic TTNN Runtime image"
        value: ${{ jobs.check-images.outputs.ubuntu-2404-basic-ttnn-runtime-tag }}
      # ManyLinux image (shared)
      manylinux-tag:
        description: "Docker tag for ManyLinux image"
        value: ${{ jobs.check-images.outputs.manylinux-tag }}
  workflow_dispatch:

permissions:
  packages: write

jobs:
  check-images:
    name: "ðŸ” Check existing images"
    runs-on: tt-ubuntu-2204-large-stable
    outputs:
      # Ubuntu 22.04
      ubuntu-2204-ci-build-tag: ${{ steps.ubuntu-2204-tags.outputs.ci-build-tag }}
      ubuntu-2204-ci-test-tag: ${{ steps.ubuntu-2204-tags.outputs.ci-test-tag }}
      ubuntu-2204-dev-tag: ${{ steps.ubuntu-2204-tags.outputs.dev-tag }}
      ubuntu-2204-basic-dev-tag: ${{ steps.ubuntu-2204-tags.outputs.basic-dev-tag }}
      ubuntu-2204-basic-ttnn-runtime-tag: ${{ steps.ubuntu-2204-tags.outputs.basic-ttnn-runtime-tag }}
      ubuntu-2204-needs-build: ${{ steps.ubuntu-2204-check.outputs.needs-build }}
      # Ubuntu 24.04
      ubuntu-2404-ci-build-tag: ${{ steps.ubuntu-2404-tags.outputs.ci-build-tag }}
      ubuntu-2404-ci-test-tag: ${{ steps.ubuntu-2404-tags.outputs.ci-test-tag }}
      ubuntu-2404-dev-tag: ${{ steps.ubuntu-2404-tags.outputs.dev-tag }}
      ubuntu-2404-basic-dev-tag: ${{ steps.ubuntu-2404-tags.outputs.basic-dev-tag }}
      ubuntu-2404-basic-ttnn-runtime-tag: ${{ steps.ubuntu-2404-tags.outputs.basic-ttnn-runtime-tag }}
      ubuntu-2404-needs-build: ${{ steps.ubuntu-2404-check.outputs.needs-build }}
      # ManyLinux
      manylinux-tag: ${{ steps.manylinux-tags.outputs.manylinux-tag }}
      manylinux-needs-build: ${{ steps.manylinux-check.outputs.needs-build }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # Compute Ubuntu 22.04 tags
      - name: Compute Ubuntu 22.04 tags
        id: ubuntu-2204-tags
        run: |
          # Extra files not in COPY but affect the image
          EXTRA_FILES=".github/workflows/build-docker-artifact.yaml"

          HASH=$(.github/scripts/dockerfile-hash.sh dockerfile/Dockerfile $EXTRA_FILES)
          ARCH="amd64"
          echo "ci-build-tag=ghcr.io/${{ github.repository }}/tt-metalium/ubuntu-22.04-ci-build-${ARCH}:${HASH}" >> $GITHUB_OUTPUT
          echo "ci-test-tag=ghcr.io/${{ github.repository }}/tt-metalium/ubuntu-22.04-ci-test-${ARCH}:${HASH}" >> $GITHUB_OUTPUT
          echo "dev-tag=ghcr.io/${{ github.repository }}/tt-metalium/ubuntu-22.04-dev-${ARCH}:${HASH}" >> $GITHUB_OUTPUT

          BASIC_DEV_HASH=$(.github/scripts/dockerfile-hash.sh dockerfile/Dockerfile.basic-dev)
          echo "basic-dev-tag=ghcr.io/${{ github.repository }}/tt-metalium/ubuntu-22.04-basic-dev-${ARCH}:${BASIC_DEV_HASH}" >> $GITHUB_OUTPUT

          BASIC_TTNN_RUNTIME_HASH=$(.github/scripts/dockerfile-hash.sh dockerfile/Dockerfile.basic-dev)
          echo "basic-ttnn-runtime-tag=ghcr.io/${{ github.repository }}/tt-metalium/ubuntu-22.04-basic-ttnn-runtime-${ARCH}:${BASIC_TTNN_RUNTIME_HASH}" >> $GITHUB_OUTPUT

      - name: Check Ubuntu 22.04 images exist
        id: ubuntu-2204-check
        run: |
          if docker manifest inspect ${{ steps.ubuntu-2204-tags.outputs.dev-tag }} > /dev/null 2>&1; then
            echo "Ubuntu 22.04 images exist"
            echo "needs-build=false" >> $GITHUB_OUTPUT
          else
            echo "Ubuntu 22.04 images need to be built"
            echo "needs-build=true" >> $GITHUB_OUTPUT
          fi

      # Compute Ubuntu 24.04 tags
      - name: Compute Ubuntu 24.04 tags
        id: ubuntu-2404-tags
        run: |
          EXTRA_FILES=".github/workflows/build-docker-artifact.yaml"

          HASH=$(.github/scripts/dockerfile-hash.sh dockerfile/Dockerfile $EXTRA_FILES)
          ARCH="amd64"
          echo "ci-build-tag=ghcr.io/${{ github.repository }}/tt-metalium/ubuntu-24.04-ci-build-${ARCH}:${HASH}" >> $GITHUB_OUTPUT
          echo "ci-test-tag=ghcr.io/${{ github.repository }}/tt-metalium/ubuntu-24.04-ci-test-${ARCH}:${HASH}" >> $GITHUB_OUTPUT
          echo "dev-tag=ghcr.io/${{ github.repository }}/tt-metalium/ubuntu-24.04-dev-${ARCH}:${HASH}" >> $GITHUB_OUTPUT

          BASIC_DEV_HASH=$(.github/scripts/dockerfile-hash.sh dockerfile/Dockerfile.basic-dev)
          echo "basic-dev-tag=ghcr.io/${{ github.repository }}/tt-metalium/ubuntu-24.04-basic-dev-${ARCH}:${BASIC_DEV_HASH}" >> $GITHUB_OUTPUT

          BASIC_TTNN_RUNTIME_HASH=$(.github/scripts/dockerfile-hash.sh dockerfile/Dockerfile.basic-dev)
          echo "basic-ttnn-runtime-tag=ghcr.io/${{ github.repository }}/tt-metalium/ubuntu-24.04-basic-ttnn-runtime-${ARCH}:${BASIC_TTNN_RUNTIME_HASH}" >> $GITHUB_OUTPUT

      - name: Check Ubuntu 24.04 images exist
        id: ubuntu-2404-check
        run: |
          if docker manifest inspect ${{ steps.ubuntu-2404-tags.outputs.dev-tag }} > /dev/null 2>&1; then
            echo "Ubuntu 24.04 images exist"
            echo "needs-build=false" >> $GITHUB_OUTPUT
          else
            echo "Ubuntu 24.04 images need to be built"
            echo "needs-build=true" >> $GITHUB_OUTPUT
          fi

      # Compute ManyLinux tags
      - name: Compute ManyLinux tags
        id: manylinux-tags
        run: |
          EXTRA_FILES=".github/workflows/build-docker-artifact.yaml"

          MANYLINUX_HASH=$(.github/scripts/dockerfile-hash.sh dockerfile/Dockerfile.manylinux $EXTRA_FILES)
          echo "manylinux-tag=ghcr.io/${{ github.repository }}/tt-metalium/manylinux-amd64:${MANYLINUX_HASH}" >> $GITHUB_OUTPUT

      - name: Check ManyLinux image exists
        id: manylinux-check
        run: |
          if docker manifest inspect ${{ steps.manylinux-tags.outputs.manylinux-tag }} > /dev/null 2>&1; then
            echo "ManyLinux image exists"
            echo "needs-build=false" >> $GITHUB_OUTPUT
          else
            echo "ManyLinux image needs to be built"
            echo "needs-build=true" >> $GITHUB_OUTPUT
          fi

  # Build Ubuntu 22.04 images
  build-ubuntu-2204:
    name: "ðŸ³ Ubuntu 22.04"
    needs: check-images
    if: needs.check-images.outputs.ubuntu-2204-needs-build == 'true'
    timeout-minutes: 90
    runs-on: tt-ubuntu-2204-large-stable
    steps:
      - name: â¬‡ï¸ Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: https://ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            env.HTTP_PROXY=proxy.restricted-proxy.svc.cluster.local:3128
            env.HTTPS_PROXY=proxy.restricted-proxy.svc.cluster.local:3128
            env.NO_PROXY=large-file-cache.large-file-cache.svc.cluster.local,harbor.*.tenstorrent.net
          buildkitd-config-inline: |
            [registry."docker.io"]
              mirrors = ["mirror.gcr.io"]
      - name: Build and push CI Build image
        id: build-ci-build
        uses: docker/build-push-action@v6
        with:
          context: ${{ github.workspace }}
          file: dockerfile/Dockerfile
          target: ci-build
          push: true
          tags: ${{ needs.check-images.outputs.ubuntu-2204-ci-build-tag }}
          build-args: UBUNTU_VERSION=22.04
          cache-to: type=inline
          pull: true
          outputs: |
            type=image,compression=zstd,compression-level=9,force-compression=true,oci-mediatypes=true
      - name: Build and push CI Test image
        id: build-ci-test
        uses: docker/build-push-action@v6
        with:
          context: ${{ github.workspace }}
          file: dockerfile/Dockerfile
          target: ci-test
          push: true
          tags: ${{ needs.check-images.outputs.ubuntu-2204-ci-test-tag }}
          build-args: UBUNTU_VERSION=22.04
          cache-to: type=inline
          pull: true
          outputs: |
            type=image,compression=zstd,compression-level=9,force-compression=true,oci-mediatypes=true
      - name: Build and push Dev image
        id: build-dev
        uses: docker/build-push-action@v6
        with:
          context: ${{ github.workspace }}
          file: dockerfile/Dockerfile
          target: dev
          push: true
          tags: ${{ needs.check-images.outputs.ubuntu-2204-dev-tag }}
          build-args: UBUNTU_VERSION=22.04
          cache-to: type=inline
          pull: true
          outputs: |
            type=image,compression=zstd,compression-level=9,force-compression=true,oci-mediatypes=true
      - name: Build and push Basic Dev image
        id: build-basic-dev
        uses: docker/build-push-action@v6
        with:
          context: ${{ github.workspace }}
          file: dockerfile/Dockerfile.basic-dev
          target: base
          push: true
          tags: ${{ needs.check-images.outputs.ubuntu-2204-basic-dev-tag }}
          build-args: UBUNTU_VERSION=22.04
          cache-to: type=inline
          pull: true
          outputs: |
            type=image,compression=zstd,compression-level=9,force-compression=true,oci-mediatypes=true
      - name: Build and push Basic TTNN runtime image
        id: build-basic-ttnn-runtime
        uses: docker/build-push-action@v6
        with:
          context: ${{ github.workspace }}
          file: dockerfile/Dockerfile.basic-dev
          target: basic-ttnn-runtime
          push: true
          tags: ${{ needs.check-images.outputs.ubuntu-2204-basic-ttnn-runtime-tag }}
          build-args: UBUNTU_VERSION=22.04
          cache-to: type=inline
          pull: true
          outputs: |
            type=image,compression=zstd,compression-level=9,force-compression=true,oci-mediatypes=true
      - name: ðŸ“Š Show Ubuntu 22.04 image sizes
        run: |
          # Function to get image size in human-readable format
          get_image_size() {
            local image_tag="$1"
            # Get total size from manifest (sum of all layer sizes)
            local size_bytes=$(docker buildx imagetools inspect "$image_tag" --raw | jq '[.layers[].size] | add // 0')
            if [ "$size_bytes" = "0" ] || [ -z "$size_bytes" ]; then
              # Try alternative: get from manifest list
              size_bytes=$(docker manifest inspect "$image_tag" 2>/dev/null | jq '[.layers[]?.size // 0] | add // 0')
            fi
            # Convert to human-readable
            if [ -n "$size_bytes" ] && [ "$size_bytes" != "0" ] && [ "$size_bytes" != "null" ]; then
              echo "$size_bytes" | awk '{
                if ($1 >= 1073741824) printf "%.2f GB", $1/1073741824
                else if ($1 >= 1048576) printf "%.2f MB", $1/1048576
                else if ($1 >= 1024) printf "%.2f KB", $1/1024
                else printf "%d B", $1
              }'
            else
              echo "N/A"
            fi
          }

          echo "## Ubuntu 22.04 Docker Image Sizes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Image | Compressed Size | Digest |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-----------------|--------|" >> $GITHUB_STEP_SUMMARY

          CI_BUILD_TAG="${{ needs.check-images.outputs.ubuntu-2204-ci-build-tag }}"
          CI_TEST_TAG="${{ needs.check-images.outputs.ubuntu-2204-ci-test-tag }}"
          DEV_TAG="${{ needs.check-images.outputs.ubuntu-2204-dev-tag }}"
          BASIC_DEV_TAG="${{ needs.check-images.outputs.ubuntu-2204-basic-dev-tag }}"
          BASIC_TTNN_TAG="${{ needs.check-images.outputs.ubuntu-2204-basic-ttnn-runtime-tag }}"

          echo "| CI Build | $(get_image_size "$CI_BUILD_TAG") | \`${{ steps.build-ci-build.outputs.digest }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| CI Test | $(get_image_size "$CI_TEST_TAG") | \`${{ steps.build-ci-test.outputs.digest }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Dev | $(get_image_size "$DEV_TAG") | \`${{ steps.build-dev.outputs.digest }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Basic Dev | $(get_image_size "$BASIC_DEV_TAG") | \`${{ steps.build-basic-dev.outputs.digest }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Basic TTNN Runtime | $(get_image_size "$BASIC_TTNN_TAG") | \`${{ steps.build-basic-ttnn-runtime.outputs.digest }}\` |" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Raw Image Inspection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details><summary>CI Build image details</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          docker buildx imagetools inspect "$CI_BUILD_TAG" >> $GITHUB_STEP_SUMMARY 2>&1 || echo "Failed to inspect" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details><summary>CI Test image details</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          docker buildx imagetools inspect "$CI_TEST_TAG" >> $GITHUB_STEP_SUMMARY 2>&1 || echo "Failed to inspect" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details><summary>Dev image details</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          docker buildx imagetools inspect "$DEV_TAG" >> $GITHUB_STEP_SUMMARY 2>&1 || echo "Failed to inspect" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details><summary>Basic Dev image details</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          docker buildx imagetools inspect "$BASIC_DEV_TAG" >> $GITHUB_STEP_SUMMARY 2>&1 || echo "Failed to inspect" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details><summary>Basic TTNN Runtime image details</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          docker buildx imagetools inspect "$BASIC_TTNN_TAG" >> $GITHUB_STEP_SUMMARY 2>&1 || echo "Failed to inspect" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY

  # Build Ubuntu 24.04 images
  build-ubuntu-2404:
    name: "ðŸ³ Ubuntu 24.04"
    needs: check-images
    if: needs.check-images.outputs.ubuntu-2404-needs-build == 'true'
    timeout-minutes: 90
    runs-on: tt-ubuntu-2204-large-stable
    steps:
      - name: â¬‡ï¸ Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: https://ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            env.HTTP_PROXY=proxy.restricted-proxy.svc.cluster.local:3128
            env.HTTPS_PROXY=proxy.restricted-proxy.svc.cluster.local:3128
            env.NO_PROXY=large-file-cache.large-file-cache.svc.cluster.local,harbor.*.tenstorrent.net
          buildkitd-config-inline: |
            [registry."docker.io"]
              mirrors = ["mirror.gcr.io"]
      - name: Build and push CI Build image
        id: build-ci-build
        uses: docker/build-push-action@v6
        with:
          context: ${{ github.workspace }}
          file: dockerfile/Dockerfile
          target: ci-build
          push: true
          tags: ${{ needs.check-images.outputs.ubuntu-2404-ci-build-tag }}
          build-args: UBUNTU_VERSION=24.04
          cache-to: type=inline
          pull: true
          outputs: |
            type=image,compression=zstd,compression-level=9,force-compression=true,oci-mediatypes=true
      - name: Build and push CI Test image
        id: build-ci-test
        uses: docker/build-push-action@v6
        with:
          context: ${{ github.workspace }}
          file: dockerfile/Dockerfile
          target: ci-test
          push: true
          tags: ${{ needs.check-images.outputs.ubuntu-2404-ci-test-tag }}
          build-args: UBUNTU_VERSION=24.04
          cache-to: type=inline
          pull: true
          outputs: |
            type=image,compression=zstd,compression-level=9,force-compression=true,oci-mediatypes=true
      - name: Build and push Dev image
        id: build-dev
        uses: docker/build-push-action@v6
        with:
          context: ${{ github.workspace }}
          file: dockerfile/Dockerfile
          target: dev
          push: true
          tags: ${{ needs.check-images.outputs.ubuntu-2404-dev-tag }}
          build-args: UBUNTU_VERSION=24.04
          cache-to: type=inline
          pull: true
          outputs: |
            type=image,compression=zstd,compression-level=9,force-compression=true,oci-mediatypes=true
      - name: Build and push Basic Dev image
        id: build-basic-dev
        uses: docker/build-push-action@v6
        with:
          context: ${{ github.workspace }}
          file: dockerfile/Dockerfile.basic-dev
          target: base
          push: true
          tags: ${{ needs.check-images.outputs.ubuntu-2404-basic-dev-tag }}
          build-args: UBUNTU_VERSION=24.04
          cache-to: type=inline
          pull: true
          outputs: |
            type=image,compression=zstd,compression-level=9,force-compression=true,oci-mediatypes=true
      - name: Build and push Basic TTNN runtime image
        id: build-basic-ttnn-runtime
        uses: docker/build-push-action@v6
        with:
          context: ${{ github.workspace }}
          file: dockerfile/Dockerfile.basic-dev
          target: basic-ttnn-runtime
          push: true
          tags: ${{ needs.check-images.outputs.ubuntu-2404-basic-ttnn-runtime-tag }}
          build-args: UBUNTU_VERSION=24.04
          cache-to: type=inline
          pull: true
          outputs: |
            type=image,compression=zstd,compression-level=9,force-compression=true,oci-mediatypes=true
      - name: ðŸ“Š Show Ubuntu 24.04 image sizes
        run: |
          # Function to get image size in human-readable format
          get_image_size() {
            local image_tag="$1"
            # Get total size from manifest (sum of all layer sizes)
            local size_bytes=$(docker buildx imagetools inspect "$image_tag" --raw | jq '[.layers[].size] | add // 0')
            if [ "$size_bytes" = "0" ] || [ -z "$size_bytes" ]; then
              # Try alternative: get from manifest list
              size_bytes=$(docker manifest inspect "$image_tag" 2>/dev/null | jq '[.layers[]?.size // 0] | add // 0')
            fi
            # Convert to human-readable
            if [ -n "$size_bytes" ] && [ "$size_bytes" != "0" ] && [ "$size_bytes" != "null" ]; then
              echo "$size_bytes" | awk '{
                if ($1 >= 1073741824) printf "%.2f GB", $1/1073741824
                else if ($1 >= 1048576) printf "%.2f MB", $1/1048576
                else if ($1 >= 1024) printf "%.2f KB", $1/1024
                else printf "%d B", $1
              }'
            else
              echo "N/A"
            fi
          }

          echo "## Ubuntu 24.04 Docker Image Sizes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Image | Compressed Size | Digest |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-----------------|--------|" >> $GITHUB_STEP_SUMMARY

          CI_BUILD_TAG="${{ needs.check-images.outputs.ubuntu-2404-ci-build-tag }}"
          CI_TEST_TAG="${{ needs.check-images.outputs.ubuntu-2404-ci-test-tag }}"
          DEV_TAG="${{ needs.check-images.outputs.ubuntu-2404-dev-tag }}"
          BASIC_DEV_TAG="${{ needs.check-images.outputs.ubuntu-2404-basic-dev-tag }}"
          BASIC_TTNN_TAG="${{ needs.check-images.outputs.ubuntu-2404-basic-ttnn-runtime-tag }}"

          echo "| CI Build | $(get_image_size "$CI_BUILD_TAG") | \`${{ steps.build-ci-build.outputs.digest }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| CI Test | $(get_image_size "$CI_TEST_TAG") | \`${{ steps.build-ci-test.outputs.digest }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Dev | $(get_image_size "$DEV_TAG") | \`${{ steps.build-dev.outputs.digest }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Basic Dev | $(get_image_size "$BASIC_DEV_TAG") | \`${{ steps.build-basic-dev.outputs.digest }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Basic TTNN Runtime | $(get_image_size "$BASIC_TTNN_TAG") | \`${{ steps.build-basic-ttnn-runtime.outputs.digest }}\` |" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Raw Image Inspection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details><summary>CI Build image details</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          docker buildx imagetools inspect "$CI_BUILD_TAG" >> $GITHUB_STEP_SUMMARY 2>&1 || echo "Failed to inspect" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details><summary>CI Test image details</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          docker buildx imagetools inspect "$CI_TEST_TAG" >> $GITHUB_STEP_SUMMARY 2>&1 || echo "Failed to inspect" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details><summary>Dev image details</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          docker buildx imagetools inspect "$DEV_TAG" >> $GITHUB_STEP_SUMMARY 2>&1 || echo "Failed to inspect" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details><summary>Basic Dev image details</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          docker buildx imagetools inspect "$BASIC_DEV_TAG" >> $GITHUB_STEP_SUMMARY 2>&1 || echo "Failed to inspect" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details><summary>Basic TTNN Runtime image details</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          docker buildx imagetools inspect "$BASIC_TTNN_TAG" >> $GITHUB_STEP_SUMMARY 2>&1 || echo "Failed to inspect" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY

  # Build ManyLinux image
  build-manylinux:
    name: "ðŸ³ ManyLinux"
    needs: check-images
    if: needs.check-images.outputs.manylinux-needs-build == 'true'
    timeout-minutes: 90
    runs-on: tt-ubuntu-2204-large-stable
    steps:
      - name: â¬‡ï¸ Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: https://ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            env.HTTP_PROXY=proxy.restricted-proxy.svc.cluster.local:3128
            env.HTTPS_PROXY=proxy.restricted-proxy.svc.cluster.local:3128
            env.NO_PROXY=large-file-cache.large-file-cache.svc.cluster.local,harbor.*.tenstorrent.net
          buildkitd-config-inline: |
            [registry."docker.io"]
              mirrors = ["mirror.gcr.io"]
      - name: Build and push ManyLinux image
        id: build-manylinux
        uses: docker/build-push-action@v6
        with:
          context: ${{ github.workspace }}
          file: dockerfile/Dockerfile.manylinux
          push: true
          tags: ${{ needs.check-images.outputs.manylinux-tag }}
          cache-to: type=inline
          pull: true
          outputs: |
            type=image,compression=zstd,compression-level=9,force-compression=true,oci-mediatypes=true
      - name: ðŸ“Š Show ManyLinux image size
        run: |
          # Function to get image size in human-readable format
          get_image_size() {
            local image_tag="$1"
            # Get total size from manifest (sum of all layer sizes)
            local size_bytes=$(docker buildx imagetools inspect "$image_tag" --raw | jq '[.layers[].size] | add // 0')
            if [ "$size_bytes" = "0" ] || [ -z "$size_bytes" ]; then
              # Try alternative: get from manifest list
              size_bytes=$(docker manifest inspect "$image_tag" 2>/dev/null | jq '[.layers[]?.size // 0] | add // 0')
            fi
            # Convert to human-readable
            if [ -n "$size_bytes" ] && [ "$size_bytes" != "0" ] && [ "$size_bytes" != "null" ]; then
              echo "$size_bytes" | awk '{
                if ($1 >= 1073741824) printf "%.2f GB", $1/1073741824
                else if ($1 >= 1048576) printf "%.2f MB", $1/1048576
                else if ($1 >= 1024) printf "%.2f KB", $1/1024
                else printf "%d B", $1
              }'
            else
              echo "N/A"
            fi
          }

          MANYLINUX_TAG="${{ needs.check-images.outputs.manylinux-tag }}"

          echo "## ManyLinux Docker Image Size" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Image | Compressed Size | Digest |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-----------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ManyLinux | $(get_image_size "$MANYLINUX_TAG") | \`${{ steps.build-manylinux.outputs.digest }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Raw Image Inspection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          docker buildx imagetools inspect "$MANYLINUX_TAG" >> $GITHUB_STEP_SUMMARY 2>&1 || echo "Failed to inspect" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # Update latest tags on main
  tag-latest:
    name: "ðŸ”„ Update latest tags"
    needs: [check-images, build-ubuntu-2204, build-ubuntu-2404, build-manylinux]
    if: always() && github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: "Push latest Ubuntu 22.04 Dev tag"
        if: needs.check-images.outputs.ubuntu-2204-needs-build != 'true' || needs.build-ubuntu-2204.result == 'success'
        uses: ./.github/actions/push-latest-image-to-ghcr
        with:
          docker-image-tag: ${{ needs.check-images.outputs.ubuntu-2204-dev-tag }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Push latest Ubuntu 24.04 Dev tag"
        if: needs.check-images.outputs.ubuntu-2404-needs-build != 'true' || needs.build-ubuntu-2404.result == 'success'
        uses: ./.github/actions/push-latest-image-to-ghcr
        with:
          docker-image-tag: ${{ needs.check-images.outputs.ubuntu-2404-dev-tag }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Push latest ManyLinux tag"
        if: needs.check-images.outputs.manylinux-needs-build != 'true' || needs.build-manylinux.result == 'success'
        uses: ./.github/actions/push-latest-image-to-ghcr
        with:
          docker-image-tag: ${{ needs.check-images.outputs.manylinux-tag }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
