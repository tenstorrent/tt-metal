name: "Build all Docker images"
# =============================================================================
# This workflow builds ALL Docker images needed by the CI pipeline in parallel.
# It should be called once at the start of the pipeline (e.g., by merge-gate.yaml),
# and all subsequent jobs should use the pre-built images via the outputs.
#
# NAMING CONVENTION: Outputs use "ubuntu-XXXX-*-tag" format to distinguish
# platform-specific images. These map to build-artifact.yaml inputs like:
#   ci-build-docker-image: ${{ needs.docker-images.outputs.ubuntu-2204-ci-build-tag }}
#
# TOOL IMAGES: This workflow depends on build-docker-artifact.yaml to build and
# cache tool images (ccache, mold, cmake, etc.). Tool image tags are computed
# locally and passed as build-args to ensure consistency with the single-platform
# workflow.
# =============================================================================

on:
  workflow_call:
    outputs:
      # Ubuntu 22.04 images
      ubuntu-2204-ci-build-tag:
        description: "Docker tag for Ubuntu 22.04 CI Build image"
        value: ${{ jobs.check-images.outputs.ubuntu-2204-ci-build-tag }}
      ubuntu-2204-ci-test-tag:
        description: "Docker tag for Ubuntu 22.04 CI Test image"
        value: ${{ jobs.check-images.outputs.ubuntu-2204-ci-test-tag }}
      ubuntu-2204-dev-tag:
        description: "Docker tag for Ubuntu 22.04 Dev image"
        value: ${{ jobs.check-images.outputs.ubuntu-2204-dev-tag }}
      ubuntu-2204-basic-dev-tag:
        description: "Docker tag for Ubuntu 22.04 Basic Dev image"
        value: ${{ jobs.check-images.outputs.ubuntu-2204-basic-dev-tag }}
      ubuntu-2204-basic-ttnn-runtime-tag:
        description: "Docker tag for Ubuntu 22.04 Basic TTNN Runtime image"
        value: ${{ jobs.check-images.outputs.ubuntu-2204-basic-ttnn-runtime-tag }}
      # Ubuntu 24.04 images
      ubuntu-2404-ci-build-tag:
        description: "Docker tag for Ubuntu 24.04 CI Build image"
        value: ${{ jobs.check-images.outputs.ubuntu-2404-ci-build-tag }}
      ubuntu-2404-ci-test-tag:
        description: "Docker tag for Ubuntu 24.04 CI Test image"
        value: ${{ jobs.check-images.outputs.ubuntu-2404-ci-test-tag }}
      ubuntu-2404-dev-tag:
        description: "Docker tag for Ubuntu 24.04 Dev image"
        value: ${{ jobs.check-images.outputs.ubuntu-2404-dev-tag }}
      ubuntu-2404-basic-dev-tag:
        description: "Docker tag for Ubuntu 24.04 Basic Dev image"
        value: ${{ jobs.check-images.outputs.ubuntu-2404-basic-dev-tag }}
      ubuntu-2404-basic-ttnn-runtime-tag:
        description: "Docker tag for Ubuntu 24.04 Basic TTNN Runtime image"
        value: ${{ jobs.check-images.outputs.ubuntu-2404-basic-ttnn-runtime-tag }}
      # ManyLinux image (shared)
      manylinux-tag:
        description: "Docker tag for ManyLinux image"
        value: ${{ jobs.check-images.outputs.manylinux-tag }}
  workflow_dispatch:

permissions:
  packages: write

jobs:
  check-images:
    name: "üîç Check existing images"
    runs-on: ubuntu-latest
    outputs:
      # Ubuntu 22.04
      ubuntu-2204-ci-build-tag: ${{ steps.ubuntu-2204-tags.outputs.ci-build-tag }}
      ubuntu-2204-ci-test-tag: ${{ steps.ubuntu-2204-tags.outputs.ci-test-tag }}
      ubuntu-2204-dev-tag: ${{ steps.ubuntu-2204-tags.outputs.dev-tag }}
      ubuntu-2204-basic-dev-tag: ${{ steps.ubuntu-2204-tags.outputs.basic-dev-tag }}
      ubuntu-2204-basic-ttnn-runtime-tag: ${{ steps.ubuntu-2204-tags.outputs.basic-ttnn-runtime-tag }}
      ubuntu-2204-needs-build: ${{ steps.ubuntu-2204-check.outputs.needs-build }}
      # Ubuntu 24.04
      ubuntu-2404-ci-build-tag: ${{ steps.ubuntu-2404-tags.outputs.ci-build-tag }}
      ubuntu-2404-ci-test-tag: ${{ steps.ubuntu-2404-tags.outputs.ci-test-tag }}
      ubuntu-2404-dev-tag: ${{ steps.ubuntu-2404-tags.outputs.dev-tag }}
      ubuntu-2404-basic-dev-tag: ${{ steps.ubuntu-2404-tags.outputs.basic-dev-tag }}
      ubuntu-2404-basic-ttnn-runtime-tag: ${{ steps.ubuntu-2404-tags.outputs.basic-ttnn-runtime-tag }}
      ubuntu-2404-needs-build: ${{ steps.ubuntu-2404-check.outputs.needs-build }}
      # ManyLinux
      manylinux-tag: ${{ steps.manylinux-tags.outputs.manylinux-tag }}
      manylinux-needs-build: ${{ steps.manylinux-check.outputs.needs-build }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # Compute Ubuntu 22.04 tags
      - name: Compute Ubuntu 22.04 tags
        id: ubuntu-2204-tags
        run: |
          # Extra files not in COPY but affect the image
          EXTRA_FILES=".github/workflows/build-docker-artifact.yaml"

          HASH=$(.github/scripts/dockerfile-hash.sh dockerfile/Dockerfile $EXTRA_FILES)
          ARCH="amd64"
          echo "ci-build-tag=ghcr.io/${{ github.repository }}/tt-metalium/ubuntu-22.04-ci-build-${ARCH}:${HASH}" >> $GITHUB_OUTPUT
          echo "ci-test-tag=ghcr.io/${{ github.repository }}/tt-metalium/ubuntu-22.04-ci-test-${ARCH}:${HASH}" >> $GITHUB_OUTPUT
          echo "dev-tag=ghcr.io/${{ github.repository }}/tt-metalium/ubuntu-22.04-dev-${ARCH}:${HASH}" >> $GITHUB_OUTPUT

          BASIC_DEV_HASH=$(.github/scripts/dockerfile-hash.sh dockerfile/Dockerfile.basic-dev)
          echo "basic-dev-tag=ghcr.io/${{ github.repository }}/tt-metalium/ubuntu-22.04-basic-dev-${ARCH}:${BASIC_DEV_HASH}" >> $GITHUB_OUTPUT

          BASIC_TTNN_RUNTIME_HASH=$(.github/scripts/dockerfile-hash.sh dockerfile/Dockerfile.basic-dev)
          echo "basic-ttnn-runtime-tag=ghcr.io/${{ github.repository }}/tt-metalium/ubuntu-22.04-basic-ttnn-runtime-${ARCH}:${BASIC_TTNN_RUNTIME_HASH}" >> $GITHUB_OUTPUT

      - name: Check Ubuntu 22.04 images exist
        id: ubuntu-2204-check
        run: |
          if docker manifest inspect ${{ steps.ubuntu-2204-tags.outputs.dev-tag }} > /dev/null 2>&1; then
            echo "Ubuntu 22.04 images exist"
            echo "needs-build=false" >> $GITHUB_OUTPUT
          else
            echo "Ubuntu 22.04 images need to be built"
            echo "needs-build=true" >> $GITHUB_OUTPUT
          fi

      # Compute Ubuntu 24.04 tags
      - name: Compute Ubuntu 24.04 tags
        id: ubuntu-2404-tags
        run: |
          EXTRA_FILES=".github/workflows/build-docker-artifact.yaml"

          HASH=$(.github/scripts/dockerfile-hash.sh dockerfile/Dockerfile $EXTRA_FILES)
          ARCH="amd64"
          echo "ci-build-tag=ghcr.io/${{ github.repository }}/tt-metalium/ubuntu-24.04-ci-build-${ARCH}:${HASH}" >> $GITHUB_OUTPUT
          echo "ci-test-tag=ghcr.io/${{ github.repository }}/tt-metalium/ubuntu-24.04-ci-test-${ARCH}:${HASH}" >> $GITHUB_OUTPUT
          echo "dev-tag=ghcr.io/${{ github.repository }}/tt-metalium/ubuntu-24.04-dev-${ARCH}:${HASH}" >> $GITHUB_OUTPUT

          BASIC_DEV_HASH=$(.github/scripts/dockerfile-hash.sh dockerfile/Dockerfile.basic-dev)
          echo "basic-dev-tag=ghcr.io/${{ github.repository }}/tt-metalium/ubuntu-24.04-basic-dev-${ARCH}:${BASIC_DEV_HASH}" >> $GITHUB_OUTPUT

          BASIC_TTNN_RUNTIME_HASH=$(.github/scripts/dockerfile-hash.sh dockerfile/Dockerfile.basic-dev)
          echo "basic-ttnn-runtime-tag=ghcr.io/${{ github.repository }}/tt-metalium/ubuntu-24.04-basic-ttnn-runtime-${ARCH}:${BASIC_TTNN_RUNTIME_HASH}" >> $GITHUB_OUTPUT

      - name: Check Ubuntu 24.04 images exist
        id: ubuntu-2404-check
        run: |
          if docker manifest inspect ${{ steps.ubuntu-2404-tags.outputs.dev-tag }} > /dev/null 2>&1; then
            echo "Ubuntu 24.04 images exist"
            echo "needs-build=false" >> $GITHUB_OUTPUT
          else
            echo "Ubuntu 24.04 images need to be built"
            echo "needs-build=true" >> $GITHUB_OUTPUT
          fi

      # Compute ManyLinux tags
      - name: Compute ManyLinux tags
        id: manylinux-tags
        run: |
          EXTRA_FILES=".github/workflows/build-docker-artifact.yaml"

          MANYLINUX_HASH=$(.github/scripts/dockerfile-hash.sh dockerfile/Dockerfile.manylinux $EXTRA_FILES)
          echo "manylinux-tag=ghcr.io/${{ github.repository }}/tt-metalium/manylinux-amd64:${MANYLINUX_HASH}" >> $GITHUB_OUTPUT

      - name: Check ManyLinux image exists
        id: manylinux-check
        run: |
          if docker manifest inspect ${{ steps.manylinux-tags.outputs.manylinux-tag }} > /dev/null 2>&1; then
            echo "ManyLinux image exists"
            echo "needs-build=false" >> $GITHUB_OUTPUT
          else
            echo "ManyLinux image needs to be built"
            echo "needs-build=true" >> $GITHUB_OUTPUT
          fi

  # =============================================================================
  # TOOL IMAGES: Check and build third-party tool images
  # =============================================================================
  # These images contain pre-built binaries for tools like ccache, mold, etc.
  # They are built once and pushed to GHCR, then pulled by the main Dockerfile.
  # This eliminates repeated downloads from upstream sources.
  # =============================================================================

  check-tool-images:
    name: "üîß Check tool images"
    runs-on: ubuntu-latest
    outputs:
      ccache-tag: ${{ steps.tags.outputs.ccache-tag }}
      ccache-exists: ${{ steps.check.outputs.ccache-exists }}
      mold-tag: ${{ steps.tags.outputs.mold-tag }}
      mold-exists: ${{ steps.check.outputs.mold-exists }}
      doxygen-tag: ${{ steps.tags.outputs.doxygen-tag }}
      doxygen-exists: ${{ steps.check.outputs.doxygen-exists }}
      cba-tag: ${{ steps.tags.outputs.cba-tag }}
      cba-exists: ${{ steps.check.outputs.cba-exists }}
      gdb-tag: ${{ steps.tags.outputs.gdb-tag }}
      gdb-exists: ${{ steps.check.outputs.gdb-exists }}
      cmake-tag: ${{ steps.tags.outputs.cmake-tag }}
      cmake-exists: ${{ steps.check.outputs.cmake-exists }}
      yq-tag: ${{ steps.tags.outputs.yq-tag }}
      yq-exists: ${{ steps.check.outputs.yq-exists }}
      any-missing: ${{ steps.check.outputs.any-missing }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Compute tool image tags
        id: tags
        run: |
          # Extract versions from Dockerfile.tools
          CCACHE_VERSION=$(grep -E "^ARG CCACHE_VERSION=" dockerfile/Dockerfile.tools | cut -d= -f2)
          MOLD_VERSION=$(grep -E "^ARG MOLD_VERSION=" dockerfile/Dockerfile.tools | cut -d= -f2)
          DOXYGEN_VERSION=$(grep -E "^ARG DOXYGEN_VERSION=" dockerfile/Dockerfile.tools | cut -d= -f2)
          CBA_VERSION=$(grep -E "^ARG CBA_VERSION=" dockerfile/Dockerfile.tools | cut -d= -f2)
          GDB_VERSION=$(grep -E "^ARG GDB_VERSION=" dockerfile/Dockerfile.tools | cut -d= -f2)
          CMAKE_VERSION=$(grep -E "^ARG CMAKE_VERSION=" dockerfile/Dockerfile.tools | cut -d= -f2)
          YQ_VERSION=$(grep -E "^ARG YQ_VERSION=" dockerfile/Dockerfile.tools | cut -d= -f2)

          # Compute hashes for each tool (version + install script)
          CCACHE_HASH=$(cat dockerfile/scripts/install-ccache.sh | sha1sum | cut -d' ' -f1 | head -c 8)
          MOLD_HASH=$(cat dockerfile/scripts/install-mold.sh | sha1sum | cut -d' ' -f1 | head -c 8)
          DOXYGEN_HASH=$(cat dockerfile/scripts/install-doxygen.sh | sha1sum | cut -d' ' -f1 | head -c 8)
          CBA_HASH=$(cat dockerfile/scripts/install-clangbuildanalyzer.sh | sha1sum | cut -d' ' -f1 | head -c 8)
          GDB_HASH=$(cat dockerfile/scripts/install-gdb.sh | sha1sum | cut -d' ' -f1 | head -c 8)
          CMAKE_HASH=$(cat dockerfile/scripts/install-cmake.sh | sha1sum | cut -d' ' -f1 | head -c 8)
          YQ_HASH=$(cat dockerfile/scripts/install-yq.sh | sha1sum | cut -d' ' -f1 | head -c 8)

          # Generate tags: ghcr.io/<repo>/tt-metalium/tools/<tool>:<version>-<hash>
          BASE="ghcr.io/${{ github.repository }}/tt-metalium/tools"
          echo "ccache-tag=${BASE}/ccache:${CCACHE_VERSION}-${CCACHE_HASH}" >> $GITHUB_OUTPUT
          echo "mold-tag=${BASE}/mold:${MOLD_VERSION}-${MOLD_HASH}" >> $GITHUB_OUTPUT
          echo "doxygen-tag=${BASE}/doxygen:${DOXYGEN_VERSION}-${DOXYGEN_HASH}" >> $GITHUB_OUTPUT
          echo "cba-tag=${BASE}/cba:${CBA_VERSION}-${CBA_HASH}" >> $GITHUB_OUTPUT
          echo "gdb-tag=${BASE}/gdb:${GDB_VERSION}-${GDB_HASH}" >> $GITHUB_OUTPUT
          echo "cmake-tag=${BASE}/cmake:${CMAKE_VERSION}-${CMAKE_HASH}" >> $GITHUB_OUTPUT
          echo "yq-tag=${BASE}/yq:${YQ_VERSION}-${YQ_HASH}" >> $GITHUB_OUTPUT

      - name: Check if tool images exist
        id: check
        run: |
          check_image() {
            local tag="$1"
            local name="$2"
            if docker manifest inspect "$tag" > /dev/null 2>&1; then
              echo "$tag exists"
              echo "${name}-exists=true" >> $GITHUB_OUTPUT
            else
              echo "$tag does not exist"
              echo "${name}-exists=false" >> $GITHUB_OUTPUT
            fi
          }

          check_image "${{ steps.tags.outputs.ccache-tag }}" "ccache"
          check_image "${{ steps.tags.outputs.mold-tag }}" "mold"
          check_image "${{ steps.tags.outputs.doxygen-tag }}" "doxygen"
          check_image "${{ steps.tags.outputs.cba-tag }}" "cba"
          check_image "${{ steps.tags.outputs.gdb-tag }}" "gdb"
          check_image "${{ steps.tags.outputs.cmake-tag }}" "cmake"
          check_image "${{ steps.tags.outputs.yq-tag }}" "yq"

          # Check if any are missing
          if ! docker manifest inspect "${{ steps.tags.outputs.ccache-tag }}" > /dev/null 2>&1 || \
             ! docker manifest inspect "${{ steps.tags.outputs.mold-tag }}" > /dev/null 2>&1 || \
             ! docker manifest inspect "${{ steps.tags.outputs.doxygen-tag }}" > /dev/null 2>&1 || \
             ! docker manifest inspect "${{ steps.tags.outputs.cba-tag }}" > /dev/null 2>&1 || \
             ! docker manifest inspect "${{ steps.tags.outputs.gdb-tag }}" > /dev/null 2>&1 || \
             ! docker manifest inspect "${{ steps.tags.outputs.cmake-tag }}" > /dev/null 2>&1 || \
             ! docker manifest inspect "${{ steps.tags.outputs.yq-tag }}" > /dev/null 2>&1; then
            echo "any-missing=true" >> $GITHUB_OUTPUT
          else
            echo "any-missing=false" >> $GITHUB_OUTPUT
          fi

  build-tool-images:
    name: "üîß Build tool images"
    needs: check-tool-images
    if: needs.check-tool-images.outputs.any-missing == 'true'
    timeout-minutes: 30
    runs-on: ubuntu-latest
    steps:
      - name: ‚¨áÔ∏è Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: https://ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push ccache image
        if: needs.check-tool-images.outputs.ccache-exists != 'true'
        uses: docker/build-push-action@v6
        with:
          context: ${{ github.workspace }}
          file: dockerfile/Dockerfile.tools
          target: ccache
          push: true
          tags: ${{ needs.check-tool-images.outputs.ccache-tag }}

      - name: Build and push mold image
        if: needs.check-tool-images.outputs.mold-exists != 'true'
        uses: docker/build-push-action@v6
        with:
          context: ${{ github.workspace }}
          file: dockerfile/Dockerfile.tools
          target: mold
          push: true
          tags: ${{ needs.check-tool-images.outputs.mold-tag }}

      - name: Build and push doxygen image
        if: needs.check-tool-images.outputs.doxygen-exists != 'true'
        uses: docker/build-push-action@v6
        with:
          context: ${{ github.workspace }}
          file: dockerfile/Dockerfile.tools
          target: doxygen
          push: true
          tags: ${{ needs.check-tool-images.outputs.doxygen-tag }}

      - name: Build and push ClangBuildAnalyzer image
        if: needs.check-tool-images.outputs.cba-exists != 'true'
        uses: docker/build-push-action@v6
        with:
          context: ${{ github.workspace }}
          file: dockerfile/Dockerfile.tools
          target: cba
          push: true
          tags: ${{ needs.check-tool-images.outputs.cba-tag }}

      - name: Build and push GDB image
        if: needs.check-tool-images.outputs.gdb-exists != 'true'
        uses: docker/build-push-action@v6
        with:
          context: ${{ github.workspace }}
          file: dockerfile/Dockerfile.tools
          target: gdb
          push: true
          tags: ${{ needs.check-tool-images.outputs.gdb-tag }}

      - name: Build and push cmake image
        if: needs.check-tool-images.outputs.cmake-exists != 'true'
        uses: docker/build-push-action@v6
        with:
          context: ${{ github.workspace }}
          file: dockerfile/Dockerfile.tools
          target: cmake
          push: true
          tags: ${{ needs.check-tool-images.outputs.cmake-tag }}

      - name: Build and push yq image
        if: needs.check-tool-images.outputs.yq-exists != 'true'
        uses: docker/build-push-action@v6
        with:
          context: ${{ github.workspace }}
          file: dockerfile/Dockerfile.tools
          target: yq
          push: true
          tags: ${{ needs.check-tool-images.outputs.yq-tag }}

  # =============================================================================
  # PYTHON VENV IMAGES: Check and build pre-built Python virtual environments
  # =============================================================================
  # These images contain pre-built Python virtual environments with all dependencies
  # installed. They are built once per requirements change and pushed to GHCR.
  # Using pre-built venvs saves 5-10 minutes per build.
  # Separate images are needed for Ubuntu 22.04 (Python 3.10) and 24.04 (Python 3.12).
  # =============================================================================

  check-python-venv-images:
    name: "üêç Check Python venv images"
    runs-on: ubuntu-latest
    outputs:
      # Ubuntu 22.04
      ubuntu-2204-ci-build-venv-tag: ${{ steps.tags.outputs.ubuntu-2204-ci-build-venv-tag }}
      ubuntu-2204-ci-build-venv-exists: ${{ steps.check.outputs.ubuntu-2204-ci-build-venv-exists }}
      ubuntu-2204-ci-test-venv-tag: ${{ steps.tags.outputs.ubuntu-2204-ci-test-venv-tag }}
      ubuntu-2204-ci-test-venv-exists: ${{ steps.check.outputs.ubuntu-2204-ci-test-venv-exists }}
      # Ubuntu 24.04
      ubuntu-2404-ci-build-venv-tag: ${{ steps.tags.outputs.ubuntu-2404-ci-build-venv-tag }}
      ubuntu-2404-ci-build-venv-exists: ${{ steps.check.outputs.ubuntu-2404-ci-build-venv-exists }}
      ubuntu-2404-ci-test-venv-tag: ${{ steps.tags.outputs.ubuntu-2404-ci-test-venv-tag }}
      ubuntu-2404-ci-test-venv-exists: ${{ steps.check.outputs.ubuntu-2404-ci-test-venv-exists }}
      any-missing: ${{ steps.check.outputs.any-missing }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Compute Python venv image tags
        id: tags
        run: |
          # Hash requirements files + Dockerfile.python to detect changes
          VENV_HASH=$(cat \
            dockerfile/Dockerfile.python \
            tt_metal/python_env/requirements-dev.txt \
            docs/requirements-docs.txt \
            tests/sweep_framework/requirements-sweeps.txt \
            tools/triage/requirements.txt \
            | sha1sum | cut -d' ' -f1 | head -c 12)

          # Generate tags for both Ubuntu versions
          BASE="ghcr.io/${{ github.repository }}/tt-metalium/python-venv"

          # Ubuntu 22.04
          echo "ubuntu-2204-ci-build-venv-tag=${BASE}/ci-build:2204-${VENV_HASH}" >> $GITHUB_OUTPUT
          echo "ubuntu-2204-ci-test-venv-tag=${BASE}/ci-test:2204-${VENV_HASH}" >> $GITHUB_OUTPUT

          # Ubuntu 24.04
          echo "ubuntu-2404-ci-build-venv-tag=${BASE}/ci-build:2404-${VENV_HASH}" >> $GITHUB_OUTPUT
          echo "ubuntu-2404-ci-test-venv-tag=${BASE}/ci-test:2404-${VENV_HASH}" >> $GITHUB_OUTPUT

      - name: Check if Python venv images exist
        id: check
        run: |
          check_image() {
            local tag="$1"
            local name="$2"
            if docker manifest inspect "$tag" > /dev/null 2>&1; then
              echo "$tag exists"
              echo "${name}-exists=true" >> $GITHUB_OUTPUT
            else
              echo "$tag does not exist"
              echo "${name}-exists=false" >> $GITHUB_OUTPUT
            fi
          }

          # Check Ubuntu 22.04 images
          check_image "${{ steps.tags.outputs.ubuntu-2204-ci-build-venv-tag }}" "ubuntu-2204-ci-build-venv"
          check_image "${{ steps.tags.outputs.ubuntu-2204-ci-test-venv-tag }}" "ubuntu-2204-ci-test-venv"

          # Check Ubuntu 24.04 images
          check_image "${{ steps.tags.outputs.ubuntu-2404-ci-build-venv-tag }}" "ubuntu-2404-ci-build-venv"
          check_image "${{ steps.tags.outputs.ubuntu-2404-ci-test-venv-tag }}" "ubuntu-2404-ci-test-venv"

          # Check if any are missing
          if ! docker manifest inspect "${{ steps.tags.outputs.ubuntu-2204-ci-build-venv-tag }}" > /dev/null 2>&1 || \
             ! docker manifest inspect "${{ steps.tags.outputs.ubuntu-2204-ci-test-venv-tag }}" > /dev/null 2>&1 || \
             ! docker manifest inspect "${{ steps.tags.outputs.ubuntu-2404-ci-build-venv-tag }}" > /dev/null 2>&1 || \
             ! docker manifest inspect "${{ steps.tags.outputs.ubuntu-2404-ci-test-venv-tag }}" > /dev/null 2>&1; then
            echo "any-missing=true" >> $GITHUB_OUTPUT
          else
            echo "any-missing=false" >> $GITHUB_OUTPUT
          fi

  build-python-venv-images:
    name: "üêç Build Python venv images"
    needs: check-python-venv-images
    if: needs.check-python-venv-images.outputs.any-missing == 'true'
    timeout-minutes: 45
    runs-on: ubuntu-latest
    steps:
      - name: ‚¨áÔ∏è Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: https://ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Ubuntu 22.04 venv images
      - name: Build and push Ubuntu 22.04 ci-build-venv image
        if: needs.check-python-venv-images.outputs.ubuntu-2204-ci-build-venv-exists != 'true'
        uses: docker/build-push-action@v6
        with:
          context: ${{ github.workspace }}
          file: dockerfile/Dockerfile.python
          target: ci-build-venv-2204
          push: true
          tags: ${{ needs.check-python-venv-images.outputs.ubuntu-2204-ci-build-venv-tag }}

      - name: Build and push Ubuntu 22.04 ci-test-venv image
        if: needs.check-python-venv-images.outputs.ubuntu-2204-ci-test-venv-exists != 'true'
        uses: docker/build-push-action@v6
        with:
          context: ${{ github.workspace }}
          file: dockerfile/Dockerfile.python
          target: ci-test-venv-2204
          push: true
          tags: ${{ needs.check-python-venv-images.outputs.ubuntu-2204-ci-test-venv-tag }}

      # Ubuntu 24.04 venv images
      - name: Build and push Ubuntu 24.04 ci-build-venv image
        if: needs.check-python-venv-images.outputs.ubuntu-2404-ci-build-venv-exists != 'true'
        uses: docker/build-push-action@v6
        with:
          context: ${{ github.workspace }}
          file: dockerfile/Dockerfile.python
          target: ci-build-venv-2404
          push: true
          tags: ${{ needs.check-python-venv-images.outputs.ubuntu-2404-ci-build-venv-tag }}

      - name: Build and push Ubuntu 24.04 ci-test-venv image
        if: needs.check-python-venv-images.outputs.ubuntu-2404-ci-test-venv-exists != 'true'
        uses: docker/build-push-action@v6
        with:
          context: ${{ github.workspace }}
          file: dockerfile/Dockerfile.python
          target: ci-test-venv-2404
          push: true
          tags: ${{ needs.check-python-venv-images.outputs.ubuntu-2404-ci-test-venv-tag }}

  # Build Ubuntu 22.04 images
  build-ubuntu-2204:
    name: "üê≥ Ubuntu 22.04"
    needs: [check-images, check-tool-images, build-tool-images, check-python-venv-images, build-python-venv-images]
    # Run if images need build AND tool/venv images are ready
    # Use always() to run even when build-tool-images or build-python-venv-images is skipped (all exist)
    if: |
      always() && !failure() && !cancelled() &&
      needs.check-images.outputs.ubuntu-2204-needs-build == 'true'
    timeout-minutes: 90
    runs-on: tt-ubuntu-2204-large-stable
    steps:
      - name: ‚¨áÔ∏è Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: https://ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and push CI Build image
        id: build-ci-build
        uses: docker/build-push-action@v6
        with:
          context: ${{ github.workspace }}
          file: dockerfile/Dockerfile
          target: ci-build
          tags: ${{ needs.check-images.outputs.ubuntu-2204-ci-build-tag }}
          build-args: |
            UBUNTU_VERSION=22.04
            TOOL_CCACHE_IMAGE=${{ needs.check-tool-images.outputs.ccache-tag }}
            TOOL_MOLD_IMAGE=${{ needs.check-tool-images.outputs.mold-tag }}
            TOOL_DOXYGEN_IMAGE=${{ needs.check-tool-images.outputs.doxygen-tag }}
            TOOL_CBA_IMAGE=${{ needs.check-tool-images.outputs.cba-tag }}
            TOOL_GDB_IMAGE=${{ needs.check-tool-images.outputs.gdb-tag }}
            TOOL_CMAKE_IMAGE=${{ needs.check-tool-images.outputs.cmake-tag }}
            TOOL_YQ_IMAGE=${{ needs.check-tool-images.outputs.yq-tag }}
            PYTHON_CI_BUILD_VENV_IMAGE=${{ needs.check-python-venv-images.outputs.ubuntu-2204-ci-build-venv-tag }}
            PYTHON_CI_TEST_VENV_IMAGE=${{ needs.check-python-venv-images.outputs.ubuntu-2204-ci-test-venv-tag }}
          cache-to: type=inline
          pull: true
          outputs: |
            type=registry,push=true,compression=zstd,compression-level=3,force-compression=true,oci-mediatypes=true
      - name: Build and push CI Test image
        id: build-ci-test
        uses: docker/build-push-action@v6
        with:
          context: ${{ github.workspace }}
          file: dockerfile/Dockerfile
          target: ci-test
          tags: ${{ needs.check-images.outputs.ubuntu-2204-ci-test-tag }}
          build-args: |
            UBUNTU_VERSION=22.04
            TOOL_CCACHE_IMAGE=${{ needs.check-tool-images.outputs.ccache-tag }}
            TOOL_MOLD_IMAGE=${{ needs.check-tool-images.outputs.mold-tag }}
            TOOL_DOXYGEN_IMAGE=${{ needs.check-tool-images.outputs.doxygen-tag }}
            TOOL_CBA_IMAGE=${{ needs.check-tool-images.outputs.cba-tag }}
            TOOL_GDB_IMAGE=${{ needs.check-tool-images.outputs.gdb-tag }}
            TOOL_CMAKE_IMAGE=${{ needs.check-tool-images.outputs.cmake-tag }}
            TOOL_YQ_IMAGE=${{ needs.check-tool-images.outputs.yq-tag }}
            PYTHON_CI_BUILD_VENV_IMAGE=${{ needs.check-python-venv-images.outputs.ubuntu-2204-ci-build-venv-tag }}
            PYTHON_CI_TEST_VENV_IMAGE=${{ needs.check-python-venv-images.outputs.ubuntu-2204-ci-test-venv-tag }}
          cache-to: type=inline
          pull: true
          outputs: |
            type=registry,push=true,compression=zstd,compression-level=3,force-compression=true,oci-mediatypes=true
      - name: Build and push Dev image
        id: build-dev
        uses: docker/build-push-action@v6
        with:
          context: ${{ github.workspace }}
          file: dockerfile/Dockerfile
          target: dev
          tags: ${{ needs.check-images.outputs.ubuntu-2204-dev-tag }}
          build-args: |
            UBUNTU_VERSION=22.04
            TOOL_CCACHE_IMAGE=${{ needs.check-tool-images.outputs.ccache-tag }}
            TOOL_MOLD_IMAGE=${{ needs.check-tool-images.outputs.mold-tag }}
            TOOL_DOXYGEN_IMAGE=${{ needs.check-tool-images.outputs.doxygen-tag }}
            TOOL_CBA_IMAGE=${{ needs.check-tool-images.outputs.cba-tag }}
            TOOL_GDB_IMAGE=${{ needs.check-tool-images.outputs.gdb-tag }}
            TOOL_CMAKE_IMAGE=${{ needs.check-tool-images.outputs.cmake-tag }}
            TOOL_YQ_IMAGE=${{ needs.check-tool-images.outputs.yq-tag }}
            PYTHON_CI_BUILD_VENV_IMAGE=${{ needs.check-python-venv-images.outputs.ubuntu-2204-ci-build-venv-tag }}
            PYTHON_CI_TEST_VENV_IMAGE=${{ needs.check-python-venv-images.outputs.ubuntu-2204-ci-test-venv-tag }}
          cache-to: type=inline
          pull: true
          outputs: |
            type=registry,push=true,compression=zstd,compression-level=3,force-compression=true,oci-mediatypes=true
      - name: Build and push Basic Dev image
        id: build-basic-dev
        uses: docker/build-push-action@v6
        with:
          context: ${{ github.workspace }}
          file: dockerfile/Dockerfile.basic-dev
          target: base
          tags: ${{ needs.check-images.outputs.ubuntu-2204-basic-dev-tag }}
          build-args: UBUNTU_VERSION=22.04
          cache-to: type=inline
          pull: true
          outputs: |
            type=registry,push=true,compression=zstd,compression-level=3,force-compression=true,oci-mediatypes=true
      - name: Build and push Basic TTNN runtime image
        id: build-basic-ttnn-runtime
        uses: docker/build-push-action@v6
        with:
          context: ${{ github.workspace }}
          file: dockerfile/Dockerfile.basic-dev
          target: basic-ttnn-runtime
          tags: ${{ needs.check-images.outputs.ubuntu-2204-basic-ttnn-runtime-tag }}
          build-args: UBUNTU_VERSION=22.04
          cache-to: type=inline
          pull: true
          outputs: |
            type=registry,push=true,compression=zstd,compression-level=3,force-compression=true,oci-mediatypes=true

  # Build Ubuntu 24.04 images
  build-ubuntu-2404:
    name: "üê≥ Ubuntu 24.04"
    needs: [check-images, check-tool-images, build-tool-images, check-python-venv-images, build-python-venv-images]
    # Run if images need build AND tool/venv images are ready
    # Use always() to run even when build-tool-images or build-python-venv-images is skipped (all exist)
    if: |
      always() && !failure() && !cancelled() &&
      needs.check-images.outputs.ubuntu-2404-needs-build == 'true'
    timeout-minutes: 90
    runs-on: tt-ubuntu-2204-large-stable
    steps:
      - name: ‚¨áÔ∏è Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: https://ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and push CI Build image
        id: build-ci-build
        uses: docker/build-push-action@v6
        with:
          context: ${{ github.workspace }}
          file: dockerfile/Dockerfile
          target: ci-build
          tags: ${{ needs.check-images.outputs.ubuntu-2404-ci-build-tag }}
          build-args: |
            UBUNTU_VERSION=24.04
            TOOL_CCACHE_IMAGE=${{ needs.check-tool-images.outputs.ccache-tag }}
            TOOL_MOLD_IMAGE=${{ needs.check-tool-images.outputs.mold-tag }}
            TOOL_DOXYGEN_IMAGE=${{ needs.check-tool-images.outputs.doxygen-tag }}
            TOOL_CBA_IMAGE=${{ needs.check-tool-images.outputs.cba-tag }}
            TOOL_GDB_IMAGE=${{ needs.check-tool-images.outputs.gdb-tag }}
            TOOL_CMAKE_IMAGE=${{ needs.check-tool-images.outputs.cmake-tag }}
            TOOL_YQ_IMAGE=${{ needs.check-tool-images.outputs.yq-tag }}
            PYTHON_CI_BUILD_VENV_IMAGE=${{ needs.check-python-venv-images.outputs.ubuntu-2404-ci-build-venv-tag }}
            PYTHON_CI_TEST_VENV_IMAGE=${{ needs.check-python-venv-images.outputs.ubuntu-2404-ci-test-venv-tag }}
          cache-to: type=inline
          pull: true
          outputs: |
            type=registry,push=true,compression=zstd,compression-level=3,force-compression=true,oci-mediatypes=true
      - name: Build and push CI Test image
        id: build-ci-test
        uses: docker/build-push-action@v6
        with:
          context: ${{ github.workspace }}
          file: dockerfile/Dockerfile
          target: ci-test
          tags: ${{ needs.check-images.outputs.ubuntu-2404-ci-test-tag }}
          build-args: |
            UBUNTU_VERSION=24.04
            TOOL_CCACHE_IMAGE=${{ needs.check-tool-images.outputs.ccache-tag }}
            TOOL_MOLD_IMAGE=${{ needs.check-tool-images.outputs.mold-tag }}
            TOOL_DOXYGEN_IMAGE=${{ needs.check-tool-images.outputs.doxygen-tag }}
            TOOL_CBA_IMAGE=${{ needs.check-tool-images.outputs.cba-tag }}
            TOOL_GDB_IMAGE=${{ needs.check-tool-images.outputs.gdb-tag }}
            TOOL_CMAKE_IMAGE=${{ needs.check-tool-images.outputs.cmake-tag }}
            TOOL_YQ_IMAGE=${{ needs.check-tool-images.outputs.yq-tag }}
            PYTHON_CI_BUILD_VENV_IMAGE=${{ needs.check-python-venv-images.outputs.ubuntu-2404-ci-build-venv-tag }}
            PYTHON_CI_TEST_VENV_IMAGE=${{ needs.check-python-venv-images.outputs.ubuntu-2404-ci-test-venv-tag }}
          cache-to: type=inline
          pull: true
          outputs: |
            type=registry,push=true,compression=zstd,compression-level=3,force-compression=true,oci-mediatypes=true
      - name: Build and push Dev image
        id: build-dev
        uses: docker/build-push-action@v6
        with:
          context: ${{ github.workspace }}
          file: dockerfile/Dockerfile
          target: dev
          tags: ${{ needs.check-images.outputs.ubuntu-2404-dev-tag }}
          build-args: |
            UBUNTU_VERSION=24.04
            TOOL_CCACHE_IMAGE=${{ needs.check-tool-images.outputs.ccache-tag }}
            TOOL_MOLD_IMAGE=${{ needs.check-tool-images.outputs.mold-tag }}
            TOOL_DOXYGEN_IMAGE=${{ needs.check-tool-images.outputs.doxygen-tag }}
            TOOL_CBA_IMAGE=${{ needs.check-tool-images.outputs.cba-tag }}
            TOOL_GDB_IMAGE=${{ needs.check-tool-images.outputs.gdb-tag }}
            TOOL_CMAKE_IMAGE=${{ needs.check-tool-images.outputs.cmake-tag }}
            TOOL_YQ_IMAGE=${{ needs.check-tool-images.outputs.yq-tag }}
            PYTHON_CI_BUILD_VENV_IMAGE=${{ needs.check-python-venv-images.outputs.ubuntu-2404-ci-build-venv-tag }}
            PYTHON_CI_TEST_VENV_IMAGE=${{ needs.check-python-venv-images.outputs.ubuntu-2404-ci-test-venv-tag }}
          cache-to: type=inline
          pull: true
          outputs: |
            type=registry,push=true,compression=zstd,compression-level=3,force-compression=true,oci-mediatypes=true
      - name: Build and push Basic Dev image
        id: build-basic-dev
        uses: docker/build-push-action@v6
        with:
          context: ${{ github.workspace }}
          file: dockerfile/Dockerfile.basic-dev
          target: base
          tags: ${{ needs.check-images.outputs.ubuntu-2404-basic-dev-tag }}
          build-args: UBUNTU_VERSION=24.04
          cache-to: type=inline
          pull: true
          outputs: |
            type=registry,push=true,compression=zstd,compression-level=3,force-compression=true,oci-mediatypes=true
      - name: Build and push Basic TTNN runtime image
        id: build-basic-ttnn-runtime
        uses: docker/build-push-action@v6
        with:
          context: ${{ github.workspace }}
          file: dockerfile/Dockerfile.basic-dev
          target: basic-ttnn-runtime
          tags: ${{ needs.check-images.outputs.ubuntu-2404-basic-ttnn-runtime-tag }}
          build-args: UBUNTU_VERSION=24.04
          cache-to: type=inline
          pull: true
          outputs: |
            type=registry,push=true,compression=zstd,compression-level=3,force-compression=true,oci-mediatypes=true

  # Build ManyLinux image
  build-manylinux:
    name: "üê≥ ManyLinux"
    needs: check-images
    if: needs.check-images.outputs.manylinux-needs-build == 'true'
    timeout-minutes: 90
    runs-on: tt-ubuntu-2204-large-stable
    steps:
      - name: ‚¨áÔ∏è Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: https://ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and push ManyLinux image
        id: build-manylinux
        uses: docker/build-push-action@v6
        with:
          context: ${{ github.workspace }}
          file: dockerfile/Dockerfile.manylinux
          tags: ${{ needs.check-images.outputs.manylinux-tag }}
          cache-to: type=inline
          pull: true
          outputs: |
            type=registry,push=true,compression=zstd,compression-level=3,force-compression=true,oci-mediatypes=true
  # Update latest tags on main
  tag-latest:
    name: "üîÑ Update latest tags"
    needs: [check-images, check-tool-images, build-tool-images, check-python-venv-images, build-python-venv-images, build-ubuntu-2204, build-ubuntu-2404, build-manylinux]
    if: always() && github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: .github/actions/push-latest-image-to-ghcr
          sparse-checkout-cone-mode: false

      - name: "Push latest Ubuntu 22.04 Dev tag"
        if: needs.check-images.outputs.ubuntu-2204-needs-build != 'true' || needs.build-ubuntu-2204.result == 'success'
        uses: ./.github/actions/push-latest-image-to-ghcr
        with:
          docker-image-tag: ${{ needs.check-images.outputs.ubuntu-2204-dev-tag }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Push latest Ubuntu 24.04 Dev tag"
        if: needs.check-images.outputs.ubuntu-2404-needs-build != 'true' || needs.build-ubuntu-2404.result == 'success'
        uses: ./.github/actions/push-latest-image-to-ghcr
        with:
          docker-image-tag: ${{ needs.check-images.outputs.ubuntu-2404-dev-tag }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Push latest ManyLinux tag"
        if: needs.check-images.outputs.manylinux-needs-build != 'true' || needs.build-manylinux.result == 'success'
        uses: ./.github/actions/push-latest-image-to-ghcr
        with:
          docker-image-tag: ${{ needs.check-images.outputs.manylinux-tag }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
