name: "Build all Docker images"
# =============================================================================
# This workflow builds ALL Docker images needed by the CI pipeline by calling
# build-docker-artifact.yaml once per platform in parallel. build-docker-artifact
# is the single source of truth for hash calculation, tool images, and image builds.
#
# It should be called once at the start of the pipeline (e.g., by merge-gate.yaml),
# and all subsequent jobs should use the pre-built images via the outputs.
#
# NAMING CONVENTION: Outputs use "ubuntu-XXXX-*-tag" format to distinguish
# platform-specific images. These map to build-artifact.yaml inputs like:
#   ci-build-docker-image: ${{ needs.docker-images.outputs.ubuntu-2204-ci-build-tag }}
# =============================================================================

on:
  workflow_call:
    outputs:
      # Ubuntu 22.04 images (from build-docker-artifact platform=Ubuntu 22.04)
      ubuntu-2204-ci-build-tag:
        description: "Docker tag for Ubuntu 22.04 CI Build image"
        value: ${{ jobs.build-2204.outputs.ci-build-tag }}
      ubuntu-2204-ci-test-tag:
        description: "Docker tag for Ubuntu 22.04 CI Test image"
        value: ${{ jobs.build-2204.outputs.ci-test-tag }}
      ubuntu-2204-dev-tag:
        description: "Docker tag for Ubuntu 22.04 Dev image"
        value: ${{ jobs.build-2204.outputs.dev-tag }}
      ubuntu-2204-basic-dev-tag:
        description: "Docker tag for Ubuntu 22.04 Basic Dev image"
        value: ${{ jobs.build-2204.outputs.basic-dev-tag }}
      ubuntu-2204-basic-ttnn-runtime-tag:
        description: "Docker tag for Ubuntu 22.04 Basic TTNN Runtime image"
        value: ${{ jobs.build-2204.outputs.basic-ttnn-runtime-tag }}
      # Ubuntu 24.04 images (from build-docker-artifact platform=Ubuntu 24.04)
      ubuntu-2404-ci-build-tag:
        description: "Docker tag for Ubuntu 24.04 CI Build image"
        value: ${{ jobs.build-2404.outputs.ci-build-tag }}
      ubuntu-2404-ci-test-tag:
        description: "Docker tag for Ubuntu 24.04 CI Test image"
        value: ${{ jobs.build-2404.outputs.ci-test-tag }}
      ubuntu-2404-dev-tag:
        description: "Docker tag for Ubuntu 24.04 Dev image"
        value: ${{ jobs.build-2404.outputs.dev-tag }}
      ubuntu-2404-basic-dev-tag:
        description: "Docker tag for Ubuntu 24.04 Basic Dev image"
        value: ${{ jobs.build-2404.outputs.basic-dev-tag }}
      ubuntu-2404-basic-ttnn-runtime-tag:
        description: "Docker tag for Ubuntu 24.04 Basic TTNN Runtime image"
        value: ${{ jobs.build-2404.outputs.basic-ttnn-runtime-tag }}
      # ManyLinux image (shared; same tag from either platform run)
      manylinux-tag:
        description: "Docker tag for ManyLinux image"
        value: ${{ jobs.build-2204.outputs.manylinux-tag }}
  workflow_dispatch:

permissions:
  packages: write

jobs:
  # Tool images (ccache, mold, doxygen, etc.) are platform-agnostic; build once and share
  build-tools:
    name: "üîß Build tool images"
    uses: ./.github/workflows/build-docker-tools.yaml
    secrets: inherit

  # Ubuntu 22.04: full build via single source of truth; this run also builds manylinux (once for all platforms)
  build-2204:
    name: "üê≥ Ubuntu 22.04"
    needs: [build-tools]
    uses: ./.github/workflows/build-docker-artifact.yaml
    with:
      platform: "Ubuntu 22.04"
      architecture: "amd64"
      build-manylinux: true
      tool-tags: ${{ needs.build-tools.outputs.tool-tags }}
    secrets: inherit

  # Ubuntu 24.04: full build via single source of truth (runs in parallel with build-2204); skip manylinux (handled by build-2204)
  build-2404:
    name: "üê≥ Ubuntu 24.04"
    needs: [build-tools]
    uses: ./.github/workflows/build-docker-artifact.yaml
    with:
      platform: "Ubuntu 24.04"
      architecture: "amd64"
      build-manylinux: false
      tool-tags: ${{ needs.build-tools.outputs.tool-tags }}
    secrets: inherit
