name: "Build tt-metal docker artifact"

on:
  workflow_call:
    inputs:
      distro:
        required: false
        type: string
        default: "ubuntu"
      version:
        required: false
        type: string
        default: "20.04"
      architecture:
        required: false
        type: string
        default: "amd64"
    outputs:
      ci-build-tag:
        description: "Docker tag for the CI Build Docker image for building TT-Metalium et al"
        value: ${{ jobs.check-docker-images.outputs.ci-build-tag }}
      ci-test-tag:
        description: "Docker tag for the CI Test Docker image for testing TT-Metalium et al"
        value: ${{ jobs.check-docker-images.outputs.ci-test-tag }}
      dev-tag:
        description: "Docker tag for the dev Docker image for developing TT-Metalium et al"
        value: ${{ jobs.check-docker-images.outputs.dev-tag }}
      basic-dev-tag:
        description: "Docker tag for the basic dev Docker image for basic development"
        value: ${{ jobs.check-docker-images.outputs.basic-dev-tag }}
      basic-ttnn-runtime-tag:
        description: "Docker tag for the basic TTNN runtime Docker image for running TTNN"
        value: ${{ jobs.check-docker-images.outputs.basic-ttnn-runtime-tag }}
      manylinux-tag:
        description: "Docker tag for the manylinux Docker image for building TT-Metalium et al"
        value: ${{ jobs.check-docker-images.outputs.manylinux-tag }}
  workflow_dispatch:
    inputs:
      distro:
        required: false
        type: choice
        default: "ubuntu"
        options:
            - "ubuntu"
      version:
        required: false
        type: choice
        default: "22.04"
        options:
            - "22.04"
            - "24.04"
      architecture:
        required: false
        type: choice
        default: "amd64"
        options:
            - "amd64"

env:
  CI_BUILD_IMAGE_NAME: ${{ inputs.distro }}-${{ inputs.version }}-ci-build-${{ inputs.architecture }}
  CI_TEST_IMAGE_NAME: ${{ inputs.distro }}-${{ inputs.version }}-ci-test-${{ inputs.architecture }}
  DEV_IMAGE_NAME: ${{ inputs.distro }}-${{ inputs.version }}-dev-${{ inputs.architecture }}
  BASIC_DEV_IMAGE_NAME: ${{ inputs.distro }}-${{ inputs.version }}-basic-dev-${{ inputs.architecture }}
  BASIC_TTNN_RUNTIME_IMAGE_NAME: ${{ inputs.distro }}-${{ inputs.version }}-basic-ttnn-runtime-${{ inputs.architecture }}
  MANYLINUX_IMAGE_NAME: manylinux-${{ inputs.architecture }}

jobs:
  check-docker-images:
    runs-on: ubuntu-latest
    outputs:
      ci-build-exists: ${{ steps.images.outputs.ci-build-exists }}
      ci-build-tag: ${{ steps.tags.outputs.ci-build-tag }}
      ci-test-exists: ${{ steps.images.outputs.ci-test-exists }}
      ci-test-tag: ${{ steps.tags.outputs.ci-test-tag }}
      dev-exists: ${{ steps.images.outputs.dev-exists }}
      dev-tag: ${{ steps.tags.outputs.dev-tag }}
      basic-dev-exists: ${{ steps.images.outputs.basic-dev-exists }}
      basic-dev-tag: ${{ steps.tags.outputs.basic-dev-tag }}
      basic-ttnn-runtime-exists: ${{ steps.images.outputs.basic-ttnn-runtime-exists }}
      basic-ttnn-runtime-tag: ${{ steps.tags.outputs.basic-ttnn-runtime-tag }}
      manylinux-exists: ${{ steps.images.outputs.manylinux-exists }}
      manylinux-tag: ${{ steps.tags.outputs.manylinux-tag }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 1

      - name: Compute Docker image tags
        id: tags
        run: |
          set -euo pipefail  # Exit on error, undefined vars, and pipe failures
          
          echo "======================================"
          echo "Computing Docker Image Tags"
          echo "======================================"
          
          # ============================================================
          # CI/Test/Dev Images (share same dependencies)
          # ============================================================
          echo "â†’ Computing hash for CI/Test/Dev images..."
          CI_DEV_HASH=$(cat \
            .github/workflows/build-docker-artifact.yaml \
            dockerfile/Dockerfile \
            docs/requirements-docs.txt \
            install_dependencies.sh \
            tests/sweep_framework/requirements-sweeps.txt \
            tt_metal/python_env/requirements-dev.txt \
            tt_metal/sfpi-info.sh \
            tt_metal/sfpi-version \
            scripts/ttexalens_ref.txt \
            tools/triage/requirements.txt \
            | sha1sum | cut -d' ' -f1)
          
          echo "  Hash: ${CI_DEV_HASH}"
          
          CI_BUILD_TAG="ghcr.io/${{ github.repository }}/tt-metalium/${{ env.CI_BUILD_IMAGE_NAME }}:${CI_DEV_HASH}"
          CI_TEST_TAG="ghcr.io/${{ github.repository }}/tt-metalium/${{ env.CI_TEST_IMAGE_NAME }}:${CI_DEV_HASH}"
          DEV_TAG="ghcr.io/${{ github.repository }}/tt-metalium/${{ env.DEV_IMAGE_NAME }}:${CI_DEV_HASH}"
          
          echo "ci-build-tag=${CI_BUILD_TAG}" >> $GITHUB_OUTPUT
          echo "ci-test-tag=${CI_TEST_TAG}" >> $GITHUB_OUTPUT
          echo "dev-tag=${DEV_TAG}" >> $GITHUB_OUTPUT
          
          # ============================================================
          # Basic Dev Image (minimal dependencies)
          # ============================================================
          echo ""
          echo "â†’ Computing hash for Basic Dev image..."
          BASIC_DEV_HASH=$(cat dockerfile/Dockerfile.basic-dev | sha1sum | cut -d' ' -f1)
          echo "  Hash: ${BASIC_DEV_HASH}"
          
          BASIC_DEV_TAG="ghcr.io/${{ github.repository }}/tt-metalium/${{ env.BASIC_DEV_IMAGE_NAME }}:${BASIC_DEV_HASH}"
          echo "basic-dev-tag=${BASIC_DEV_TAG}" >> $GITHUB_OUTPUT
          
          # ============================================================
          # Basic TTNN Runtime Image (runtime dependencies)
          # ============================================================
          echo ""
          echo "â†’ Computing hash for Basic TTNN Runtime image..."
          BASIC_TTNN_RUNTIME_HASH=$(cat \
            dockerfile/Dockerfile.basic-dev \
            install_dependencies.sh \
            tt_metal/sfpi-info.sh \
            tt_metal/sfpi-version \
            | sha1sum | cut -d' ' -f1)
          echo "  Hash: ${BASIC_TTNN_RUNTIME_HASH}"
          
          BASIC_TTNN_RUNTIME_TAG="ghcr.io/${{ github.repository }}/tt-metalium/${{ env.BASIC_TTNN_RUNTIME_IMAGE_NAME }}:${BASIC_TTNN_RUNTIME_HASH}"
          echo "basic-ttnn-runtime-tag=${BASIC_TTNN_RUNTIME_TAG}" >> $GITHUB_OUTPUT
          
          # ============================================================
          # Manylinux Image (wheel building)
          # ============================================================
          echo ""
          echo "â†’ Computing hash for Manylinux image..."
          MANYLINUX_HASH=$(cat \
            .github/workflows/build-docker-artifact.yaml \
            dockerfile/Dockerfile.manylinux \
            install_dependencies.sh \
            tt_metal/sfpi-info.sh \
            tt_metal/sfpi-version \
            | sha1sum | cut -d' ' -f1)
          echo "  Hash: ${MANYLINUX_HASH}"
          
          MANYLINUX_TAG="ghcr.io/${{ github.repository }}/tt-metalium/${{ env.MANYLINUX_IMAGE_NAME }}:${MANYLINUX_HASH}"
          echo "manylinux-tag=${MANYLINUX_TAG}" >> $GITHUB_OUTPUT
          
          # ============================================================
          # Summary
          # ============================================================
          echo ""
          echo "======================================"
          echo "Generated Image Tags:"
          echo "======================================"
          echo "CI Build:           ${CI_BUILD_TAG}"
          echo "CI Test:            ${CI_TEST_TAG}"
          echo "Dev:                ${DEV_TAG}"
          echo "Basic Dev:          ${BASIC_DEV_TAG}"
          echo "Basic TTNN Runtime: ${BASIC_TTNN_RUNTIME_TAG}"
          echo "Manylinux:          ${MANYLINUX_TAG}"
          echo "======================================"

      - name: Check if images exist in registry
        id: images
        run: |
          set -euo pipefail
          
          echo "======================================"
          echo "Checking Image Existence in Registry"
          echo "======================================"
          
          # Helper function to check if image exists
          check_image() {
            local image_tag=$1
            local output_name=$2
            
            echo -n "Checking ${output_name}... "
            if docker manifest inspect "${image_tag}" > /dev/null 2>&1; then
              echo "âœ… EXISTS"
              echo "${output_name}-exists=true" >> $GITHUB_OUTPUT
              return 0
            else
              echo "âŒ NOT FOUND"
              echo "${output_name}-exists=false" >> $GITHUB_OUTPUT
              return 1
            fi
          }
          
          # Check CI/Dev/Test images (grouped - if one exists, all should exist)
          if check_image "${{ steps.tags.outputs.dev-tag }}" "dev"; then
            echo "ci-build-exists=true" >> $GITHUB_OUTPUT
            echo "ci-test-exists=true" >> $GITHUB_OUTPUT
          else
            echo "ci-build-exists=false" >> $GITHUB_OUTPUT
            echo "ci-test-exists=false" >> $GITHUB_OUTPUT
          fi
          
          # Check other images independently
          check_image "${{ steps.tags.outputs.basic-dev-tag }}" "basic-dev"
          check_image "${{ steps.tags.outputs.basic-ttnn-runtime-tag }}" "basic-ttnn-runtime"
          check_image "${{ steps.tags.outputs.manylinux-tag }}" "manylinux"
          
          echo "======================================"

  # Assume if dev-tag does not exist, the others will not exist either
  build-docker-image:
    name: "ğŸ³ï¸ Build images"
    needs: check-docker-images
    if: needs.check-docker-images.outputs.dev-exists != 'true' || needs.check-docker-images.outputs.basic-dev-exists != 'true' || needs.check-docker-images.outputs.basic-ttnn-runtime-exists != 'true' || needs.check-docker-images.outputs.manylinux-exists != 'true'
    timeout-minutes: 90
    runs-on: tt-ubuntu-2204-large-stable
    steps:
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: ğŸ” Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: https://ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ³ Build and push CI Build image
        if: needs.check-docker-images.outputs.dev-exists != 'true'
        uses: docker/build-push-action@v6
        with:
          context: ${{ github.workspace }}
          file: dockerfile/Dockerfile
          target: ci-build
          push: true
          tags: ${{ needs.check-docker-images.outputs.ci-build-tag }}
          build-args: UBUNTU_VERSION=${{ inputs.version }}
          cache-to: type=inline
          pull: true
      
      - name: ğŸ³ Build and push CI Test image
        if: needs.check-docker-images.outputs.dev-exists != 'true'
        uses: docker/build-push-action@v6
        with:
          context: ${{ github.workspace }}
          file: dockerfile/Dockerfile
          target: ci-test
          push: true
          tags: ${{ needs.check-docker-images.outputs.ci-test-tag }}
          build-args: UBUNTU_VERSION=${{ inputs.version }}
          cache-to: type=inline
          pull: true
      
      - name: ğŸ³ Build and push Dev image
        if: needs.check-docker-images.outputs.dev-exists != 'true'
        uses: docker/build-push-action@v6
        with:
          context: ${{ github.workspace }}
          file: dockerfile/Dockerfile
          target: dev
          push: true
          tags: ${{ needs.check-docker-images.outputs.dev-tag }}
          build-args: UBUNTU_VERSION=${{ inputs.version }}
          cache-to: type=inline
          pull: true
      - name: ğŸ³ Build and push Basic Dev image
        if: needs.check-docker-images.outputs.basic-dev-exists != 'true'
        uses: docker/build-push-action@v6
        with:
          context: ${{ github.workspace }}
          file: dockerfile/Dockerfile.basic-dev
          target: base
          push: true
          tags: ${{ needs.check-docker-images.outputs.basic-dev-tag }}
          build-args: UBUNTU_VERSION=${{ inputs.version }}
          cache-to: type=inline
          pull: true
      
      - name: ğŸ³ Build and push Basic TTNN Runtime image
        if: needs.check-docker-images.outputs.basic-ttnn-runtime-exists != 'true'
        uses: docker/build-push-action@v6
        with:
          context: ${{ github.workspace }}
          file: dockerfile/Dockerfile.basic-dev
          target: basic-ttnn-runtime
          push: true
          tags: ${{ needs.check-docker-images.outputs.basic-ttnn-runtime-tag }}
          build-args: UBUNTU_VERSION=${{ inputs.version }}
          cache-to: type=inline
          pull: true
      
      - name: ğŸ³ Build and push Manylinux image
        if: needs.check-docker-images.outputs.manylinux-exists != 'true'
        uses: docker/build-push-action@v6
        with:
          context: ${{ github.workspace }}
          file: dockerfile/Dockerfile.manylinux
          push: true
          tags: ${{ needs.check-docker-images.outputs.manylinux-tag }}
          cache-to: type=inline
          pull: true

  # Cannot use needs.build-docker-image to ensure this job runs sequentially after the build job because it would break when the build job is skipped
  # Instead, this setup causes the tag-latest job to lag one run behind the actual build.
  # However, this isn't a huge issue because the image should already have been built on a branch before merging, and if it wasn't (like in a push scenario),
  # the problem would self-correct on the next merge to main, which happens frequently.
  tag-latest:
    name: "ğŸ”„ Update latest tag"
    needs: check-docker-images
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: "Push latest CI Build tag"
        if: needs.check-docker-images.outputs.ci-build-exists == 'true'
        uses: ./.github/actions/push-latest-image-to-ghcr
        with:
          docker-image-tag: ${{ needs.check-docker-images.outputs.ci-build-tag }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Push latest CI Test tag"
        if: needs.check-docker-images.outputs.ci-test-exists == 'true'
        uses: ./.github/actions/push-latest-image-to-ghcr
        with:
          docker-image-tag: ${{ needs.check-docker-images.outputs.ci-test-tag }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Push latest Dev tag"
        if: needs.check-docker-images.outputs.dev-exists == 'true'
        uses: ./.github/actions/push-latest-image-to-ghcr
        with:
          docker-image-tag: ${{ needs.check-docker-images.outputs.dev-tag }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Push latest Basic Dev tag"
        if: needs.check-docker-images.outputs.basic-dev-exists == 'true'
        uses: ./.github/actions/push-latest-image-to-ghcr
        with:
          docker-image-tag: ${{ needs.check-docker-images.outputs.basic-dev-tag }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Push latest Basic TTNN Runtime tag"
        if: needs.check-docker-images.outputs.basic-ttnn-runtime-exists == 'true'
        uses: ./.github/actions/push-latest-image-to-ghcr
        with:
          docker-image-tag: ${{ needs.check-docker-images.outputs.basic-ttnn-runtime-tag }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Push latest Manylinux tag"
        if: needs.check-docker-images.outputs.manylinux-exists == 'true'
        uses: ./.github/actions/push-latest-image-to-ghcr
        with:
          docker-image-tag: ${{ needs.check-docker-images.outputs.manylinux-tag }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
