name: "Profiler CI"
run-name: "Profiler CI"

on:
  schedule:
    - cron: "0 2 * * *" # Run daily at 2am UTC (matches T3K/Galaxy profiler schedules)
  workflow_dispatch:
    inputs:
      debug_build:
        description: "Run ALL profiler jobs using a debug build (RelWithDebInfo) instead of Release."
        required: false
        type: boolean
        default: false
      run_t3k_profiler:
        description: "T3K profiler"
        required: false
        type: boolean
        default: false
      run_galaxy_profiler:
        description: "Galaxy profiler"
        required: false
        type: boolean
        default: false
      run_blackhole_profiler:
        description: "Blackhole profiler"
        required: false
        type: boolean
        default: false
      run_n300_profiler:
        description: "N300 profiler"
        required: false
        type: boolean
        default: false
      run_n150_profiler:
        description: "N150 profiler"
        required: false
        type: boolean
        default: false
      enable-watcher:
        description: "Enable watcher (profiler regressions only)"
        required: false
        type: boolean
        default: false
      enable-lightweight-kernel-asserts:
        description: "Enable lightweight kernel asserts (profiler regressions only)"
        required: false
        type: boolean
        default: false
      enable-llk-asserts:
        description: "Enable LLK asserts (profiler regressions only)"
        required: false
        type: boolean
        default: false
  workflow_call:
    inputs:
      debug_build:
        description: "Run ALL profiler jobs using a debug build (RelWithDebInfo) instead of Release."
        required: false
        type: boolean
        default: false
      run_t3k_profiler:
        description: "T3K profiler"
        required: false
        type: boolean
        default: false
      run_galaxy_profiler:
        description: "Galaxy profiler"
        required: false
        type: boolean
        default: false
      run_blackhole_profiler:
        description: "Blackhole profiler"
        required: false
        type: boolean
        default: false
      run_n300_profiler:
        description: "N300 profiler"
        required: false
        type: boolean
        default: false
      run_n150_profiler:
        description: "N150 profiler"
        required: false
        type: boolean
        default: false
      enable-watcher:
        description: "Enable watcher (profiler regressions only)"
        default: false
        type: boolean
      enable-lightweight-kernel-asserts:
        description: "Enable lightweight kernel asserts (profiler regressions only)"
        default: false
        type: boolean
      enable-llk-asserts:
        description: "Enable LLK asserts (profiler regressions only)"
        default: false
        type: boolean

jobs:
  build-artifact-profiler:
    if: >-
      ${{
        github.event_name == 'schedule' ||
        (github.event_name == 'workflow_call' && (inputs.debug_build || inputs.run_t3k_profiler || inputs.run_galaxy_profiler || inputs.run_blackhole_profiler || inputs.run_n300_profiler || inputs.run_n150_profiler)) ||
        (github.event_name == 'workflow_dispatch' && (
          github.event.inputs.debug_build == 'true' || github.event.inputs.debug_build == true ||
          github.event.inputs.run_t3k_profiler == 'true' || github.event.inputs.run_t3k_profiler == true ||
          github.event.inputs.run_galaxy_profiler == 'true' || github.event.inputs.run_galaxy_profiler == true ||
          github.event.inputs.run_blackhole_profiler == 'true' || github.event.inputs.run_blackhole_profiler == true ||
          github.event.inputs.run_n300_profiler == 'true' || github.event.inputs.run_n300_profiler == true ||
          github.event.inputs.run_n150_profiler == 'true' || github.event.inputs.run_n150_profiler == true
        ))
      }}
    uses: ./.github/workflows/build-artifact.yaml
    permissions:
      packages: write
    secrets: inherit
    with:
      build-type: >-
        ${{
          (
            (
              (github.event_name == 'workflow_call' && inputs.debug_build) ||
              (github.event_name == 'workflow_dispatch' && (github.event.inputs.debug_build == 'true' || github.event.inputs.debug_build == true))
            )
            && 'RelWithDebInfo'
          ) || 'Release'
        }}
      tracy: true
      build-wheel: true
      version: "22.04"

  t3k-profiler-tests:
    if: >-
      ${{
        github.event_name == 'schedule' ||
        (github.event_name == 'workflow_call' && (inputs.debug_build || inputs.run_t3k_profiler)) ||
        (github.event_name == 'workflow_dispatch' && (
          github.event.inputs.debug_build == 'true' || github.event.inputs.debug_build == true ||
          github.event.inputs.run_t3k_profiler == 'true' || github.event.inputs.run_t3k_profiler == true
        ))
      }}
    needs: build-artifact-profiler
    secrets: inherit
    uses: ./.github/workflows/profiler-tests-impl.yaml
    with:
      docker-image: ${{ needs.build-artifact-profiler.outputs.dev-docker-image }}
      build-artifact-name: ${{ needs.build-artifact-profiler.outputs.build-artifact-name }}
      wheel-artifact-name: ${{ needs.build-artifact-profiler.outputs.wheel-artifact-name }}
      topology: config-t3000
      test-script: ./tests/scripts/t3000/run_t3000_profiler_tests.sh

  galaxy-profiler-tests:
    if: >-
      ${{
        github.event_name == 'schedule' ||
        (github.event_name == 'workflow_call' && (inputs.debug_build || inputs.run_galaxy_profiler)) ||
        (github.event_name == 'workflow_dispatch' && (
          github.event.inputs.debug_build == 'true' || github.event.inputs.debug_build == true ||
          github.event.inputs.run_galaxy_profiler == 'true' || github.event.inputs.run_galaxy_profiler == true
        ))
      }}
    needs: build-artifact-profiler
    secrets: inherit
    uses: ./.github/workflows/profiler-tests-impl.yaml
    with:
      docker-image: ${{ needs.build-artifact-profiler.outputs.dev-docker-image }}
      build-artifact-name: ${{ needs.build-artifact-profiler.outputs.build-artifact-name }}
      wheel-artifact-name: ${{ needs.build-artifact-profiler.outputs.wheel-artifact-name }}
      topology: topology-6u
      test-script: ./tests/scripts/wh_6u/run_wh_6u_profiler_tests.sh

  blackhole-profiler:
    if: >-
      ${{
        github.event_name == 'schedule' ||
        (github.event_name == 'workflow_call' && (inputs.debug_build || inputs.run_blackhole_profiler)) ||
        (github.event_name == 'workflow_dispatch' && (
          github.event.inputs.debug_build == 'true' || github.event.inputs.debug_build == true ||
          github.event.inputs.run_blackhole_profiler == 'true' || github.event.inputs.run_blackhole_profiler == true
        ))
      }}
    needs: build-artifact-profiler
    secrets: inherit
    uses: ./.github/workflows/run-profiler-regression.yaml
    with:
      arch: blackhole
      runner-label: P150b
      # Full profiler regression (non post-commit)
      post_commit_only: false
      docker-image: ${{ needs.build-artifact-profiler.outputs.dev-docker-image }}
      build-artifact-name: ${{ needs.build-artifact-profiler.outputs.build-artifact-name }}
      wheel-artifact-name: ${{ needs.build-artifact-profiler.outputs.wheel-artifact-name }}
      enable-watcher: ${{ (github.event_name == 'workflow_call' && inputs.enable-watcher) || (github.event_name == 'workflow_dispatch' && (github.event.inputs.enable-watcher == 'true' || github.event.inputs.enable-watcher == true)) || false }}
      enable-lightweight-kernel-asserts: ${{ (github.event_name == 'workflow_call' && inputs.enable-lightweight-kernel-asserts) || (github.event_name == 'workflow_dispatch' && (github.event.inputs.enable-lightweight-kernel-asserts == 'true' || github.event.inputs.enable-lightweight-kernel-asserts == true)) || false }}
      enable-llk-asserts: ${{ (github.event_name == 'workflow_call' && inputs.enable-llk-asserts) || (github.event_name == 'workflow_dispatch' && (github.event.inputs.enable-llk-asserts == 'true' || github.event.inputs.enable-llk-asserts == true)) || false }}

  n300-profiler:
    if: >-
      ${{
        github.event_name == 'schedule' ||
        (github.event_name == 'workflow_call' && (inputs.debug_build || inputs.run_n300_profiler)) ||
        (github.event_name == 'workflow_dispatch' && (
          github.event.inputs.debug_build == 'true' || github.event.inputs.debug_build == true ||
          github.event.inputs.run_n300_profiler == 'true' || github.event.inputs.run_n300_profiler == true
        ))
      }}
    needs: build-artifact-profiler
    secrets: inherit
    uses: ./.github/workflows/run-profiler-regression.yaml
    with:
      arch: wormhole_b0
      runner-label: N300
      # Full profiler regression (non post-commit)
      post_commit_only: false
      docker-image: ${{ needs.build-artifact-profiler.outputs.dev-docker-image }}
      build-artifact-name: ${{ needs.build-artifact-profiler.outputs.build-artifact-name }}
      wheel-artifact-name: ${{ needs.build-artifact-profiler.outputs.wheel-artifact-name }}
      enable-watcher: ${{ (github.event_name == 'workflow_call' && inputs.enable-watcher) || (github.event_name == 'workflow_dispatch' && (github.event.inputs.enable-watcher == 'true' || github.event.inputs.enable-watcher == true)) || false }}
      enable-lightweight-kernel-asserts: ${{ (github.event_name == 'workflow_call' && inputs.enable-lightweight-kernel-asserts) || (github.event_name == 'workflow_dispatch' && (github.event.inputs.enable-lightweight-kernel-asserts == 'true' || github.event.inputs.enable-lightweight-kernel-asserts == true)) || false }}
      enable-llk-asserts: ${{ (github.event_name == 'workflow_call' && inputs.enable-llk-asserts) || (github.event_name == 'workflow_dispatch' && (github.event.inputs.enable-llk-asserts == 'true' || github.event.inputs.enable-llk-asserts == true)) || false }}

  n150-profiler:
    if: >-
      ${{
        github.event_name == 'schedule' ||
        (github.event_name == 'workflow_call' && (inputs.debug_build || inputs.run_n150_profiler)) ||
        (github.event_name == 'workflow_dispatch' && (
          github.event.inputs.debug_build == 'true' || github.event.inputs.debug_build == true ||
          github.event.inputs.run_n150_profiler == 'true' || github.event.inputs.run_n150_profiler == true
        ))
      }}
    needs: build-artifact-profiler
    secrets: inherit
    uses: ./.github/workflows/run-profiler-regression.yaml
    with:
      arch: wormhole_b0
      runner-label: N150
      # Full profiler regression (non post-commit)
      post_commit_only: false
      docker-image: ${{ needs.build-artifact-profiler.outputs.dev-docker-image }}
      build-artifact-name: ${{ needs.build-artifact-profiler.outputs.build-artifact-name }}
      wheel-artifact-name: ${{ needs.build-artifact-profiler.outputs.wheel-artifact-name }}
      enable-watcher: ${{ (github.event_name == 'workflow_call' && inputs.enable-watcher) || (github.event_name == 'workflow_dispatch' && (github.event.inputs.enable-watcher == 'true' || github.event.inputs.enable-watcher == true)) || false }}
      enable-lightweight-kernel-asserts: ${{ (github.event_name == 'workflow_call' && inputs.enable-lightweight-kernel-asserts) || (github.event_name == 'workflow_dispatch' && (github.event.inputs.enable-lightweight-kernel-asserts == 'true' || github.event.inputs.enable-lightweight-kernel-asserts == true)) || false }}
      enable-llk-asserts: ${{ (github.event_name == 'workflow_call' && inputs.enable-llk-asserts) || (github.event_name == 'workflow_dispatch' && (github.event.inputs.enable-llk-asserts == 'true' || github.event.inputs.enable-llk-asserts == true)) || false }}
