name: "(APC) Select and Run Post-Commit Tests"

on:
  workflow_dispatch:
    inputs:
      tests-json:
        description: |
          JSON object specifying which tests to run.
          Example: {"sd-unit-tests":true,"fast-dispatch-unit-tests":true,"fabric-unit-tests":true,"cpp-unit-tests":true,"ttnn-unit-tests":true,"models-unit-tests":true,"tt-train-cpp-unit-tests":true,"run-profiler-regression":true,"t3000-apc-fast-tests":true,"test-ttnn-tutorials":true}
        required: false
        type: string
        default: '{"sd-unit-tests":true,"fast-dispatch-unit-tests":true,"fabric-unit-tests":true,"cpp-unit-tests":true,"ttnn-unit-tests":true,"models-unit-tests":true,"tt-train-cpp-unit-tests":true,"run-profiler-regression":true,"t3000-apc-fast-tests":true,"test-ttnn-tutorials":true,"triage-tests":true}'
      commit:
        required: false
        type: string
        default: ""
        description: 'Commit SHA to test (default: HEAD)'
      enable-watcher:
        description: "Enable watcher for long-running tests"
        required: false
        default: false
        type: boolean
      enable-lightweight-kernel-asserts:
        description: "Enable lightweight kernel asserts"
        required: false
        default: false
        type: boolean
      enable-llk-asserts:
        description: "Enable LLK asserts"
        required: false
        default: false
        type: boolean
      platform:
        description: "Platform to build and test"
        required: false
        type: choice
        options:
          - "Ubuntu 22.04"
          - "Ubuntu 24.04"
        default: "Ubuntu 22.04"
      build-type:
        description: "Build type"
        required: false
        type: choice
        options:
          - Release
          - Debug
          - RelWithDebInfo
          - ASan
          - TSan
        default: Release
      enable-lto:
        description: "Enable Link Time Optimization (LTO)"
        required: false
        default: false
        type: boolean

jobs:
  parse-tests-json:
    runs-on: ubuntu-latest
    outputs:
      tests-to-run: ${{ steps.parse.outputs.tests_to_run }}
    steps:
      - name: Parse tests-json to comma-separated string
        id: parse
        run: |
          TESTS_JSON='${{ inputs.tests-json }}'
          TESTS=$(echo "$TESTS_JSON" | jq -r 'to_entries | map(select(.value == true) | .key) | join(",")')
          echo "tests_to_run=$TESTS" >> $GITHUB_OUTPUT

  # NOTE: build-artifact.yaml handles platform parsing internally.
  # Just pass platform and enable-lto inputs directly.
  build-artifact:
    needs: [parse-tests-json]
    if: ${{ always() }}
    uses: ./.github/workflows/build-artifact.yaml
    permissions:
      packages: write
    secrets: inherit
    with:
      build-type: ${{ inputs.build-type || 'Release' }}
      build-wheel: true
      tracy: true
      platform: ${{ inputs.platform }}
      skip-tt-train: false
      ref: ${{ inputs.commit || github.sha }}
      enable-lto: ${{ inputs.enable-lto || false }}

  sd-unit-tests:
    needs: [parse-tests-json, build-artifact]
    if: ${{ contains(needs.parse-tests-json.outputs.tests-to-run, 'sd-unit-tests') }}
    secrets: inherit
    strategy:
      fail-fast: false
      matrix:
        test-group: [
          { arch: wormhole_b0, runner-label: N150 },
          { arch: wormhole_b0, runner-label: N300 },
        ]
    uses: ./.github/workflows/build-and-unit-tests.yaml
    with:
      arch: ${{ matrix.test-group.arch }}
      runner-label: ${{ matrix.test-group.runner-label }}
      docker-image: ${{ needs.build-artifact.outputs.dev-docker-image }}
      build-artifact-name: ${{ needs.build-artifact.outputs.build-artifact-name }}
      wheel-artifact-name: ${{ needs.build-artifact.outputs.wheel-artifact-name }}
      enable-watcher: ${{ inputs.enable-watcher || false }}
      enable-lightweight-kernel-asserts: ${{ inputs.enable-lightweight-kernel-asserts || false }}
      enable-llk-asserts: ${{ inputs.enable-llk-asserts || false }}

  fast-dispatch-unit-tests:
    needs: [parse-tests-json, build-artifact]
    if: ${{ contains(needs.parse-tests-json.outputs.tests-to-run, 'fast-dispatch-unit-tests') }}
    secrets: inherit
    strategy:
      fail-fast: false
      matrix:
        test-group: [
          { arch: wormhole_b0, runner-label: N150 },
          { arch: wormhole_b0, runner-label: N300 },
        ]
    uses: ./.github/workflows/fast-dispatch-build-and-unit-tests.yaml
    with:
      arch: ${{ matrix.test-group.arch }}
      runner-label: ${{ matrix.test-group.runner-label }}
      docker-image: ${{ needs.build-artifact.outputs.dev-docker-image }}
      wheel-artifact-name: ${{ needs.build-artifact.outputs.wheel-artifact-name }}
      enable-watcher: ${{ inputs.enable-watcher || false }}
      enable-lightweight-kernel-asserts: ${{ inputs.enable-lightweight-kernel-asserts || false }}
      enable-llk-asserts: ${{ inputs.enable-llk-asserts || false }}

  fabric-unit-tests:
    needs: [parse-tests-json, build-artifact]
    if: ${{ contains(needs.parse-tests-json.outputs.tests-to-run, 'fabric-unit-tests') }}
    secrets: inherit
    strategy:
      fail-fast: false
      matrix:
        test-group: [
          { arch: wormhole_b0, runner-label: N300 },
        ]
    uses: ./.github/workflows/fabric-build-and-unit-tests.yaml
    with:
      arch: ${{ matrix.test-group.arch }}
      runner-label: ${{ matrix.test-group.runner-label }}
      docker-image: ${{ needs.build-artifact.outputs.dev-docker-image }}
      build-artifact-name: ${{ needs.build-artifact.outputs.build-artifact-name }}
      wheel-artifact-name: ${{ needs.build-artifact.outputs.wheel-artifact-name }}
      enable-watcher: ${{ inputs.enable-watcher || false }}
      enable-lightweight-kernel-asserts: ${{ inputs.enable-lightweight-kernel-asserts || false }}
      enable-llk-asserts: ${{ inputs.enable-llk-asserts || false }}

  ttnn-unit-tests:
    needs: [parse-tests-json, build-artifact]
    if: ${{ contains(needs.parse-tests-json.outputs.tests-to-run, 'ttnn-unit-tests') }}
    secrets: inherit
    strategy:
      fail-fast: false
      matrix:
        test-group: [
          { arch: wormhole_b0, runner-label: N150 },
          { arch: wormhole_b0, runner-label: N300 },
        ]
    uses: ./.github/workflows/ttnn-post-commit.yaml
    with:
      arch: ${{ matrix.test-group.arch }}
      runner-label: ${{ matrix.test-group.runner-label }}
      docker-image: ${{ needs.build-artifact.outputs.dev-docker-image }}
      wheel-artifact-name: ${{ needs.build-artifact.outputs.wheel-artifact-name }}
      timeout: ${{ inputs.enable-watcher && 240 || 40 }}
      enable-watcher: ${{ inputs.enable-watcher || false }}
      enable-lightweight-kernel-asserts: ${{ inputs.enable-lightweight-kernel-asserts || false }}
      enable-llk-asserts: ${{ inputs.enable-llk-asserts || false }}

  models-unit-tests:
    needs: [parse-tests-json, build-artifact]
    if: ${{ contains(needs.parse-tests-json.outputs.tests-to-run, 'models-unit-tests') }}
    secrets: inherit
    strategy:
      fail-fast: false
      matrix:
        test-group: [
          { arch: wormhole_b0, runner-label: N150 },
          { arch: wormhole_b0, runner-label: N300 },
        ]
    uses: ./.github/workflows/models-post-commit.yaml
    with:
      arch: ${{ matrix.test-group.arch }}
      runner-label: ${{ matrix.test-group.runner-label }}
      docker-image: ${{ needs.build-artifact.outputs.dev-docker-image }}
      wheel-artifact-name: ${{ needs.build-artifact.outputs.wheel-artifact-name }}
      timeout: ${{ inputs.enable-watcher && 120 || 35 }}
      enable-watcher: ${{ inputs.enable-watcher || false }}
      enable-lightweight-kernel-asserts: ${{ inputs.enable-lightweight-kernel-asserts || false }}
      enable-llk-asserts: ${{ inputs.enable-llk-asserts || false }}

  cpp-unit-tests:
    needs: [parse-tests-json, build-artifact]
    if: ${{ contains(needs.parse-tests-json.outputs.tests-to-run, 'cpp-unit-tests') }}
    secrets: inherit
    strategy:
      fail-fast: false
      matrix:
        test-group: [
          { arch: wormhole_b0, runner-label: N150 },
          { arch: wormhole_b0, runner-label: N300 },
        ]
    uses: ./.github/workflows/cpp-post-commit.yaml
    with:
      arch: ${{ matrix.test-group.arch }}
      runner-label: ${{ matrix.test-group.runner-label }}
      docker-image: ${{ needs.build-artifact.outputs.dev-docker-image }}
      build-artifact-name: ${{ needs.build-artifact.outputs.build-artifact-name }}
      enable-watcher: ${{ inputs.enable-watcher || false }}
      enable-lightweight-kernel-asserts: ${{ inputs.enable-lightweight-kernel-asserts || false }}
      enable-llk-asserts: ${{ inputs.enable-llk-asserts || false }}

  tt-train-cpp-unit-tests:
    needs: [parse-tests-json, build-artifact]
    if: ${{ contains(needs.parse-tests-json.outputs.tests-to-run, 'tt-train-cpp-unit-tests') }}
    secrets: inherit
    strategy:
      fail-fast: false
      matrix:
        test-group: [
          { arch: wormhole_b0, runner-label: N150 },
          { arch: wormhole_b0, runner-label: N300 },
        ]
    uses: ./.github/workflows/tt-train-post-commit.yaml
    with:
      arch: ${{ matrix.test-group.arch }}
      runner-label: ${{ matrix.test-group.runner-label }}
      docker-image: ${{ needs.build-artifact.outputs.dev-docker-image }}
      build-artifact-name: ${{ needs.build-artifact.outputs.build-artifact-name }}
      enable-watcher: ${{ inputs.enable-watcher || false }}
      enable-lightweight-kernel-asserts: ${{ inputs.enable-lightweight-kernel-asserts || false }}
      enable-llk-asserts: ${{ inputs.enable-llk-asserts || false }}

  run-profiler-regression:
    needs: [parse-tests-json, build-artifact]
    if: ${{ contains(needs.parse-tests-json.outputs.tests-to-run, 'run-profiler-regression') && !inputs.enable-watcher && !inputs.enable-lightweight-kernel-asserts }}
    secrets: inherit
    strategy:
      fail-fast: false
      matrix:
        test-group: [
          { arch: wormhole_b0, runner-label: N150 },
          { arch: wormhole_b0, runner-label: N300 },
        ]
    uses: ./.github/workflows/run-profiler-regression.yaml
    with:
      arch: ${{ matrix.test-group.arch}}
      runner-label: ${{ matrix.test-group.runner-label}}
      post_commit_only: true
      docker-image: ${{ needs.build-artifact.outputs.dev-docker-image }}
      build-artifact-name: ${{ needs.build-artifact.outputs.build-artifact-name }}
      wheel-artifact-name: ${{ needs.build-artifact.outputs.wheel-artifact-name }}
      enable-watcher: ${{ inputs.enable-watcher || false }}
      enable-lightweight-kernel-asserts: ${{ inputs.enable-lightweight-kernel-asserts || false }}
      enable-llk-asserts: ${{ inputs.enable-llk-asserts || false }}

  t3000-apc-fast-tests:
    needs: [parse-tests-json, build-artifact]
    if: ${{ contains(needs.parse-tests-json.outputs.tests-to-run, 't3000-apc-fast-tests') }}
    secrets: inherit
    uses: ./.github/workflows/t3000-fast-tests-impl.yaml
    with:
      docker-image: ${{ needs.build-artifact.outputs.dev-docker-image }}
      build-artifact-name: ${{ needs.build-artifact.outputs.build-artifact-name }}
      wheel-artifact-name: ${{ needs.build-artifact.outputs.wheel-artifact-name }}
      enable-watcher: ${{ inputs.enable-watcher || false }}
      enable-lightweight-kernel-asserts: ${{ inputs.enable-lightweight-kernel-asserts || false }}
      enable-llk-asserts: ${{ inputs.enable-llk-asserts || false }}

  test-ttnn-tutorials:
    needs: [parse-tests-json, build-artifact]
    if: ${{ contains(needs.parse-tests-json.outputs.tests-to-run, 'test-ttnn-tutorials') }}
    secrets: inherit
    strategy:
      fail-fast: false
      matrix:
        test-group: [
          { arch: wormhole_b0, runner-label: N150 },
        ]
    uses: ./.github/workflows/ttnn-tutorials-post-commit.yaml
    with:
      arch: ${{ matrix.test-group.arch }}
      runner-label: ${{ matrix.test-group.runner-label }}
      docker-image: ${{ needs.build-artifact.outputs.basic-ttnn-runtime-docker-image }}
      build-artifact-name: ${{ needs.build-artifact.outputs.build-artifact-name }}
      wheel-artifact-name: ${{ needs.build-artifact.outputs.wheel-artifact-name }}
      enable-watcher: ${{ inputs.enable-watcher || false }}
      enable-lightweight-kernel-asserts: ${{ inputs.enable-lightweight-kernel-asserts || false }}
      enable-llk-asserts: ${{ inputs.enable-llk-asserts || false }}

  triage-tests:
    needs: [parse-tests-json, build-artifact]
    if: ${{ contains(needs.parse-tests-json.outputs.tests-to-run, 'triage-tests') && !inputs.enable-watcher && !inputs.enable-lightweight-kernel-asserts }}
    secrets: inherit
    strategy:
      fail-fast: false
      matrix:
        test-group: [
          { runner-label: N150 },
          { runner-label: N300 },
        ]
    uses: ./.github/workflows/triage.yaml
    with:
      runner-label: ${{ matrix.test-group.runner-label }}
      docker-image: ${{ needs.build-artifact.outputs.dev-docker-image }}
      build-artifact-name: ${{ needs.build-artifact.outputs.build-artifact-name }}
      wheel-artifact-name: ${{ needs.build-artifact.outputs.wheel-artifact-name }}
      enable-watcher: ${{ inputs.enable-watcher || false }}
      enable-lightweight-kernel-asserts: ${{ inputs.enable-lightweight-kernel-asserts || false }}
      enable-llk-asserts: ${{ inputs.enable-llk-asserts || false }}
