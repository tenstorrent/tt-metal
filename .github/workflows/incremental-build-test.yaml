name: Incremental Build Test

# This workflow tests incremental build performance to ensure ccache effectiveness
# and fast developer iteration cycles. It validates that small changes don't cause
# excessive rebuild times.

on:
  workflow_call:
    inputs:
      docker-image:
        required: true
        type: string
        description: "Docker image to use for the build"

permissions:
  contents: read
  packages: write

jobs:
  incremental-build-test:
    name: "Incremental Build Performance Test"
    timeout-minutes: 45
    runs-on: tt-ubuntu-2204-large-stable
    environment: ${{ github.ref == 'refs/heads/main' && 'mainline' || '' }}
    container:
      image: ${{ inputs.docker-image }}
      env:
        CCACHE_REMOTE_ONLY: "true"
        CCACHE_TEMPDIR: /tmp/ccache
        CARGO_HOME: /tmp/.cargo
        TT_FROM_PRECOMPILED_DIR: /work
        TRACY_NO_INVARIANT_CHECK: 1
        TRACY_NO_ISA_EXTENSIONS: 1
      volumes:
        - ${{ github.workspace }}/docker-job:/work
        - /home/ubuntu/.ccache-ci:/github/home/.ccache
      options: >
        --group-add 1457
        --tmpfs /tmp
    defaults:
      run:
        shell: bash
        working-directory: /work

    steps:
      - name: Check Redis credentials
        if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false }}
        run: |
          if [ -z "${{ secrets.REDIS_PASSWORD }}" ]; then
            echo "Redis password is missing. Did you forget 'secrets: inherit'?"
            exit 1
          fi
          CCACHE_REMOTE_STORAGE="redis://${{ vars.REDIS_USER }}:${{ secrets.REDIS_PASSWORD }}@${{ vars.REDIS_HOST }}:${{ vars.REDIS_PORT }}|read-only=${{ vars.REDIS_IS_READONLY }}"
          echo "CCACHE_REMOTE_STORAGE=${CCACHE_REMOTE_STORAGE}" >> $GITHUB_ENV

      - name: Checkout main branch (baseline)
        uses: actions/checkout@v4
        with:
          ref: main
          submodules: recursive
          fetch-depth: 0
          fetch-tags: true
          path: docker-job

      - name: Create ccache tmpdir
        run: mkdir -p /tmp/ccache

      - name: Store current PR info
        run: |
          echo "PR_SHA=${{ github.sha }}" >> $GITHUB_ENV
          echo "PR_REF=${{ github.ref }}" >> $GITHUB_ENV
          echo "Current PR SHA: ${{ github.sha }}"
          echo "Current PR ref: ${{ github.ref }}"

      - name: Build main branch baseline
        run: |
          ./build_metal.sh \
            --build-dir build_incremental \
            --build-type Release \
            --build-ttnn-tests \
            --enable-ccache \
            --disable-profiler

      - name: Initialize ccache stats
        run: |
          ccache -z
          echo "Ccache stats after main build:"
          ccache -s

      - name: Apply PR changes
        run: |
          git fetch origin ${{ github.ref }}
          git checkout -b incremental-test-branch
          git merge --no-ff ${{ github.sha }} -m "Merge PR changes for incremental build test"

      - name: Test incremental build with PR changes
        run: |
          start_time=$(date +%s)
          cmake --build build_incremental --target ttnn_test_basics -- -j$(nproc)
          end_time=$(date +%s)
          pr_changes_duration=$((end_time - start_time))
          echo "PR changes incremental build time: ${pr_changes_duration}s"
          echo "INCREMENTAL_BUILD_PR_CHANGES=${pr_changes_duration}" >> $GITHUB_ENV

      - name: Test no-change build (cache effectiveness)
        run: |
          start_time=$(date +%s)
          cmake --build build_incremental --target ttnn_test_basics -- -j$(nproc)
          end_time=$(date +%s)
          no_change_duration=$((end_time - start_time))
          echo "No-change incremental build time: ${no_change_duration}s"
          echo "INCREMENTAL_BUILD_NO_CHANGE=${no_change_duration}" >> $GITHUB_ENV

      - name: Final ccache stats
        run: |
          echo "Final ccache stats:"
          ccache -s

      - name: Performance summary
        run: |
          echo '## Incremental Build Performance Results' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo '### Build Times' >> $GITHUB_STEP_SUMMARY
          echo "- **PR changes build**: ${INCREMENTAL_BUILD_PR_CHANGES}s" >> $GITHUB_STEP_SUMMARY
          echo "- **No-change build**: ${INCREMENTAL_BUILD_NO_CHANGE}s" >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY

          # Performance analysis
          if [ "${INCREMENTAL_BUILD_PR_CHANGES}" -gt 300 ]; then
            echo '**Warning**: PR changes build took longer than 5 minutes' >> $GITHUB_STEP_SUMMARY
          else
            echo 'PR changes incremental build performance is acceptable' >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${INCREMENTAL_BUILD_NO_CHANGE}" -gt 60 ]; then
            echo '**Warning**: No-change build took longer than 60s - ccache may not be working effectively' >> $GITHUB_STEP_SUMMARY
          else
            echo 'Ccache effectiveness is good (no-change build < 60s)' >> $GITHUB_STEP_SUMMARY
          fi

          echo '' >> $GITHUB_STEP_SUMMARY
          echo '### Ccache Statistics' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ccache -s >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
