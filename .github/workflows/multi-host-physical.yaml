name: Multi-Host Deployment (Physical)
on:
  push:
    branches:
      - akirby/multi-host-workflow
  workflow_dispatch:

jobs:
  build-artifact:
    uses: ./.github/workflows/build-artifact.yaml
    permissions:
      packages: write
    secrets: inherit
    with:
      version: 22.04
      build-wheel: true
  deploy:
    runs-on: multi-host
    needs: build-artifact
    steps:
      - name: ⬇️ Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: ⬇️ Download Build
        uses: actions/download-artifact@v4
        timeout-minutes: 10
        with:
          name: ${{ needs.build-artifact.outputs.build-artifact-name }}
      - name: Extract files
        run: tar -xvf ttm_any.tar
      - name: ⬇️ Download Wheel
        uses: actions/download-artifact@v4
        timeout-minutes: 10
        with:
          name: ${{ needs.build-artifact.outputs.wheel-artifact-name }}
      - name: Run tests on multiple hosts
        uses: ./.github/actions/docker-run
        timeout-minutes: 120
        with:
          docker_image: ${{ needs.build-artifact.outputs.dev-docker-image || 'docker-image-unresolved!'}}
          docker_opts: |
            -e TT_METAL_HOME="/work"
            -e PYTHONPATH="/work"
            -e LD_LIBRARY_PATH="/work/build/lib"
            -e LOGURU_LEVEL="INFO"
            -e TT_METAL_ENABLE_ERISC_IRAM="1"
            -e GTEST_OUTPUT="xml:/work/generated/test_reports/"
            -v ${{ github.workspace }}/docker-job:/work
            -v /dev/hugepages-1G:/dev/hugepages-1G
            -v /etc/rankfile:/etc/rankfile:ro
            -v /etc/ssh/multihost:/root/.ssh:ro
            --device /dev/tenstorrent
            --network host
            --privileged
          install_wheel: true
          run_args: |
            sleep 10s
            echo "Running mpirun command on multiple hosts"
            mpirun --allow-run-as-root --rankfile /etc/rankfile --mca btl_tcp_if_exclude docker0,lo --tag-output hostname
