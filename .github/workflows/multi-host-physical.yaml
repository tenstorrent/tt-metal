name: Multi-Host Deployment (Physical)
on:
  push:
    branches:
      - akirby/multi-host-workflow
  workflow_dispatch:

jobs:
  build-artifact:
    uses: ./.github/workflows/build-artifact.yaml
    permissions:
      packages: write
    secrets: inherit
    with:
      version: 22.04
      build-wheel: true
  deploy:
    runs-on: multi-host
    # needs: build-artifact
    steps:
      - name: ⬇️ Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: ⬇️ Download Build
        uses: actions/download-artifact@v4
        timeout-minutes: 10
        with:
          name: ${{ needs.build-artifact.outputs.build-artifact-name }}
      - name: Extract files
        run: tar -xvf ttm_any.tar
      - name: ⬇️ Download Wheel
        uses: actions/download-artifact@v4
        timeout-minutes: 10
        with:
          name: ${{ needs.build-artifact.outputs.wheel-artifact-name }}
      - name: Capture runner's home directory
        id: capture-home
        run: echo "home=${HOME}" >> $GITHUB_OUTPUT
      - name: Run tests on multiple hosts
        uses: ./.github/actions/docker-run
        timeout-minutes: 120
        env:
          CONTAINER_HOME: "/home/ansible"
        with:
          docker_image: ghcr.io/tenstorrent/tt-metal/tt-metalium/ubuntu-22.04-dev-amd64:c2417bb0778b77d3092bd2f4a4c4269123d25b05
          docker_password: ${{ secrets.GITHUB_TOKEN }}
          docker_opts: |
            -e TT_METAL_HOME="/work"
            -e PYTHONPATH="/work"
            -e LD_LIBRARY_PATH="/work/build/lib"
            -e TT_METAL_ENABLE_ERISC_IRAM="1"
            -e GTEST_OUTPUT="xml:/work/generated/test_reports/"
            -v ${{ github.workspace }}/docker-job:/work
            -v /dev/hugepages-1G:/dev/hugepages-1G
            -v /etc/rankfile:/etc/rankfile:ro
            -v ${{ steps.capture-home.outputs.home }}/.ssh:${{ steps.capture-home.outputs.home }}/.ssh:ro
            --device /dev/tenstorrent
            --privileged
          install_wheel: false
          run_args: |
            sleep 10s
            echo "Running mpirun command on multiple hosts"
            mpirun --allow-run-as-root --rankfile /etc/rankfile --mca btl_tcp_if_exclude docker0,lo --tag-output hostname
