name: Set "Opened On" in Project

on:
  issues:
    types: [opened]

# This job uses a fine-grained PAT secret (DATE_AUTOMATION) via gh CLI.
# Required token scopes: read:project, project (or write:project)
# No repo write perms needed from the Actions token itself.
permissions:
  contents: read

jobs:
  set-opened-on:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.DATE_AUTOMATION }}
      ORG: "tenstorrent"
      PROJECT_NUMBER: "31"
      OPENED_ON_FIELD_NAME: "Opened On"
    steps:
      - name: Resolve Project and Field IDs
        id: setup
        run: |
          set -e

          # Validate token is set
          if [ -z "$GH_TOKEN" ]; then
            echo "Error: GH_TOKEN (DATE_AUTOMATION secret) is not set" >&2
            exit 1
          fi

          # Extract date from issue creation timestamp
          RAW_CREATED="${{ github.event.issue.created_at }}"
          OPENED_DATE="${RAW_CREATED%%T*}"

          # Query the org project by number and list fields
          RESP=$(gh api graphql -f query='
          query($org:String!, $number:Int!){
            organization(login:$org){
              projectV2(number:$number){
                id
                fields(first:100){
                  nodes {
                    ... on ProjectV2FieldCommon {
                      id
                      name
                      dataType
                    }
                  }
                }
              }
            }
          }' -F org="$ORG" -F number="$PROJECT_NUMBER") || {
            echo "Error: Failed to query project" >&2
            exit 1
          }

          # Check for GraphQL errors (including permission issues)
          if echo "$RESP" | jq -e '.errors' > /dev/null 2>&1; then
            echo "Error: GraphQL returned errors:" >&2
            echo "$RESP" | jq '.errors' >&2

            # Check specifically for scope issues
            if echo "$RESP" | jq -e '.errors[] | select(.type == "INSUFFICIENT_SCOPES")' > /dev/null 2>&1; then
              echo "" >&2
              echo "Token is missing required scopes. Please update DATE_AUTOMATION secret with:" >&2
              echo "  - read:project (to read project data)" >&2
              echo "  - project or write:project (to update fields)" >&2
            fi
            exit 1
          fi

          PROJECT_ID=$(echo "$RESP" | jq -r '.data.organization.projectV2.id // empty')

          if [ -z "$PROJECT_ID" ]; then
            echo "Error: Project '$PROJECT_NUMBER' not found in org '$ORG'" >&2
            echo "This may be due to:" >&2
            echo "  - Project doesn't exist" >&2
            echo "  - Token lacks 'read:project' scope (or token is expired)" >&2
            echo "  - Token doesn't have access to the organization" >&2
            exit 1
          fi

          FIELD_ID=$(echo "$RESP" | jq -r --arg NAME "$OPENED_ON_FIELD_NAME" '.data.organization.projectV2.fields.nodes[] | select(. != null and .name==$NAME) | .id // empty')

          if [ -z "$FIELD_ID" ]; then
            echo "Error: Field '$OPENED_ON_FIELD_NAME' not found in project" >&2
            echo "Available fields:" >&2
            echo "$RESP" | jq -r '.data.organization.projectV2.fields.nodes[] | select(. != null) | "\(.name) [\(.dataType)]"' >&2
            exit 1
          fi

          echo "opened_date=$OPENED_DATE" >> "$GITHUB_OUTPUT"
          echo "project_id=$PROJECT_ID" >> "$GITHUB_OUTPUT"
          echo "field_id=$FIELD_ID" >> "$GITHUB_OUTPUT"

      - name: Add Issue to Project and Set Date
        run: |
          set -e

          # Add issue to project (idempotent - will return existing item if already added)
          ADD_RESP=$(gh api graphql -f query='
          mutation($projectId:ID!, $contentId:ID!){
            addProjectV2ItemById(input:{projectId:$projectId, contentId:$contentId}){
              item{ id }
            }
          }' \
          -F projectId='${{ steps.setup.outputs.project_id }}' \
          -F contentId='${{ github.event.issue.node_id }}') || {
            echo "Error: Failed to add issue to project" >&2
            exit 1
          }

          if echo "$ADD_RESP" | jq -e '.errors' > /dev/null 2>&1; then
            echo "Error: Failed to add issue to project:" >&2
            echo "$ADD_RESP" | jq '.errors' >&2

            # Check for scope/permission issues
            if echo "$ADD_RESP" | jq -e '.errors[] | select(.type == "INSUFFICIENT_SCOPES" or (.message // "" | contains("permission")))' > /dev/null 2>&1; then
              echo "" >&2
              echo "Token may lack 'project' or 'write:project' scope" >&2
            fi
            exit 1
          fi

          ITEM_ID=$(echo "$ADD_RESP" | jq -r '.data.addProjectV2ItemById.item.id // empty')
          if [ -z "$ITEM_ID" ]; then
            echo "Error: Could not get project item ID" >&2
            exit 1
          fi

          # Set the "Opened On" field value
          UPDATE_RESP=$(gh api graphql -f query='
          mutation($projectId:ID!, $itemId:ID!, $fieldId:ID!, $date:String!){
            updateProjectV2ItemFieldValue(input:{
              projectId:$projectId,
              itemId:$itemId,
              fieldId:$fieldId,
              value:{ date:$date }
            }){
              projectV2Item{ id }
            }
          }' \
          -F projectId='${{ steps.setup.outputs.project_id }}' \
          -F itemId="$ITEM_ID" \
          -F fieldId='${{ steps.setup.outputs.field_id }}' \
          -F date='${{ steps.setup.outputs.opened_date }}') || {
            echo "Error: Failed to set field value" >&2
            exit 1
          }

          if echo "$UPDATE_RESP" | jq -e '.errors' > /dev/null 2>&1; then
            echo "Error: Failed to set field value:" >&2
            echo "$UPDATE_RESP" | jq '.errors' >&2

            # Check for scope/permission issues
            if echo "$UPDATE_RESP" | jq -e '.errors[] | select(.type == "INSUFFICIENT_SCOPES" or (.message // "" | contains("permission")))' > /dev/null 2>&1; then
              echo "" >&2
              echo "Token may lack 'project' or 'write:project' scope" >&2
            fi
            exit 1
          fi

          if ! echo "$UPDATE_RESP" | jq -e '.data.updateProjectV2ItemFieldValue.projectV2Item.id' > /dev/null 2>&1; then
            echo "Error: Field update returned unexpected response" >&2
            exit 1
          fi

          echo "Successfully set 'Opened On' to ${{ steps.setup.outputs.opened_date }} for issue #${{ github.event.issue.number }}"
