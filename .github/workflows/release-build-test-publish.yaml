name: "[internal] Release, build, test, and publish"
on:
  workflow_call:
    inputs:
      dry-run:
        description: "Dry-run: If true, do not upload tag or draft release."
        required: false
        default: false
        type: boolean
      platform:
        description: "Platform for building and testing (e.g., 'Ubuntu 22.04', 'Ubuntu 24.04')"
        required: false
        default: "Ubuntu 22.04"
        type: string
      tag-version:
        description: "Tag version to create, e.g. 'rc' for release candidate, 'dev' for dev development, or '' for normal release"
        required: true
        default: ""
        type: string
      is-release-candidate:
        description: "If true, this is a release candidate, and some steps will be skipped"
        required: false
        default: "false"
        type: string
      main-platform:
        description: "Main platform that all test workflows should run on"
        required: false
        default: "Ubuntu 22.04"
        type: string

permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  # Parse platform to extract distro/version for downstream workflows.
  # NOTE: This parse-platform is needed because create-docker-release-image and
  # release-docs jobs use the parsed distro/version values to construct image tags.
  # This is different from workflows that just pass platform to build-artifact.yaml.
  parse-platform:
    runs-on: ubuntu-latest
    outputs:
      distro: ${{ steps.parse.outputs.distro }}
      version: ${{ steps.parse.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: .github/actions
          sparse-checkout-cone-mode: false
      - id: parse
        uses: ./.github/actions/parse-platform
        with:
          platform: ${{ inputs.platform }}

  build-artifact:
      needs: parse-platform
      uses: ./.github/workflows/build-artifact.yaml
      permissions:
        packages: write
      secrets: inherit
      with:
        platform: ${{ inputs.platform || 'Ubuntu 22.04' }}
        build-wheel: true
        tracy: false
        fetch-depth: 0
        skip-tt-train: false
        enable-lto: false

  single-card-demo-tests:
    needs: build-artifact
    if: ${{ inputs.tag-version != '' }}
    secrets: inherit
    uses: ./.github/workflows/single-card-demo-tests-impl.yaml
    with:
      docker-image: ${{ needs.build-artifact.outputs.dev-docker-image }}
      build-artifact-name: ${{ needs.build-artifact.outputs.build-artifact-name }}
      wheel-artifact-name: ${{ needs.build-artifact.outputs.wheel-artifact-name }}
      arch: wormhole_b0
      mlperf-read-only: ${{ !(github.ref == 'refs/heads/stable' || startsWith(github.ref, 'refs/tags/v')) }}

  t3000-demo-tests:
    needs: build-artifact
    if: ${{ inputs.platform == inputs.main-platform && inputs.tag-version != '' }}
    secrets: inherit
    uses: ./.github/workflows/t3000-demo-tests-impl.yaml
    with:
      docker-image: ${{ needs.build-artifact.outputs.dev-docker-image }}
      wheel-artifact-name: ${{ needs.build-artifact.outputs.wheel-artifact-name }}
      build-artifact-name: ${{ needs.build-artifact.outputs.build-artifact-name }}
      mlperf-read-only: ${{ !(github.ref == 'refs/heads/stable' || startsWith(github.ref, 'refs/tags/v')) }}
      extra-tag: "in-release"

  galaxy-demos:
    needs: build-artifact
    if: ${{ inputs.platform == inputs.main-platform && inputs.tag-version != '' }}
    uses: ./.github/workflows/galaxy-demo-tests-impl.yaml
    secrets: inherit
    with:
      docker-image: ${{ needs.build-artifact.outputs.dev-docker-image }}
      wheel-artifact-name: ${{ needs.build-artifact.outputs.wheel-artifact-name }}
      build-artifact-name: ${{ needs.build-artifact.outputs.build-artifact-name }}
      enabled-skus: wh_galaxy
      mlperf-read-only: ${{ !(github.ref == 'refs/heads/stable' || startsWith(github.ref, 'refs/tags/v')) }}

  blackhole-demo-tests:
    needs: build-artifact
    if: ${{ inputs.platform == inputs.main-platform && inputs.tag-version != '' }}
    secrets: inherit
    uses: ./.github/workflows/blackhole-demo-tests-impl.yaml
    strategy:
      fail-fast: false
      matrix:
        test-group:
          - name: P150 Demo tests
            runner-label: P150
            extra-tag: pipeline-perf
            num_devices: 1
          - name: LLMBox Demo tests
            runner-label: BH-LLMBox
            extra-tag: pipeline-perf
            num_devices: 4
          - name: LoudBox Demo tests
            runner-label: BH-LoudBox
            extra-tag: pipeline-functional
            num_devices: 8
          - name: P300 Demo tests
            runner-label: P300-viommu
            extra-tag: pipeline-yyz2-lfc
            num_devices: 2
          # - name: QuietBox Global Edition tests
          #   runner-label: BH-QB-GE
          #   extra-tag: pipeline-perf
          #   num_devices: 4
    with:
      runner-label: ${{ matrix.test-group.runner-label }}
      docker-image: ${{ needs.build-artifact.outputs.dev-docker-image }}
      build-artifact-name: ${{ needs.build-artifact.outputs.build-artifact-name }}
      wheel-artifact-name: ${{ needs.build-artifact.outputs.wheel-artifact-name }}
      extra-tag: ${{ matrix.test-group.extra-tag }}
      num_devices: ${{ matrix.test-group.num_devices }}
      regenerate-ttnn-cache: false
      model: "all"

  # We need to tag the image used to reproduce the release later
  push-image-to-ghcr:
    needs: build-artifact
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Push dev docker image to GHCR with release tag
        uses: ./.github/actions/push-latest-image-to-ghcr
        with:
          docker-image-tag: ${{ needs.build-artifact.outputs.dev-docker-image }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          new-tag: ${{ inputs.tag-version || 'latest' }}

  create-docker-release-image:
    needs:
      - build-artifact
      - parse-platform
    uses: ./.github/workflows/publish-release-image.yaml
    secrets: inherit
    if: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/stable' || startsWith(github.ref, 'refs/tags/v') || inputs.dry-run }}
    with:
      os: ${{ needs.parse-platform.outputs.distro }}-${{ needs.parse-platform.outputs.version }}
      version: ${{ inputs.tag-version }}
      tag-latest:  ${{ inputs.is-release-candidate != 'true' }}
      wheel-artifact-name: ${{ needs.build-artifact.outputs.wheel-artifact-name }}
      dry-run: ${{ inputs.dry-run }}

  # Only run docs release once per run on the main platform
  release-docs:
    needs: [build-artifact, parse-platform]
    if: ${{ inputs.platform == inputs.main-platform && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/stable' || startsWith(github.ref, 'refs/tags/v') || inputs.dry-run) }}
    uses: ./.github/workflows/docs-latest-public.yaml
    with:
      version: ${{ inputs.tag-version }}
      docker-image: ${{ needs.build-artifact.outputs.dev-docker-image }}
      wheel-artifact-name: ${{ needs.build-artifact.outputs.wheel-artifact-name }}
      dry-run: ${{ inputs.dry-run }}
    secrets: inherit

  publish-wheels:
    name: "Publish wheels to internal PyPI"
    needs: build-artifact
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # Required for AWS OIDC
    if: ${{ github.ref == 'refs/heads/main' }}
    steps:
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.PYPI_ROLE }}
          aws-region: ${{ secrets.PYPI_REGION }}

      - name: Install s3pypi
        run: |
          pip install s3pypi

      - name: Download wheel artifacts
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0
        with:
          name: ${{ needs.build-artifact.outputs.wheel-artifact-name }}
          path: ./wheels

      - name: Publish wheels to internal PyPI
        if: ${{ github.ref == 'refs/heads/main' && !inputs.dry-run }}
        run: |
          found_wheel_files=$(find ./wheels -type f -name "*.whl" -exec realpath {} \;)
          for wheel in $found_wheel_files; do
            echo "Publishing wheel: $wheel"
            s3pypi upload "$wheel" --put-root-index --bucket ${{ secrets.PYPI_BUCKET }}
          done
