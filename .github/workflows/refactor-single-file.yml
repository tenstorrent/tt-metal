name: Refactor Single File (Reusable)

on:
  workflow_call:
    inputs:
      file_path:
        required: true
        type: string
      batch_id:
        required: true
        type: string
      base_branch:
        required: true
        type: string
      branch_name:
        required: true
        type: string
    secrets:
      AY_KEY:
        required: true
      AI_GH_TOKEN:
        required: true

jobs:
  refactor-file:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
      id-token: write
    steps:
      - name: ðŸ§¬ Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 500

      - name: ðŸŒ¿ Setup Branch
        env:
          GITHUB_TOKEN: ${{ secrets.AI_GH_TOKEN }}
        run: |
          BRANCH_NAME="${{ inputs.branch_name }}"
          BASE_BRANCH="${{ inputs.base_branch }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Checkout base branch and pull latest
          git checkout "$BASE_BRANCH" || git checkout main || git checkout master
          git pull origin "$BASE_BRANCH" || true

          # Create or checkout feature branch
          git checkout -b "$BRANCH_NAME" || git checkout "$BRANCH_NAME"
          git pull origin "$BRANCH_NAME" || true

      - name: ðŸ’¾ Cache Build Artifacts
        uses: actions/cache@v4
        with:
          path: |
            build_Debug/**
            build/**
            .ccache/**
          key: ${{ runner.os }}-build-cache-${{ hashFiles('CMakeLists.txt', '**/CMakeLists.txt') }}
          restore-keys: |
            ${{ runner.os }}-build-cache-

      - name: ðŸ”§ Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ runner.os }}-ccache-${{ hashFiles('CMakeLists.txt', '**/CMakeLists.txt') }}
          restore-keys: |
            ${{ runner.os }}-ccache-
          max-size: 2G

      - name: ðŸ¤– Run Claude Code Refactoring
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.AY_KEY }}
          github_token: ${{ secrets.AI_GH_TOKEN }}
          prompt: |
            You are refactoring a single device operation file to convert from register_operation to direct function calls.

            **File to refactor:** ${{ inputs.file_path }}

            Follow the instructions in REFACTORING_GUIDE.md exactly.

            **Steps:**
            1. Read REFACTORING_GUIDE.md to understand the refactoring pattern
            2. Read the file: ${{ inputs.file_path }}
            3. Extract the register_operation call and the invoke function from the .hpp file
            4. Replace register_operation with a direct function declaration in the .hpp (same namespace)
            5. Remove the invoke member function declaration from the operation class in the .hpp
            6. Find the corresponding .cpp file and implement the new global function
            7. Remove the invoke member function implementation from the .cpp
            8. Run: ./build_metal.sh -c -e --debug
            9. If the build fails, analyze the compiler errors and fix the code
            10. Rebuild until the build succeeds

            **CRITICAL:** The build MUST succeed before you finish. Do not stop until the build passes.
          settings: |
            {
              "env": {
                "DEBUG": "true",
                "VERBOSE": "1"
              },
              "hooks": {
                "PreToolUse": [
                  {
                    "matcher": "Bash",
                    "hooks": [
                      {
                        "type": "command",
                        "command": "echo 'ðŸ”§ Running Bash command..'"
                      }
                    ]
                  }
                ]
              }
            }
          claude_args: |
            --allowedTools Bash,Edit,Read,Write,mcp__sequential-thinking__sequentialthinking
            --system-prompt "You are a senior C++ engineer refactoring device operations. Be precise and follow the REFACTORING_GUIDE.md exactly. Use sequential thinking to plan your refactoring steps carefully."
            --mcp-config '{"mcpServers": {"sequential-thinking": {"command": "npx", "args": ["-y", "@modelcontextprotocol/server-sequential-thinking"]}}}'
            --max-turns 30
            --verbose

      - name: ðŸ§¹ Ensure .gitignore Excludes Cache
        run: |
          if ! grep -q "^\.ccache/" .gitignore 2>/dev/null; then
            echo ".ccache/" >> .gitignore
          fi

      - name: ðŸ’¾ Commit and Push Single File
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.AI_GH_TOKEN }}
        run: |
          BRANCH_NAME="${{ inputs.branch_name }}"
          FILE_PATH="${{ inputs.file_path }}"

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Add all changes, then remove .ccache from staging
          git add -A
          git reset -- .ccache/ .ccache/** 2>/dev/null || true

          # Also ensure .ccache is in .gitignore (already done in previous step, but double-check)
          if ! grep -q "^\.ccache/" .gitignore 2>/dev/null; then
            echo ".ccache/" >> .gitignore
            git add .gitignore
          fi

          # Commit if there are changes (excluding .ccache)
          if ! git diff --cached --quiet; then
            git commit -m "Refactor $FILE_PATH: Convert register_operation to direct function (batch ${{ inputs.batch_id }})" || echo "Nothing to commit"
          fi

          # Push
          git push "https://${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git" HEAD:"$BRANCH_NAME" || {
            git pull "https://${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git" "$BRANCH_NAME" --rebase || true
            git push "https://${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git" HEAD:"$BRANCH_NAME"
          }

      - name: ðŸ”€ Create/Update Pull Request
        if: success()
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.AI_GH_TOKEN }}
          branch: ${{ inputs.branch_name }}
          base: ${{ inputs.base_branch }}
          commit-message: |
            Refactor batch ${{ inputs.batch_id }}: Convert register_operation to direct functions

            Files are being refactored one at a time and verified with builds.
          title: '[Refactor] Batch ${{ inputs.batch_id }}: Convert register_operation to direct functions'
          body: |
            ## Refactoring Batch ${{ inputs.batch_id }}

            This PR contains refactored device operations from batch ${{ inputs.batch_id }}.

            **Current file:** ${{ inputs.file_path }}

            **Changes:**
            - Removed `register_operation` calls
            - Replaced with direct function declarations
            - Removed `invoke` member functions
            - Implemented new global functions

            **Build status:** âœ… Each file verified with `./build_metal.sh -c -e --debug`

            This is part of a parallel refactoring effort to convert all device operations.
            See REFACTORING_GUIDE.md for details.
          labels: refactor,automated
          delete-branch: false
          add-paths: |
            **/*.hpp
            **/*.cpp
            .gitignore
            REFACTORING_GUIDE.md
