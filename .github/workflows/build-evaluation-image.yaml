name: "Build Evaluation Image"

permissions:
  packages: write

on:
  workflow_call:
    inputs:
      evaluation-image-tag:
        required: false
        description: "(default: sha-run_id)"
        type: string
        default: ""
      build-args:
        required: false
        description: "Additional build arguments to pass to docker build"
        type: string
        default: ""
      buildkit:
        required: false
        description: "Whether to use BuildKit remote build or local docker installation"
        type: boolean
        default: false
      runner-label:
        required: false
        description: "runner requires kvm when buildkit disabled"
        type: string
        default: "tt-ubuntu-2204-large-stable"
      cache-from:
        required: false
        description: "Cache from option for docker build"
        type: string
        default: ""
      cache-to:
        required: false
        description: "Cache to option for docker build"
        type: string
        default: ""
      push-to-harbor:
        required: false
        description: "Whether to push the built image to Harbor registry"
        type: boolean
        default: true
      push-to-ghcr:
        required: false
        description: "Whether to push the built image to GitHub Container Registry"
        type: boolean
        default: false
    outputs:
      evaluation-image-url:
        description: "Docker image URL(s) for the evaluation image"
        value: ${{ jobs.build-evaluation-image.outputs.evaluation-image-url }}
  workflow_dispatch:
    inputs:
      evaluation-image-tag:
        required: false
        description: "(default: github sha)"
        type: string
        default: ""
      build-args:
        required: false
        description: "Additional build arguments to pass to docker build"
        type: string
        default: ""
      buildkit:
        required: false
        description: "Whether to use BuildKit remote build or local docker installation"
        type: boolean
        default: false
      runner-label:
        required: false
        description: "runner requires kvm when buildkit disabled"
        type: string
        default: "tt-ubuntu-2204-large-stable"
      cache-from:
        required: false
        description: "Cache from option for docker build"
        type: string
        default: "type=inline"
      cache-to:
        required: false
        description: "Cache to option for docker build"
        type: string
        default: "type=inline"
      push-to-harbor:
        required: false
        description: "Whether to push the built image to Harbor registry"
        type: boolean
        default: true
      push-to-ghcr:
        required: false
        description: "Whether to push the built image to GitHub Container Registry"
        type: boolean
        default: false

env:
  BUILDKIT_HOST: buildkitd.buildkit.svc.cluster.local
  BUILDKIT_PORT: 1234

jobs:
  build-evaluation-image:
    name: "Build and push"
    runs-on: ${{ inputs.runner-label }}
    timeout-minutes: 30
    outputs:
      evaluation-image-url: ${{ steps.docker-metadata.outputs.tags }}
    steps:
      - name: ⬇️ Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set evaluation image metadata
        id: evaluation-image-metadata
        run: |
          # Construct tag
          if [ -z "${{ inputs.evaluation-image-tag }}" ]; then
            eval_image_tag="${{ github.sha }}-${{ github.run_id }}"
          else
            eval_image_tag="${{ inputs.evaluation-image-tag }}"
          fi
          echo "Evaluation image tag: $eval_image_tag"

          # Construct image URLs
          image_urls=()
          if [ "${{ inputs.push-to-harbor }}" = "true" ]; then
            image_urls+=("harbor.ci.tenstorrent.net/evaluation/tt-metalium")
          fi
          if [ "${{ inputs.push-to-ghcr }}" = "true" ]; then
            image_urls+=("ghcr.io/tenstorrent/evaluation/tt-metalium")
          fi

          evaluation_image_names=$(IFS=$'\n' ; echo "${image_urls[*]}")

          echo "Evaluation image names: $evaluation_image_names"

          echo "evaluation-image-names=$evaluation_image_names" >> $GITHUB_OUTPUT
          echo "evaluation-image-tag=$eval_image_tag" >> $GITHUB_OUTPUT

      - name: Login to Harbor Container Registry
        if: ${{ inputs.push-to-harbor }}
        uses: docker/login-action@v3
        with:
          registry: harbor.ci.tenstorrent.net
          username: ${{ secrets.HARBOR_PUSH_USER }}
          password: ${{ secrets.HARBOR_PUSH_PASSWORD }}

      - name: Login to GitHub Container Registry
        if: ${{ inputs.push-to-ghcr }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify BuildKit connection
        if: ${{ inputs.buildkit }}
        run: |

          nc -zv ${{ env.BUILDKIT_HOST }} ${{ env.BUILDKIT_PORT }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        if: ${{ inputs.buildkit }}
        with:
          driver: remote
          endpoint: tcp://${{ env.BUILDKIT_HOST }}:${{ env.BUILDKIT_PORT }}
        env:
          BUILDER_NODE_0_AUTH_TLS_CACERT: ${{ secrets.BUILDKIT_CA_CERT }}
          BUILDER_NODE_0_AUTH_TLS_CERT: ${{ secrets.BUILDKIT_CERT }}
          BUILDER_NODE_0_AUTH_TLS_KEY: ${{ secrets.BUILDKIT_KEY }}

      - name: Extract metadata (tags, labels)
        id: docker-metadata
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.evaluation-image-metadata.outputs.evaluation-image-names }}
          tags: |
            # Tag as 'latest' for pushes to main branch
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=${{ steps.evaluation-image-metadata.outputs.evaluation-image-tag }}

      - name: Build and push Evaluation image
        uses: docker/build-push-action@v6
        with:
          context: ${{ github.workspace }}
          file: dockerfile/Dockerfile.evaluation
          tags: ${{ steps.docker-metadata.outputs.tags }}
          labels: ${{ steps.docker-metadata.outputs.labels }}
          build-args: ${{ inputs.build-args }}
          cache-from: ${{ inputs.cache-from }}
          cache-to: ${{ inputs.cache-to }}
          push: true
