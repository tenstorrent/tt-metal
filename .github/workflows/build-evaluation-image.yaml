name: "Build tt-metal evaluation image"

on:
  workflow_call:
    inputs:
      base-image-name:
        required: true
        description: "Name of the base docker image to use for evaluation image"
        type: string
      evaluation-image-name:
        required: true
        description: "Name of the evaluation docker image to build and push"
        type: string
      build-artifact-name:
        required: true
        description: "Name of the build artifact to download"
        type: string
      wheel-artifact-name:
        required: true
        description: "Name of the python wheel artifact to download"
        type: string
      run-id:
        required: false
        description: "The run ID from which to download the build artifacts (defaults to current run)"
        type: string
    outputs:
      evaluation-docker-image:
        description: "Docker tag for the evaluation Docker image"
        value: ${{ inputs.evaluation-image-name }}

  workflow_dispatch:
    inputs:
      base-image-name:
        required: true
        description: "Name of the base docker image to use for evaluation image"
        type: string
      evaluation-image-name:
        required: true
        description: "Name of the evaluation docker image to build and push"
        type: string
      build-artifact-name:
        required: true
        description: "Name of the build artifact to download"
        type: string
      wheel-artifact-name:
        required: true
        description: "Name of the python wheel artifact to download"
        type: string
      run-id:
        required: false
        description: "The run ID from which to download the build artifacts (defaults to current run)"
        type: string

jobs:
  build-evaluation-image:
    name: "üì¶ Build Evaluation Docker Image"
    runs-on: tt-ubuntu-2204-large-stable
    timeout-minutes: 30
    steps:
      - name: ‚¨áÔ∏è Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Login to Harbor Container Registry
        uses: docker/login-action@v3
        with:
          registry: https://harbor.ci.tenstorrent.net
          username: ${{ secrets.HARBOR_PUSH_USER }}
          password: ${{ secrets.HARBOR_PUSH_PASSWORD }}

      - name: üì¶ Download Build Artifact
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0
        with:
          name: ${{ inputs.build-artifact-name }}
          run-id: ${{ inputs.run-id || github.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path: ./artifacts

      - name: üß™ Download Wheel
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0
        with:
          name: ${{ inputs.wheel-artifact-name }}
          run-id: ${{ inputs.run-id || github.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path: ./artifacts

      - name: Build and push Evaluation image
        uses: docker/build-push-action@v6
        with:
          context: ${{ github.workspace }}
          file: dockerfile/Dockerfile.evaluation
          push: true
          tags: ${{ inputs.evaluation-image-name }}
          build-args: |
            BASE_IMAGE=${{ inputs.base-image-name }}
          cache-to: type=inline
          pull: true
