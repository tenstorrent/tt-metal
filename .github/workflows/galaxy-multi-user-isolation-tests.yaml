name: Galaxy Multi-user Isolation Tests
on:
  push:
    branches:
      - main
      - slee/multiusergalaxy
  workflow_dispatch:
    inputs:
      galaxy-multi-user-isolation-tests:
        description: 'Run Galaxy multi-host job'
        required: false
        default: true
        type: boolean

jobs:
  build-artifact:
    uses: ./.github/workflows/build-artifact.yaml
    permissions:
      packages: write
    secrets: inherit
    with:
      version: 22.04
      build-wheel: true
  galaxy-multi-user-isolation-tests:
    needs: build-artifact
    runs-on:
      # A physical, multi-host WH 6U that's in service
      - topology-6u
      - arch-wormhole_b0
      - bare-metal
      - g15glx04
    steps:
      - name: ⬇️ Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: ⬇️ Download Build
        uses: actions/download-artifact@v4
        timeout-minutes: 10
        with:
          name: ${{ needs.build-artifact.outputs.build-artifact-name }}
      - name: Extract files
        run: tar -xvf ttm_any.tar
      - name: ⬇️ Download Wheel
        uses: actions/download-artifact@v4
        timeout-minutes: 10
        with:
          name: ${{ needs.build-artifact.outputs.wheel-artifact-name }}
      - name: Create Docker Compose file
        run: |
          cat > multi-user-dc.yaml <<EOF
          services:
            tray-1:
              image: ${{ needs.build-artifact.outputs.dev-docker-image }}
              stdin_open: true
              tty: true
              volumes:
                  - ${{ github.workspace }}:/app/tt-metal
              entrypoint: ["sleep", "infinity"]
              user: "\${USER_ID}:\${GROUP_ID}"
              working_dir: /app/tt-metal
              environment:
                LD_LIBRARY_PATH: /app/tt-metal/build/lib
                TT_METAL_HOME: /app/tt-metal
              devices:
                - "/dev/tenstorrent/0:/dev/tenstorrent/0"
                - "/dev/tenstorrent/1:/dev/tenstorrent/1"
                - "/dev/tenstorrent/2:/dev/tenstorrent/2"
                - "/dev/tenstorrent/3:/dev/tenstorrent/3"
                - "/dev/tenstorrent/4:/dev/tenstorrent/4"
                - "/dev/tenstorrent/5:/dev/tenstorrent/5"
                - "/dev/tenstorrent/6:/dev/tenstorrent/6"
                - "/dev/tenstorrent/7:/dev/tenstorrent/7"

            tray-2:
              image: ${{ needs.build-artifact.outputs.dev-docker-image }}
              stdin_open: true
              tty: true
              volumes:
                  - ${{ github.workspace }}:/app/tt-metal
              entrypoint: ["sleep", "infinity"]
              user: "\${USER_ID}:\${GROUP_ID}"
              working_dir: /app/tt-metal
              environment:
                LD_LIBRARY_PATH: /app/tt-metal/build/lib
                TT_METAL_HOME: /app/tt-metal
              devices:
                - "/dev/tenstorrent/8:/dev/tenstorrent/8"
                - "/dev/tenstorrent/9:/dev/tenstorrent/9"
                - "/dev/tenstorrent/10:/dev/tenstorrent/10"
                - "/dev/tenstorrent/11:/dev/tenstorrent/11"
                - "/dev/tenstorrent/12:/dev/tenstorrent/12"
                - "/dev/tenstorrent/13:/dev/tenstorrent/13"
                - "/dev/tenstorrent/14:/dev/tenstorrent/14"
                - "/dev/tenstorrent/15:/dev/tenstorrent/15"

            tray-3:
              image: ${{ needs.build-artifact.outputs.dev-docker-image }}
              stdin_open: true
              tty: true
              volumes:
                  - ${{ github.workspace }}:/app/tt-metal
              entrypoint: ["sleep", "infinity"]
              user: "\${USER_ID}:\${GROUP_ID}"
              working_dir: /app/tt-metal
              environment:
                LD_LIBRARY_PATH: /app/tt-metal/build/lib
                TT_METAL_HOME: /app/tt-metal
              devices:
                - "/dev/tenstorrent/16:/dev/tenstorrent/16"
                - "/dev/tenstorrent/17:/dev/tenstorrent/17"
                - "/dev/tenstorrent/18:/dev/tenstorrent/18"
                - "/dev/tenstorrent/19:/dev/tenstorrent/19"
                - "/dev/tenstorrent/20:/dev/tenstorrent/20"
                - "/dev/tenstorrent/21:/dev/tenstorrent/21"
                - "/dev/tenstorrent/22:/dev/tenstorrent/22"
                - "/dev/tenstorrent/23:/dev/tenstorrent/23"

            tray-4:
              image: ${{ needs.build-artifact.outputs.dev-docker-image }}
              stdin_open: true
              tty: true
              volumes:
                  - ${{ github.workspace }}:/app/tt-metal
              entrypoint: ["sleep", "infinity"]
              user: "\${USER_ID}:\${GROUP_ID}"
              working_dir: /app/tt-metal
              environment:
                LD_LIBRARY_PATH: /app/tt-metal/build/lib
                TT_METAL_HOME: /app/tt-metal
              devices:
                - "/dev/tenstorrent/24:/dev/tenstorrent/24"
                - "/dev/tenstorrent/25:/dev/tenstorrent/25"
                - "/dev/tenstorrent/26:/dev/tenstorrent/26"
                - "/dev/tenstorrent/27:/dev/tenstorrent/27"
                - "/dev/tenstorrent/28:/dev/tenstorrent/28"
                - "/dev/tenstorrent/29:/dev/tenstorrent/29"
                - "/dev/tenstorrent/30:/dev/tenstorrent/30"
                - "/dev/tenstorrent/31:/dev/tenstorrent/31"
          EOF

      - name: Run Docker Compose
        run: |
          USER_ID=$(id -u) GROUP_ID=$(id -g) docker compose -f multi-user-dc.yaml up -d

      - name: Run the tests
        run: |
          run_test() {
            command=$1
            pids=()
            for tray in tray-1 tray-2 tray-3 tray-4; do
              cname="multihosttest-$tray-1"
              echo ">>> Running tests in $cname"
              docker exec "$cname" bash -c "$command" &
              pids+=($!)
            done

            status=0
            for pid in "${pids[@]}"; do
              if ! wait "$pid"; then
                status=1
              fi
            done

            if [ $status -ne 0 ]; then
              exit 1
            fi
          }

          export -f run_test
          run_test "./build/test/tt_metal/tt_fabric/test_system_health --cluster-type T3K"

      - name: Tear down containers
        if: always()
        run: |
          USER_ID=$(id -u) GROUP_ID=$(id -g) docker compose -f multi-user-dc.yaml down
