name: "[internal] Validate installation step from instructions impl"


on:
  workflow_call:
    inputs:
      runner-label:
        required: false
        type: string
        default: N150

jobs:
  install-and-run-mnist:
    name: Install deps and run MNIST MLP
    runs-on: ${{ format('tt-ubuntu-2204-{0}-viommu-stable', inputs.runner-label) }}
    timeout-minutes: 15
    steps:
      - name: Prepare system
        run: |
          # The runners come with docker preinstalled but we want to
          # simulate a completely blank system for our Podman install
          sudo apt-get purge -y docker-ce docker-ce-cli containerd.io

      - name: Install TT dependencies via TT-Installer
        shell: bash
        run: |
          set -euo pipefail
          timeout 60 curl -fsSL https://github.com/tenstorrent/tt-installer/releases/download/v2.1.0/install.sh -O
          chmod +x install.sh

          timeout 600 bash ./install.sh \
            --update-firmware=off \
            --install-metalium-models-container \
            --verbose \
            --reboot-option=never \
            --mode-non-interactive

      - name: Run MNIST MLP via tt-metalium-models
        shell: bash
        timeout-minutes: 10
        run: |
          set -euo pipefail
          export PATH=~/.local/bin:$PATH
          tt-metalium-models -c "python3 ttnn/tutorials/basic_python/ttnn_mlp_inference_mnist.py"

      - name: Download Falcon7b weights via tt-metalium-models
        shell: bash
        timeout-minutes: 30
        env:
          HF_CACHE_DIR: ${{ runner.temp }}/hf_cache
        run: |
          set -euo pipefail
          export PATH=~/.local/bin:$PATH
          mkdir -p "$HF_CACHE_DIR"
          echo "Downloading Falcon7b weights to $HF_CACHE_DIR (auto-cleaned after workflow)..."
          # Mount host dir into container, download saves to mounted path -> persists on host
          tt-metalium-models \
            -v "$HF_CACHE_DIR:$HF_CACHE_DIR" \
            -c "export HF_HOME=$HF_CACHE_DIR && python3 -c \"from transformers import FalconForCausalLM; FalconForCausalLM.from_pretrained('tiiuae/falcon-7b-instruct')\""
          echo "Download complete. Host cache contents:"
          ls -la "$HF_CACHE_DIR/hub/" || true

      - name: Run Falcon7b Demo via tt-metalium-models
        shell: bash
        timeout-minutes: 30
        env:
          HF_CACHE_DIR: ${{ runner.temp }}/hf_cache
        run: |
          set -euo pipefail
          export PATH=~/.local/bin:$PATH
          # Mount same host HF cache into container - weights already there from previous step
          tt-metalium-models \
            -v "$HF_CACHE_DIR:$HF_CACHE_DIR" \
            -c "export HF_HOME=$HF_CACHE_DIR && pytest --disable-warnings -q -s \
              --input-method=json \
              --input-path='models/demos/ttnn_falcon7b/demo/input_data.json' \
              models/demos/ttnn_falcon7b/demo/demo.py::test_demo"
