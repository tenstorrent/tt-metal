name: "[internal] CMake Configuration Tests"

on:
  workflow_call:
    inputs:
      docker-image:
        required: true
        type: string
      build-artifact-name:
        required: false
        type: string
        default: ""
  workflow_dispatch:
    inputs:
      docker-image:
        required: true
        type: string
        description: "Docker image to use for testing"

jobs:
  cmake-config-tests:
    runs-on: ubuntu-latest
    container:
      image: ${{ inputs.docker-image || 'docker-image-unresolved!' }}
      env:
        PYTHONPATH: /work
      volumes:
        - ${{ github.workspace }}/docker-job:/work
    defaults:
      run:
        shell: bash
        working-directory: /work
    steps:
      - name: üß¨ Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          path: docker-job

      - name: ‚¨áÔ∏è  Setup Job (if build artifact provided)
        if: ${{ inputs.build-artifact-name != '' }}
        uses: ./docker-job/.github/actions/setup-job
        timeout-minutes: 10
        with:
          build-artifact-name: ${{ inputs.build-artifact-name }}

      - name: Run Distro Detection Tests
        timeout-minutes: 5
        run: |
          echo "Running distro detection unit tests..."
          python3 -m pytest tests/cmake/test_distro_detection.py -v

      - name: Run MPI Configuration Tests
        timeout-minutes: 10
        run: |
          echo "Running MPI configuration integration tests..."
          python3 -m pytest tests/cmake/test_mpi_configuration.py -v || echo "MPI tests may require MPI installation"

      - name: Validate RPATH (if build available)
        if: ${{ inputs.build-artifact-name != '' }}
        timeout-minutes: 5
        run: |
          echo "Validating RPATH/RUNPATH in built libraries..."
          if [ -f build/lib/libtt_metal.so ]; then
            ./tests/scripts/validate_rpath.sh build libtt_metal.so
          elif [ -f build/lib/libtt_stl.so ]; then
            ./tests/scripts/validate_rpath.sh build libtt_stl.so
          else
            echo "No libraries found for RPATH validation"
          fi

      - uses: tenstorrent/tt-metal/.github/actions/upload-artifact-with-job-uuid@main
        timeout-minutes: 10
        if: ${{ !cancelled() }}
        with:
          prefix: "cmake_test_reports_"

      - uses: tenstorrent/tt-metal/.github/actions/cleanup@main
        if: always()
