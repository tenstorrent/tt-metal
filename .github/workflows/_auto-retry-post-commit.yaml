name: "[internal] Auto-retry post-commit"

on:
  workflow_dispatch:
    inputs:
      test_workflow_run_id:
        description: "Unique GitHub workflow run ID to use for test"
        default: 12788722730
        type: number
      test_workflow_run_attempt:
        description: "Run attempt of the workflow run"
        default: 1
        type: number
  workflow_run:
    workflows:
      - "All post-commit tests"
      - "(Single-card) Tests for new models"
      # We push to main, but not part of APC. TGs are flaky so we are going
      # to want to to
      - "zzz TG Quick tests"
      - "apc nightly debug run"
    types:
      - completed

jobs:
  auto-retry:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Get workflow run_id attempt number to analyze
        id: get-run-id-and-attempt
        shell: bash
        run: |
          event_name="${{ github.event_name }}"
          if [[ "$event_name" == "workflow_dispatch" ]]; then
            run_id="${{ inputs.test_workflow_run_id }}"
            attempt_number="${{ inputs.test_workflow_run_attempt }}"
          elif [[ "$event_name" == "workflow_run" ]]; then
            run_id="${{ github.event.workflow_run.id }}"
            attempt_number="${{ github.event.workflow_run.run_attempt }}"
            [[ -z "$run_id" ]] && { echo "run_id is empty" ; exit 1; }
            [[ -z "$attempt_number" ]] && { echo "attempt_number is empty" ; exit 1; }
          else
            echo "Unknown event name" && exit 1
          fi

          echo $run_id
          echo $attempt_number
          echo "run-id=$run_id" >> "$GITHUB_OUTPUT"
          echo "attempt-number=$attempt_number" >> "$GITHUB_OUTPUT"

          echo "::notice title=target-workflow-link::The workflow being analyzed is available at https://github.com/tenstorrent/tt-metal/actions/runs/$run_id/attempts/$attempt_number"
      - name: Determine if we should continue
        id: determine-should-continue
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          MAX_ATTEMPTS=3
          read original_trigger conclusion workflow_name <<< $(gh api /repos/tenstorrent/tt-metal/actions/runs/${{ steps.get-run-id-and-attempt.outputs.run-id }}/attempts/${{ steps.get-run-id-and-attempt.outputs.attempt-number }} --jq '.event + " " + .conclusion + " " + .name')
          caller_branch_name=$(gh api /repos/tenstorrent/tt-metal/actions/runs/${{ steps.get-run-id-and-attempt.outputs.run-id }} --jq '.head_branch')
          echo "caller workflow branch name: $caller_branch_name"

          if [[ "${{ steps.get-run-id-and-attempt.outputs.attempt-number }}" -ge "$MAX_ATTEMPTS" ]]; then
            echo "::notice title=no-continue-max-tries::This workflow has exceeded max tries. Not re-trying"
            should_continue=false
          elif [[ "$original_trigger" == "workflow_dispatch" && "$workflow_name" != "All post-commit tests (with retries)" ]]; then
            echo "::notice title=no-continue-is-on-branch::This workflow was a workflow dispatched on a branch, not main. Not re-trying"
            should_continue=false
          elif [[ "$conclusion" != "failure" ]]; then
            echo "::notice title=no-continue-did-not-fail::This workflow did not fail. Not re-trying"
            should_continue=false
          else
            should_continue=true
          fi

          echo "should-continue=$should_continue" >> "$GITHUB_OUTPUT"
          echo "caller_branch_name=$caller_branch_name" >> "$GITHUB_OUTPUT"
      - name: Determine if test failures exist
        id: determine-if-test-failures-exist
        if: ${{ steps.determine-should-continue.outputs.should-continue == 'true' }}
        env:
          GH_TOKEN: ${{ secrets.RETRY_WORKFLOW_TOKEN }}
        shell: bash
        run: |
          echo "should_rerun=true" >> "$GITHUB_OUTPUT"
          # If the caller branch is not main, we need to check for test failures
          # We only want to re-run if there are no test failures
          # If the caller branch is main, we can just re-run the workflow
          if [[ "${{ steps.determine-should-continue.outputs.caller_branch_name }}" != "main" ]]; then
            echo "Checking for test failures on non-main branch: ${{ steps.determine-should-continue.outputs.caller_branch_name }}"

            while read -r job; do
              job_id=$(echo "$job" | jq -r '.id')
              job_conclusion=$(echo "$job" | jq -r '.conclusion')

              # Only read annotations for failed jobs
              if [[ "$job_conclusion" == "failure" ]]; then
                echo "Checking annotations for failed job $job_id to see if we have test or infra failures"
                annotations=$(gh api /repos/tenstorrent/tt-metal/check-runs/$job_id/annotations)

                # Check each annotation for non-infra failures
                while read -r annotation; do
                  level=$(echo "$annotation" | jq -r '.annotation_level')
                  path=$(echo "$annotation" | jq -r '.path')

                  if [[ "$level" == "failure" && "$path" != ".github"* ]]; then
                    echo "::notice title=no-continue-test-failure::This workflow failed a test on job https://github.com/tenstorrent/tt-metal/actions/runs/${{ steps.get-run-id-and-attempt.outputs.run-id }}/job/$job_id Not re-trying"
                    echo "should_rerun=false" >> "$GITHUB_OUTPUT"
                    exit 0
                  fi
                done < <(echo "$annotations" | jq -c '.[]')
              fi
            done < <(gh api /repos/tenstorrent/tt-metal/actions/runs/${{ steps.get-run-id-and-attempt.outputs.run-id }}/attempts/${{ steps.get-run-id-and-attempt.outputs.attempt-number }}/jobs --paginate | jq -c '.jobs[] | {id: .id, conclusion: .conclusion}')
          fi
      - name: Re-run failed jobs
        if: ${{ steps.determine-if-test-failures-exist.outputs.should_rerun == 'true' }}
        env:
          GH_TOKEN: ${{ secrets.RETRY_WORKFLOW_TOKEN }}
        run: |
          echo "Re-running jobs here"
          gh api --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/tenstorrent/tt-metal/actions/runs/${{ steps.get-run-id-and-attempt.outputs.run-id }}/rerun-failed-jobs
      - uses: tenstorrent/tt-metal/.github/actions/slack-report@main
        if: ${{ failure() }}
        with:
          slack_webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          owner: U014XCQ9CF8 # tt-rkim
