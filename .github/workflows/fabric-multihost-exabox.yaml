name: "Fabric Test on a BH Quad"

on:
  workflow_dispatch:

run-name: Fabric Test on a BH Quad
jobs:
  build-artifact:
    uses: ./.github/workflows/build-artifact.yaml
    permissions:
      packages: write
    secrets: inherit
    with:
      build-wheel: true
      platform: 'Ubuntu 22.04'
      skip-tt-train: false
      ref: ${{ github.sha }}

  create-allocation:
    name: Create Allocation for 32x4 RINGxRING
    needs: build-artifact
    timeout-minutes: 30
    outputs:
      ranksData: ${{ steps.get-allocation-data.outputs.ranksData }}
      mgd: ${{ steps.mgd.outputs.mgd }}
    runs-on:
      group: exabox
      labels: exabox-multihost
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: MGD
        id: mgd
        run: |
          MGD_CONFIG='
            mesh_descriptors {
              name: \"M0\"
              arch: BLACKHOLE
              device_topology { dims: [ 32,4 ] dim_types: [ RING,RING ] }
              host_topology   { dims: [ 4,1 ] }
              channels { count: 2 policy: RELAXED }
            }
            top_level_instance { mesh { mesh_descriptor: \"M0\" mesh_id: 0 } }
          '
          echo "mgd<<EOF" >> $GITHUB_OUTPUT
          echo "$MGD_CONFIG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create allocation
        id: allocation
        uses: ./.github/actions/ttop-create-allocation
        with:
          allocationName: ci-${{ github.run_id }}
          spec: |
            allocationType: MGD
            matchLabels:
              exabox.tenstorrent.com/purpose: ci-quads
            topologyKeys:
              - exabox.tenstorrent.com/quad-id
            mgd: |-
              ${{ steps.mgd.outputs.mgd }}

      - name: Get Allocation data
        uses: ./.github/actions/ttop-get-allocation-data
        id: get-allocation-data
        with:
          allocationName: ci-${{ github.run_id }}

  run:
    name: Run test
    needs: [build-artifact, create-allocation]
    runs-on:
      group: exabox
      labels: exabox-multihost-with-nfs
    env:
      OMPI_MCA_btl_tcp_if_exclude: docker0,lo
      PRTE_MCA_plm_ssh_args: "-o StrictHostKeyChecking=false -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR"
      PRTE_MCA_plm_ssh_pass_libpath: /opt/openmpi-v5.0.7-ulfm/lib
      PRTE_MCA_prte_launch_agent: /opt/openmpi-v5.0.7-ulfm/bin/prted
      PRTE_MCA_prte_default_hostfile: /ci/ttrun/hostfile
      LD_LIBRARY_PATH: /home/user/tt-metal/build/lib
      TT_METAL_RUNTIME_ROOT: /home/user/tt-metal
      TT_METAL_CACHE: /home/user/.cache
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create environment
        uses: ./.github/actions/ttop-create-environment
        timeout-minutes: 5
        with:
          environmentName:  ci-${{ github.run_id }}
          allocationName:  ci-${{ github.run_id }}
          workerImage: ${{ needs.build-artifact.outputs.dev-docker-image }}
          sharedVolumeEnabled: 'true'

      - name: Setup tt-run
        uses: ./.github/actions/ttop-configure-tt-run
        timeout-minutes: 5
        with:
          directory: /ci/ttrun
          mgd: ${{ needs.create-allocation.outputs.mgd }}
          copyToWorkers: false
          ranksData: ${{ needs.create-allocation.outputs.ranksData }}

      - name: ðŸ“¦ Download Build Artifact
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0
        with:
          name: ${{ needs.build-artifact.outputs.build-artifact-name }}
          path: /ci/artifacts

      - name: ðŸ§ª Download Python Wheel
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0
        with:
          name: ${{ needs.wheel-artifact.outputs.wheel-artifact-name }}
          path: /ci/artifacts

      - name: Unpack artifacts & install
        run: |
          # Move the cloned directory to workers. TODO: Clone directly to NFS
          cp -r "$GITHUB_WORKSPACE" /ci/tt-metal
          mpirun --pernode cp -r /ci/tt-metal /home/user
          mpirun --pernode git -C /home/user/tt-metal submodule update --init --recursive

          # Unpack artifacts
          mpirun --pernode tar --zstd -xf /ci/artifacts/ttm_any.tar.zst -C /home/user/tt-metal
          mpirun --pernode pip install $(find /ci/artifacts | grep whl)

      - name: Run Physical discovery test
        timeout-minutes: 10
        run: |
            mpirun --tag-output -x LD_LIBRARY_PATH -x TT_METAL_RUNTIME_ROOT --pernode /home/user/tt-metal/build/test/tt_metal/tt_fabric/test_physical_discovery

      - name: Run Fabric Test
        run: |
          tt-run --skip-executable-check --rank-binding /ci/ttrun/rank_bindings.yaml --mpi-args "--tag-output --host $(paste -sd, /ci/ttrun/hostfile)" \
            /home/user/tt-metal/build/test/tt_metal/perf_microbenchmark/routing/test_tt_fabric --test_config /home/user/tt-metal/tests/tt_metal/tt_metal/perf_microbenchmark/routing/test_bh_glx_2d_torus_short_running.yaml

  cleanup:
    name: Cleanup
    needs: [run, create-allocation]
    if: always()
    runs-on:
      group: exabox
      labels: exabox-multihost
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Delete environment
        uses: ./.github/actions/ttop-delete-environment
        with:
          environmentName:  ci-${{ github.run_id }}

      - name: Delete allocation
        uses: ./.github/actions/ttop-delete-allocation
        with:
          allocationName:  ci-${{ github.run_id }}
