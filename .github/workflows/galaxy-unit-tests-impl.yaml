name: "[internal] Galaxy unit tests impl"

on:
  workflow_call:
    inputs:
      docker-image:
        required: true
        type: string
      build-artifact-name:
        required: true
        type: string
      wheel-artifact-name:
        required: true
        type: string
      model:
        required: false
        type: string
        default: "all"
      extra-tag:
        required: false
        type: string
        default: "in-service"
      topology:
        required: false
        type: string
        default: "topology-6u"

jobs:
  galaxy-umd-tests:
   strategy:
     fail-fast: false
     matrix:
       test-group: [
         {
           name: "Galaxy UMD unit tests",
           arch: wormhole_b0,
           runs-on: ["arch-wormhole_b0", "${{ inputs.topology }}", "${{ inputs.extra-tag }}", "bare-metal", "pipeline-functional"],
           cmd: "./build/test/umd/galaxy/unit_tests_glx",
           timeout: 10
         },  # Bojan Ro≈°ko
         {
           name: "UMD API tests",
           arch: wormhole_b0,
           runs-on: ["arch-wormhole_b0", "${{ inputs.topology }}", "${{ inputs.extra-tag }}", "bare-metal", "pipeline-functional"],
           cmd: "./build/test/umd/api/api_tests",
           timeout: 20
         },
       ]
   runs-on: ${{ matrix.test-group.runs-on }}
   container:
     image: ${{ inputs.docker-image }}
     env:
       ARCH_NAME: ${{ matrix.test-group.arch }}
       LOGURU_LEVEL: INFO
       LD_LIBRARY_PATH: /work/build/lib
     volumes:
       - ${{ github.workspace }}/docker-job:/work # Subdir to workaround https://github.com/actions/runner/issues/691
       - /dev/hugepages-1G:/dev/hugepages-1G
     options: "--device /dev/tenstorrent"
   defaults:
     run:
       shell: bash
       working-directory: /work # https://github.com/actions/runner/issues/878
   steps:
     - name: üß¨ Checkout Repository
       uses: actions/checkout@v4
       with:
         submodules: recursive
         path: docker-job
     - name: ‚¨áÔ∏è  Setup Job
       uses: ./docker-job/.github/actions/setup-job
       timeout-minutes: 10
       with:
         build-artifact-name: ${{ inputs.build-artifact-name }}

     - name: Run UMD unit regression tests
       timeout-minutes: ${{ matrix.test-group.timeout }}
       run: |
         ${{ matrix.test-group.cmd }}

     - uses: tenstorrent/tt-metal/.github/actions/cleanup@main
       if: always()
