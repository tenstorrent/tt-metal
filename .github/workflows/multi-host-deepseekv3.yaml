name: DeepSeek V3 Multi-Host Tests
on:
  workflow_dispatch:
    inputs:
      setup:
        description: 'Galaxy setup to test'
        required: true
        type: choice
        default: both
        options:
          - dual
          - quad
          - both
      deepseekv3_unit_tests:
        description: 'Run DeepSeek V3 unit tests'
        required: false
        default: false
        type: boolean
      deepseekv3_module_tests:
        description: 'Run DeepSeek V3 module tests'
        required: false
        default: false
        type: boolean
      teacher_forced:
        description: 'Run teacher forced accuracy test'
        required: false
        default: false
        type: boolean
      demo:
        description: 'Run demo test'
        required: false
        default: false
        type: boolean
      demo_stress:
        description: 'Run demo stress test'
        required: false
        default: false
        type: boolean
      platform:
        required: false
        type: choice
        default: "Ubuntu 22.04"
        options:
          - "Ubuntu 22.04"
          - "Ubuntu 24.04"
        description: "Platform to build and test"
      build-type:
        required: false
        type: choice
        default: Release
        options:
          - Release
          - Debug
          - RelWithDebInfo
          - ASan
          - TSan
        description: "Build type configuration"
      enable-lto:
        required: false
        type: boolean
        default: false
        description: "Enable Link Time Optimization (LTO)"

run-name: "DeepSeek V3 – ${{ inputs.setup }} [${{ inputs.deepseekv3_unit_tests && 'unit ' || '' }}${{ inputs.deepseekv3_module_tests && 'module ' || '' }}${{ inputs.teacher_forced && 'tf ' || '' }}${{ inputs.demo && 'demo ' || '' }}${{ inputs.demo_stress && 'stress' || '' }}]"

jobs:
  build-artifact:
    uses: ./.github/workflows/build-artifact.yaml
    permissions:
      packages: write
    secrets: inherit
    with:
      build-type: ${{ inputs.build-type || 'Release' }}
      platform: ${{ inputs.platform || 'Ubuntu 22.04' }}
      enable-lto: ${{ inputs.enable-lto || false }}
      build-wheel: true

  deepseekv3-tests:
    if: ${{ inputs.deepseekv3_unit_tests || inputs.deepseekv3_module_tests || inputs.teacher_forced || inputs.demo || inputs.demo_stress }}
    runs-on:
      - multi-host-glx-4x
      - arch-wormhole_b0
      - bare-metal
      - in-service
    needs: build-artifact
    steps:
      - name: ⬇️ Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: ⬇️ Download Build
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0
        timeout-minutes: 10
        with:
          name: ${{ needs.build-artifact.outputs.build-artifact-name }}
      - name: Extract files
        run: tar --zstd -xvf ttm_any.tar.zst
      - name: ⬇️ Download Wheel
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0
        timeout-minutes: 10
        with:
          name: ${{ needs.build-artifact.outputs.wheel-artifact-name }}
      - name: Capture runner's home directory
        id: capture-home
        run: echo "home=${HOME}" >> $GITHUB_OUTPUT

      # ── DeepSeek V3 unit tests ──────────────────────────────────────────
      - name: Run dual DeepSeek V3 unit tests
        if: ${{ inputs.deepseekv3_unit_tests && (inputs.setup == 'dual' || inputs.setup == 'both') }}
        uses: ./.github/actions/docker-run
        timeout-minutes: 60
        with:
          docker_image: ${{ needs.build-artifact.outputs.dev-docker-image }}
          docker_password: ${{ secrets.GITHUB_TOKEN }}
          docker_opts: |
            -e LD_LIBRARY_PATH=${{ github.workspace }}/build/lib
            -e PYTHONPATH=${{ github.workspace }}
            -e TT_METAL_HOME=${{ github.workspace }}
            -e ARCH_NAME=wormhole_b0
            -e TT_METAL_ENABLE_ERISC_IRAM="1"
            -e GTEST_OUTPUT="xml:${{ github.workspace }}/generated/test_reports/"
            -v /etc/mpirun:/etc/mpirun:ro
            -v ${{ steps.capture-home.outputs.home }}/.ssh:${{ steps.capture-home.outputs.home }}/.ssh:ro
            --device /dev/tenstorrent
            --pid=host
            --hostname=mpirun-host
          install_wheel: true
          run_args: |
            ./tests/scripts/multihost/setup_shared_venv.sh
            ./tests/scripts/multihost/run_quad_galaxy_tests.sh dual_deepseekv3_unit_tests

      - name: Run quad DeepSeek V3 unit tests
        if: ${{ inputs.deepseekv3_unit_tests && (inputs.setup == 'quad' || inputs.setup == 'both') }}
        uses: ./.github/actions/docker-run
        timeout-minutes: 60
        with:
          docker_image: ${{ needs.build-artifact.outputs.dev-docker-image }}
          docker_password: ${{ secrets.GITHUB_TOKEN }}
          docker_opts: |
            -e LD_LIBRARY_PATH=${{ github.workspace }}/build/lib
            -e PYTHONPATH=${{ github.workspace }}
            -e TT_METAL_HOME=${{ github.workspace }}
            -e ARCH_NAME=wormhole_b0
            -e TT_METAL_ENABLE_ERISC_IRAM="1"
            -e GTEST_OUTPUT="xml:${{ github.workspace }}/generated/test_reports/"
            -v /etc/mpirun:/etc/mpirun:ro
            -v ${{ steps.capture-home.outputs.home }}/.ssh:${{ steps.capture-home.outputs.home }}/.ssh:ro
            --device /dev/tenstorrent
            --pid=host
            --hostname=mpirun-host
          install_wheel: true
          run_args: |
            ./tests/scripts/multihost/setup_shared_venv.sh
            ./tests/scripts/multihost/run_quad_galaxy_tests.sh quad_deepseekv3_unit_tests

      # ── DeepSeek V3 module tests ────────────────────────────────────────
      - name: Run dual DeepSeek V3 module tests
        if: ${{ inputs.deepseekv3_module_tests && (inputs.setup == 'dual' || inputs.setup == 'both') }}
        uses: ./.github/actions/docker-run
        timeout-minutes: 150
        with:
          docker_image: ${{ needs.build-artifact.outputs.dev-docker-image }}
          docker_password: ${{ secrets.GITHUB_TOKEN }}
          docker_opts: |
            -e LD_LIBRARY_PATH=${{ github.workspace }}/build/lib
            -e PYTHONPATH=${{ github.workspace }}
            -e TT_METAL_HOME=${{ github.workspace }}
            -e ARCH_NAME=wormhole_b0
            -e TT_METAL_ENABLE_ERISC_IRAM="1"
            -e GTEST_OUTPUT="xml:${{ github.workspace }}/generated/test_reports/"
            -v /etc/mpirun:/etc/mpirun:ro
            -v ${{ steps.capture-home.outputs.home }}/.ssh:${{ steps.capture-home.outputs.home }}/.ssh:ro
            --device /dev/tenstorrent
            --pid=host
            --hostname=mpirun-host
          install_wheel: true
          run_args: |
            ./tests/scripts/multihost/setup_shared_venv.sh
            ./tests/scripts/multihost/run_quad_galaxy_tests.sh dual_deepseekv3_module_tests

      - name: Run quad DeepSeek V3 module tests
        if: ${{ inputs.deepseekv3_module_tests && (inputs.setup == 'quad' || inputs.setup == 'both') }}
        uses: ./.github/actions/docker-run
        timeout-minutes: 150
        with:
          docker_image: ${{ needs.build-artifact.outputs.dev-docker-image }}
          docker_password: ${{ secrets.GITHUB_TOKEN }}
          docker_opts: |
            -e LD_LIBRARY_PATH=${{ github.workspace }}/build/lib
            -e PYTHONPATH=${{ github.workspace }}
            -e TT_METAL_HOME=${{ github.workspace }}
            -e ARCH_NAME=wormhole_b0
            -e TT_METAL_ENABLE_ERISC_IRAM="1"
            -e GTEST_OUTPUT="xml:${{ github.workspace }}/generated/test_reports/"
            -v /etc/mpirun:/etc/mpirun:ro
            -v ${{ steps.capture-home.outputs.home }}/.ssh:${{ steps.capture-home.outputs.home }}/.ssh:ro
            --device /dev/tenstorrent
            --pid=host
            --hostname=mpirun-host
          install_wheel: true
          run_args: |
            ./tests/scripts/multihost/setup_shared_venv.sh
            ./tests/scripts/multihost/run_quad_galaxy_tests.sh quad_deepseekv3_module_tests

      # ── Teacher forced accuracy tests ───────────────────────────────────
      - name: Run dual teacher forced accuracy test
        if: ${{ inputs.teacher_forced && (inputs.setup == 'dual' || inputs.setup == 'both') }}
        uses: ./.github/actions/docker-run
        timeout-minutes: 60
        with:
          docker_image: ${{ needs.build-artifact.outputs.dev-docker-image }}
          docker_password: ${{ secrets.GITHUB_TOKEN }}
          docker_opts: |
            -e LD_LIBRARY_PATH=${{ github.workspace }}/build/lib
            -e PYTHONPATH=${{ github.workspace }}
            -e TT_METAL_HOME=${{ github.workspace }}
            -e ARCH_NAME=wormhole_b0
            -e TT_METAL_ENABLE_ERISC_IRAM="1"
            -e GTEST_OUTPUT="xml:${{ github.workspace }}/generated/test_reports/"
            -v /etc/mpirun:/etc/mpirun:ro
            -v ${{ steps.capture-home.outputs.home }}/.ssh:${{ steps.capture-home.outputs.home }}/.ssh:ro
            --device /dev/tenstorrent
            --pid=host
            --hostname=mpirun-host
          install_wheel: true
          run_args: |
            ./tests/scripts/multihost/setup_shared_venv.sh
            ./tests/scripts/multihost/run_quad_galaxy_tests.sh dual_teacher_forced

      - name: Upload dual teacher forced accuracy artifacts
        if: ${{ always() && inputs.teacher_forced && (inputs.setup == 'dual' || inputs.setup == 'both') }}
        uses: actions/upload-artifact@v4
        with:
          name: dual-teacher-forced-accuracy-${{ github.run_id }}
          path: |
            generated/artifacts/dual_teacher_forced_accuracy.txt
            generated/artifacts/dual_teacher_forced_output.log
          if-no-files-found: warn

      - name: Run quad teacher forced accuracy test
        if: ${{ inputs.teacher_forced && (inputs.setup == 'quad' || inputs.setup == 'both') }}
        uses: ./.github/actions/docker-run
        timeout-minutes: 60
        with:
          docker_image: ${{ needs.build-artifact.outputs.dev-docker-image }}
          docker_password: ${{ secrets.GITHUB_TOKEN }}
          docker_opts: |
            -e LD_LIBRARY_PATH=${{ github.workspace }}/build/lib
            -e PYTHONPATH=${{ github.workspace }}
            -e TT_METAL_HOME=${{ github.workspace }}
            -e ARCH_NAME=wormhole_b0
            -e TT_METAL_ENABLE_ERISC_IRAM="1"
            -e GTEST_OUTPUT="xml:${{ github.workspace }}/generated/test_reports/"
            -v /etc/mpirun:/etc/mpirun:ro
            -v ${{ steps.capture-home.outputs.home }}/.ssh:${{ steps.capture-home.outputs.home }}/.ssh:ro
            --device /dev/tenstorrent
            --pid=host
            --hostname=mpirun-host
          install_wheel: true
          run_args: |
            ./tests/scripts/multihost/setup_shared_venv.sh
            ./tests/scripts/multihost/run_quad_galaxy_tests.sh quad_teacher_forced

      - name: Upload quad teacher forced accuracy artifacts
        if: ${{ always() && inputs.teacher_forced && (inputs.setup == 'quad' || inputs.setup == 'both') }}
        uses: actions/upload-artifact@v4
        with:
          name: quad-teacher-forced-accuracy-${{ github.run_id }}
          path: |
            generated/artifacts/quad_teacher_forced_accuracy.txt
            generated/artifacts/quad_teacher_forced_output.log
          if-no-files-found: warn

      # ── Demo tests ──────────────────────────────────────────────────────
      - name: Run dual demo test (256 prompts, 1 batch)
        if: ${{ inputs.demo && (inputs.setup == 'dual' || inputs.setup == 'both') }}
        uses: ./.github/actions/docker-run
        timeout-minutes: 40
        with:
          docker_image: ${{ needs.build-artifact.outputs.dev-docker-image }}
          docker_password: ${{ secrets.GITHUB_TOKEN }}
          docker_opts: |
            -e LD_LIBRARY_PATH=${{ github.workspace }}/build/lib
            -e PYTHONPATH=${{ github.workspace }}
            -e TT_METAL_HOME=${{ github.workspace }}
            -e ARCH_NAME=wormhole_b0
            -e TT_METAL_ENABLE_ERISC_IRAM="1"
            -e GTEST_OUTPUT="xml:${{ github.workspace }}/generated/test_reports/"
            -v /etc/mpirun:/etc/mpirun:ro
            -v ${{ steps.capture-home.outputs.home }}/.ssh:${{ steps.capture-home.outputs.home }}/.ssh:ro
            --device /dev/tenstorrent
            --pid=host
            --hostname=mpirun-host
          install_wheel: true
          run_args: |
            ./tests/scripts/multihost/setup_shared_venv.sh
            ./tests/scripts/multihost/run_quad_galaxy_tests.sh dual_demo

      - name: Upload dual demo output artifacts
        if: ${{ always() && inputs.demo && (inputs.setup == 'dual' || inputs.setup == 'both') }}
        uses: actions/upload-artifact@v4
        with:
          name: dual-demo-output-${{ github.run_id }}
          path: |
            generated/artifacts/dual_demo_output.log
            generated/artifacts/dual_demo_full_results.json
          if-no-files-found: warn

      - name: Run quad demo test (512 prompts, 1 batch)
        if: ${{ inputs.demo && (inputs.setup == 'quad' || inputs.setup == 'both') }}
        uses: ./.github/actions/docker-run
        timeout-minutes: 60
        with:
          docker_image: ${{ needs.build-artifact.outputs.dev-docker-image }}
          docker_password: ${{ secrets.GITHUB_TOKEN }}
          docker_opts: |
            -e LD_LIBRARY_PATH=${{ github.workspace }}/build/lib
            -e PYTHONPATH=${{ github.workspace }}
            -e TT_METAL_HOME=${{ github.workspace }}
            -e ARCH_NAME=wormhole_b0
            -e TT_METAL_ENABLE_ERISC_IRAM="1"
            -e GTEST_OUTPUT="xml:${{ github.workspace }}/generated/test_reports/"
            -v /etc/mpirun:/etc/mpirun:ro
            -v ${{ steps.capture-home.outputs.home }}/.ssh:${{ steps.capture-home.outputs.home }}/.ssh:ro
            --device /dev/tenstorrent
            --pid=host
            --hostname=mpirun-host
          install_wheel: true
          run_args: |
            ./tests/scripts/multihost/setup_shared_venv.sh
            ./tests/scripts/multihost/run_quad_galaxy_tests.sh quad_demo

      - name: Upload quad demo output artifacts
        if: ${{ always() && inputs.demo && (inputs.setup == 'quad' || inputs.setup == 'both') }}
        uses: actions/upload-artifact@v4
        with:
          name: quad-demo-output-${{ github.run_id }}
          path: |
            generated/artifacts/quad_demo_output.log
            generated/artifacts/quad_demo_full_results.json
          if-no-files-found: warn

      # ── Demo stress tests ───────────────────────────────────────────────
      - name: Run dual demo stress test (56 prompts, 20 batches)
        if: ${{ inputs.demo_stress && (inputs.setup == 'dual' || inputs.setup == 'both') }}
        uses: ./.github/actions/docker-run
        timeout-minutes: 90
        with:
          docker_image: ${{ needs.build-artifact.outputs.dev-docker-image }}
          docker_password: ${{ secrets.GITHUB_TOKEN }}
          docker_opts: |
            -e LD_LIBRARY_PATH=${{ github.workspace }}/build/lib
            -e PYTHONPATH=${{ github.workspace }}
            -e TT_METAL_HOME=${{ github.workspace }}
            -e ARCH_NAME=wormhole_b0
            -e TT_METAL_ENABLE_ERISC_IRAM="1"
            -e GTEST_OUTPUT="xml:${{ github.workspace }}/generated/test_reports/"
            -v /etc/mpirun:/etc/mpirun:ro
            -v ${{ steps.capture-home.outputs.home }}/.ssh:${{ steps.capture-home.outputs.home }}/.ssh:ro
            --device /dev/tenstorrent
            --pid=host
            --hostname=mpirun-host
          install_wheel: true
          run_args: |
            ./tests/scripts/multihost/setup_shared_venv.sh
            ./tests/scripts/multihost/run_quad_galaxy_tests.sh dual_demo_stress

      - name: Upload dual demo stress output artifacts
        if: ${{ always() && inputs.demo_stress && (inputs.setup == 'dual' || inputs.setup == 'both') }}
        uses: actions/upload-artifact@v4
        with:
          name: dual-demo-stress-output-${{ github.run_id }}
          path: |
            generated/artifacts/dual_demo_stress_output.log
            generated/artifacts/dual_demo_stress_results.json
          if-no-files-found: warn

      - name: Run quad demo stress test (56 prompts, 20 batches)
        if: ${{ inputs.demo_stress && (inputs.setup == 'quad' || inputs.setup == 'both') }}
        uses: ./.github/actions/docker-run
        timeout-minutes: 90
        with:
          docker_image: ${{ needs.build-artifact.outputs.dev-docker-image }}
          docker_password: ${{ secrets.GITHUB_TOKEN }}
          docker_opts: |
            -e LD_LIBRARY_PATH=${{ github.workspace }}/build/lib
            -e PYTHONPATH=${{ github.workspace }}
            -e TT_METAL_HOME=${{ github.workspace }}
            -e ARCH_NAME=wormhole_b0
            -e TT_METAL_ENABLE_ERISC_IRAM="1"
            -e GTEST_OUTPUT="xml:${{ github.workspace }}/generated/test_reports/"
            -v /etc/mpirun:/etc/mpirun:ro
            -v ${{ steps.capture-home.outputs.home }}/.ssh:${{ steps.capture-home.outputs.home }}/.ssh:ro
            --device /dev/tenstorrent
            --pid=host
            --hostname=mpirun-host
          install_wheel: true
          run_args: |
            ./tests/scripts/multihost/setup_shared_venv.sh
            ./tests/scripts/multihost/run_quad_galaxy_tests.sh quad_demo_stress

      - name: Upload quad demo stress output artifacts
        if: ${{ always() && inputs.demo_stress && (inputs.setup == 'quad' || inputs.setup == 'both') }}
        uses: actions/upload-artifact@v4
        with:
          name: quad-demo-stress-output-${{ github.run_id }}
          path: |
            generated/artifacts/quad_demo_stress_output.log
            generated/artifacts/quad_demo_stress_results.json
          if-no-files-found: warn
