name: "Code analysis"

on:
  schedule:
    - cron: "0 2 * * 1,3,5" # Static analysis: 2 AM UTC on Mon/Wed/Fri
  workflow_call:
    inputs:
      distro:
        required: false
        type: string
        default: "ubuntu"
      version:
        required: false
        type: string
        default: "24.04"
      architecture:
        required: false
        type: string
        default: "amd64"
      enable-static-analysis:
        description: "Enable Clang Static Analyzer (CSA) via CodeChecker"
        required: false
        type: boolean
        default: false
  workflow_dispatch:
    inputs:
      distro:
        required: false
        type: string
        default: "ubuntu"
      version:
        required: false
        type: string
        default: "24.04"
      architecture:
        required: false
        type: string
        default: "amd64"
      enable-static-analysis:
        description: "Enable Clang Static Analyzer (CSA) via CodeChecker"
        required: false
        type: boolean
        default: false

jobs:
  connectivity-test:
    runs-on: ubuntu-latest

    steps:
      - name: üì° ICMP Ping Test
        run: |
          echo "==== ICMP PING TEST ===="
          for host in github.com google.com cloudflare.com neon.tech aswincloud.com; do
            echo ""
            echo "Pinging: $host"
            ping -c 3 -W 3 $host \
              && echo "‚úÖ Ping OK" \
              || echo "‚ùå Ping FAILED"
          done

      - name: üß™ DNS Resolution Test
        run: |
          echo ""
          echo "==== DNS RESOLUTION TEST ===="
          for host in github.com google.com cloudflare.com neon.tech aswincloud.com; do
            echo ""
            echo "Resolving: $host"
            getent ahosts $host || echo "‚ùå DNS lookup failed for $host"
          done

      - name: üîå TCP Connectivity Test (443)
        run: |
          echo ""
          echo "==== TCP CONNECTIVITY TEST (PORT 443) ===="
          for host in github.com google.com cloudflare.com neon.tech aswincloud.com; do
            echo ""
            echo "Testing TCP: $host:443"
            timeout 5 bash -c "cat < /dev/null > /dev/tcp/$host/443" \
              && echo "‚úÖ TCP connect OK" \
              || echo "‚ùå TCP connect FAILED"
          done

      - name: üîå Neon DB connectivity test
        run: |
          pip install -q psycopg2-binary

          python3 << 'EOF'
          import psycopg2, sys

          conn = psycopg2.connect(
              "postgresql://sweep_reader:sweep_readonly_pw@"
              "ep-blue-credit-ah8iebt7-pooler.c-3.us-east-1.aws.neon.tech/"
              "tt-sweeps?sslmode=require&options=endpoint%3Dep-blue-credit-ah8iebt7"
          )
          cur = conn.cursor()
          cur.execute("SELECT COUNT(*) FROM operations")
          print("Operations:", cur.fetchone()[0])
          conn.close()
          print("‚úÖ Neon DB works directly from CI")
          EOF
