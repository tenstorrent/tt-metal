name: "Code analysis"

on:
  schedule:
    - cron: "0 2 * * 1,3,5" # Static analysis: 2 AM UTC on Mon/Wed/Fri
  workflow_call:
    inputs:
      distro:
        required: false
        type: string
        default: "ubuntu"
      version:
        required: false
        type: string
        default: "24.04"
      architecture:
        required: false
        type: string
        default: "amd64"
      enable-static-analysis:
        description: "Enable Clang Static Analyzer (CSA) via CodeChecker"
        required: false
        type: boolean
        default: false
  workflow_dispatch:
    inputs:
      distro:
        required: false
        type: string
        default: "ubuntu"
      version:
        required: false
        type: string
        default: "24.04"
      architecture:
        required: false
        type: string
        default: "amd64"
      enable-static-analysis:
        description: "Enable Clang Static Analyzer (CSA) via CodeChecker"
        required: false
        type: boolean
        default: false

jobs:
  connectivity-test:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ”Œ Neon DB test
        run: |
          pip install -q psycopg2-binary

          python3 << 'EOF'
          import psycopg2

          conn = psycopg2.connect(
              "postgresql://sweep_reader:sweep_readonly_pw@"
              "ep-blue-credit-ah8iebt7-pooler.c-3.us-east-1.aws.neon.tech/"
              "tt-sweeps?sslmode=require&options=endpoint%3Dep-blue-credit-ah8iebt7-pooler"
          )
          cur = conn.cursor()
          cur.execute("SELECT COUNT(*) FROM operations")
          print("Operations:", cur.fetchone()[0])
          conn.close()
          print("âœ… Neon DB connection successful")
          EOF
