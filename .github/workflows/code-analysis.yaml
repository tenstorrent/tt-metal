name: Auto-Approve LLK Submodule Uplift PRs

on:
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  auto-approve:
    runs-on: ubuntu-latest
    steps:
      - name: Auto-approve PR
        env:
          GH_TOKEN: ${{ secrets.WILDER_PAT }}
        run: |
          echo "üîç Finding PR in llk-submodule-uplift branch..."

          # Find the PR in llk-submodule-uplift branch using GitHub CLI
          PR_DATA=$(gh pr list --head "llk-submodule-uplift" --json number,headRefName,headRepository --repo "${{ github.repository }}")

          if [ -z "$PR_DATA" ] || [ "$PR_DATA" = "[]" ]; then
            echo "‚ùå No PR found in llk-submodule-uplift branch"
            exit 1
          fi

          # Extract PR number from the JSON response
          PR_NUMBER=$(echo "$PR_DATA" | jq -r '.[0].number')
          PR_BRANCH=$(echo "$PR_DATA" | jq -r '.[0].headRefName')
          PR_REPO=$(echo "$PR_DATA" | jq -r '.[0].headRepository.full_name')

          echo "üîÑ Found PR #$PR_NUMBER in branch: $PR_BRANCH"

          # Verify it's from the same repository (not a fork)
          if [ "$PR_REPO" != "null" ] && [ "$PR_REPO" != "${{ github.repository }}" ]; then
            echo "‚ùå PR is from a fork: $PR_REPO"
            exit 1
          fi

          # Verify the branch is correct
          if [ "$PR_BRANCH" != "llk-submodule-uplift" ]; then
            echo "‚ùå PR is not in llk-submodule-uplift branch: $PR_BRANCH"
            exit 1
          fi

          # Approve the PR using GitHub CLI
          echo "Approving PR #$PR_NUMBER..."

          # Use GitHub CLI to approve the PR
          if gh pr review "$PR_NUMBER" --approve --repo "${{ github.repository }}"; then
            echo "‚úÖ Successfully approved PR #$PR_NUMBER"
          else
            echo "‚ùå Failed to approve PR #$PR_NUMBER"
            exit 1
          fi

          # Add a comment to indicate automatic approval
          gh pr comment "$PR_NUMBER" --body "‚úÖ **Approved by @blozano-tt** - This PR has been automatically approved as part of the LLK submodule uplift process." --repo "${{ github.repository }}"

          echo "‚úÖ Automatic approval process completed successfully"
