name: "Code analysis"

on:
  schedule:
    - cron: "0 2 * * 1,3,5" # Static analysis: 2 AM UTC on Mon/Wed/Fri
  workflow_call:
    inputs:
      distro:
        required: false
        type: string
        default: "ubuntu"
      version:
        required: false
        type: string
        default: "24.04"
      architecture:
        required: false
        type: string
        default: "amd64"
      enable-static-analysis:
        description: "Enable Clang Static Analyzer (CSA) via CodeChecker"
        required: false
        type: boolean
        default: false
      debug-file-filter:
        description: "Analyze only specific file(s) for fast debugging (e.g., 'tests/tt_metal/**/*.hpp' or 'path/to/file.cpp')"
        required: false
        type: string
        default: ""
      enable-copilot-fix:
        description: "Enable Copilot to automatically fix ClangSA issues and create a PR"
        required: false
        type: boolean
        default: false
      copilot-max-fixes:
        description: "Maximum number of issues for Copilot to fix (blank = all)"
        required: false
        type: string
        default: ""
  workflow_dispatch:
    inputs:
      distro:
        required: false
        type: string
        default: "ubuntu"
      version:
        required: false
        type: string
        default: "24.04"
      architecture:
        required: false
        type: string
        default: "amd64"
      enable-static-analysis:
        description: "Enable Clang Static Analyzer (CSA) via CodeChecker"
        required: false
        type: boolean
        default: false
      debug-file-filter:
        description: "Analyze only specific file(s) for fast debugging (e.g., 'tests/tt_metal/**/*.hpp' or 'path/to/file.cpp')"
        required: false
        type: string
        default: ""
      enable-copilot-fix:
        description: "Enable Copilot to automatically fix ClangSA issues and create a PR"
        required: false
        type: boolean
        default: false
      copilot-max-fixes:
        description: "Maximum number of issues for Copilot to fix (blank = all)"
        required: false
        type: string
        default: ""

jobs:
  determine-scan-type:
    runs-on: ubuntu-latest
    outputs:
      do-full-scan: ${{ steps.compute-outputs.outputs.do-full-scan }}
      do-scan: ${{ steps.compute-outputs.outputs.do-scan }}
    steps:
      - id: find-changes
        uses: tenstorrent/tt-metal/.github/actions/find-changed-files@v0.63.0

      - id: compute-outputs
        shell: bash
        run: |
          do_full_scan=$([[ "${{ github.ref_name }}" == "main" || "${{ steps.find-changes.outputs.clang-tidy-config-changed }}" == "true" ]] && echo "true" || echo "false")
          do_scan=$([[ "$do_full_scan" == "true" || "${{ steps.find-changes.outputs.any-code-changed }}" == "true" || "${{ steps.find-changes.outputs.cmake-changed }}" == "true" ]] && echo "true" || echo "false")
          echo "Do a scan: $do_scan"
          echo "Do a full scan: $do_full_scan"
          echo "do-full-scan=$do_full_scan" >> "$GITHUB_OUTPUT"
          echo "do-scan=$do_scan" >> "$GITHUB_OUTPUT"

  build-docker-image:
    uses: ./.github/workflows/build-docker-artifact.yaml
    permissions:
      packages: write
    secrets: inherit
    with:
      distro: ${{ inputs.distro || 'ubuntu' }}
      version: ${{ inputs.version || '24.04' }}
      architecture: ${{ inputs.architecture || 'amd64' }}

  clang-tidy:
    name: ðŸ¤– Clang Tidy
    needs: [ build-docker-image, determine-scan-type ]
    if: ${{ needs.determine-scan-type.outputs.do-scan == 'true' }}
    runs-on: tt-ubuntu-2204-xlarge-stable
    environment: ${{ github.ref == 'refs/heads/main' && 'mainline' || '' }}
    container:
      image: harbor.ci.tenstorrent.net/${{ needs.build-docker-image.outputs.ci-build-tag || 'docker-image-unresolved!'}}
      env:
        CCACHE_REMOTE_ONLY: "true"
        CCACHE_TEMPDIR: /tmp/ccache
      volumes:
        - ${{ github.workspace }}:/work
        - /home/ubuntu/.ccache-ci:/github/home/.ccache # HOME is hardcoded for no clear reason: https://github.com/actions/runner/issues/863
      # Group 1457 is for the shared ccache drive
      # tmpfs is for efficiency
      options: >
        --group-add 1457
        --tmpfs /tmp
    defaults:
      run:
        shell: bash
        working-directory: /work # https://github.com/actions/runner/issues/878
    steps:
      - name: Check Redis credentials
        # Failing internal jobs draws attention immediately so we can fix them and make them fast.
        # Forks will never have secrets; don't fail the job for them, they'll just run slower
        if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false }}
        run: |
          if [ -z "${{ secrets.REDIS_PASSWORD }}" ]; then
            echo "Redis password is missing. Did you forget 'secrets: inherit'?"
            exit 1
          fi
          # Conditionally set this here so that it remains unset on forks, otherwise it resolves an invalid URL and the job fails
          CCACHE_REMOTE_STORAGE="redis://${{ vars.REDIS_USER }}:${{ secrets.REDIS_PASSWORD }}@${{ vars.REDIS_HOST }}:${{ vars.REDIS_PORT }}|read-only=${{ vars.REDIS_IS_READONLY }}"
          echo "CCACHE_REMOTE_STORAGE=${CCACHE_REMOTE_STORAGE}" >> $GITHUB_ENV
          echo "CCACHE_REMOTE_STORAGE: ${CCACHE_REMOTE_STORAGE}"

      - name: Create ccache tmpdir
        run: |
          mkdir -p /tmp/ccache

      - name: Check out repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          submodules: recursive
          clean: true

      - name: Configure git safe.directory
        run: git config --global --add safe.directory /work

      - name: Determine merge base
        if: ${{ needs.determine-scan-type.outputs.do-full-scan != 'true' }}
        run: |
          echo "Current branch: ${{ github.ref_name }}"
          MERGE_BASE=$(git merge-base ${{ github.ref_name }} origin/main)
          echo "Merge base between ${{ github.ref_name }} and main: $MERGE_BASE"
          echo "MERGE_BASE=$MERGE_BASE" >> $GITHUB_ENV

      - name: Check out baseline
        if: ${{ needs.determine-scan-type.outputs.do-full-scan != 'true' }}
        uses: actions/checkout@v4
        with:
          ref: ${{ env.MERGE_BASE }}
          fetch-depth: 0
          fetch-tags: true
          submodules: recursive
          clean: true

      - name: Create shim
        run: |
          # Suppress clang-tidy to first get an up-to-date build tree
          ln -sf /usr/bin/true ./clang-tidy-shim

      - name: ðŸ”§ CMake configure
        run: |
          cmake --preset clang-tidy -DCMAKE_CXX_CLANG_TIDY="$(pwd)/clang-tidy-shim;--warnings-as-errors=*" -DCMAKE_C_CLANG_TIDY="$(pwd)/clang-tidy-shim;--warnings-as-errors=*"

      - name: Prepare baseline ccache summary
        if: ${{ needs.determine-scan-type.outputs.do-full-scan != 'true' }}
        run: |
          # Zero out the stats so we can see how we did this build
          # NOTE: may be inaccurate if we have >1 build runner on the same machine, using the same local cache
          ccache -z

      - name: ðŸ› ï¸ Baseline Build
        if: ${{ needs.determine-scan-type.outputs.do-full-scan != 'true' }}
        run: |
          cmake --build --preset clang-tidy

      - name: Publish Ccache summary
        if: ${{ needs.determine-scan-type.outputs.do-full-scan != 'true' }}
        run: |
          echo '## CCache Summary' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ccache -s >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          submodules: recursive
          clean: false

      - name: Restore shim
        run: |
          # Restore shim to legit clang-tidy
          # Symlink tomfoolery here so that Ninja believes the build command has not changed from the previous run
          ln -sf $(which clang-tidy-20) ./clang-tidy-shim

      - name: Prepare ccache summary
        run: |
          # Zero out the stats so we can see how we did this build
          # NOTE: may be inaccurate if we have >1 build runner on the same machine, using the same local cache
          ccache -z

      - name: ðŸ” Analyze code with clang-tidy
        run: |
          cmake --build --preset clang-tidy

      - name: Publish Ccache summary
        run: |
          echo '## CCache Summary' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ccache -s >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  clang-static-analyzer:
    name: ðŸ”¬ Clang Static Analyzer
    needs: [ build-docker-image ]
    if: ${{ inputs.enable-static-analysis == true || github.event_name == 'schedule' }}
    runs-on: tt-ubuntu-2204-xlarge-stable
    container:
      image: harbor.ci.tenstorrent.net/${{ needs.build-docker-image.outputs.ci-build-tag || 'docker-image-unresolved!'}}
      volumes:
        - ${{ github.workspace }}:/work
        - ${{ github.workspace }}/../../_actions:${{ github.workspace }}/../../_actions # HACK: make actions available inside container
      options: --tmpfs /tmp
    defaults:
      run:
        shell: bash
        working-directory: /work # https://github.com/actions/runner/issues/878
    steps:
      - name: Check out repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: recursive

      - name: Configure git safe.directory
        run: git config --global --add safe.directory /work

      - name: ðŸ”§ CMake configure
        run: cmake --preset clang-static-analyzer

      - name: ðŸ› ï¸ Generate files
        run: cmake --build .build/clang-static-analyzer --target all_generated_files

      - name: Setup clang symlinks for CodeChecker
        run: |
          update-alternatives --install /usr/bin/clang clang /usr/bin/clang-20 100
          update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-20 100

      - name: Install CodeChecker
        run: |
          # Pre-install CodeChecker in the container's venv using uv.
          # Pin to a specific version for reproducibility.
          uv pip install codechecker==6.27.1

      - name: ðŸ”¬ Analyze with CodeChecker
        id: codechecker
        run: |
          set -euo pipefail

          OUTPUT_DIR=/work/.build/codechecker-reports
          mkdir -p "$OUTPUT_DIR"

          echo "=== Starting CodeChecker analysis ==="

          # Build command with optional file filter
          ANALYZE_CMD="CodeChecker analyze \
            /work/.build/clang-static-analyzer/compile_commands.json \
            --output $OUTPUT_DIR \
            --jobs $(nproc) \
            --config /work/.codechecker.json"

          if [ -n "${{ inputs.debug-file-filter }}" ]; then
            echo "ðŸ› DEBUG MODE: Analyzing only: ${{ inputs.debug-file-filter }}"
            ANALYZE_CMD="$ANALYZE_CMD --file '${{ inputs.debug-file-filter }}'"
          fi

          # Run analysis (don't fail on analyzer crashes - common with static analysis)
          eval "$ANALYZE_CMD" || echo "âš ï¸ Analysis completed with warnings"

          # Set output for downstream steps
          echo "analyze-output=$OUTPUT_DIR" >> "$GITHUB_OUTPUT"

          # Show summary
          PLIST_COUNT=$(find "$OUTPUT_DIR" -name "*.plist" 2>/dev/null | wc -l)
          echo "âœ… Generated $PLIST_COUNT plist files"

      - name: Generate JSON and HTML reports from analysis results
        run: |
          set -euo pipefail

          OUTPUT_DIR="${{ steps.codechecker.outputs.analyze-output }}"
          JSON_OUTPUT="/work/.build/codechecker_issues.json"
          HTML_OUTPUT="/work/.build/codechecker_html"

          echo "=== Generating JSON report ==="
          CodeChecker parse "$OUTPUT_DIR" --export json --output "$JSON_OUTPUT" || true

          if [ -f "$JSON_OUTPUT" ] && [ -s "$JSON_OUTPUT" ]; then
            ISSUE_COUNT=$(jq '.reports | length' "$JSON_OUTPUT" || echo "0")
            echo "âœ… JSON report contains $ISSUE_COUNT issues"
          else
            echo "âš ï¸ No JSON output, creating empty report"
            echo '{"version": 1, "reports": []}' > "$JSON_OUTPUT"
          fi

          echo ""
          echo "=== Generating HTML report ==="
          mkdir -p "$HTML_OUTPUT"
          CodeChecker parse "$OUTPUT_DIR" --export html --output "$HTML_OUTPUT" || true

          if [ -d "$HTML_OUTPUT" ] && [ -n "$(ls -A "$HTML_OUTPUT")" ]; then
            echo "âœ… HTML report generated"
          else
            echo "âš ï¸ HTML report is empty or missing"
          fi

      - name: Upload JSON report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: CodeChecker-JSON-Report
          path: /work/.build/codechecker_issues.json

      - name: Upload HTML report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: CodeChecker-HTML-Report
          path: /work/.build/codechecker_html

  copilot-fix-clangsa-issue:
    name: ðŸ¤– Copilot Fix ClangSA Issue
    needs: [ clang-static-analyzer ]
    if: |
      always() &&
      inputs.enable-copilot-fix == true &&
      needs.clang-static-analyzer.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    outputs:
      pr-url: ${{ steps.copilot-fix.outputs.pr-url }}
      pr-created: ${{ steps.copilot-fix.outputs.pr-created }}
    steps:
      - name: Check out repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download CodeChecker JSON report
        uses: actions/download-artifact@v4
        with:
          name: CodeChecker-JSON-Report
          path: /tmp

      - name: Check if issues exist and prepare prompt
        id: prepare-prompt
        run: |
          set -euo pipefail

          if [ ! -f "/tmp/codechecker_issues.json" ]; then
            echo "No CodeChecker issues found"
            echo "has-issues=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          ISSUE_COUNT=$(jq '.reports | length' /tmp/codechecker_issues.json || echo "0")

          if [ "$ISSUE_COUNT" = "0" ] || [ -z "$ISSUE_COUNT" ]; then
            echo "No issues found"
            echo "has-issues=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Found $ISSUE_COUNT issues"
          echo "has-issues=true" >> "$GITHUB_OUTPUT"
          echo "issue-count=$ISSUE_COUNT" >> "$GITHUB_OUTPUT"

          # Determine max fixes
          MAX_FIXES="${{ inputs.copilot-max-fixes }}"
          if [ -z "$MAX_FIXES" ]; then
            LIMIT=15
          else
            LIMIT="$MAX_FIXES"
          fi

          # Format issues for Copilot prompt
          ISSUE_LIST=$(jq -r --argjson limit "$LIMIT" '
            .reports[:$limit] | to_entries | .[] |
            "- **\(.value.severity)**: `\(.value.checker_name)` in `\(.value.file.path | sub("^/work/"; "")):\(.value.line)` - \(.value.message)"
          ' /tmp/codechecker_issues.json)

          echo "=== Issues for Copilot ==="
          echo "$ISSUE_LIST"

          # Save prompt to file (avoids shell escaping issues)
          cat > /tmp/copilot_prompt.txt << 'EOF'
          Fix these Clang Static Analyzer issues found in the codebase:

          EOF
          echo "$ISSUE_LIST" >> /tmp/copilot_prompt.txt
          cat >> /tmp/copilot_prompt.txt << 'EOF'

          For each issue:
          1. Verify it's a real bug (skip false positives)
          2. Apply a minimal, safe fix that doesn't change program behavior
          3. Follow the project's coding standards

          Create a PR with the fixes. Use a clear commit message describing what was fixed.
          EOF

          echo "Prompt saved to /tmp/copilot_prompt.txt"

      - name: Authenticate GitHub CLI with OAuth token
        if: steps.prepare-prompt.outputs.has-issues == 'true'
        env:
          # OAuth token from `gh auth token` after interactive login
          # Required for agent-task command (PATs don't work)
          COPILOT_OAUTH_TOKEN: ${{ secrets.COPILOT_OAUTH_TOKEN }}
        run: |
          if [ -z "$COPILOT_OAUTH_TOKEN" ]; then
            echo "::error::COPILOT_OAUTH_TOKEN secret is not set."
            echo "To set it up:"
            echo "  1. Run 'gh auth login' locally"
            echo "  2. Run 'gh auth token' to get your OAuth token"
            echo "  3. Add it as a repository secret named COPILOT_OAUTH_TOKEN"
            exit 1
          fi

          echo "$COPILOT_OAUTH_TOKEN" | gh auth login --with-token
          echo "Authenticated as: $(gh api user --jq .login)"

      - name: Run Copilot to fix issues and create PR
        if: steps.prepare-prompt.outputs.has-issues == 'true'
        id: copilot-fix
        run: |
          set -euo pipefail

          # Requires GitHub CLI v2.80.0+ for agent-task command
          echo "GitHub CLI version: $(gh --version | head -1)"

          # Determine base branch
          if [ "${{ github.event_name }}" = "schedule" ]; then
            BASE_BRANCH="main"
          else
            BASE_BRANCH="${{ github.ref_name }}"
          fi

          echo "Base branch: $BASE_BRANCH"
          echo "Repository: ${{ github.repository }}"
          echo ""
          echo "=== Copilot Prompt ==="
          cat /tmp/copilot_prompt.txt
          echo ""
          echo "=== Running Copilot Agent ==="

          # Use gh agent-task create (requires gh v2.80.0+)
          # Copilot handles: branch creation, code changes, commits, and PR
          # See: https://docs.github.com/en/copilot/how-tos/use-copilot-agents/coding-agent/create-a-pr
          PROMPT=$(cat /tmp/copilot_prompt.txt)

          if gh agent-task create "$PROMPT" \
            --base "$BASE_BRANCH" \
            --repo "${{ github.repository }}" \
            --follow 2>&1 | tee /tmp/copilot_output.log; then

            echo ""
            echo "Copilot task completed"

            # Try to extract PR URL from output (format may vary)
            PR_URL=$(grep -oE 'https://github.com/[^/]+/[^/]+/pull/[0-9]+' /tmp/copilot_output.log | head -1 || true)

            if [ -n "$PR_URL" ]; then
              echo "pr-url=$PR_URL" >> "$GITHUB_OUTPUT"
              echo "pr-created=true" >> "$GITHUB_OUTPUT"
              echo "Created PR: $PR_URL"

              # Add codeowners ping comment
              gh pr comment "$PR_URL" --body "/codeowners ping" || true
            else
              echo "pr-created=false" >> "$GITHUB_OUTPUT"
              echo "No PR URL found in output - check Copilot dashboard for status"
            fi
          else
            echo "Copilot task creation failed"
            echo "pr-created=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Output job summary
        if: always()
        run: |
          echo "## ðŸ¤– Copilot Coding Agent Task" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [ "${{ steps.prepare-prompt.outputs.has-issues }}" != "true" ]; then
            echo "No Clang Static Analyzer issues found to fix." >> "$GITHUB_STEP_SUMMARY"
          elif [ "${{ steps.copilot-fix.outputs.pr-created }}" = "true" ]; then
            echo "âœ… **Success!** Copilot created a PR to fix the issues." >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "**Pull Request:** [${{ steps.copilot-fix.outputs.pr-url }}](${{ steps.copilot-fix.outputs.pr-url }})" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "Please review the changes carefully before merging." >> "$GITHUB_STEP_SUMMARY"
          else
            echo "âš ï¸ Copilot task did not create a PR." >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "**Possible causes:**" >> "$GITHUB_STEP_SUMMARY"
            echo "- \`COPILOT_OAUTH_TOKEN\` secret not configured (see setup below)" >> "$GITHUB_STEP_SUMMARY"
            echo "- Copilot determined all issues were false positives" >> "$GITHUB_STEP_SUMMARY"
            echo "- Issues were too complex to fix automatically" >> "$GITHUB_STEP_SUMMARY"
            echo "- Copilot is still processing (check dashboard)" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "<details>" >> "$GITHUB_STEP_SUMMARY"
            echo "<summary>ðŸ”§ Setup: COPILOT_OAUTH_TOKEN secret</summary>" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "The \`gh agent-task\` command requires OAuth authentication (PATs don't work)." >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "**One-time setup by a team member with Copilot access:**" >> "$GITHUB_STEP_SUMMARY"
            echo '```bash' >> "$GITHUB_STEP_SUMMARY"
            echo '# 1. Login interactively' >> "$GITHUB_STEP_SUMMARY"
            echo 'gh auth login' >> "$GITHUB_STEP_SUMMARY"
            echo '' >> "$GITHUB_STEP_SUMMARY"
            echo '# 2. Extract your OAuth token' >> "$GITHUB_STEP_SUMMARY"
            echo 'gh auth token' >> "$GITHUB_STEP_SUMMARY"
            echo '' >> "$GITHUB_STEP_SUMMARY"
            echo '# 3. Add as repository secret: COPILOT_OAUTH_TOKEN' >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "The token owner must have GitHub Copilot access." >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "</details>" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "Check the [Copilot dashboard](https://github.com/${{ github.repository }}/copilot) for status." >> "$GITHUB_STEP_SUMMARY"
          fi

  publish-clangsa-pages:
    name: ðŸ“„ Publish CSA HTML to GitHub Pages
    needs: [ clang-static-analyzer ]
    if: ${{ always() && needs.clang-static-analyzer.result == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Download CodeChecker HTML report
        uses: actions/download-artifact@v4
        with:
          name: CodeChecker-HTML-Report
          path: site

      - name: Add .nojekyll
        run: touch site/.nojekyll

      - name: Publish to blozano-tt/clangsa-results (gh-pages)
        uses: peaceiris/actions-gh-pages@v4
        with:
          personal_token: ${{ secrets.CLANGSA_RESULTS_PAT }}
          external_repository: blozano-tt/clangsa-results
          publish_branch: gh-pages
          publish_dir: site
          force_orphan: true
          commit_message: "Update CSA reports from tt-metal @ ${{ github.sha }}"
