name: "Trace Qwen Model Operations"

on:
  workflow_dispatch:
    inputs:
      hf_model:
        description: "HuggingFace model to trace"
        type: string
        default: "Qwen/Qwen2.5-Coder-7B-Instruct"
        required: false
      test_path:
        description: "Test path to trace"
        type: string
        default: "models/tt_transformers/demo/simple_text_demo.py::test_demo_text"
        required: false
      runner_label:
        description: "Runner label (machine type)"
        type: choice
        default: "n300"
        options:
          - n300
          - n300-llmbox
          - N150
      arch:
        description: "Architecture"
        type: choice
        default: "wormhole_b0"
        options:
          - wormhole_b0
          - blackhole

jobs:
  display-inputs:
    name: Display workflow inputs
    runs-on: ubuntu-22.04
    steps:
      - name: Display configuration
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘          Model Tracer Workflow Configuration           â•‘"
          echo "â•Ÿâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢"
          echo "â”‚ HF Model:             ${{ github.event.inputs.hf_model || 'Qwen/Qwen2.5-Coder-7B-Instruct' }}"
          echo "â”‚ Test Path:            ${{ github.event.inputs.test_path || 'models/tt_transformers/demo/simple_text_demo.py::test_demo_text' }}"
          echo "â”‚ Runner Label:         ${{ github.event.inputs.runner_label || 'n300' }}"
          echo "â”‚ Architecture:         ${{ github.event.inputs.arch || 'wormhole_b0' }}"
          echo "â”‚ Triggered by:         ${{ github.actor }}"
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"

  build-artifact:
    uses: ./.github/workflows/build-artifact.yaml
    permissions:
      packages: write
    secrets: inherit
    with:
      build-type: Release
      build-wheel: true
      platform: Ubuntu 22.04
      enable-lto: false
      tracy: false

  trace-model:
    name: "Trace ${{ github.event.inputs.hf_model || 'Qwen/Qwen2.5-Coder-7B-Instruct' }}"
    needs: build-artifact
    runs-on: tt-ubuntu-2204-${{ github.event.inputs.runner_label || 'n300' }}-viommu-stable
    container:
      image: ${{ needs.build-artifact.outputs.dev-docker-image }}
      env:
        TT_METAL_HOME: /work
        PYTHONPATH: /work
        LD_LIBRARY_PATH: /work/build/lib
        ARCH_NAME: ${{ github.event.inputs.arch || 'wormhole_b0' }}
        LOGURU_LEVEL: INFO
        GITHUB_ACTIONS: true
        TRACY_NO_INVARIANT_CHECK: 1
        HF_MODEL: ${{ github.event.inputs.hf_model || 'Qwen/Qwen2.5-Coder-7B-Instruct' }}
        HF_TOKEN: ${{ secrets.HUGGINGFACE_TOKEN }}
      volumes:
        - ${{ github.workspace }}/docker-job:/work
        - /dev/hugepages-1G:/dev/hugepages-1G
      options: "--device /dev/tenstorrent"
    defaults:
      run:
        shell: bash
        working-directory: /work
    timeout-minutes: 60
    steps:
      - name: ğŸ§¬ Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          path: docker-job

      - name: â¬‡ï¸ Setup Job
        uses: ./docker-job/.github/actions/setup-job
        timeout-minutes: 10
        with:
          build-artifact-name: ${{ needs.build-artifact.outputs.build-artifact-name }}
          wheel-artifact-name: ${{ needs.build-artifact.outputs.wheel-artifact-name }}

      - name: ğŸ“Š Display Environment
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Environment Information"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Working Directory: $(pwd)"
          echo "Architecture: $ARCH_NAME"
          echo "HuggingFace Model: $HF_MODEL"
          echo "HF Token: $([ -n "$HF_TOKEN" ] && echo "âœ… Configured" || echo "âŒ Not set")"
          echo "Test Path: ${{ github.event.inputs.test_path || 'models/tt_transformers/demo/simple_text_demo.py::test_demo_text' }}"
          echo ""
          echo "Python Environment:"
          which python3
          python3 --version
          echo ""
          echo "Available Devices:"
          tt-smi -ls || echo "tt-smi not available"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: ğŸ”§ Run Model Tracer
        run: |
          echo "Starting model tracing..."
          TEST_PATH="${{ github.event.inputs.test_path || 'models/tt_transformers/demo/simple_text_demo.py::test_demo_text' }}"

          # The setup-job action should have already configured the environment
          # Just use python3 directly which should be available from the Docker container
          echo "Using Python: $(which python3)"
          python3 --version

          # Run the tracer
          python3 model_tracer/generic_ops_tracer.py "$TEST_PATH"

      - name: ğŸ“¦ Display Trace Results
        if: always()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Trace Results"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          if [ -d "model_tracer/traced_operations" ]; then
            echo "Traced operations directory:"
            ls -lh model_tracer/traced_operations/

            if [ -f "model_tracer/traced_operations/ttnn_operations_master.json" ]; then
              echo ""
              echo "Master JSON file size:"
              du -h model_tracer/traced_operations/ttnn_operations_master.json

              echo ""
              echo "Number of operations in master JSON:"
              python3 << 'EOF'
          import json
          try:
              with open('model_tracer/traced_operations/ttnn_operations_master.json', 'r') as f:
                  data = json.load(f)
              print(f"  Operations: {len(data.get('operations', {}))}")
              print(f"  Total configs: {data.get('metadata', {}).get('total_configurations', 'N/A')}")
          except Exception as e:
              print(f"  Error reading JSON: {e}")
          EOF
            fi
          else
            echo "âš ï¸ No traced_operations directory found"
          fi
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: ğŸ“¤ Upload Traced Operations
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: traced-operations-${{ github.event.inputs.hf_model || 'qwen-coder' }}-${{ github.run_id }}
          path: /work/model_tracer/traced_operations/
          retention-days: 7

      - name: ğŸ“¤ Upload Master JSON
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: master-json-${{ github.event.inputs.hf_model || 'qwen-coder' }}-${{ github.run_id }}
          path: /work/model_tracer/traced_operations/ttnn_operations_master.json
          retention-days: 30
          if-no-files-found: warn

      - name: ğŸ“Š Generate Summary
        if: always()
        run: |
          echo "# Model Tracer Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Configuration:**" >> $GITHUB_STEP_SUMMARY
          echo "- Model: \`$HF_MODEL\`" >> $GITHUB_STEP_SUMMARY
          echo "- Test: \`${{ github.event.inputs.test_path || 'models/tt_transformers/demo/simple_text_demo.py::test_demo_text' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Runner: \`${{ github.event.inputs.runner_label || 'n300' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Architecture: \`$ARCH_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "model_tracer/traced_operations/ttnn_operations_master.json" ]; then
            echo "**Results:**" >> $GITHUB_STEP_SUMMARY
            python3 << 'EOF' >> $GITHUB_STEP_SUMMARY
          import json
          try:
              with open('model_tracer/traced_operations/ttnn_operations_master.json', 'r') as f:
                  data = json.load(f)
              print(f"- âœ… Operations traced: {len(data.get('operations', {}))}")
              print(f"- âœ… Total configurations: {data.get('metadata', {}).get('total_configurations', 'N/A')}")
          except Exception as e:
              print(f"- âŒ Error: {e}")
          EOF
          else
            echo "- âŒ No trace results found" >> $GITHUB_STEP_SUMMARY
          fi
