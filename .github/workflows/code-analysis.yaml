name: "Code analysis"

on:
  schedule:
    # Run daily at 6 PM PST (2 AM UTC next day)
    - cron: "0 2 * * *"
  workflow_call:
    inputs:
      platform:
        required: false
        type: string
        default: "Ubuntu 24.04"
        description: "Platform to analyze (e.g., 'Ubuntu 22.04', 'Ubuntu 24.04')"
      architecture:
        required: false
        type: string
        default: "amd64"
      enable-static-analysis:
        description: "Enable Clang Static Analyzer (CSA) via CodeChecker"
        required: false
        type: boolean
        default: false
      # Pre-built Docker image tags (optional - if provided, skips docker build)
      ci-build-docker-image:
        required: false
        type: string
        default: ""
        description: "Pre-built CI Build Docker image tag"
      dev-docker-image:
        required: false
        type: string
        default: ""
        description: "Pre-built Dev Docker image tag"
      debug-file-filter:
        description: >-
          Analyze only specific file(s) for fast debugging
          (e.g., 'tests/tt_metal/**/*.hpp' or 'path/to/file.cpp')
        required: false
        type: string
        default: ""
      build-type:
        required: false
        type: string
        default: "Release"
        description: "Build type configuration (Release, Debug, RelWithDebInfo, ASan, TSan)"
      enable-lto:
        required: false
        type: boolean
        default: false
        description: "Enable Link Time Optimization (LTO)"
  workflow_dispatch:
    inputs:
      architecture:
        required: false
        type: string
        default: "amd64"
      enable-static-analysis:
        description: "Enable Clang Static Analyzer (CSA) via CodeChecker"
        required: false
        type: boolean
        default: false
      debug-file-filter:
        description: >-
          Analyze only specific file(s) for fast debugging
          (e.g., 'tests/tt_metal/**/*.hpp' or 'path/to/file.cpp')
        required: false
        type: string
        default: ""
      platform:
        required: false
        type: choice
        default: "Ubuntu 24.04"
        options:
          - "Ubuntu 22.04"
          - "Ubuntu 24.04"
        description: "Platform to analyze"
      build-type:
        required: false
        type: choice
        default: Release
        options:
          - Release
          - Debug
          - RelWithDebInfo
          - ASan
          - TSan
        description: "Build type configuration"
      enable-lto:
        required: false
        type: boolean
        default: false
        description: "Enable Link Time Optimization (LTO)"

jobs:
  # NOTE: Platform parsing is handled by build-docker-artifact.yaml internally.
  # This workflow only needs to pass the platform string.

  determine-scan-type:
    runs-on: ubuntu-latest
    outputs:
      do-full-scan: ${{ steps.compute-outputs.outputs.do-full-scan }}
      do-scan: ${{ steps.compute-outputs.outputs.do-scan }}
      merge-base: ${{ steps.compute-outputs.outputs.merge-base }}
    steps:
      - name: Check out repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Configure git safe.directory
        run: git config --global --add safe.directory ${{ github.workspace }}

      - id: find-changes
        uses: tenstorrent/tt-metal/.github/actions/find-changed-files@v0.63.0

      - id: compute-outputs
        shell: bash
        run: |
          if [[ "${{ github.ref_name }}" == "main" ]] || \
             [[ "${{ steps.find-changes.outputs.clang-tidy-config-changed }}" == "true" ]]; then
            do_full_scan="true"
          else
            do_full_scan="false"
          fi

          if [[ "$do_full_scan" == "true" ]] || \
             [[ "${{ steps.find-changes.outputs.any-code-changed }}" == "true" ]] || \
             [[ "${{ steps.find-changes.outputs.cmake-changed }}" == "true" ]]; then
            do_scan="true"
          else
            do_scan="false"
          fi

          merge_base=""
          if [[ "$do_full_scan" != "true" ]]; then
            merge_base=$(git merge-base ${{ github.ref_name }} origin/main)
            echo "Merge base between ${{ github.ref_name }} and main: $merge_base"
          fi

          echo "Do a scan: $do_scan"
          echo "Do a full scan: $do_full_scan"
          echo "do-full-scan=$do_full_scan" >> "$GITHUB_OUTPUT"
          echo "do-scan=$do_scan" >> "$GITHUB_OUTPUT"
          echo "merge-base=$merge_base" >> "$GITHUB_OUTPUT"

  # Only build docker images if pre-built tags are not provided
  build-docker-image:
    if: ${{ always() && !failure() && !cancelled() && inputs.ci-build-docker-image == '' }}
    uses: ./.github/workflows/build-docker-artifact.yaml
    permissions:
      packages: write
    secrets: inherit
    with:
      platform: ${{ inputs.platform || 'Ubuntu 24.04' }}
      architecture: ${{ inputs.architecture || 'amd64' }}

  # Full scan: single job that analyzes everything
  clang-tidy-full:
    name: ðŸ¤– Clang Tidy (Full)
    needs: [ build-docker-image, determine-scan-type ]
    if: >-
      ${{ always() && !failure() && !cancelled() &&
          needs.determine-scan-type.outputs.do-scan == 'true' &&
          needs.determine-scan-type.outputs.do-full-scan == 'true' }}
    uses: ./.github/workflows/clang-tidy-reusable.yaml
    secrets: inherit
    with:
      platform: ${{ inputs.platform || 'Ubuntu 24.04' }}
      architecture: ${{ inputs.architecture || 'amd64' }}
      ci-build-docker-image: >-
        ${{ inputs.ci-build-docker-image ||
            needs.build-docker-image.outputs.ci-build-tag ||
            'docker-image-unresolved!' }}
      do-full-scan: 'true'
      merge-base: ''
      prereq-targets: ''
      scan-targets: ''

  # Incremental scan: parallel jobs for different targets
  clang-tidy-incremental-tt-metal:
    name: ðŸ¤– Clang Tidy (Metalium)
    needs: [ build-docker-image, determine-scan-type ]
    if: >-
      ${{ always() && !failure() && !cancelled() &&
          needs.determine-scan-type.outputs.do-scan == 'true' &&
          needs.determine-scan-type.outputs.do-full-scan != 'true' }}
    uses: ./.github/workflows/clang-tidy-reusable.yaml
    secrets: inherit
    with:
      platform: ${{ inputs.platform || 'Ubuntu 24.04' }}
      architecture: ${{ inputs.architecture || 'amd64' }}
      ci-build-docker-image: >-
        ${{ inputs.ci-build-docker-image ||
            needs.build-docker-image.outputs.ci-build-tag ||
            'docker-image-unresolved!' }}
      do-full-scan: 'false'
      merge-base: ${{ needs.determine-scan-type.outputs.merge-base }}
      prereq-targets: ''
      scan-targets: 'tt_metal'

  clang-tidy-incremental-ttnn:
    name: ðŸ¤– Clang Tidy (TTNN)
    needs: [ build-docker-image, determine-scan-type ]
    if: >-
      ${{ always() && !failure() && !cancelled() &&
          needs.determine-scan-type.outputs.do-scan == 'true' &&
          needs.determine-scan-type.outputs.do-full-scan != 'true' }}
    uses: ./.github/workflows/clang-tidy-reusable.yaml
    secrets: inherit
    with:
      platform: ${{ inputs.platform || 'Ubuntu 24.04' }}
      architecture: ${{ inputs.architecture || 'amd64' }}
      ci-build-docker-image: >-
        ${{ inputs.ci-build-docker-image ||
            needs.build-docker-image.outputs.ci-build-tag ||
            'docker-image-unresolved!' }}
      do-full-scan: 'false'
      merge-base: ${{ needs.determine-scan-type.outputs.merge-base }}
      prereq-targets: 'tt_metal'
      scan-targets: 'ttnn'

  clang-tidy-incremental-catchall:
    name: ðŸ¤– Clang Tidy (catchall)
    needs: [ build-docker-image, determine-scan-type ]
    if: >-
      ${{ always() && !failure() && !cancelled() &&
          needs.determine-scan-type.outputs.do-scan == 'true' &&
          needs.determine-scan-type.outputs.do-full-scan != 'true' }}
    uses: ./.github/workflows/clang-tidy-reusable.yaml
    secrets: inherit
    with:
      platform: ${{ inputs.platform || 'Ubuntu 24.04' }}
      architecture: ${{ inputs.architecture || 'amd64' }}
      ci-build-docker-image: >-
        ${{ inputs.ci-build-docker-image ||
            needs.build-docker-image.outputs.ci-build-tag ||
            'docker-image-unresolved!' }}
      do-full-scan: 'false'
      merge-base: ${{ needs.determine-scan-type.outputs.merge-base }}
      prereq-targets: 'tt_metal ttnn'
      scan-targets: ''

  clang-static-analyzer:
    name: ðŸ”¬ Clang Static Analyzer
    needs: [ build-docker-image ]
    if: >-
      ${{ always() && !failure() && !cancelled() &&
          (inputs.enable-static-analysis == true || github.event_name == 'schedule') }}
    timeout-minutes: 300
    runs-on: tt-ubuntu-2204-xlarge-stable
    container:
      image: >-
        harbor.ci.tenstorrent.net/${{
          inputs.ci-build-docker-image ||
          needs.build-docker-image.outputs.ci-build-tag ||
          'docker-image-unresolved!'}}
      volumes:
        - ${{ github.workspace }}:/work
        # HACK: make actions available inside container
        - ${{ github.workspace }}/../../_actions:${{ github.workspace }}/../../_actions
      options: --tmpfs /tmp
    defaults:
      run:
        shell: bash
        working-directory: /work # https://github.com/actions/runner/issues/878
    steps:
      - name: Check out repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: recursive

      - name: Configure git safe.directory
        run: git config --global --add safe.directory /work

      - name: ðŸ”§ CMake configure
        run: cmake --preset clang-static-analyzer

      - name: ðŸ› ï¸ Generate files
        run: cmake --build .build/clang-static-analyzer --target all_generated_files

      - name: Setup clang symlinks for CodeChecker
        run: |
          update-alternatives --install /usr/bin/clang clang /usr/bin/clang-20 100
          update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-20 100

      - name: Install CodeChecker
        run: |
          # Pre-install CodeChecker in the container's venv using uv.
          # Pin to a specific version for reproducibility.
          uv pip install codechecker==6.27.1

      - name: ðŸ”¬ Analyze with CodeChecker
        id: codechecker
        run: |
          set -euo pipefail

          OUTPUT_DIR=/work/.build/codechecker-reports
          mkdir -p "$OUTPUT_DIR"

          echo "=== Starting CodeChecker analysis ==="

          # Build command with optional file filter
          ANALYZE_CMD="CodeChecker analyze \
            /work/.build/clang-static-analyzer/compile_commands.json \
            --output $OUTPUT_DIR \
            --jobs $(nproc) \
            --config /work/.codechecker.json"

          if [ -n "${{ inputs.debug-file-filter }}" ]; then
            echo "ðŸ› DEBUG MODE: Analyzing only: ${{ inputs.debug-file-filter }}"
            ANALYZE_CMD="$ANALYZE_CMD --file '${{ inputs.debug-file-filter }}'"
          fi

          # Run analysis (don't fail on analyzer crashes - common with static analysis)
          eval "$ANALYZE_CMD" || echo "âš ï¸ Analysis completed with warnings"

          # Set output for downstream steps
          echo "analyze-output=$OUTPUT_DIR" >> "$GITHUB_OUTPUT"

          # Show summary
          PLIST_COUNT=$(find "$OUTPUT_DIR" -name "*.plist" 2>/dev/null | wc -l)
          echo "âœ… Generated $PLIST_COUNT plist files"

      - name: Generate JSON and HTML reports from analysis results
        run: |
          set -euo pipefail

          OUTPUT_DIR="${{ steps.codechecker.outputs.analyze-output }}"
          JSON_OUTPUT="/work/.build/codechecker_issues.json"
          HTML_OUTPUT="/work/.build/codechecker_html"

          echo "=== Generating JSON report ==="
          # CodeChecker parse can fail if no issues found or plist files corrupted - that's OK
          CodeChecker parse "$OUTPUT_DIR" --export json --output "$JSON_OUTPUT" || true

          if [ -f "$JSON_OUTPUT" ] && [ -s "$JSON_OUTPUT" ]; then
            ISSUE_COUNT=$(jq '.reports | length' "$JSON_OUTPUT" || echo "0")
            echo "âœ… JSON report contains $ISSUE_COUNT issues"
          else
            echo "âš ï¸ No JSON output, creating empty report"
            echo '{"version": 1, "reports": []}' > "$JSON_OUTPUT"
          fi

          echo ""
          echo "=== Generating HTML report ==="
          mkdir -p "$HTML_OUTPUT"
          # Same as above - parse can fail for non-fatal reasons
          CodeChecker parse "$OUTPUT_DIR" --export html --output "$HTML_OUTPUT" || true

          if [ -d "$HTML_OUTPUT" ] && [ -n "$(ls -A "$HTML_OUTPUT")" ]; then
            echo "âœ… HTML report generated"
          else
            echo "âš ï¸ HTML report is empty or missing"
          fi

      - name: Upload JSON report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: CodeChecker-JSON-Report
          path: /work/.build/codechecker_issues.json

      - name: Upload HTML report
        uses: actions/upload-artifact@v4
        if: always()
        timeout-minutes: 10
        with:
          name: CodeChecker-HTML-Report
          path: /work/.build/codechecker_html

  publish-clangsa-pages:
    name: ðŸ“„ Publish CSA HTML to GitHub Pages
    needs: [ clang-static-analyzer ]
    # Only publish on full scans (skip when debug-file-filter is used)
    if: >-
      ${{ always() && needs.clang-static-analyzer.result == 'success' &&
          inputs.debug-file-filter == '' }}
    runs-on: ubuntu-latest

    steps:
      - name: Download CodeChecker HTML report
        uses: actions/download-artifact@v4
        with:
          name: CodeChecker-HTML-Report
          path: site

      - name: Download CodeChecker JSON report
        uses: actions/download-artifact@v4
        with:
          name: CodeChecker-JSON-Report
          path: site

      - name: Add .nojekyll
        run: touch site/.nojekyll

      - name: Publish to tenstorrent/tt-metal-clangsa-results (gh-pages)
        uses: peaceiris/actions-gh-pages@v4
        with:
          personal_token: ${{ secrets.CLANGSA_RESULTS_PAT }}
          external_repository: tenstorrent/tt-metal-clangsa-results
          publish_branch: gh-pages
          publish_dir: site
          force_orphan: true
          commit_message: "Update CSA reports from tt-metal @ ${{ github.sha }}"
