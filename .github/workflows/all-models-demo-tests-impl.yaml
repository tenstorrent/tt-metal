name: "[internal] All Models Demo Tests Implementation"

on:
  workflow_call:
    inputs:
      device-type:
        required: true
        type: string
        description: "Device type: n150, n300, p100, p150, wh-qb, bh-qb2, wh-6u, bh-6u"
      runner-label:
        required: true
        type: string
        description: "GitHub runner label"
      arch:
        required: true
        type: string
        description: "Architecture: wormhole_b0 or blackhole"
      docker-image:
        required: true
        type: string
      build-artifact-name:
        required: true
        type: string
      wheel-artifact-name:
        required: true
        type: string
      regenerate-ttnn-cache:
        required: false
        type: boolean
        default: false
      model-type:
        required: false
        type: string
        default: "all"
        description: "Model type filter: all, tt-transformers, or standalone"
      extra-tag:
        required: false
        type: string
        default: "in-service"
        description: "Extra tag for runner selection"

jobs:
  generate-test-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.generate.outputs.matrix }}
    steps:
      - name: Generate test matrix
        id: generate
        run: |
          # Define device-compatible TT-Transformers models
          case "${{ inputs.device-type }}" in
            n150)
              tt_transformers_models='["llama3.1-8b", "llama3.2-1b", "llama3.2-3b", "mistral-7b", "phi-3-mini-128k"]'
              ;;
            n300)
              tt_transformers_models='["llama3.2-11b-vision", "qwen2.5-7b", "phi-3-mini-128k"]'
              ;;
            p100)
              tt_transformers_models='["llama3.1-8b", "llama3.2-1b", "llama3.2-3b", "llama3.2-11b-vision", "mistral-7b", "phi-3-mini-128k"]'
              ;;
            p150)
              tt_transformers_models='["llama3.1-8b"]'
              ;;
            p300)
              tt_transformers_models='["llama3.1-8b", "llama3.2-1b", "llama3.2-3b", "llama3.2-11b-vision", "mistral-7b", "qwen2.5-7b", "qwen2.5-coder-32b", "qwen3-32b", "phi-3-mini-128k"]'
              ;;
            WH-QB)
              tt_transformers_models='["deepseek-r1-distill-llama-70b", "llama3.1-70b", "llama3.2-90b-vision", "qwen2.5-coder-32b", "qwen2.5-72b", "qwen3-32b"]'
              ;;
            BH-QB2)
              tt_transformers_models='["deepseek-r1-distill-llama-70b", "llama3.1-70b", "llama3.3-70b", "llama3.2-90b-vision", "qwen3-32b"]'
              ;;
            WH-6U)
              tt_transformers_models='["llama3.1-70b"]'
              ;;
            BH-6U)
              tt_transformers_models='["llama3.1-70b"]'
              ;;
          esac

          # Define device-compatible standalone models
          case "${{ inputs.device-type }}" in
            n150)
              standalone_models=$(jq -nc '[
                {"name":"whisper","test_path":"models/demos/audio/whisper/demo/demo.py::test_demo_for_conditional_generation_dataset","test_args":"","timeout":30},
                {"name":"stable-diffusion","test_path":"models/demos/vision/generative/stable_diffusion/wormhole/demo/demo.py::test_demo","test_args":"--input-path=models/demos/vision/generative/stable_diffusion/wormhole/demo/input_data.json","timeout":30},
                {"name":"resnet-50","test_path":"models/demos/vision/classification/resnet50/wormhole/demo/demo.py::test_demo_sample","test_args":"","timeout":20},
                {"name":"vit","test_path":"models/demos/vision/classification/vit/wormhole/tests/test_ttnn_optimized_sharded_vit_wh.py::test_vit","test_args":"","timeout":20},
                {"name":"mobilenet-v2","test_path":"models/demos/vision/classification/mobilenetv2/tests/pcc/test_mobilenetv2.py::test_mobilenetv2","test_args":"","timeout":20},
                {"name":"unet-vgg19","test_path":"models/demos/vision/segmentation/vgg_unet/wormhole/demo/demo.py::test_demo","test_args":"","timeout":20},
                {"name":"ufld-v2","test_path":"models/demos/vision/segmentation/ufld_v2/wormhole/tests/pcc/test_ttnn_ufld_v2.py::test_ufld_v2_model","test_args":"","timeout":20},
                {"name":"bert-large","test_path":"models/demos/metal_BERT_large_11/demo/demo.py::test_demo","test_args":"","timeout":20},
                {"name":"sentence-bert","test_path":"models/demos/wormhole/sentence_bert/tests/pcc/test_ttnn_sentencebert_model.py::test_ttnn_sentence_bert_model","test_args":"","timeout":20},
                {"name":"unet-vanilla","test_path":"models/demos/vision/segmentation/vanilla_unet/demo/demo.py::test_unet_demo_single_image","test_args":"","timeout":20},
                {"name":"segformer","test_path":"models/demos/vision/segmentation/segformer/tests/pcc/test_segformer_for_semantic_segmentation.py","test_args":"","timeout":20}
              ]')
              ;;
            n300)
              standalone_models=$(jq -nc '[
                {"name":"stable-diffusion","test_path":"models/demos/vision/generative/stable_diffusion/wormhole/demo/demo.py::test_demo","test_args":"--input-path=models/demos/vision/generative/stable_diffusion/wormhole/demo/input_data.json","timeout":30},
                {"name":"resnet-50","test_path":"models/demos/vision/classification/resnet50/wormhole/demo/demo.py::test_demo_sample","test_args":"","timeout":20},
                {"name":"vit","test_path":"models/demos/vision/classification/vit/wormhole/tests/test_ttnn_optimized_sharded_vit_wh.py::test_vit","test_args":"","timeout":20},
                {"name":"mobilenet-v2","test_path":"models/demos/vision/classification/mobilenetv2/tests/pcc/test_mobilenetv2.py::test_mobilenetv2","test_args":"","timeout":20},
                {"name":"unet-vgg19","test_path":"models/demos/vision/segmentation/vgg_unet/wormhole/demo/demo.py::test_demo","test_args":"","timeout":20},
                {"name":"ufld-v2","test_path":"models/demos/vision/segmentation/ufld_v2/wormhole/tests/pcc/test_ttnn_ufld_v2.py::test_ufld_v2_model","test_args":"","timeout":20},
                {"name":"sentence-bert","test_path":"models/demos/wormhole/sentence_bert/tests/pcc/test_ttnn_sentencebert_model.py::test_ttnn_sentence_bert_model","test_args":"","timeout":20},
                {"name":"unet-vanilla","test_path":"models/demos/vision/segmentation/vanilla_unet/demo/demo.py::test_unet_demo_single_image","test_args":"","timeout":20},
                {"name":"segformer","test_path":"models/demos/vision/segmentation/segformer/tests/pcc/test_segformer_for_semantic_segmentation.py","test_args":"","timeout":20}
              ]')
              ;;
            p100)
              standalone_models=$(jq -nc '[
                {"name":"whisper","test_path":"models/demos/audio/whisper/demo/demo.py::test_demo_for_conditional_generation_dataset","test_args":"","timeout":30},
                {"name":"stable-diffusion","test_path":"models/demos/vision/generative/stable_diffusion/blackhole/tests/test_unet_2d_condition_model.py::test_unet_2d_condition_model_512x512","test_args":"","timeout":30},
                {"name":"resnet-50","test_path":"models/demos/vision/classification/resnet50/blackhole/demo/demo.py::test_demo_sample","test_args":"","timeout":20},
                {"name":"vit","test_path":"models/demos/vision/classification/vit/blackhole/tests/test_ttnn_optimized_sharded_vit_bh.py::test_vit","test_args":"","timeout":20},
                {"name":"mobilenet-v2","test_path":"models/demos/vision/classification/mobilenetv2/tests/pcc/test_mobilenetv2.py::test_mobilenetv2","test_args":"","timeout":20},
                {"name":"unet-vgg19","test_path":"models/demos/vision/segmentation/vgg_unet/blackhole/demo/demo.py::test_demo","test_args":"","timeout":20},
                {"name":"ufld-v2","test_path":"models/demos/vision/segmentation/ufld_v2/blackhole/demo/demo.py::test_ufld_v2_demo","test_args":"","timeout":20},
                {"name":"bert-large","test_path":"models/demos/metal_BERT_large_11/demo/demo.py::test_demo","test_args":"","timeout":20},
                {"name":"sentence-bert","test_path":"models/demos/blackhole/sentence_bert/demo/demo.py::test_sentence_bert_demo_inference","test_args":"","timeout":20},
                {"name":"segformer","test_path":"models/demos/vision/segmentation/segformer/tests/pcc/test_segformer_for_semantic_segmentation.py","test_args":"","timeout":20}
              ]')
              ;;
            p150)
              standalone_models=$(jq -nc '[
                {"name":"whisper","test_path":"models/demos/audio/whisper/demo/demo.py::test_demo_for_conditional_generation_dataset","test_args":"","timeout":30},
                {"name":"stable-diffusion","test_path":"models/demos/vision/generative/stable_diffusion/blackhole/tests/test_unet_2d_condition_model.py::test_unet_2d_condition_model_512x512","test_args":"","timeout":30},
                {"name":"resnet-50","test_path":"models/demos/vision/classification/resnet50/blackhole/demo/demo.py::test_demo_sample","test_args":"","timeout":20},
                {"name":"vit","test_path":"models/demos/vision/classification/vit/blackhole/tests/test_ttnn_optimized_sharded_vit_bh.py::test_vit","test_args":"","timeout":20},
                {"name":"unet-vgg19","test_path":"models/demos/vision/segmentation/vgg_unet/blackhole/demo/demo.py::test_demo","test_args":"","timeout":20},
                {"name":"ufld-v2","test_path":"models/demos/vision/segmentation/ufld_v2/blackhole/demo/demo.py::test_ufld_v2_demo","test_args":"","timeout":20},
                {"name":"sentence-bert","test_path":"models/demos/blackhole/sentence_bert/demo/demo.py::test_sentence_bert_demo_inference","test_args":"","timeout":20}
              ]')
              ;;
            p300)
              standalone_models=$(jq -nc '[
                {"name":"whisper","test_path":"models/demos/audio/whisper/demo/demo.py::test_demo_for_conditional_generation_dataset","test_args":"","timeout":30},
                {"name":"stable-diffusion","test_path":"models/demos/vision/generative/stable_diffusion/blackhole/tests/test_unet_2d_condition_model.py::test_unet_2d_condition_model_512x512","test_args":"","timeout":30},
                {"name":"resnet-50","test_path":"models/demos/vision/classification/resnet50/blackhole/demo/demo.py::test_demo_sample","test_args":"","timeout":20},
                {"name":"vit","test_path":"models/demos/vision/classification/vit/blackhole/tests/test_ttnn_optimized_sharded_vit_bh.py::test_vit","test_args":"","timeout":20},
                {"name":"mobilenet-v2","test_path":"models/demos/vision/classification/mobilenetv2/tests/pcc/test_mobilenetv2.py::test_mobilenetv2","test_args":"","timeout":20},
                {"name":"unet-vgg19","test_path":"models/demos/vision/segmentation/vgg_unet/blackhole/demo/demo.py::test_demo","test_args":"","timeout":20},
                {"name":"segformer","test_path":"models/demos/vision/segmentation/segformer/tests/pcc/test_segformer_for_semantic_segmentation.py","test_args":"","timeout":20},
                {"name":"ufld-v2","test_path":"models/demos/vision/segmentation/ufld_v2/blackhole/demo/demo.py::test_ufld_v2_demo","test_args":"","timeout":20},
                {"name":"bert-large","test_path":"models/demos/metal_BERT_large_11/demo/demo.py::test_demo","test_args":"","timeout":20},
                {"name":"sentence-bert","test_path":"models/demos/blackhole/sentence_bert/demo/demo.py::test_sentence_bert_demo_inference","test_args":"","timeout":20}
              ]')
              ;;
            WH-QB)
              standalone_models=$(jq -nc '[
                {"name":"whisper","test_path":"models/demos/audio/whisper/demo/demo.py::test_demo_for_conditional_generation_dataset","test_args":"","timeout":30},
                {"name":"resnet-50","test_path":"models/demos/vision/classification/resnet50/ttnn_resnet/tests/test_demo.py::test_demo_sample","test_args":"","timeout":20},
                {"name":"vit","test_path":"models/demos/vision/classification/vit/t3000/demo/demo_vit_performant_imagenet_inference.py::test_run_vit_trace_2cqs_inference","test_args":"","timeout":20}
              ]')
              ;;
            BH-QB2)
              standalone_models=$(jq -nc '[
                {"name":"whisper","test_path":"models/demos/audio/whisper/demo/demo.py::test_demo_for_conditional_generation_dataset","test_args":"","timeout":30},
                {"name":"flux.1-dev","test_path":"models/experimental/tt_dit/tests/models/flux1/test_pipeline_flux1.py::test_flux1_pipeline","test_args":"-k \"2x2sp0tp1 and dev and encoder_device and not_traced and yes_use_cache\"","timeout":60},
                {"name":"wan2.2-t2v-a14b","test_path":"models/experimental/tt_dit/tests/models/wan2_2/test_pipeline_wan.py::test_pipeline_inference","test_args":"-k \"1x4sp0tp1 and resolution_480p\"","timeout":60}
              ]')
              ;;
            WH-6U)
              standalone_models=$(jq -nc '[
                {"name":"whisper","test_path":"models/demos/audio/whisper/demo/demo.py::test_demo_for_conditional_generation_dataset","test_args":"","timeout":30},
                {"name":"stable-diffusion","test_path":"models/demos/vision/generative/stable_diffusion/wormhole/demo/demo.py::test_demo","test_args":"--input-path=models/demos/vision/generative/stable_diffusion/wormhole/demo/input_data.json","timeout":30},
                {"name":"resnet-50","test_path":"models/demos/vision/classification/resnet50/ttnn_resnet/tests/test_demo.py::test_demo_sample","test_args":"","timeout":20},
                {"name":"vit","test_path":"models/demos/vision/classification/vit/t3000/demo/demo_vit_performant_imagenet_inference.py::test_run_vit_trace_2cqs_inference","test_args":"","timeout":20},
                {"name":"mobilenet-v2","test_path":"models/demos/vision/classification/mobilenetv2/tests/pcc/test_mobilenetv2.py::test_mobilenetv2","test_args":"","timeout":20},
                {"name":"unet-vgg19","test_path":"models/demos/vision/segmentation/vgg_unet/wormhole/demo/demo.py::test_demo","test_args":"","timeout":20},
                {"name":"ufld-v2","test_path":"models/demos/vision/segmentation/ufld_v2/wormhole/tests/pcc/test_ttnn_ufld_v2.py::test_ufld_v2_model","test_args":"","timeout":20},
                {"name":"bert-large","test_path":"models/demos/metal_BERT_large_11/demo/demo.py::test_demo","test_args":"","timeout":20},
                {"name":"sentence-bert","test_path":"models/demos/wormhole/sentence_bert/tests/pcc/test_ttnn_sentencebert_model.py::test_ttnn_sentence_bert_model","test_args":"","timeout":20},
                {"name":"unet-vanilla","test_path":"models/demos/vision/segmentation/vanilla_unet/demo/demo.py::test_unet_demo_single_image","test_args":"","timeout":20},
                {"name":"segformer","test_path":"models/demos/vision/segmentation/segformer/tests/pcc/test_segformer_for_semantic_segmentation.py","test_args":"","timeout":20}
              ]')
              ;;
            BH-6U)
              standalone_models=$(jq -nc '[
                {"name":"whisper","test_path":"models/demos/audio/whisper/demo/demo.py::test_demo_for_conditional_generation_dataset","test_args":"","timeout":30},
                {"name":"stable-diffusion","test_path":"models/demos/vision/generative/stable_diffusion/blackhole/tests/test_unet_2d_condition_model.py::test_unet_2d_condition_model_512x512","test_args":"","timeout":30},
                {"name":"resnet-50","test_path":"models/demos/vision/classification/resnet50/blackhole/demo/demo.py::test_demo_sample","test_args":"","timeout":20},
                {"name":"vit","test_path":"models/demos/vision/classification/vit/blackhole/tests/test_ttnn_optimized_sharded_vit_bh.py::test_vit","test_args":"","timeout":20},
                {"name":"mobilenet-v2","test_path":"models/demos/vision/classification/mobilenetv2/tests/pcc/test_mobilenetv2.py::test_mobilenetv2","test_args":"","timeout":20},
                {"name":"unet-vgg19","test_path":"models/demos/vision/segmentation/vgg_unet/blackhole/demo/demo.py::test_demo","test_args":"","timeout":20},
                {"name":"ufld-v2","test_path":"models/demos/vision/segmentation/ufld_v2/blackhole/demo/demo.py::test_ufld_v2_demo","test_args":"","timeout":20},
                {"name":"bert-large","test_path":"models/demos/metal_BERT_large_11/demo/demo.py::test_demo","test_args":"","timeout":20},
                {"name":"sentence-bert","test_path":"models/demos/blackhole/sentence_bert/demo/demo.py::test_sentence_bert_demo_inference","test_args":"","timeout":20},
                {"name":"unet-vanilla","test_path":"models/demos/vision/segmentation/vanilla_unet/demo/demo.py::test_unet_demo_single_image","test_args":"","timeout":20},
                {"name":"segformer","test_path":"models/demos/vision/segmentation/segformer/tests/pcc/test_segformer_for_semantic_segmentation.py","test_args":"","timeout":20}
              ]')
              ;;
          esac

          # Define model HuggingFace paths mapping
          declare -A model_paths
          model_paths["llama3.1-8b"]="meta-llama/Llama-3.1-8B-Instruct"
          model_paths["llama3.1-70b"]="meta-llama/Llama-3.1-70B-Instruct"
          model_paths["llama3.3-70b"]="meta-llama/Llama-3.3-70B-Instruct"
          model_paths["llama3.2-1b"]="meta-llama/Llama-3.2-1B"
          model_paths["llama3.2-3b"]="meta-llama/Llama-3.2-3B"
          model_paths["llama3.2-11b-vision"]="meta-llama/Llama-3.2-11B-Vision"
          model_paths["llama3.2-90b-vision"]="meta-llama/Llama-3.2-90B-Vision"
          model_paths["mistral-7b"]="mistralai/Mistral-7B-Instruct-v0.3"
          model_paths["qwen2.5-7b"]="Qwen/Qwen2.5-7B"
          model_paths["qwen2.5-coder-32b"]="Qwen/Qwen2.5-Coder-32B"
          model_paths["qwen2.5-72b"]="Qwen/Qwen2.5-72B"
          model_paths["qwen3-32b"]="Qwen/Qwen3-32B"
          model_paths["phi-3-mini-128k"]="microsoft/Phi-3-mini-128k-instruct"
          model_paths["deepseek-r1-distill-llama-70b"]="deepseek-ai/DeepSeek-R1-Distill-Llama-70B"

          # Define test configurations
          tests='[{"name":"Batch-1 CI","test_key":"performance and ci-1","extra_args":"","timeout":60,"owner_id":"U03PUAKE719"},{"name":"Batch-32 CI","test_key":"performance and ci-32","extra_args":"","timeout":60,"owner_id":"U03PUAKE719"},{"name":"Long Context 16K","test_key":"performance and ci-long-context-16k","extra_args":"","timeout":60,"owner_id":"U03PUAKE719"}]'

          # Generate matrix combining models and tests
          matrix='[]'

          # Process TT-Transformers models if requested
          if [[ "${{ inputs.model-type }}" == "all" || "${{ inputs.model-type }}" == "tt-transformers" ]]; then
            # Process TT-Transformers models with 4 test types each
            for model in $(echo "$tt_transformers_models" | jq -r '.[]'); do
              HF_MODEL="${model_paths[$model]}"

              # Determine cache path based on architecture
              if [[ "${{ inputs.arch }}" == "blackhole" ]]; then
                CACHE_PATH="/localdev/blackhole_demos/huggingface_data/${HF_MODEL}"
              else
                CACHE_PATH="/mnt/MLPerf/huggingface/tt_cache/${HF_MODEL}"
              fi

              # Add each test for this model to the matrix
              model_tests=$(echo "$tests" | jq -c --arg model "$model" --arg hf "$HF_MODEL" --arg cache "$CACHE_PATH" \
                '[.[] | . + {"model": $model, "hf_model": $hf, "cache_path": $cache, "model_type": "tt-transformers"}]')

              matrix=$(echo "$matrix" | jq -c --argjson new "$model_tests" '. + $new')
            done
          fi

          # Process standalone models if requested
          if [[ "${{ inputs.model-type }}" == "all" || "${{ inputs.model-type }}" == "standalone" ]]; then
            # Process standalone models with single demo test each
            standalone_count=$(echo "$standalone_models" | jq 'length')
            for ((i=0; i<standalone_count; i++)); do
              standalone=$(echo "$standalone_models" | jq -c ".[$i]")
              model_name=$(echo "$standalone" | jq -r '.name')
              test_path=$(echo "$standalone" | jq -r '.test_path')
              test_args=$(echo "$standalone" | jq -r '.test_args')
              timeout=$(echo "$standalone" | jq -r '.timeout')

              # Determine cache path based on architecture
              if [[ "${{ inputs.arch }}" == "blackhole" ]]; then
                CACHE_PATH="/localdev/blackhole_demos/huggingface_data"
              else
                CACHE_PATH="/mnt/MLPerf/huggingface/tt_cache"
              fi

              # Add standalone model test to matrix using proper JSON construction
              matrix=$(echo "$matrix" | jq -c \
                --arg model "$model_name" \
                --arg test_path "$test_path" \
                --arg test_args "$test_args" \
                --arg cache "$CACHE_PATH" \
                --argjson timeout "$timeout" \
                '. + [{
                  "model": $model,
                  "name": "Demo Test",
                  "test_path": $test_path,
                  "test_args": $test_args,
                  "cache_path": $cache,
                  "timeout": $timeout,
                  "model_type": "standalone"
                }]')
            done
          fi

          echo "Generated matrix for device-type: ${{ inputs.device-type }}"
          echo "Matrix length: $(echo "$matrix" | jq 'length')"
          echo "matrix=$matrix" >> $GITHUB_OUTPUT

  run-tests:
    needs: generate-test-matrix
    strategy:
      fail-fast: false
      matrix:
        test: ${{ fromJson(needs.generate-test-matrix.outputs.matrix) }}
    name: "${{ inputs.device-type }} - ${{ matrix.test.model }} - ${{ matrix.test.name }}"
    runs-on: >-
      ${{
        inputs.runner-label == 'topology-6u'
        && fromJSON(format('["{0}", "{1}", "{2}"]', inputs.arch == 'blackhole' && 'arch-blackhole' || 'arch-wormhole_b0', inputs.runner-label, inputs.extra-tag))
        || fromJSON(format('["{0}", "{1}"]', inputs.runner-label, inputs.extra-tag))
      }}
    container:
      image: ${{ inputs.docker-image }}
      env:
        TT_METAL_HOME: /work
        PYTHONPATH: /work
        LD_LIBRARY_PATH: /work/build/lib
        LOGURU_LEVEL: INFO
        ARCH_NAME: ${{ inputs.arch }}
        HF_MODEL: ${{ matrix.test.model_type == 'tt-transformers' && matrix.test.hf_model || '' }}
        TT_CACHE_PATH: ${{ matrix.test.cache_path }}
        HF_TOKEN: ${{ secrets.HUGGINGFACE_TOKEN }}
        HF_HUB_CACHE: ${{ inputs.arch == 'blackhole' && '/localdev/blackhole_demos/huggingface_data/hub' || '/mnt/MLPerf/huggingface/hub' }}
        HF_HOME: /tmp/hf_home
        SD_HF_DOWNLOAD_OVERRIDE: ${{ inputs.regenerate-ttnn-cache && '1' || '0' }}
        TT_CACHE_HOME: ${{ inputs.arch == 'blackhole' && '/localdev/blackhole_demos/huggingface_data/tt_cache' || '/mnt/MLPerf/huggingface/tt_cache' }}
      volumes:
        - ${{ github.workspace }}/docker-job:/work
        - /dev/hugepages-1G:/dev/hugepages-1G
        - ${{ inputs.arch == 'blackhole' && '/localdev/blackhole_demos/huggingface_data:/localdev/blackhole_demos/huggingface_data:rw' || format('/mnt/MLPerf:/mnt/MLPerf{0}', inputs.regenerate-ttnn-cache && ':rw' || ':ro') }}
      options: "--device /dev/tenstorrent"
    defaults:
      run:
        shell: bash
        working-directory: /work
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          path: docker-job

      - name: ⬇️  Setup Job
        uses: ./docker-job/.github/actions/setup-job
        timeout-minutes: 10
        with:
          build-artifact-name: ${{ inputs.build-artifact-name }}
          wheel-artifact-name: ${{ inputs.wheel-artifact-name }}

      - name: Run ${{ matrix.test.name }} test
        timeout-minutes: ${{ matrix.test.timeout }}
        run: |
          echo "=========================================="
          echo "Running: ${{ matrix.test.name }}"
          echo "Device: ${{ inputs.device-type }}"
          echo "Model: ${{ matrix.test.model }}"
          echo "Model Type: ${{ matrix.test.model_type }}"
          echo "=========================================="

          # Sanitize test name for file naming (replace spaces with hyphens)
          TEST_NAME_SAFE="$(echo '${{ matrix.test.name }}' | tr ' ' '-')"

          # Check if we're not regenerating cache and should verify cache exists
          SKIP_IF_MISSING="${{ !inputs.regenerate-ttnn-cache }}"

          if [[ "${{ matrix.test.model_type }}" == "tt-transformers" ]]; then
            echo "HF_MODEL: ${{ matrix.test.hf_model }}"
            echo "TT_CACHE_PATH: ${{ matrix.test.cache_path }}"
            echo "Test Key: ${{ matrix.test.test_key }}"
            echo "Extra Args: ${{ matrix.test.extra_args }}"
            echo "=========================================="

            pytest models/tt_transformers/demo/simple_text_demo.py \
              -k "${{ matrix.test.test_key }}" \
              ${{ matrix.test.extra_args }} \
              --timeout 1000 \
              --junitxml=generated/test_results/results-${{ inputs.device-type }}-${{ matrix.test.model }}-${TEST_NAME_SAFE}.xml
          else
            echo "Test Path: ${{ matrix.test.test_path }}"
            echo "Test Args: ${{ matrix.test.test_args }}"
            echo "Working Directory: $(pwd)"
            echo "Test file exists: $(test -f ${{ matrix.test.test_path }} && echo 'YES' || echo 'NO')"
            echo "=========================================="

            # Run pytest with verbose output to see what's happening
            pytest --disable-warnings -v \
              ${{ matrix.test.test_path }} \
              ${{ matrix.test.test_args }} \
              --junitxml=generated/test_results/results-${{ inputs.device-type }}-${{ matrix.test.model }}-${TEST_NAME_SAFE}.xml || echo "pytest exit code: $?"
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ inputs.device-type }}-${{ matrix.test.model }}-${{ hashFiles(format('docker-job/generated/test_results/results-{0}-{1}-*.xml', inputs.device-type, matrix.test.model)) || github.run_number }}
          path: docker-job/generated/test_results/*.xml
          if-no-files-found: ignore

      - name: Save environment data
        id: save-environment-data
        if: ${{ !cancelled() }}
        timeout-minutes: 15
        env:
          ARCH_NAME: ${{ inputs.arch }}
        run: |
          if [ -d "generated/benchmark_data" ]; then
            echo "has_benchmark_data=true" >> $GITHUB_OUTPUT
            python3 .github/scripts/data_analysis/create_benchmark_with_environment_json.py
          fi

      - name: Upload benchmark data artifact
        if: ${{ !cancelled() && steps.save-environment-data.outputs.has_benchmark_data == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-data-${{ inputs.device-type }}-${{ matrix.test.model }}-${{ github.run_number }}-${{ strategy.job-index }}
          path: generated/benchmark_data
