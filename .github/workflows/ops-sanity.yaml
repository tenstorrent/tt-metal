# This is a template workflow for running Ops Sanity pipeline tests.
# These tests are meant to run after every commit and are meant to replace the existing APC pipeline.


# The following parameters can be controlled in the tests.yaml file by the developer:

# name: The name of the test
# cmd: The command to run the test
# sku: the sku of the test (N150, N300, P100, P150b, llmbox, galaxy, etc)
# owner_id: The owner of the test


name: "[testing] Ops Sanity pipeline"

on:
  workflow_dispatch:
    inputs:
      platform:
        required: false
        type: choice
        default: "Ubuntu 22.04"
        options:
          - "Ubuntu 22.04"
          - "Ubuntu 24.04"
        description: "Platform to build and test"
      build-type:
        required: false
        default: Release
        type: choice
        options:
          - Release
          - Debug
          - RelWithDebInfo
          - ASan
          - TSan
      enable-lto:
        required: false
        default: false
        type: boolean
        description: "Enable Link Time Optimization (LTO)"
  workflow_call:
    inputs:
      build-artifact-name:
        required: true
        type: string
      wheel-artifact-name:
        required: true
        type: string
      docker-image:
        required: true
        type: string
      platform:
        required: false
        type: string
        default: "Ubuntu 22.04"
        description: "Platform to build and test"
      build-type:
        required: false
        type: string
        default: "Release"
        description: "Build type configuration"
      enable-lto:
        required: false
        type: boolean
        default: false
        description: "Enable Link Time Optimization (LTO)"

jobs:
  # Parse platform dropdown to extract enable-lto
  parse-platform:
    runs-on: ubuntu-latest
    outputs:
      enable-lto: ${{ steps.parse.outputs.enable-lto }}
    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: .github/actions
          sparse-checkout-cone-mode: false
      - id: parse
        uses: ./.github/actions/parse-platform
        with:
          platform: ${{ inputs.platform }}
          enable-lto: ${{ inputs.enable-lto }}

  load-test-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.load-test-matrix.outputs.matrix }}
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Install dependencies
        run: pip install PyYAML
      - name: Verify test timeouts against budget
        run: |
          set -e
          echo "Verifying that timeouts defined in tests.yaml are within the allowed limits..."
          python3 .github/scripts/utils/verify_time_budget.py \
            ./tests/pipeline_reorg/ops/sanity/tests.yaml \
            ./.github/time_budget.yaml

      - name: Load test matrix
        id: load-test-matrix
        # the tests.yaml file is currently hardcoded
        # Install yq to parse the tests.yaml file
        # TODO: move yq install out to install dependencies step.
        env:
          TESTS_YAML_PATH: ./tests/pipeline_reorg/ops/sanity/tests.yaml
        run: |
          set -e
          # Install yq
          YQ_VERSION="v4.44.1"
          wget -q "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64" -O /usr/local/bin/yq
          chmod +x /usr/local/bin/yq
          # Check if the file exists
          if [ ! -f "$TESTS_YAML_PATH" ]; then
            echo "::error::Test matrix file not found at: $TESTS_YAML_PATH"
            exit 1
          fi
          # Convert to compact JSON (single line, no indentation)
          json_output=$(yq -o=json -I=0 '.' "$TESTS_YAML_PATH")
          # Print the JSON output for debugging
          echo "Read contents of $TESTS_YAML_PATH and converted to JSON:"
          echo "${json_output}"
          # Output using heredoc delimiter approach (required for multi-line or complex values)
          {
            echo 'matrix<<EOF'
            echo "${json_output}"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

  build-artifact:
    # This job will ONLY run if the build-artifact-name input is NOT provided.
    if: ${{ inputs.build-artifact-name == '' }}
    needs: [load-test-matrix, parse-platform]
    uses: ./.github/workflows/build-artifact.yaml
    permissions:
      packages: write
    secrets: inherit
    with:
      build-type: ${{ inputs.build-type || 'Release' }}
      build-wheel: true
      platform: ${{ inputs.platform }}
      # Enable LTO based on platform setting (user can override via checkbox)
      enable-lto: ${{ needs.parse-platform.outputs.enable-lto == 'true' }}

  tests:
    # If the build-artifact-name input is NOT provided, we need to run the build-artifact job first.
    needs: [load-test-matrix, build-artifact]
    # Always run this job even if build-artifact job is not run.
    if: always()
    strategy:
      fail-fast: false
      matrix:
        test-group: ${{ fromJson(needs.load-test-matrix.outputs.matrix) }}
    name: ${{ matrix.test-group.name }}
    runs-on: >-
      ${{
        (matrix.test-group.sku == 'P100') && fromJSON(format('["in-service", "cloud-virtual-machine", "{0}"]', matrix.test-group.sku))
        || ((matrix.test-group.sku == 'P150b') && format('tt-ubuntu-2204-{0}-metal', matrix.test-group.sku))
        || format('tt-ubuntu-2204-{0}-viommu-metal', matrix.test-group.sku)
      }}
    container:
      image: ${{ inputs.docker-image || needs.build-artifact.outputs.dev-docker-image || 'docker-image-unresolved!' }}
      env:
        LOGURU_LEVEL: INFO
        PYTHONPATH: /work
        LD_LIBRARY_PATH: /work/build/lib
      volumes:
        - ${{ github.workspace }}/docker-job:/work # Subdir to workaround https://github.com/actions/runner/issues/691
        - /dev/hugepages-1G:/dev/hugepages-1G
      options: "--device /dev/tenstorrent"
    defaults:
      run:
        shell: bash
        working-directory: /work # https://github.com/actions/runner/issues/878
    steps:
      - name: Mark repository as safe directory
        run: |
          git config --global --add safe.directory $GITHUB_WORKSPACE
      - name: üß¨ Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          path: docker-job
      - name: ‚¨áÔ∏è  Setup Job
        uses: ./docker-job/.github/actions/setup-job
        timeout-minutes: 10
        with:
          wheel-artifact-name: ${{ inputs.wheel-artifact-name || needs.build-artifact.outputs.wheel-artifact-name }}
      - name: ${{ matrix.test-group.name }}
        timeout-minutes: ${{ matrix.test-group.timeout }}
        run: |
          echo ${{ matrix.test-group.cmd }}
          ${{ matrix.test-group.cmd }}
      - uses: tenstorrent/tt-metal/.github/actions/slack-report@main
        if: ${{ failure() }}
        with:
          slack_webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          owner: ${{ matrix.test-group.owner_id }}
      - uses: tenstorrent/tt-metal/.github/actions/cleanup@main
        if: always()
