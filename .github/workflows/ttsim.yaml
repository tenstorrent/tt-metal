name: "[impl] TTSim Integration Tests"

on:
  workflow_call:
    inputs:
      basic-docker-image:
        required: true
        type: string
      test-docker-image:
        required: true
        type: string
      package-artifact-name:
        required: false
        type: string
      wheel-artifact-name:
        required: false
        type: string
      build-artifact-name:
        required: false
        type: string
      ttsim-version:
        required: false
        type: string
        default: "v1.3.4"
      job-timeout:
        required: false
        type: number
        default: 15
      run-ttsim-integration-tests:
        required: false
        type: boolean
        default: false
      run-metal-cpp-unit-tests:
        required: false
        type: boolean
        default: false

jobs:
  ttsim-integration:
    if: ${{ inputs.run-ttsim-integration-tests }}
    runs-on: tt-ubuntu-2204-small-stable
    timeout-minutes: ${{ inputs.job-timeout }}
    name: "TTSim Integration - ${{ matrix.arch }}"
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: wormhole_b0
            build_suffix: release_wh
            soc_desc: wormhole_b0_80_arch.yaml
          - arch: blackhole
            build_suffix: release_bh
            soc_desc: blackhole_140_arch.yaml
    permissions:
      contents: read
    container:
      image: harbor.ci.tenstorrent.net/${{ inputs.basic-docker-image || 'docker-image-unresolved!'}}
      volumes:
        - ${{ github.workspace }}:/work
    defaults:
      run:
        shell: bash
        working-directory: /work # https://github.com/actions/runner/issues/878
    env:
      CC: gcc-12
      CXX: g++-12
      TT_METAL_HOME: /usr/libexec/tt-metalium
      TT_METAL_SIMULATOR_HOME: /work/sim
      TT_METAL_SIMULATOR: /work/sim/libttsim.so
      TT_METAL_SLOW_DISPATCH_MODE: 1
    steps:

      - name: Checkout actions
        uses: actions/checkout@v4
        with:
          sparse-checkout: .github/actions/download-artifact-with-retry
          sparse-checkout-cone-mode: false

      - name: Download packages artifact
        uses: ./.github/actions/download-artifact-with-retry
        timeout-minutes: 15
        with:
          name: ${{ inputs.package-artifact-name || 'packages artifact unresolved!' }}
          path: /work/pkgs/

      - name: Install packages
        timeout-minutes: 10
        run: |
          set -euo pipefail
          apt update
          apt install -y ./pkgs/tt-metalium_*.deb ./pkgs/tt-metalium-jit_*.deb ./pkgs/tt-metalium-dev_*.deb ./pkgs/tt-metalium-examples_*.deb

      - name: Compute ttsim asset name
        id: ttsim-asset
        run: |
          asset_suffix="${{ matrix.build_suffix }}"
          asset_suffix="${asset_suffix#release_}"
          echo "asset_name=libttsim_${asset_suffix}.so" >> "$GITHUB_OUTPUT"

      - name: Download ttsim binary
        uses: robinraju/release-downloader@daf26c55d821e836577a15f77d86ddc078948b05 # v1.12
        with:
          repository: tenstorrent/ttsim
          tag: ${{ inputs.ttsim-version }}
          fileName: ${{ steps.ttsim-asset.outputs.asset_name }}
          out-file-path: /tmp/ttsim

      - name: Install ttsim
        run: |
          set -euo pipefail
          mkdir -p $TT_METAL_SIMULATOR_HOME
          mv /tmp/ttsim/${{ steps.ttsim-asset.outputs.asset_name }} $TT_METAL_SIMULATOR_HOME/libttsim.so
          cp $TT_METAL_HOME/tt_metal/soc_descriptors/${{ matrix.soc_desc }} $TT_METAL_SIMULATOR_HOME/soc_descriptor.yaml

      - name: Build and Run Metal Examples
        timeout-minutes: 3
        run: |
          working_examples=(
            "add_2_integers_in_compute"
            "add_2_integers_in_riscv"
            "eltwise_binary"
            "eltwise_sfpu"
            "hello_world_compute_kernel"
            "hello_world_datamovement_kernel"
            "matmul_multi_core"
            "matmul_multicore_reuse"
          )
          for example_name in "${working_examples[@]}"; do
            example_path="/usr/share/tt-metalium/examples/${example_name}"
            if [[ -d "$example_path" ]]; then
              echo "::group::${example_name} - build and run"
              build_dir=$(mktemp -d)
              cd "$build_dir"
              # Build the example
              cmake -G Ninja -S "$example_path" -B .
              cmake --build .
              # Find and run the built executable
              readarray -t exec_paths < <(find . -maxdepth 2 -type f -executable -not -name "*.so")
              for exe in "${exec_paths[@]}"; do
                exe_basename=$(basename "$exe")
                echo "Running ${exe_basename}"
                "$exe"
              done
              echo "::endgroup::"
            else
              echo "Warning: Example directory not found: $example_path"
            fi
          done
  # ---------------------------------------------------------------------------
  # Define TTSim-compatible TTNN tests from shared config
  # ---------------------------------------------------------------------------
  define-ttsim-ttnn-tests:
    if: ${{ inputs.run-ttsim-integration-tests }}
    runs-on: ubuntu-latest
    env:
      TTNN_TESTS_YAML: tests/pipeline_reorg/ttnn-tests.yaml
    outputs:
      ttnn-tests: ${{ steps.compute-tests.outputs.ttnn-tests }}
    steps:
      # Note: This checkout is needed because this is a separate job that runs before ttnn-pytests.
      # Each job runs in a fresh environment, so we can't reuse the checkout from ttnn-pytests.
      # We use sparse checkout to efficiently fetch only the test definitions YAML file.
      - name: Checkout repository for test definitions
        uses: actions/checkout@v4
        with:
          sparse-checkout: ${{ env.TTNN_TESTS_YAML }}
          sparse-checkout-cone-mode: false

      - name: Compute TTSim-compatible tests
        shell: bash
        id: compute-tests
        run: |
          set -euo pipefail

          # Read test definitions from shared YAML file and filter for ttsim-compatible tests
          echo "[info] Reading test definitions from $TTNN_TESTS_YAML"
          ttsim_tests=$(yq -o=json '.tests | [.[] | select(.ttsim == true)]' "$TTNN_TESTS_YAML")
          echo "[info] TTSim-compatible tests:"
          echo "$ttsim_tests" | jq

          # Check that we have a valid test list
          echo "$ttsim_tests" | jq -e 'if type != "array" then error("Not a valid JSON array") elif length == 0 then error("Test list is empty") else . end' && echo "Valid test configs"
          echo "ttnn-tests=$(echo $ttsim_tests | tr -d '\n')" >> "$GITHUB_OUTPUT"

  # ---------------------------------------------------------------------------
  # TTNN Pytests on TTSim (uses shared test definitions)
  # ---------------------------------------------------------------------------
  ttnn-pytests:
    needs: define-ttsim-ttnn-tests
    if: ${{ inputs.run-ttsim-integration-tests }}
    runs-on: ubuntu-latest
    env:
      TTSIM_SKIP_LIST_YAML: tests/pipeline_reorg/ttsim-skip-list.yaml
    timeout-minutes: ${{ matrix.test-group.timeout || inputs.job-timeout }}
    name: "TTNN ${{ matrix.test-group.name }} - ${{ matrix.arch.name }}"
    strategy:
      fail-fast: false
      matrix:
        arch:
          - name: wormhole_b0
            build_suffix: release_wh
            soc_desc: wormhole_b0_80_arch.yaml
          - name: blackhole
            build_suffix: release_bh
            soc_desc: blackhole_140_arch.yaml
        test-group: ${{ fromJSON(needs.define-ttsim-ttnn-tests.outputs.ttnn-tests) }}
        exclude:
          # Conv tests are all skipped on Blackhole - skip the job entirely
          - arch:
              name: blackhole
            test-group:
              name: "ttnn conv group"
    container:
      image: ${{ inputs.test-docker-image || 'docker-image-unresolved!'}}
      volumes:
        - ${{ github.workspace }}:/work
      env:
        ARCH_NAME: ${{ matrix.arch.name }}
        TT_METAL_SIMULATOR_HOME: /work/sim
        TT_METAL_SIMULATOR: /work/sim/libttsim.so
        TT_METAL_SLOW_DISPATCH_MODE: 1
        LOGURU_LEVEL: INFO
        PYTHONPATH: /work
        PYTHONHASHSEED: 0
    defaults:
      run:
        shell: bash
        working-directory: /work # https://github.com/actions/runner/issues/878
    steps:
      - name: ðŸ§¬ Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: â¬‡ï¸  Setup Job
        uses: ./.github/actions/setup-job
        timeout-minutes: 10
        with:
          path: .
          wheel-artifact-name: ${{ inputs.wheel-artifact-name }}

      - name: Compute ttsim asset name
        id: ttsim-asset
        run: |
          asset_suffix="${{ matrix.arch.build_suffix }}"
          asset_suffix="${asset_suffix#release_}"
          echo "asset_name=libttsim_${asset_suffix}.so" >> "$GITHUB_OUTPUT"

      - name: Download ttsim binary
        uses: robinraju/release-downloader@daf26c55d821e836577a15f77d86ddc078948b05 # v1.12
        with:
          repository: tenstorrent/ttsim
          tag: ${{ inputs.ttsim-version }}
          fileName: ${{ steps.ttsim-asset.outputs.asset_name }}
          out-file-path: /tmp/ttsim

      - name: Install ttsim
        run: |
          set -euo pipefail
          mkdir -p $TT_METAL_SIMULATOR_HOME
          mv /tmp/ttsim/${{ steps.ttsim-asset.outputs.asset_name }} $TT_METAL_SIMULATOR_HOME/libttsim.so
          cp /work/tt_metal/soc_descriptors/${{ matrix.arch.soc_desc }} $TT_METAL_SIMULATOR_HOME/soc_descriptor.yaml

      - name: Install pytest-xdist for parallel execution
        run: uv pip install pytest-xdist

      # Note: The skip list YAML is available from the full checkout above (line 227-230).
      # No sparse checkout is needed because the ttnn-pytests job does a full checkout with submodules.
      - name: Build skip list arguments
        id: skip-list
        run: |
          ARCH="${{ matrix.arch.name }}"
          SKIP_ARGS=$(yq -r ".${ARCH}[]" "$TTSIM_SKIP_LIST_YAML" | sed 's/^/--deselect=/' | tr '\n' ' ' | sed 's/[[:space:]]*$//')
          echo "[info] Loaded skip list for arch: $ARCH from $TTSIM_SKIP_LIST_YAML"
          echo "[info] Skip args count: $(echo $SKIP_ARGS | wc -w)"
          echo "skip_args=${SKIP_ARGS}" >> "$GITHUB_OUTPUT"

      - name: Run TTNN Pytests - ${{ matrix.test-group.name }}
        run: |
          # Run pytest with parallel execution and skip list
          ${{ matrix.test-group.cmd }} -n 4 ${{ steps.skip-list.outputs.skip_args }}

  ttsim-cpp-unit-tests:
    if: ${{ inputs.run-metal-cpp-unit-tests }}
    runs-on: tt-ubuntu-2204-small-stable
    timeout-minutes: ${{ inputs.job-timeout }}
    name: "TTSim C++ tests - ${{ matrix.arch }}"
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: wormhole_b0
            build_suffix: release_wh
            soc_desc: wormhole_b0_80_arch.yaml
          - arch: blackhole
            build_suffix: release_bh
            soc_desc: blackhole_140_arch.yaml
    container:
      image: harbor.ci.tenstorrent.net/${{ inputs.test-docker-image || 'docker-image-unresolved!'}}
      volumes:
        - ${{ github.workspace }}:/work
    defaults:
      run:
        shell: bash
        working-directory: /work # https://github.com/actions/runner/issues/878
    env:
      TT_METAL_SIMULATOR_HOME: /work/sim
      TT_METAL_SIMULATOR: /work/sim/libttsim.so
      TT_METAL_SLOW_DISPATCH_MODE: 1
    steps:
      - name: ðŸ§¬ Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Setup Job
        uses: ./.github/actions/setup-job
        timeout-minutes: 10
        with:
          path: .
          build-artifact-name: ${{ inputs.build-artifact-name }}
          wheel-artifact-name: ${{ inputs.wheel-artifact-name }}

      - name: Compute ttsim asset name
        id: ttsim-asset
        run: |
          asset_suffix="${{ matrix.build_suffix }}"
          asset_suffix="${asset_suffix#release_}"
          echo "asset_name=libttsim_${asset_suffix}.so" >> "$GITHUB_OUTPUT"

      - name: Download ttsim binary
        uses: robinraju/release-downloader@daf26c55d821e836577a15f77d86ddc078948b05 # v1.12
        with:
          repository: tenstorrent/ttsim
          tag: ${{ inputs.ttsim-version }}
          fileName: ${{ steps.ttsim-asset.outputs.asset_name }}
          out-file-path: /tmp/ttsim

      - name: Install ttsim
        run: |
          set -euo pipefail
          mkdir -p $TT_METAL_SIMULATOR_HOME
          mv /tmp/ttsim/${{ steps.ttsim-asset.outputs.asset_name }} $TT_METAL_SIMULATOR_HOME/libttsim.so
          cp /work/tt_metal/soc_descriptors/${{ matrix.soc_desc }} $TT_METAL_SIMULATOR_HOME/soc_descriptor.yaml

      - name: C++ tests
        timeout-minutes: 5
        run: |
          if [[ "${{ matrix.arch }}" == "quasar" ]]; then
            # ToDo: Re-enable this test once tt-sim supports NOC
            # GH issue for tt-sim NOC support: https://github.com/tenstorrent/ttsim/issues/24
            # ./build/test/tt_metal/test_single_dm_l1_write
            :
          else
            ./build/test/tt_metal/unit_tests_api --gtest_filter="MeshDeviceFixture.IdleEthTestNocStreamRegs"
            ./build/test/tt_metal/unit_tests_api --gtest_filter="MeshDispatchFixture.IdleEthDRAMLoopbackSingleCore"
            ./build/test/tt_metal/unit_tests_debug_tools --gtest_filter="DPrintMeshFixture.IdleEthTestPrint"
            # WH works (very long test, by default for erisc runs at least 0x5f5e1000U cycles)
            # ./build/test/tt_metal/unit_tests_debug_tools --gtest_filter="MeshWatcherFixture.TensixTestWatcherPause"
            ./build/test/tt_metal/unit_tests_debug_tools --gtest_filter="*WatcherRingBuffer*/IErisc"
            ./build/test/tt_metal/unit_tests_debug_tools --gtest_filter="MeshWatcherFixture.TestWatcherStackUsage0"
            ./build/test/tt_metal/unit_tests_debug_tools --gtest_filter="MeshWatcherFixture.TestWatcherStackUsage16"
            ./build/test/tt_metal/unit_tests_dispatch --gtest_filter="MeshDispatchFixture.TensixIdleEthTestSemaphores"
            ./build/test/tt_metal/unit_tests_dispatch --gtest_filter="MeshDispatchFixture.EthTestBlank"
            ./build/test/tt_metal/unit_tests_eth --gtest_filter="BlackholeSingleCardFixture.IdleEthKernelOnIdleErisc0"
            ./build/test/tt_metal/unit_tests_eth --gtest_filter="BlackholeSingleCardFixture.IdleEthKernelOnIdleErisc1"
            ./build/test/tt_metal/unit_tests_eth --gtest_filter="BlackholeSingleCardFixture.IdleEthKernelOnBothIdleEriscs"
          fi
  ttsim-galaxy-cpp-unit-tests:
    if: ${{ inputs.run-metal-cpp-unit-tests }}
    runs-on: tt-ubuntu-2204-large-stable
    timeout-minutes: ${{ inputs.job-timeout }}
    name: "TTSim Galaxy C++ tests - ${{ matrix.arch }}"
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: wormhole_b0
            build_suffix: release_wh
            cluster_desc: tests/tt_metal/tt_fabric/custom_mock_cluster_descriptors/6u_cluster_desc.yaml
            soc_desc: wormhole_b0_80_arch.yaml
          - arch: blackhole
            build_suffix: release_bh
            cluster_desc: tests/tt_metal/tt_fabric/custom_mock_cluster_descriptors/bh_6u_cluster_desc.yaml
            soc_desc: blackhole_140_arch.yaml
    container:
      image: harbor.ci.tenstorrent.net/${{ inputs.test-docker-image || 'docker-image-unresolved!'}}
      volumes:
        - ${{ github.workspace }}:/work
    defaults:
      run:
        shell: bash
        working-directory: /work # https://github.com/actions/runner/issues/878
    env:
      TT_METAL_SIMULATOR_HOME: /work/sim
      TT_METAL_SIMULATOR: /work/sim/libttsim.so
      TT_METAL_SLOW_DISPATCH_MODE: 1
      TT_METAL_MOCK_CLUSTER_DESC_PATH: ${{ matrix.cluster_desc }}
    steps:
      - name: ðŸ§¬ Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Setup Job
        uses: ./.github/actions/setup-job
        timeout-minutes: 10
        with:
          path: .
          build-artifact-name: ${{ inputs.build-artifact-name }}
          wheel-artifact-name: ${{ inputs.wheel-artifact-name }}

      - name: Compute ttsim asset name
        id: ttsim-asset
        run: |
          asset_suffix="${{ matrix.build_suffix }}"
          asset_suffix="${asset_suffix#release_}"
          echo "asset_name=libttsim_${asset_suffix}.so" >> "$GITHUB_OUTPUT"

      - name: Download ttsim binary
        uses: robinraju/release-downloader@daf26c55d821e836577a15f77d86ddc078948b05 # v1.12
        with:
          repository: tenstorrent/ttsim
          tag: ${{ inputs.ttsim-version }}
          fileName: ${{ steps.ttsim-asset.outputs.asset_name }}
          out-file-path: /tmp/ttsim

      - name: Install ttsim
        run: |
          set -euo pipefail
          mkdir -p $TT_METAL_SIMULATOR_HOME
          mv /tmp/ttsim/${{ steps.ttsim-asset.outputs.asset_name }} $TT_METAL_SIMULATOR_HOME/libttsim.so
          cp /work/tt_metal/soc_descriptors/${{ matrix.soc_desc }} $TT_METAL_SIMULATOR_HOME/soc_descriptor.yaml

      - name: C++ tests
        timeout-minutes: 5
        run: |
          ./build/test/tt_metal/unit_tests_api --gtest_filter="*StreamRegWrite*"
          ./build/test/tt_metal/unit_tests_api --gtest_filter="*InlineWrite*"
