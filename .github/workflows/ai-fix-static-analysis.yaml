name: "AI-Assisted Static Analysis Fixes"

# This workflow runs static analysis, then uses Claude to automatically
# generate fixes for violations, creating a PR with the changes.
#
# Inspired by the workflow used to create PRs like:
# - https://github.com/tenstorrent/tt-metal/pull/35888
# - https://github.com/tenstorrent/tt-metal/pull/35802

on:
  # Manual trigger with customizable options
  workflow_dispatch:
    inputs:
      check_filter:
        description: "Only fix diagnostics matching this check name (e.g., 'bugprone', 'modernize')"
        required: false
        type: string
        default: ""
      file_filter:
        description: "Only fix files matching this path pattern (e.g., 'ttnn/', 'tt_metal/')"
        required: false
        type: string
        default: ""
      max_files:
        description: "Maximum number of files to process"
        required: false
        type: number
        default: 20
      model:
        description: "Claude model to use"
        required: false
        type: choice
        options:
          - sonnet
          - opus
        default: sonnet
      create_pr:
        description: "Create a pull request with the fixes"
        required: false
        type: boolean
        default: true
      base_branch:
        description: "Base branch for the PR"
        required: false
        type: string
        default: "main"

  # Can also be called from other workflows
  workflow_call:
    inputs:
      check_filter:
        required: false
        type: string
        default: ""
      file_filter:
        required: false
        type: string
        default: ""
      max_files:
        required: false
        type: number
        default: 20
      model:
        required: false
        type: string
        default: "sonnet"
      create_pr:
        required: false
        type: boolean
        default: true
      base_branch:
        required: false
        type: string
        default: "main"
    secrets:
      ANTHROPIC_API_KEY:
        required: true

jobs:
  ai-fix-violations:
    name: ðŸ¤– AI Fix Static Analysis Violations
    runs-on: tt-ubuntu-2204-xlarge-stable
    # Only run on main repo, not forks (they won't have the API key)
    if: ${{ github.repository == 'tenstorrent/tt-metal' }}

    permissions:
      contents: write
      pull-requests: write

    env:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

    steps:
      - name: Check API Key
        run: |
          if [ -z "${{ secrets.ANTHROPIC_API_KEY }}" ]; then
            echo "::error::ANTHROPIC_API_KEY secret is not set"
            exit 1
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.base_branch || 'main' }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          pip install pyyaml

      - name: Install Claude Code CLI
        run: |
          # Install Claude Code CLI
          # Note: This assumes Claude Code is available via npm or direct download
          # Adjust based on actual installation method
          npm install -g @anthropic-ai/claude-code || {
            echo "::warning::Claude Code CLI not available via npm, trying alternative..."
            # Alternative: use the Anthropic API directly via Python
            pip install anthropic
          }

      - name: Install clang-tidy
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-tidy-20 || sudo apt-get install -y clang-tidy

      - name: Configure CMake
        run: |
          cmake --preset clang-tidy-fix-parallel

      - name: Generate compile_commands.json
        run: |
          # Ensure compile_commands.json exists
          cmake --build .build/clang-tidy-fix-parallel --target all_generated_files || true

      - name: Run clang-tidy and collect fixes
        id: collect-fixes
        run: |
          set -x

          FIXES_DIR=".build/clang-tidy-fix-parallel/fixes"
          mkdir -p "$FIXES_DIR"

          # Run clang-tidy with fix export
          # Using -k0 to continue on errors
          cmake --build --preset clang-tidy-fix-parallel -- -k0 2>&1 | tee clang-tidy.log || true

          # Count fixes
          FIX_COUNT=$(find "$FIXES_DIR" -name "*.yaml" 2>/dev/null | wc -l)
          echo "fix_count=$FIX_COUNT" >> $GITHUB_OUTPUT
          echo "Found $FIX_COUNT fix files"

          if [ "$FIX_COUNT" -eq 0 ]; then
            echo "No fixes to process"
            echo "has_fixes=false" >> $GITHUB_OUTPUT
          else
            echo "has_fixes=true" >> $GITHUB_OUTPUT
          fi

      - name: Generate AI fix prompts
        if: steps.collect-fixes.outputs.has_fixes == 'true'
        run: |
          # Collect all YAML fix files
          YAML_FILES=$(find .build/clang-tidy-fix-parallel/fixes -name "*.yaml" 2>/dev/null | head -100)

          if [ -z "$YAML_FILES" ]; then
            echo "No YAML files found"
            exit 0
          fi

          # Build arguments
          ARGS="--clang-tidy-fixes $YAML_FILES"
          ARGS="$ARGS --output-dir .ai-fixes"
          ARGS="$ARGS --max-files ${{ inputs.max_files || 20 }}"

          if [ -n "${{ inputs.check_filter }}" ]; then
            ARGS="$ARGS --check-filter '${{ inputs.check_filter }}'"
          fi

          if [ -n "${{ inputs.file_filter }}" ]; then
            ARGS="$ARGS --file-filter '${{ inputs.file_filter }}'"
          fi

          # Generate prompts
          python3 scripts/ai_fix_static_analysis.py $ARGS

      - name: Apply AI fixes using Claude
        if: steps.collect-fixes.outputs.has_fixes == 'true'
        env:
          CLAUDE_MODEL: ${{ inputs.model == 'opus' && 'claude-opus-4-5-20260117' || 'claude-sonnet-4-5-20260117' }}
        run: |
          # Process each prompt file with Claude API
          # This uses the Anthropic Python SDK directly for CI environments

          python3 << 'PYTHON_SCRIPT'
          import json
          import os
          import sys
          from pathlib import Path

          try:
              import anthropic
          except ImportError:
              print("Installing anthropic...")
              import subprocess
              subprocess.check_call([sys.executable, "-m", "pip", "install", "anthropic"])
              import anthropic

          def extract_code_block(response: str) -> str:
              """Extract code from markdown code block."""
              lines = response.split("\n")
              in_block = False
              code_lines = []

              for line in lines:
                  if line.startswith("```"):
                      if not in_block:
                          in_block = True
                          continue
                      else:
                          break
                  elif in_block:
                      code_lines.append(line)

              return "\n".join(code_lines) if code_lines else response

          def process_prompt(client, prompt_file: Path, model: str) -> dict:
              """Process a single prompt file with Claude."""
              prompt = prompt_file.read_text()

              # Extract source file path from prompt
              source_file = None
              for line in prompt.split("\n"):
                  if line.startswith("**File:**") or "Fix the following" in line:
                      # Try to extract file path
                      import re
                      match = re.search(r'`([^`]+\.(cpp|hpp|h|cc|cxx))`', line)
                      if match:
                          source_file = match.group(1)
                          break

              if not source_file:
                  # Try manifest
                  manifest_file = prompt_file.parent / "manifest.json"
                  if manifest_file.exists():
                      manifest = json.loads(manifest_file.read_text())
                      for entry in manifest:
                          if entry["prompt_file"] == str(prompt_file):
                              source_file = entry["source_file"]
                              break

              if not source_file:
                  print(f"  Could not determine source file for {prompt_file}")
                  return {"success": False, "error": "no source file"}

              print(f"  Processing: {source_file}")

              try:
                  response = client.messages.create(
                      model=model,
                      max_tokens=8192,
                      messages=[
                          {
                              "role": "user",
                              "content": prompt
                          }
                      ]
                  )

                  content = response.content[0].text
                  fixed_code = extract_code_block(content)

                  if fixed_code and Path(source_file).exists():
                      Path(source_file).write_text(fixed_code)
                      return {"success": True, "file": source_file}
                  else:
                      return {"success": False, "error": "no code extracted or file not found"}

              except Exception as e:
                  print(f"  Error: {e}")
                  return {"success": False, "error": str(e)}

          def main():
              api_key = os.environ.get("ANTHROPIC_API_KEY")
              if not api_key:
                  print("ANTHROPIC_API_KEY not set")
                  sys.exit(1)

              model = os.environ.get("CLAUDE_MODEL", "claude-sonnet-4-5-20260117")
              print(f"Using model: {model}")

              client = anthropic.Anthropic(api_key=api_key)

              fixes_dir = Path(".ai-fixes")
              if not fixes_dir.exists():
                  print("No .ai-fixes directory found")
                  sys.exit(0)

              prompt_files = list(fixes_dir.glob("*.prompt.md"))
              print(f"Found {len(prompt_files)} prompt files")

              results = {"success": [], "failed": []}

              for prompt_file in prompt_files:
                  result = process_prompt(client, prompt_file, model)
                  if result.get("success"):
                      results["success"].append(result.get("file"))
                  else:
                      results["failed"].append(prompt_file.name)

              print(f"\nResults: {len(results['success'])} fixed, {len(results['failed'])} failed")

              # Write results for later steps
              Path(".ai-fix-results.json").write_text(json.dumps(results, indent=2))

          if __name__ == "__main__":
              main()
          PYTHON_SCRIPT

      - name: Create branch and commit fixes
        if: steps.collect-fixes.outputs.has_fixes == 'true'
        id: commit
        run: |
          # Check if there are any changes
          if git diff --quiet; then
            echo "No changes to commit"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "has_changes=true" >> $GITHUB_OUTPUT

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create branch name
          BRANCH_NAME="ai-fix/static-analysis-$(date +%Y%m%d-%H%M%S)"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

          git checkout -b "$BRANCH_NAME"

          # Determine what was fixed for commit message
          CHECK_FILTER="${{ inputs.check_filter }}"
          FILE_FILTER="${{ inputs.file_filter }}"
          MODEL="${{ inputs.model || 'sonnet' }}"

          COMMIT_MSG="fix(static-analysis): auto-fix clang-tidy violations"

          if [ -n "$CHECK_FILTER" ]; then
            COMMIT_MSG="$COMMIT_MSG matching '$CHECK_FILTER'"
          fi

          if [ -n "$FILE_FILTER" ]; then
            COMMIT_MSG="$COMMIT_MSG in '$FILE_FILTER'"
          fi

          # Add co-author based on model
          if [ "$MODEL" = "opus" ]; then
            CO_AUTHOR="Claude Opus 4.5"
          else
            CO_AUTHOR="Claude Sonnet 4.5"
          fi

          # Stage all changes
          git add -A

          # Commit with co-author
          git commit -m "$COMMIT_MSG

          Auto-generated fixes for static analysis violations.
          Generated by AI-assisted workflow.

          Co-Authored-By: $CO_AUTHOR <noreply@anthropic.com>"

          # Push branch
          git push origin "$BRANCH_NAME"

      - name: Create Pull Request
        if: steps.commit.outputs.has_changes == 'true' && (inputs.create_pr == true || inputs.create_pr == '')
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ steps.commit.outputs.branch_name }}
          base: ${{ inputs.base_branch || 'main' }}
          title: "fix(static-analysis): AI-assisted clang-tidy fixes"
          body: |
            ## Summary

            This PR contains auto-generated fixes for static analysis violations detected by clang-tidy.

            ### Configuration
            - **Model:** ${{ inputs.model || 'sonnet' }}
            - **Check filter:** ${{ inputs.check_filter || 'all' }}
            - **File filter:** ${{ inputs.file_filter || 'all' }}
            - **Max files:** ${{ inputs.max_files || 20 }}

            ### Generated by
            This PR was created by the AI-Assisted Static Analysis workflow using Claude ${{ inputs.model == 'opus' && 'Opus 4.5' || 'Sonnet 4.5' }}.

            ### Review Notes
            - [ ] Verify all fixes are correct and don't change behavior
            - [ ] Ensure no new warnings are introduced
            - [ ] Check that tests pass

            ---
            Co-Authored-By: Claude ${{ inputs.model == 'opus' && 'Opus 4.5' || 'Sonnet 4.5' }} <noreply@anthropic.com>
          labels: |
            ai-generated
            static-analysis
            automated-pr
          draft: true

      - name: Upload fix results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ai-fix-results
          path: |
            .ai-fixes/
            .ai-fix-results.json
            clang-tidy.log
          retention-days: 7

      - name: Summary
        if: always()
        run: |
          echo "## AI Fix Static Analysis Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f ".ai-fix-results.json" ]; then
            echo "### Results" >> $GITHUB_STEP_SUMMARY
            cat .ai-fix-results.json >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.commit.outputs.has_changes }}" = "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Pull Request Created" >> $GITHUB_STEP_SUMMARY
            echo "Branch: \`${{ steps.commit.outputs.branch_name }}\`" >> $GITHUB_STEP_SUMMARY
          fi
