name: Multi-Host Deployment
on:
  push:
    branches:
      - akirby/multi-host-workflow
  workflow_dispatch:
    inputs:
      configuration:
        description: 'Virtual environment configuration'
        required: true
        default: "2"
        type: choice
        options:
          - "1"
          - "2"
          - "4"

jobs:
  deploy:
    runs-on:
      - multi-host
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Generate the rankfile
        run: ./generate-rankfile.sh "4"

      - name: Run tt-smi via mpirun command
        env:
          VIRTUAL_CONFIG: "4"
        run: |
          echo "Running mpirun command on multiple hosts"
          mpirun --rankfile rankfile --tag-output ./docker-wrapper.sh tt-smi -ls
