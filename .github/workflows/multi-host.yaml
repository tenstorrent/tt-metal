name: Multi-Host Deployment
on:
  push:
    branches:
      - akirby/multi-host-workflow
  workflow_dispatch:
    inputs:
      configuration:
        description: 'Virtual environment configuration'
        required: true
        default: "2"
        type: choice
        options:
          - "1"
          - "2"
          - "4"

jobs:
  deploy:
    runs-on:
      - multi-host
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Generate the rankfile
        run: ./generate-rankfile.sh "4"

      - name: Run tt-smi via mpirun command
        env:
          VIRTUAL_CONFIG: "4"
        run: |
          echo "Running mpirun command on multiple hosts"
          cat rankfile
          wc -l rankfile
          mpirun --rankfile rankfile --tag-output ./docker-wrapper.sh tt-smi -ls

      - name: Compile mpi allreduce test
        run: |
          docker run -v ./:/data ghcr.io/tenstorrent/tt-metal/tt-metalium/ubuntu-22.04-dev-amd64 bash -c "cd /data; apt update && apt install -y libopenmpi-dev; mpicc mpi.c"
      
      - name: Run mpi allreduce test outside docker
        run: |
          mpirun --rankfile rankfile --tag-output ./a.out
      
      - name: Run mpi allreduce test inside docker
        env:
          VIRTUAL_CONFIG: "4"
        run: |
          mpirun --rankfile rankfile --tag-output ./docker-wrapper.sh ./a.out
