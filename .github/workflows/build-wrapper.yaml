name: "Build TT-Metalium across all configs"

on:
  workflow_call:
    inputs:
      # Pre-built Docker image tags (optional - if provided, skips docker build)
      ubuntu-2204-ci-build-tag:
        required: false
        type: string
        default: ""
      ubuntu-2204-dev-tag:
        required: false
        type: string
        default: ""
      ubuntu-2204-manylinux-tag:
        required: false
        type: string
        default: ""
      ubuntu-2404-ci-build-tag:
        required: false
        type: string
        default: ""
      ubuntu-2404-dev-tag:
        required: false
        type: string
        default: ""
      ubuntu-2404-manylinux-tag:
        required: false
        type: string
        default: ""
      fedora-43-ci-build-tag:
        required: false
        type: string
        default: ""
      fedora-43-dev-tag:
        required: false
        type: string
        default: ""
  workflow_dispatch:
    inputs:
      platform:
        required: false
        type: choice
        default: "Ubuntu 22.04"
        options:
          - "Ubuntu 22.04"
          - "Ubuntu 24.04"
          - "Fedora 43"
        description: "Platform to build for"

permissions:
  packages: write

jobs:
  # parse-platform and build-dispatch are for direct workflow_dispatch calls
  # They only run if NO pre-built docker image tags were provided (i.e., not called from merge-gate)
  parse-platform:
    if: ${{ inputs.ubuntu-2204-ci-build-tag == '' && inputs.platform != '' }}
    runs-on: ubuntu-latest
    outputs:
      distro: ${{ steps.parse.outputs.distro }}
      version: ${{ steps.parse.outputs.version }}
      toolchain: ${{ steps.parse.outputs.toolchain }}
      enable-lto: ${{ steps.parse.outputs.enable-lto }}
    steps:
      - id: parse
        run: |
          case "${{ inputs.platform }}" in
            "Ubuntu 22.04")
              echo "distro=ubuntu" >> "$GITHUB_OUTPUT"
              echo "version=22.04" >> "$GITHUB_OUTPUT"
              echo "toolchain=cmake/x86_64-linux-clang-17-libstdcpp-toolchain.cmake" >> "$GITHUB_OUTPUT"
              echo "enable-lto=false" >> "$GITHUB_OUTPUT"
              ;;
            "Ubuntu 24.04")
              echo "distro=ubuntu" >> "$GITHUB_OUTPUT"
              echo "version=24.04" >> "$GITHUB_OUTPUT"
              echo "toolchain=cmake/x86_64-linux-clang-17-libstdcpp-toolchain.cmake" >> "$GITHUB_OUTPUT"
              echo "enable-lto=true" >> "$GITHUB_OUTPUT"
              ;;
            "Fedora 43")
              echo "distro=fedora" >> "$GITHUB_OUTPUT"
              echo "version=43" >> "$GITHUB_OUTPUT"
              echo "toolchain=cmake/x86_64-linux-clang-21-libstdcpp-toolchain.cmake" >> "$GITHUB_OUTPUT"
              echo "enable-lto=true" >> "$GITHUB_OUTPUT"
              ;;
          esac

  build-dispatch:
    if: ${{ inputs.ubuntu-2204-ci-build-tag == '' && inputs.platform != '' }}
    needs: parse-platform
    uses: ./.github/workflows/build-artifact.yaml
    permissions:
      packages: write
    secrets: inherit
    with:
      distro: ${{ needs.parse-platform.outputs.distro }}
      version: ${{ needs.parse-platform.outputs.version }}
      toolchain: ${{ needs.parse-platform.outputs.toolchain }}
      build-type: "Release"
      enable-lto: ${{ needs.parse-platform.outputs.enable-lto == 'true' }}
      publish-artifact: false
      publish-package: false
      skip-tt-train: true
      tracy: false

  # build job runs the matrix - either when called from merge-gate with pre-built tags,
  # or when called via workflow_call without the platform dropdown
  build:
    if: ${{ inputs.ubuntu-2204-ci-build-tag != '' || inputs.platform == '' }}
    uses: ./.github/workflows/build-artifact.yaml
    permissions:
      packages: write
    secrets: inherit
    strategy:
      fail-fast: false
      matrix:
        config:
          - version: "22.04"
            toolchain: "cmake/x86_64-linux-clang-17-libstdcpp-toolchain.cmake"
            build-type: "Debug"
          - version: "22.04"
            toolchain: "cmake/x86_64-linux-clang-17-libcpp-toolchain.cmake"
            build-type: "Release"
          - version: "22.04"
            toolchain: "cmake/x86_64-linux-gcc-12-toolchain.cmake"
            build-type: "Release"
          - version: "24.04"
            toolchain: "cmake/x86_64-linux-clang-17-libstdcpp-toolchain.cmake"
            build-type: "Release"
            enable-lto: true
          - version: "24.04"
            toolchain: "cmake/x86_64-linux-gcc-14-toolchain.cmake"
            build-type: "Release"
          - distro: "fedora"
            version: "43"
            toolchain: "cmake/x86_64-linux-clang-21-libstdcpp-toolchain.cmake"
            build-type: "Release"
            enable-lto: true
    with:
      distro: ${{ matrix.config.distro || 'ubuntu' }}
      version: ${{ matrix.config.version }}
      toolchain: ${{ matrix.config.toolchain }}
      build-type: ${{ matrix.config.build-type }}
      enable-lto: ${{ matrix.config.enable-lto || false }}
      publish-artifact: false
      publish-package: false
      skip-tt-train: true
      tracy: false
      # Pass pre-built docker image tags based on distro/version
      ci-build-docker-image: ${{ matrix.config.distro == 'fedora' && inputs.fedora-43-ci-build-tag || (matrix.config.version == '24.04' && inputs.ubuntu-2404-ci-build-tag || inputs.ubuntu-2204-ci-build-tag) }}
      dev-docker-image: ${{ matrix.config.distro == 'fedora' && inputs.fedora-43-dev-tag || (matrix.config.version == '24.04' && inputs.ubuntu-2404-dev-tag || inputs.ubuntu-2204-dev-tag) }}
      manylinux-docker-image: ${{ matrix.config.version == '24.04' && inputs.ubuntu-2404-manylinux-tag || inputs.ubuntu-2204-manylinux-tag }}
