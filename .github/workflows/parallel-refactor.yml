name: Parallel Refactoring - Device Operations

on:
  workflow_dispatch:
    secrets:
      AY_KEY:
        required: true
      AI_GH_TOKEN:
        required: true

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: ðŸ§¬ Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Generate Matrix from batch_mapping.json
        id: set-matrix
        run: |
          if [ ! -f batch_mapping.json ]; then
            echo "Error: batch_mapping.json not found. Run codegen_tools/partition_ops.py first."
            exit 1
          fi

          # Create nested matrix: one entry per file with batch_id and file_path
          # This will create a job per file (N jobs per batch)
          # We need to capture batch_id in a variable before iterating over files
          MATRIX=$(jq -c '[range(.batch_id | length) as $i | .batch_id[$i] as $batch_id | .files[$i][] | {batch_id: $batch_id, file_path: .}]' batch_mapping.json)

          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          echo "Generated matrix with $(echo "$MATRIX" | jq '. | length') file jobs"

  refactor-file:
    needs: generate-matrix
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
    permissions:
      contents: write
      pull-requests: write
      id-token: write
    uses: ./.github/workflows/refactor-single-file.yml
    secrets: inherit
    with:
      file_path: ${{ matrix.file_path }}
      batch_id: ${{ matrix.batch_id }}
      base_branch: main
      branch_name: refactor/batch-${{ matrix.batch_id }}
