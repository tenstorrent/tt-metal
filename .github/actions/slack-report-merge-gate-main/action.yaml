name: "Report Workflow Status to Slack"
description: "Report the workflow status to Slack to help identify breakages faster."
inputs:
  owner:
    description: "The Slack ID of the person or group to be tagged (user IDs start with U, group IDs start with S)."
    default: "U014XCQ9CF8" # @Raymond Kim
  slack_webhook_url:
    description: "Webhook URL for the Slack channel to be posted to. Generated via slack app!"
    required: true
runs:
  using: "composite"
  steps:
    - name: Format Slack User Mentions
      id: format_mentions
      run: |
        # Split comma-separated IDs and format each appropriately
        # User IDs (U...) use <@U...>, Group IDs (S...) use <!subteam^S...>
        MENTIONS=""
        IFS=',' read -ra IDS <<< "${{ inputs.owner }}"
        for ID in "${IDS[@]}"; do
          ID=$(echo "$ID" | xargs)  # trim whitespace
          [[ -z "$ID" ]] && continue  # skip empty IDs
          if [[ "$ID" =~ ^S ]]; then
            # Group/subteam ID
            MENTIONS="${MENTIONS}<!subteam^${ID}> "
          else
            # User ID
            MENTIONS="${MENTIONS}<@${ID}> "
          fi
        done
        MENTIONS=$(echo "$MENTIONS" | sed 's/[[:space:]]*$//')  # trim trailing space
        echo "mentions=$MENTIONS" >> $GITHUB_OUTPUT
      shell: bash
    - name: Report Github Pipeline Status Slack Action
      uses: slackapi/slack-github-action@v1.26.0
      with:
        payload: |
          {
            "text": "${{ steps.format_mentions.outputs.mentions }} ðŸš¨ALERTðŸš¨ ðŸš¨ALERTðŸš¨ ðŸš¨ALERTðŸš¨ ${{ github.workflow }} IS FAILING ON MAIN ðŸ™€: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }} \nfailing commit: https://github.com/tenstorrent/tt-metal/commit/${{ github.sha }}"
          }
      env:
        SLACK_WEBHOOK_URL: ${{ inputs.slack_webhook_url }}
