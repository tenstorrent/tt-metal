name: "Report Workflow Status to Slack"
description: "Report the workflow status to Slack to help identify breakages faster."
inputs:
  slack_webhook_url:
    description: "Webhook URL for the Slack channel to be posted to. Generated via slack app!"
    required: true
  regressed_workflows:
    description: "JSON array from analyze step output 'regressed_workflows'"
    required: true
runs:
  using: "composite"
  steps:
    - name: Build Slack message from regressions
      id: build
      shell: bash
      run: |
        set -euo pipefail
        tmp_file="$(mktemp)"
        printf "%s" '${{ inputs.regressed_workflows }}' > "$tmp_file"
        if ! jq -e . "$tmp_file" >/dev/null 2>&1; then
          echo "payload={\"text\":\"Failed to parse regression list\"}" >> "$GITHUB_OUTPUT"
          exit 0
        fi
        TEXT=$(jq -r '
          if (type=="array" and length==0) then
            "No new regressions."
          elif (type=="array") then
            "Regressions (Pass → Fail):\n" + (map("- " + .name + " — <" + (.run_url // "") + "|run> (" + (.created_at // "") + ")") | join("\n"))
          else
            "Malformed regressions payload"
          end' "$tmp_file")
        PAYLOAD=$(jq -n --arg text "$TEXT" '{text:$text}')
        echo "payload=$PAYLOAD" >> "$GITHUB_OUTPUT"
    - name: Report Github Pipeline Status Slack Action
      uses: slackapi/slack-github-action@v1.26.0
      with:
        payload: ${{ steps.build.outputs.payload }}
      env:
        SLACK_WEBHOOK_URL: ${{ inputs.slack_webhook_url }}
