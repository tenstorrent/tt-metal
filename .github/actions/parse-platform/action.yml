name: 'Parse Platform'
description: 'Parses platform dropdown (e.g., "Ubuntu 22.04") into distro, version, and toolchain'

inputs:
  platform:
    description: 'Platform string (e.g., "Ubuntu 22.04", "Ubuntu 24.04", "Fedora 43")'
    required: false
    default: ''
  distro:
    description: 'Direct distro input (used when platform is not set)'
    required: false
    default: ''
  version:
    description: 'Direct version input (used when platform is not set)'
    required: false
    default: ''
  default-distro:
    description: 'Default distro if neither platform nor distro is set'
    required: false
    default: 'ubuntu'
  default-version:
    description: 'Default version if neither platform nor version is set'
    required: false
    default: '22.04'

outputs:
  distro:
    description: 'Parsed distribution (ubuntu, fedora)'
    value: ${{ steps.parse.outputs.distro }}
  version:
    description: 'Parsed version (22.04, 24.04, 43)'
    value: ${{ steps.parse.outputs.version }}
  toolchain:
    description: 'Appropriate toolchain for the platform'
    value: ${{ steps.parse.outputs.toolchain }}
  enable-lto:
    description: 'Whether LTO should be enabled for this platform'
    value: ${{ steps.parse.outputs.enable-lto }}

runs:
  using: 'composite'
  steps:
    - id: parse
      shell: bash
      run: |
        # Parse platform dropdown if provided, otherwise use direct inputs or defaults
        if [ -n "${{ inputs.platform }}" ]; then
          case "${{ inputs.platform }}" in
            "Ubuntu 22.04")
              echo "distro=ubuntu" >> "$GITHUB_OUTPUT"
              echo "version=22.04" >> "$GITHUB_OUTPUT"
              echo "toolchain=cmake/x86_64-linux-clang-17-libstdcpp-toolchain.cmake" >> "$GITHUB_OUTPUT"
              echo "enable-lto=false" >> "$GITHUB_OUTPUT"
              ;;
            "Ubuntu 24.04")
              echo "distro=ubuntu" >> "$GITHUB_OUTPUT"
              echo "version=24.04" >> "$GITHUB_OUTPUT"
              echo "toolchain=cmake/x86_64-linux-clang-17-libstdcpp-toolchain.cmake" >> "$GITHUB_OUTPUT"
              echo "enable-lto=true" >> "$GITHUB_OUTPUT"
              ;;
            "Fedora 43")
              echo "distro=fedora" >> "$GITHUB_OUTPUT"
              echo "version=43" >> "$GITHUB_OUTPUT"
              echo "toolchain=cmake/x86_64-linux-clang-21-libstdcpp-toolchain.cmake" >> "$GITHUB_OUTPUT"
              echo "enable-lto=true" >> "$GITHUB_OUTPUT"
              ;;
            *)
              # Unknown platform, use defaults
              echo "distro=${{ inputs.default-distro }}" >> "$GITHUB_OUTPUT"
              echo "version=${{ inputs.default-version }}" >> "$GITHUB_OUTPUT"
              echo "toolchain=cmake/x86_64-linux-clang-17-libstdcpp-toolchain.cmake" >> "$GITHUB_OUTPUT"
              echo "enable-lto=false" >> "$GITHUB_OUTPUT"
              ;;
          esac
        else
          # No platform dropdown, use direct inputs or defaults
          DISTRO="${{ inputs.distro }}"
          VERSION="${{ inputs.version }}"
          [ -z "$DISTRO" ] && DISTRO="${{ inputs.default-distro }}"
          [ -z "$VERSION" ] && VERSION="${{ inputs.default-version }}"

          echo "distro=$DISTRO" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

          # Determine toolchain based on distro
          if [ "$DISTRO" = "fedora" ]; then
            echo "toolchain=cmake/x86_64-linux-clang-21-libstdcpp-toolchain.cmake" >> "$GITHUB_OUTPUT"
            echo "enable-lto=true" >> "$GITHUB_OUTPUT"
          elif [ "$VERSION" = "24.04" ]; then
            echo "toolchain=cmake/x86_64-linux-clang-17-libstdcpp-toolchain.cmake" >> "$GITHUB_OUTPUT"
            echo "enable-lto=true" >> "$GITHUB_OUTPUT"
          else
            echo "toolchain=cmake/x86_64-linux-clang-17-libstdcpp-toolchain.cmake" >> "$GITHUB_OUTPUT"
            echo "enable-lto=false" >> "$GITHUB_OUTPUT"
          fi
        fi
