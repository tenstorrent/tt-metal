name: Setup Job
description: Common setup steps for workflows
inputs:
  build-artifact-name:
    required: false
    description: Name of the build artifact
    default: ''
  wheel-artifact-name:
    required: false
    description: Name of the wheel artifact
    default: ''
  path:
    required: false
    description: Where to checkout
    default: docker-job
  enable-watcher:
    description: 'Enable watcher'
    default: false
    type: boolean
  enable-lightweight-kernel-asserts:
    description: 'Enable lightweight kernel asserts'
    default: false
    type: boolean
  enable-llk-asserts:
    description: 'Enable LLK asserts'
    default: false
    type: boolean
  use-evaluation-image:
    description: 'Skip download and installation of build artifacts and wheel as theyre pre-installed in evaluation image'
    default: false
    type: boolean
  auto-triage:
    description: 'Enable detection of timeout on fast dispatch and automatically call tt-triage'
    default: true
    type: boolean
  slow-dispatch-timeout:
    description: 'Timeout in seconds to consider a dispatch as slow for auto-triage'
    default: 60.0
    type: float
runs:
  using: "composite"
  steps:
    - name: ðŸ§ª Check Required Tools
      run: |
        echo "ðŸ” Verifying tools..."
        command -v tar >/dev/null 2>&1 && tar --version || { echo "âŒ tar not found"; exit 1; }
        command -v uv >/dev/null 2>&1 && uv --version || { echo "âŒ uv not found"; exit 1; }
      shell: bash

    - name: ðŸ“¦ Download Build Artifact
      if: ${{ inputs.build-artifact-name != '' && inputs.use-evaluation-image == 'false' }}
      uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0
      with:
        name: ${{ inputs.build-artifact-name }}
        path: ${{ inputs.path }}

    - name: ðŸ“‚ Extract Build Files
      if: ${{ inputs.build-artifact-name != '' && inputs.use-evaluation-image == 'false' }}
      working-directory: ${{ inputs.path }}
      run: tar --zstd -xf ttm_any.tar.zst
      shell: bash

    - name: ðŸ§ª Download Python Wheel
      if: ${{ inputs.wheel-artifact-name != '' && inputs.use-evaluation-image == 'false' }}
      uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0
      with:
        name: ${{ inputs.wheel-artifact-name }}
        path: ${{ inputs.path }}

    - name: ðŸ’¿ Install Wheel
      if: ${{ inputs.wheel-artifact-name != '' && inputs.use-evaluation-image == 'false' }}
      working-directory: ${{ inputs.path }}
      run: |
        echo "ðŸ“‚ In directory: $(pwd)"
        echo "ðŸ“„ Files:"
        ls -la
        WHEEL_FILENAME=$(ls -1 *.whl)
        echo "ðŸ“¦ Installing $WHEEL_FILENAME"
        uv pip install "$WHEEL_FILENAME"
      shell: bash

    - name: Set up env vars for watcher
      if: ${{ inputs.enable-watcher == 'true' }}
      working-directory: ${{ inputs.path }}
      run: |
        echo "Enabling TT Metal Watcher"
        echo "TT_METAL_WATCHER=120" >> $GITHUB_ENV
        echo "TT_METAL_WATCHER_APPEND=1" >> $GITHUB_ENV
        echo "TT_METAL_WATCHER_NOINLINE=1" >> $GITHUB_ENV
      shell: bash

    - name: Set up env vars for lightweight kernel asserts
      if: ${{ inputs.enable-lightweight-kernel-asserts == 'true' }}
      working-directory: ${{ inputs.path }}
      run: |
        echo "Enabling TT Metal Lightweight Kernel Asserts"
        echo "TT_METAL_LIGHTWEIGHT_KERNEL_ASSERTS=1" >> $GITHUB_ENV
      shell: bash

    - name: Set up env vars for LLK asserts
      if: ${{ inputs.enable-llk-asserts == 'true' }}
      working-directory: ${{ inputs.path }}
      run: |
        echo "Enabling TT Metal LLK Asserts"
        echo "TT_METAL_LLK_ASSERTS=1" >> $GITHUB_ENV
      shell: bash

    - name: Set up env vars for auto-triage
      if: ${{ inputs.auto-triage == 'true' && inputs.enable-watcher != 'true' }}
      working-directory: ${{ inputs.path }}
      run: |
        echo "Enabling detection of timeout on fast dispatch and automatically call tt-triage"
        echo "TT_METAL_DISPATCH_TIMEOUT_COMMAND_TO_EXECUTE=/opt/venv/bin/python3 $(pwd)/tools/tt-triage.py --disable-progress 1>&2" >> $GITHUB_ENV
        echo "TT_METAL_OPERATION_TIMEOUT_SECONDS=${{ inputs.slow-dispatch-timeout }}" >> $GITHUB_ENV
        echo "TT_RUN_DISABLED_TRIAGE_SCRIPTS_IN_CI=1" >> $GITHUB_ENV
      shell: bash
