name: Set CPU Governor
description: Install cpufrequtils if needed and set CPU governor for all cores
inputs:
  governor:
    required: true
    description: 'CPU governor to set (performance, ondemand, conservative, powersave, userspace, schedutil)'
    default: 'performance'
runs:
  using: "composite"
  steps:
    - name: Check and install cpufrequtils
      run: |
        set -euo pipefail

        # Check if cpufreq-set is already available
        if command -v cpufreq-set >/dev/null 2>&1; then
          echo "✅ cpufrequtils is already installed"
          cpufreq-set --version || echo "cpufreq-set found but version check failed"
        else
          echo "📦 Installing cpufrequtils..."
          apt-get update
          apt-get install -y --no-install-recommends cpufrequtils
          echo "✅ cpufrequtils installed successfully"
        fi

        # Verify installation
        command -v cpufreq-set || { echo "❌ cpufreq-set installation failed"; exit 1; }
      shell: bash

    - name: Set CPU governor to ${{ inputs.governor }}
      run: |
        set -euo pipefail

        governor="${{ inputs.governor }}"
        echo "🔧 Setting CPU governor to: $governor for all cores"

        # Set governor for all CPU cores using -r flag
        if sudo cpufreq-set -r -g "$governor"; then
          echo "✅ Successfully set $governor governor for all CPU cores"
        else
          echo "❌ Failed to set $governor governor"
          exit 1
        fi

        # Verify the setting on a few cores for confirmation
        echo "🔍 Verifying governor settings:"
        for cpu in /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor; do
          if [ -f "$cpu" ]; then
            cpu_num=$(echo "$cpu" | grep -o 'cpu[0-9]*' | grep -o '[0-9]*')
            current_governor=$(cat "$cpu" 2>/dev/null || echo "unknown")
            echo "CPU $cpu_num: $current_governor"
            # Only show first few cores to avoid too much output
            if [ "$cpu_num" -ge 3 ]; then
              break
            fi
          fi
        done
      shell: bash
