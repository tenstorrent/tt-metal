name: Set CPU Governor
description: Install cpufrequtils if needed and set CPU governor for all cores
inputs:
  governor:
    required: true
    description: 'CPU governor to set (performance, ondemand, conservative, powersave, userspace, schedutil)'
    default: 'performance'
runs:
  using: "composite"
  steps:
    - name: Check and install cpufrequtils
      run: |
        set -euxo pipefail

        # Check if cpufreq-set is already available
        if command -v cpufreq-set >/dev/null 2>&1; then
          echo "‚úÖ cpufrequtils is already installed"
          cpufreq-set --version || echo "cpufreq-set found but version check failed"
        else
          echo "üì¶ Installing cpufrequtils..."
          apt-get update
          apt-get install -y --no-install-recommends cpufrequtils
          echo "‚úÖ cpufrequtils installed successfully"
        fi

        # Verify installation
        command -v cpufreq-set || { echo "‚ùå cpufreq-set installation failed"; exit 1; }
      shell: bash

    - name: Set CPU governor to ${{ inputs.governor }}
      run: |
        set -euxo pipefail

        governor="${{ inputs.governor }}"
        cores_set=0
        cores_failed=0

        echo "üîß Setting CPU governor to: $governor"

        # Iterate through all CPU cores
        for cpu in /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor; do
          if [ -f "$cpu" ]; then
            cpu_num=$(echo "$cpu" | grep -o 'cpu[0-9]*' | grep -o '[0-9]*')
            echo "Setting $governor governor for CPU $cpu_num"

            if sudo cpufreq-set -c "$cpu_num" -g "$governor" 2>/dev/null; then
              cores_set=$((cores_set + 1))
            else
              echo "‚ö†Ô∏è  Failed to set governor for CPU $cpu_num"
              cores_failed=$((cores_failed + 1))
            fi
          fi
        done

        echo "‚úÖ Successfully set governor for $cores_set CPU cores"
        if [ $cores_failed -gt 0 ]; then
          echo "‚ö†Ô∏è  Failed to set governor for $cores_failed CPU cores"
        fi
      shell: bash
