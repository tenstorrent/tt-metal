name: "Wrap a bash command with tt-triage"
description: "Wrap a bash command with tt-triage so if it fails or times-out we run tt-triage"
inputs:
  command:
    description: "Command to run"
    required: true
  timeout-seconds:
    description: "Timeout period in seconds for command to complete"
    required: true
runs:
  using: "composite"
  steps:
    - name: "Invoke command with retries"
      shell: bash
      run: |
        set +e

        max_retries="${{ inputs.max-retries }}"
        count=0

        while (( count < max_retries )); do
          echo "Attempt $((count + 1)) of $max_retries..."

          # Execute the command with timeout
          if timeout ${{ inputs.timeout-seconds }} "${{ inputs.command }}"; then
            echo "Command succeeded."
            exit 0
          else
            echo "Command failed or timed out. Backing off..."
            count=$((count + 1))
          fi

          # Optional: Add a delay between retries
          sleep ${{ inputs.backoff-seconds }}
        done

        echo "Command failed after $max_retries attempts."
        exit 1
