name: 'Analyze Workflow Data'
description: 'Analyzes cached workflow run data and generates a report'

inputs:
  cache-path:
    description: 'Path to the cached workflow data file'
    required: true
  previous-cache-path:
    description: "Path to the previous run's workflow data file (optional)"
    required: false
  GITHUB_TOKEN:
    description: 'GitHub token for API access. Used to fetch PR information and workflow details.'
    required: true
  workflow_configs:
    description: |
      JSON array of workflow configurations. Each config object should have:
      - display: Human-readable name for the workflow group
      - wkflw_name: Exact workflow name to match (mutually exclusive with wkflw_prefix)
      - wkflw_prefix: Prefix to match workflow names (mutually exclusive with wkflw_name)

      Example:
      [
        {"display": "All post-commit tests", "wkflw_name": "All post-commit tests"},
        {"display": "(TG) prefix", "wkflw_prefix": "(TG)"}
      ]
    required: true
  days:
    description: 'Number of days to look back for workflow data'
    required: false
    default: '15'
  alert-all:
    description: 'If true, generate a Slack-ready alert message listing all currently failing workflows with owner mentions.'
    required: false
    default: 'false'
  annotations-index-path:
    description: 'Path to JSON mapping run_id -> annotations directory (optional)'
    required: false
  commits-path:
    description: 'Path to JSON array of commits on main (optional)'
    required: false
  logs-index-path:
    description: 'Path to JSON mapping run_id -> extracted logs dir (optional)'
    required: false

outputs:
  failed_workflows:
    description: 'JSON array of workflow names that have failed their latest run on the main branch'
  report:
    description: 'The generated workflow report in markdown format, containing workflow statistics and failure details'
  regressed_workflows:
    description: 'JSON array of objects {name, run_id, run_url, created_at} for workflows that regressed (success -> fail)'
  alert_all_message:
    description: 'Slack-ready alert message listing all currently failing workflows with owner mentions (set when alert-all=true)'

runs:
  using: 'node20'
  main: 'analyze-workflow-data.js'
