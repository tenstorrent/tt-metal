# Task: Implement Fix

Read the AI_PROMPT.md in implementing-features/ and implement a fix for this failure.

## User Prompt
Fix ttnn.to_torch() timeout with wide tensors [1, 151936]. Optimize completion queue copy in system_memory_manager.cpp

## Reproduction Test
reproduce-deterministic-failures/timeout-in-datamovement/tests/test_gather_timeout_stress.py

## Error Information
RuntimeError: TT_THROW @ /tt-metal/tt_metal/impl/dispatch/system_memory_manager.cpp:627: tt::exception
info:
TIMEOUT: device timeout, potential hang detected, the device is unrecoverable

Stack trace:
  at buffer_dispatch::copy_completion_queue_data_into_user_space()
  at tt::tt_metal::distributed::FDMeshCommandQueue::read_completion_queue()
  at Device::read_buffer()
  at ttnn.to_torch()

Test: test_gather_long_tensor_stress[0]
Shape: [1, 151936]
Operation: ttnn.gather() followed by ttnn.to_torch()
Timeout setting: TT_METAL_OPERATION_TIMEOUT_SECONDS=5

## Current Branch
fix/fix-ttnn-to-torch---timeout-with-wide-te (created from main)

## Original Branch
ebanerjee/hail-mary

## CRITICAL INSTRUCTIONS

1. **Build Metal first**: Run ./build_metal.sh before testing
2. **Use bash script**: Run tests via ./run_test.sh (in test parent dir)
3. **Rebuild after changes**: Run ./build_metal.sh after EVERY code change
4. **Test multiple times**: Verify stability with 5 consecutive successful runs (deterministic=True)
5. **DO NOT create PR**: Push branch and write PR description, but don't run gh pr create
6. **Write report**: Document everything in outputs/

Note: The bash script (run_test.sh) was copied to the fix branch along with the test.

## Expected Output
1. Analyze root cause from error information above
2. Build Metal: ./build_metal.sh
3. Implement fix iteratively (rebuild after each change)
4. Verify test passes 5/5 times using ./run_test.sh
5. Remove test from branch
6. Push fix branch
7. Write PR description to /tmp/pr_description.md
8. Write execution report to outputs/

## Time Limit
30 minutes (includes build time)

## Success Criteria
- Test passes 5/5 times using ./run_test.sh
- Metal rebuilt after all changes
- Branch pushed (but PR NOT created)
- Report written to outputs/

## If You Cannot Fix
Document attempts, explain blockers, recommend experts.
Write report with Status: Failed.
