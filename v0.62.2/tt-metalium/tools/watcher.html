<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Watcher &mdash; TT-Metalium  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/tt_theme.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/favicon.png"/>
    <link rel="canonical" href="/tt-metal/latest/tt-metalium/tools/watcher.html" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=b3ba4146"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Tracy Profiler" href="tracy_profiler.html" />
    <link rel="prev" title="Kernel Debug Print" href="kernel_print.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >



<a href="https://docs.tenstorrent.com/">
    <img src="../_static/tt_logo.svg" class="logo" alt="Logo"/>
</a>

<a href="../index.html">
    TT-Metalium
</a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Get Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../get_started/get_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installing.html">Install</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">TT-Metalium</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../tt_metal/programming_model/index.html">Programming Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tt_metal/apis/index.html">APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tt_metal/examples/index.html">Programming Examples</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Tools</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="kernel_print.html">Kernel Debug Print</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Watcher</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#enabling">Enabling</a></li>
<li class="toctree-l3"><a class="reference internal" href="#details">Details</a></li>
<li class="toctree-l3"><a class="reference internal" href="#gdb-integration">gdb Integration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#example">Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="#asserts">Asserts</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pausing">Pausing</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ring-buffer">Ring Buffer</a></li>
<li class="toctree-l3"><a class="reference internal" href="#stack-usage-measurement">Stack Usage Measurement</a></li>
<li class="toctree-l3"><a class="reference internal" href="#debug-delays">Debug Delays</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="tracy_profiler.html">Tracy Profiler</a></li>
<li class="toctree-l2"><a class="reference internal" href="device_program_profiler.html">Device Program Profiler</a></li>
<li class="toctree-l2"><a class="reference internal" href="inspector.html">Inspector</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Resources</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../resources/support.html">Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../resources/contributing.html">Contributing as a developer</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">TT-Metalium</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Tools</a></li>
      <li class="breadcrumb-item active">Watcher</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/tools/watcher.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="watcher">
<h1>Watcher<a class="headerlink" href="#watcher" title="Permalink to this heading"></a>
</h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Tools are only fully supported on source builds.</p>
</div>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this heading"></a>
</h2>
<p>The Watcher consists of two components: one instruments the firmware and kernels to catch common programming errors and
the other launches a thread on the host which periodically monitors the status of the device. If a programming error is
encountered, the Watcher stops the program and reports the error.  If a hang occurs, the data in the log shows the state
of the device at the time of the hang. Watcher functionality includes:</p>
<ul class="simple">
<li><p>Logged “waypoints” indicate which piece of code last executed on each RISC V</p></li>
<li><p>Sanitized NOC transactions prevent transactions with invalid coordinates or addresses from being submitted to the
hardware and stops the offending RISC V via a soft hang</p></li>
<li><p>Memory corruption detection at address 0 of L1</p></li>
<li><p>Kernel paths and names of the currently executing kernel</p></li>
<li><p>Flags which indicate which RISC Vs are executing in the current kernel</p></li>
</ul>
</section>
<section id="enabling">
<h2>Enabling<a class="headerlink" href="#enabling" title="Permalink to this heading"></a>
</h2>
<p>Enable the Watcher by setting the following environment variables:</p>
<div class="highlight-default notranslate">
<div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">TT_METAL_WATCHER</span><span class="o">=</span><span class="mi">120</span>        <span class="c1"># the number of seconds between Watcher updates (longer is less invasive)</span>
<span class="n">export</span> <span class="n">TT_METAL_WATCHER_APPEND</span><span class="o">=</span><span class="mi">1</span>   <span class="c1"># optional: append to the end of the existing log file (vs creating a new file)</span>
<span class="n">export</span> <span class="n">TT_METAL_WATCHER_DUMP_ALL</span><span class="o">=</span><span class="mi">1</span> <span class="c1"># optional: dump all state including unsafe state</span>
</pre></div>
</div>
<p>Note that <code class="docutils literal notranslate"><span class="pre">TT_METAL_WATCHER_DUMP_ALL</span></code> dumps state that can lead to a hang when a kernel is running.  Only set this if
needed and use a time interval large enough to ensure the kernel is stopped when the Watcher polls.</p>
<p>After starting the program, the log messages will indicate when the watcher attaches/detaches from a device and where
the log file is stored as well as a message each time the watcher checks the device.</p>
<p>Watcher features can be disabled individually using the following environment variables:</p>
<div class="highlight-default notranslate">
<div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">TT_METAL_WATCHER_DISABLE_ASSERT</span><span class="o">=</span><span class="mi">1</span>
<span class="n">export</span> <span class="n">TT_METAL_WATCHER_DISABLE_PAUSE</span><span class="o">=</span><span class="mi">1</span>
<span class="n">export</span> <span class="n">TT_METAL_WATCHER_DISABLE_RING_BUFFER</span><span class="o">=</span><span class="mi">1</span>
<span class="n">export</span> <span class="n">TT_METAL_WATCHER_DISABLE_NOC_SANITIZE</span><span class="o">=</span><span class="mi">1</span>
<span class="n">export</span> <span class="n">TT_METAL_WATCHER_DISABLE_WAYPOINT</span><span class="o">=</span><span class="mi">1</span>
<span class="n">export</span> <span class="n">TT_METAL_WATCHER_DISABLE_STACK_USAGE</span><span class="o">=</span><span class="mi">1</span>

<span class="c1"># This feature is opt-in, set the env var to enable it</span>
<span class="n">export</span> <span class="n">TT_METAL_WATCHER_ENABLE_NOC_SANITIZE_LINKED_TRANSACTION</span><span class="o">=</span><span class="mi">1</span>

<span class="c1"># In certain cases enabling watcher can cause the binary to be too large. In this case, disable inlining.</span>
<span class="n">export</span> <span class="n">TT_METAL_WATCHER_NOINLINE</span><span class="o">=</span><span class="mi">1</span>

<span class="c1"># If the above doesn't work, and dispatch kernels (cq_prefetch.cpp, cq_dispatch.cpp) are still too large, compile out</span>
<span class="c1"># debug tools on dispatch kernels.</span>
<span class="n">export</span> <span class="n">TT_METAL_WATCHER_DISABLE_DISPATCH</span><span class="o">=</span><span class="mi">1</span>

<span class="c1"># If you need to see the physical coordinates in the watcher log (note that physical coordinates are not expected</span>
<span class="c1"># to be used in host-side code).</span>
<span class="n">export</span> <span class="n">TT_METAL_WATCHER_PHYS_COORDS</span><span class="o">=</span><span class="mi">1</span>
</pre></div>
</div>
</section>
<section id="details">
<h2>Details<a class="headerlink" href="#details" title="Permalink to this heading"></a>
</h2>
<p>When enabled the Watcher both dumps status updates to a log file and stops execution if a fatal error (e.g., bad NOC
address) is encountered.  The log file contains one line for each core with a cryptic status.  The top of the log file
includes a legend to help decipher the results.  One datum is the last “waypoint” each of the 5 RISCVs
encountered as a string of up to 4 characters.  These waypoints can be inserted into kernel/firmware code as shown
below:</p>
<div class="highlight-default notranslate">
<div class="highlight"><pre><span></span><span class="c1">#include "debug/waypoint.h"</span>

<span class="n">void</span> <span class="n">noc_semaphore_wait</span><span class="p">(</span><span class="n">volatile</span> <span class="n">tt_l1_ptr</span> <span class="n">uint32_t</span><span class="o">*</span> <span class="n">sem_addr</span><span class="p">,</span> <span class="n">uint32_t</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">WAYPOINT</span><span class="p">(</span><span class="s2">"NSW"</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">((</span><span class="o">*</span><span class="n">sem_addr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span>
        <span class="p">;</span>
    <span class="n">WAYPOINT</span><span class="p">(</span><span class="s2">"NSD"</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Waypoints have no overhead when the watcher is disabled and can be used inside user written kernels.  They indicate
the last code block executed before a hang condition (e.g., waiting for data that never arrives).  This mechanism is
separate from the fault detection mechanism.</p>
<p>The characters in a waypoint name are a mnemonic unique to each waypoint.  By convention, the last character is one of:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">W</span></code>: waiting at the top of a loop</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">D</span></code>: done waiting after a loop</p></li>
</ul>
<p>When dumping state for each RISC V, the Watcher always dumps in the order BRISC, NCRISC, TRISC0, TRISC1, TRISC2.</p>
<p>The path to the log file is printed to the screen during application initialization when the watcher is enabled.</p>
</section>
<section id="gdb-integration">
<h2>gdb Integration<a class="headerlink" href="#gdb-integration" title="Permalink to this heading"></a>
</h2>
<p>The Watcher state can be dumped using <code class="docutils literal notranslate"><span class="pre">gdb</span></code> regardless of whether or not the Watcher was enabled; however, if it is
disabled the dumped state won’t include the debug only state such as waypoints.  In the example below, gdb’s responses
to commands have been removed for brevity.  After attaching to the program and stopping it with <code class="docutils literal notranslate"><span class="pre">ctl-c</span></code>:</p>
<div class="highlight-default notranslate">
<div class="highlight"><pre><span></span><span class="n">thread</span> <span class="mi">1</span>   <span class="c1"># make sure the main thread is present</span>
<span class="n">up</span>         <span class="c1"># repeat until in the "tt" namespace (not in, e.g., template library code)</span>
<span class="n">call</span> <span class="n">tt</span><span class="p">::</span><span class="n">watcher</span><span class="p">::</span><span class="n">dump</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="n">true</span><span class="p">)</span> <span class="c1"># the "true" at the end enables dumping HW registers</span>
</pre></div>
</div>
</section>
<section id="example">
<h2>Example<a class="headerlink" href="#example" title="Permalink to this heading"></a>
</h2>
<p>The log file will contain lines such as the following:</p>
<div class="highlight-default notranslate">
<div class="highlight"><pre><span></span><span class="n">Core</span> <span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>    <span class="n">CWFW</span><span class="p">,</span><span class="n">CRBW</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">R</span> <span class="n">rmsg</span><span class="p">:</span><span class="n">D0G</span><span class="o">|</span><span class="n">BNT</span> <span class="n">smsg</span><span class="p">:</span><span class="n">GGGG</span> <span class="n">k_ids</span><span class="p">:</span><span class="mi">4</span><span class="o">|</span><span class="mi">3</span><span class="o">|</span><span class="mi">5</span>
</pre></div>
</div>
<ul class="simple">
<li><p>The hang above originated on core (1,1) in physical coords (i.e., the top left core)</p></li>
<li><p>BRISC last hit waypoint <code class="docutils literal notranslate"><span class="pre">CWFW</span></code> (CB Wait Front Wait), NCRISC hit <code class="docutils literal notranslate"><span class="pre">CRBW</span></code> (NOC CB Reserve Back Wait) and each TRISC
is in the Run <code class="docutils literal notranslate"><span class="pre">R</span></code> state (running a kernel). Look in the source (dataflow_api.h primarily) to decode the obscure names,
search for <code class="docutils literal notranslate"><span class="pre">WAYPOINT</span></code></p></li>
<li><p>The run message <code class="docutils literal notranslate"><span class="pre">rmsg</span></code> sent from the host to the device, says the kernel was Device <code class="docutils literal notranslate"><span class="pre">D</span></code> dispatched, BRISC is
using NOC <code class="docutils literal notranslate"><span class="pre">0</span></code> (NCRISC is using the other NOC, NOC 1), the host run state is Go <code class="docutils literal notranslate"><span class="pre">G</span></code> and each of BRISC, NCRISC and
TRISC kernels are running (capital <code class="docutils literal notranslate"><span class="pre">BNT</span></code>; lowercase would signify no kernel running)</p></li>
<li><p>The subordinate message <code class="docutils literal notranslate"><span class="pre">smsg</span></code> sent from BRISC to the other RISC Vs are all Go <code class="docutils literal notranslate"><span class="pre">G</span></code>; <code class="docutils literal notranslate"><span class="pre">D</span></code> would indicate Done</p></li>
<li><p>The kernel IDs <code class="docutils literal notranslate"><span class="pre">k_ids</span></code> running are <code class="docutils literal notranslate"><span class="pre">4</span></code> on BRISC, <code class="docutils literal notranslate"><span class="pre">3</span></code> on NCRISC and <code class="docutils literal notranslate"><span class="pre">5</span></code> on TRISC; look further down the log file
to see the names and paths to those kernels</p></li>
</ul>
</section>
<section id="asserts">
<h2>Asserts<a class="headerlink" href="#asserts" title="Permalink to this heading"></a>
</h2>
<p>Asserts are supported in kernel code. When the watcher is disabled, asserts will be compiled out.
When the watcher is enabled, tripping an assert will cause the program to exit, and report which
assert was tripped. An example of an assert and the resulting message is shown below:</p>
<div class="highlight-c++ notranslate">
<div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">"debug/assert.h"</span><span class="c1">  // Required in all kernels using watcher asserts</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">"debug/waypoint.h"</span><span class="c1">  // Pair the assert with a status to see which assert is tripped</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">kernel_main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_arg_val</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_arg_val</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="w">    </span><span class="n">WAYPOINT</span><span class="p">(</span><span class="s">"AST1"</span><span class="p">);</span>
<span class="w">    </span><span class="n">ASSERT</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">b</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If this assert was tripped, the kernel will hang, and a message will be reported on stderr as well
as in the watcher log file:</p>
<div class="highlight-default notranslate">
<div class="highlight"><pre><span></span><span class="c1"># For example, the kernel running on device 0, core (1,1), brisc trips an assert. The last waypoint will also be shown.</span>
<span class="c1"># Note that the reported line number may be from an included header file, rather than from the kernel source.</span>
<span class="n">Device</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Core</span> <span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>    <span class="n">AST1</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">R</span>  <span class="n">brisc</span> <span class="n">tripped</span> <span class="k">assert</span> <span class="n">on</span> <span class="n">line</span> <span class="mf">7.</span> <span class="n">Running</span> <span class="n">kernel</span><span class="p">:</span> <span class="n">my_kernel</span><span class="o">.</span><span class="n">cpp</span><span class="o">.</span>
</pre></div>
</div>
</section>
<section id="pausing">
<h2>Pausing<a class="headerlink" href="#pausing" title="Permalink to this heading"></a>
</h2>
<p>Temporarily pausing a kernel on the device is supported using the <cite>PAUSE</cite> macro. When the watcher is
disabled, pauses will be compiled out. When a pause is hit, the kernel on the device will wait for
a signal from the user (via pressing ENTER as prompted on the command line). Note that while waiting
for a pause to be cleared, the watcher server is temporarily halted, and regular polling only
resumes after the user has given the unpause signal. An example of a pause and resulting message is
shown below:</p>
<div class="highlight-c++ notranslate">
<div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">"debug/pause.h"</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">kernel_main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Other parts of the kernel...</span>
<span class="w">    </span><span class="n">PAUSE</span><span class="p">();</span><span class="w">  </span><span class="c1">// Kernel halts here until user presses ENTER on the console.</span>
<span class="w">    </span><span class="c1">// Rest of the kernel...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The resulting message will be printed on the command line (and watcher log):</p>
<div class="highlight-default notranslate">
<div class="highlight"><pre><span></span><span class="n">INFO</span>     <span class="o">|</span> <span class="n">Paused</span> <span class="n">cores</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span><span class="n">brisc</span>
<span class="n">Press</span> <span class="n">ENTER</span> <span class="n">to</span> <span class="n">unpause</span> <span class="n">core</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">and</span> <span class="k">continue</span><span class="o">...</span>
</pre></div>
</div>
</section>
<section id="ring-buffer">
<h2>Ring Buffer<a class="headerlink" href="#ring-buffer" title="Permalink to this heading"></a>
</h2>
<p>A small ring buffer is available on each core, accessible via the <cite>WATCHER_RING_BUFFER_PUSH()</cite> macro.
This ring buffer has 31 <cite>uint32_t</cite> elements, and when more than the max amounts of elements
are pushed into the buffer, the oldest are overwritten. When the watcher is disabled, the ring
buffer is still present, but any writes to it are compiled out. An example of pushing data to the
ring buffer, and the resulting log is shown below.</p>
<p>Important: the ring buffer does not have any synchronization for writes between difference RISCs on
the same core. Calling <cite>WATCHER_RING_BUFFER_PUSH()</cite> from different RISCs in the same core at the same time
is undefined behaviour.</p>
<div class="highlight-default notranslate">
<div class="highlight"><pre><span></span><span class="c1">#include "debug/ring_buffer.h"</span>

<span class="n">void</span> <span class="n">kernel_main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">uint32_t</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">WATCHER_RING_BUFFER_PUSH</span><span class="p">(</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The contents of the ring buffer for each core (if values have been written) will be shown in the
watcher log:</p>
<div class="highlight-default notranslate">
<div class="highlight"><pre><span></span><span class="c1"># The ring buffer has a size of 32 elements, therefore writing 40 entries into the buffer will</span>
<span class="c1"># result in the oldest 8 entries being dropped. Entries are printed starting with the most recent.</span>
<span class="n">Core</span> <span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>    <span class="n">R</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">R</span> <span class="n">rmsg</span><span class="p">:</span><span class="n">D0G</span><span class="o">|</span><span class="n">BNT</span> <span class="n">smsg</span><span class="p">:</span><span class="n">GGGG</span> <span class="n">k_ids</span><span class="p">:</span><span class="mi">1</span><span class="o">|</span><span class="mi">0</span><span class="o">|</span><span class="mi">0</span>
    <span class="n">debug_ring_buffer</span><span class="p">(</span><span class="n">latest_written_idx</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span><span class="o">=</span>
    <span class="p">[</span><span class="mh">0x00000028</span><span class="p">,</span><span class="mh">0x00000027</span><span class="p">,</span><span class="mh">0x00000026</span><span class="p">,</span><span class="mh">0x00000025</span><span class="p">,</span><span class="mh">0x00000024</span><span class="p">,</span><span class="mh">0x00000023</span><span class="p">,</span><span class="mh">0x00000022</span><span class="p">,</span><span class="mh">0x00000021</span><span class="p">,</span>
     <span class="mh">0x00000020</span><span class="p">,</span><span class="mh">0x0000001f</span><span class="p">,</span><span class="mh">0x0000001e</span><span class="p">,</span><span class="mh">0x0000001d</span><span class="p">,</span><span class="mh">0x0000001c</span><span class="p">,</span><span class="mh">0x0000001b</span><span class="p">,</span><span class="mh">0x0000001a</span><span class="p">,</span><span class="mh">0x00000019</span><span class="p">,</span>
     <span class="mh">0x00000018</span><span class="p">,</span><span class="mh">0x00000017</span><span class="p">,</span><span class="mh">0x00000016</span><span class="p">,</span><span class="mh">0x00000015</span><span class="p">,</span><span class="mh">0x00000014</span><span class="p">,</span><span class="mh">0x00000013</span><span class="p">,</span><span class="mh">0x00000012</span><span class="p">,</span><span class="mh">0x00000011</span><span class="p">,</span>
     <span class="mh">0x00000010</span><span class="p">,</span><span class="mh">0x0000000f</span><span class="p">,</span><span class="mh">0x0000000e</span><span class="p">,</span><span class="mh">0x0000000d</span><span class="p">,</span><span class="mh">0x0000000c</span><span class="p">,</span><span class="mh">0x0000000b</span><span class="p">,</span><span class="mh">0x0000000a</span><span class="p">,</span><span class="mh">0x00000009</span><span class="p">]</span>
</pre></div>
</div>
</section>
<section id="stack-usage-measurement">
<h2>Stack Usage Measurement<a class="headerlink" href="#stack-usage-measurement" title="Permalink to this heading"></a>
</h2>
<p>The watcher will automatically measure the stack usage after each kernel is run, and report the overall stack usage
per RISC in the log. If a stack overflow is detected, the core will hang and an error will be thrown on host.</p>
<div class="highlight-default notranslate">
<div class="highlight"><pre><span></span><span class="n">Device</span> <span class="mi">0</span> <span class="n">worker</span> <span class="n">core</span><span class="p">(</span><span class="n">x</span><span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="n">y</span><span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">virtual</span><span class="p">(</span><span class="n">x</span><span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">y</span><span class="o">=</span> <span class="mi">1</span><span class="p">):</span>   <span class="n">GW</span><span class="p">,</span>   <span class="n">W</span><span class="p">,</span>   <span class="n">W</span><span class="p">,</span>   <span class="n">W</span><span class="p">,</span>   <span class="n">W</span>  <span class="n">rmsg</span><span class="p">:</span><span class="n">D1D</span><span class="o">|</span><span class="n">BNt</span> <span class="n">smsg</span><span class="p">:</span><span class="n">DDDD</span> <span class="n">k_ids</span><span class="p">:</span><span class="mi">11</span><span class="o">|</span><span class="mi">10</span><span class="o">|</span><span class="mi">0</span>
    <span class="n">brisc</span> <span class="n">stack</span> <span class="n">usage</span><span class="p">:</span> <span class="mi">228</span><span class="o">/</span><span class="mi">768</span><span class="p">,</span> <span class="n">kernel</span> <span class="n">using</span> <span class="n">most</span> <span class="n">stack</span><span class="p">:</span> <span class="n">ttnn</span><span class="o">/</span><span class="n">cpp</span><span class="o">/</span><span class="n">ttnn</span><span class="o">/</span><span class="n">operations</span><span class="o">/</span><span class="n">normalization</span><span class="o">/</span><span class="n">groupnorm</span><span class="o">/</span><span class="n">device</span><span class="o">/</span><span class="n">kernels</span><span class="o">/</span><span class="n">dataflow</span><span class="o">/</span><span class="n">reader_mcast_sender_unary_sharded_gn_v2</span><span class="o">.</span><span class="n">cpp</span>
    <span class="n">ncrisc</span> <span class="n">stack</span> <span class="n">usage</span><span class="p">:</span> <span class="mi">192</span><span class="o">/</span><span class="mi">768</span><span class="p">,</span> <span class="n">kernel</span> <span class="n">using</span> <span class="n">most</span> <span class="n">stack</span><span class="p">:</span>  <span class="n">ttnn</span><span class="o">/</span><span class="n">cpp</span><span class="o">/</span><span class="n">ttnn</span><span class="o">/</span><span class="n">operations</span><span class="o">/</span><span class="n">data_movement</span><span class="o">/</span><span class="n">sharded</span><span class="o">/</span><span class="n">device</span><span class="o">/</span><span class="n">kernels</span><span class="o">/</span><span class="n">dataflow</span><span class="o">/</span><span class="n">reader_unary_sharded_blocks_interleaved_start_id</span><span class="o">.</span><span class="n">cpp</span>
    <span class="n">trisc0</span> <span class="n">stack</span> <span class="n">usage</span><span class="p">:</span> <span class="mi">252</span><span class="o">/</span><span class="mi">320</span><span class="p">,</span> <span class="n">kernel</span> <span class="n">using</span> <span class="n">most</span> <span class="n">stack</span><span class="p">:</span> <span class="n">ttnn</span><span class="o">/</span><span class="n">cpp</span><span class="o">/</span><span class="n">ttnn</span><span class="o">/</span><span class="n">operations</span><span class="o">/</span><span class="n">normalization</span><span class="o">/</span><span class="n">groupnorm</span><span class="o">/</span><span class="n">device</span><span class="o">/</span><span class="n">kernels</span><span class="o">/</span><span class="n">compute</span><span class="o">/</span><span class="n">groupnorm_sharded_v2</span><span class="o">.</span><span class="n">cpp</span>
    <span class="n">trisc1</span> <span class="n">stack</span> <span class="n">usage</span><span class="p">:</span> <span class="mi">208</span><span class="o">/</span><span class="mi">256</span><span class="p">,</span> <span class="n">kernel</span> <span class="n">using</span> <span class="n">most</span> <span class="n">stack</span><span class="p">:</span> <span class="n">ttnn</span><span class="o">/</span><span class="n">cpp</span><span class="o">/</span><span class="n">ttnn</span><span class="o">/</span><span class="n">operations</span><span class="o">/</span><span class="n">normalization</span><span class="o">/</span><span class="n">groupnorm</span><span class="o">/</span><span class="n">device</span><span class="o">/</span><span class="n">kernels</span><span class="o">/</span><span class="n">compute</span><span class="o">/</span><span class="n">groupnorm_sharded_v2</span><span class="o">.</span><span class="n">cpp</span>
    <span class="n">trisc2</span> <span class="n">stack</span> <span class="n">usage</span><span class="p">:</span> <span class="mi">192</span><span class="o">/</span><span class="mi">768</span><span class="p">,</span> <span class="n">kernel</span> <span class="n">using</span> <span class="n">most</span> <span class="n">stack</span><span class="p">:</span> <span class="n">ttnn</span><span class="o">/</span><span class="n">cpp</span><span class="o">/</span><span class="n">ttnn</span><span class="o">/</span><span class="n">operations</span><span class="o">/</span><span class="n">normalization</span><span class="o">/</span><span class="n">groupnorm</span><span class="o">/</span><span class="n">device</span><span class="o">/</span><span class="n">kernels</span><span class="o">/</span><span class="n">compute</span><span class="o">/</span><span class="n">groupnorm_sharded_v2</span><span class="o">.</span><span class="n">cpp</span>
</pre></div>
</div>
</section>
<section id="debug-delays">
<h2>Debug Delays<a class="headerlink" href="#debug-delays" title="Permalink to this heading"></a>
</h2>
<p>Watcher can insert NOC transaction delays for debugging purposes. These delays can be specified by
transaction type and location. Environment variable <code class="docutils literal notranslate"><span class="pre">TT_METAL_WATCHER_DELAY</span></code> specifies the number
of clock cycles to wait for. Similarly to DPRINT, the delay can be set for all cores, or a
or a subset by setting environment variable <code class="docutils literal notranslate"><span class="pre">TT_METAL_*_DEBUG_DELAY_CORES</span></code>: x,y OR (x1,y1),(x2,y2),(x3,y3) OR (x1,y1)-(x2,y2) OR all.
The * can be one of: READ, WRITE or ATOMIC indicating whether the delays will be inserted before read, write or atomic NOC
transactions. Finally, the delay can be set for a specific RISCs (BRISC, NCRISC, TRISC0, TRISC1, TRISC2) through the
environment variable <code class="docutils literal notranslate"><span class="pre">TT_METAL_*_DEBUG_DELAY_RISCVS</span></code>: (one of: BR,NC,TR0,TR1,TR2); if not set, the delay
is applied to all RISCs.
Note that <cite>TT_METAL_WATCHER</cite> must be set and <code class="docutils literal notranslate"><span class="pre">TT_METAL_WATCHER_DISABLE_NOC_SANITIZE</span></code> must not be
set for the delays to be applied.</p>
<p>For example, the following command will run test_eltwise_binary with a delay of 10 iterations added to both READ and WRITE
transactions on BRISC core at location 0,0:</p>
<div class="highlight-default notranslate">
<div class="highlight"><pre><span></span><span class="n">TT_METAL_WATCHER</span><span class="o">=</span><span class="mi">1</span> <span class="n">TT_METAL_WATCHER_DEBUG_DELAY</span><span class="o">=</span><span class="mi">10</span> <span class="n">TT_METAL_READ_DEBUG_DELAY_CORES</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span> <span class="n">TT_METAL_WRITE_DEBUG_DELAY_CORES</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span> <span class="n">TT_METAL_READ_DEBUG_DELAY_RISCVS</span><span class="o">=</span><span class="n">BR</span> <span class="n">TT_METAL_WRITE_DEBUG_DELAY_RISCVS</span><span class="o">=</span><span class="n">BR</span> <span class="o">./</span><span class="n">build</span><span class="o">/</span><span class="n">test</span><span class="o">/</span><span class="n">tt_metal</span><span class="o">/</span><span class="n">test_eltwise_binary</span>
</pre></div>
</div>
</section>
</section>



           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="kernel_print.html" class="btn btn-neutral float-left" title="Kernel Debug Print" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="tracy_profiler.html" class="btn btn-neutral float-right" title="Tracy Profiler" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Tenstorrent.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        Version: <span id="current-version">latest</span>
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl id="version-list">
            <dt>Versions</dt>
        </dl>
        <br>
        </dl>
    </div>
</div>

<script>
const VERSIONS_URL = 'https://raw.githubusercontent.com/tenstorrent/tt-metal/refs/heads/main/docs/published_versions.json';

async function loadVersions() {
    try {
        const response = await fetch(VERSIONS_URL);
        const data = await response.json();
        const versionList = document.getElementById('version-list');
        const projectCode = location.pathname.split('/')[3];

        data.versions.forEach(version => {
            const dd = document.createElement('dd');
            const link = document.createElement('a');
            link.href = `https://docs.tenstorrent.com/tt-metal/${version}/${projectCode}/index.html`;
            link.textContent = version;
            dd.appendChild(link);
            versionList.appendChild(dd);
        });
    } catch (error) {
        console.error('Error loading versions:', error);
    }
}

loadVersions();

function getCurrentVersion() {
    return window.location.pathname.split('/')[2];
}
document.getElementById('current-version').textContent = getCurrentVersion();

const versionEl = document.createElement("span");
versionEl.innerText = getCurrentVersion();
versionEl.className = "project-versions";
const wySideSearchEl = document.getElementsByClassName("wy-side-nav-search").item(0);
if (wySideSearchEl) {
    const projectNameEl = wySideSearchEl.children.item(1);
    if (projectNameEl) projectNameEl.appendChild(versionEl);
}

</script><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>