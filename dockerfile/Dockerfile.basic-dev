ARG UBUNTU_VERSION=22.04
FROM public.ecr.aws/ubuntu/ubuntu:${UBUNTU_VERSION} AS base
# Re-declare ARG make it available in the build stage
ARG UBUNTU_VERSION

# Install basic tools to build
# The Boost PPA is because TT-Metalium depends on a Boost too new for Ubuntu 22.04
# It should not be used in 24.04.
RUN apt-get update && apt-get install -y \
    software-properties-common \
    && if [ "${UBUNTU_VERSION}" = "22.04" ]; then \
        add-apt-repository -y ppa:mhier/libboost-latest; \
    fi \
    && apt-get update && apt-get install -y \
    cmake \
    ninja-build \
    g++-12 \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Install mpi-ulfm from the tenstorrent repository
RUN set -eux; \
    apt-get update && \
    apt-get install -y -f \
        wget ca-certificates && \
    TMP_DIR="$(mktemp -d)" && \
    DEB_URL="https://github.com/tenstorrent/ompi/releases/download/v5.0.7/openmpi-ulfm_5.0.7-1_amd64.deb" && \
    wget -qO "$TMP_DIR/ompi.deb" "$DEB_URL" && \
    apt-get install -f -y "$TMP_DIR/ompi.deb" && \
    rm -rf "$TMP_DIR" && \
    rm -rf /var/lib/apt/lists/*


ARG BOOST_VERSION=1.86.0
RUN mkdir -p /tmp/boost \
    && BOOST_VERSION_UNDERSCORE=$(echo ${BOOST_VERSION} | sed 's/\./_/g') \
    && wget -O /tmp/boost/boost_${BOOST_VERSION}.tar.gz "https://archives.boost.io/release/${BOOST_VERSION}/source/boost_${BOOST_VERSION_UNDERSCORE}.tar.gz" \
    && tar -xzf /tmp/boost/boost_${BOOST_VERSION}.tar.gz -C /tmp/boost --strip-components=1 \
    && cd /tmp/boost \
    && ./bootstrap.sh \
    && ./b2 install --prefix=/usr/local \
    && rm -rf /tmp/boost

RUN mkdir /debians
# Copy all .deb files from host into the image
COPY .build/default/*.deb /debians/
COPY personal_cmake_stuff.sh /
RUN chmod +x /personal_cmake_stuff.sh
RUN echo "BOOST_VERSION: ${BOOST_VERSION}"