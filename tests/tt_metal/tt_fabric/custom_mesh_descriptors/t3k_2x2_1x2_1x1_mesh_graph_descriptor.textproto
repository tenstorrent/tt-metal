# --- Meshes ---------------------------------------------------------------

mesh_descriptors {
  name: "M0"  # 2x2
  arch: WORMHOLE_B0
  device_topology { dims: [ 2, 2 ] }
  host_topology   { dims: [ 1, 1 ] }
  channels { count: 2 policy: STRICT }
}

mesh_descriptors {
  name: "M1"  # 1x2
  arch: WORMHOLE_B0
  device_topology { dims: [ 1, 2 ] }
  host_topology   { dims: [ 1, 1 ] }
  channels { count: 2 policy: STRICT }
}

mesh_descriptors {
  name: "M2"  # 1x1
  arch: WORMHOLE_B0
  device_topology { dims: [ 1, 1 ] }
  host_topology   { dims: [ 1, 1 ] }
  channels { count: 2 policy: STRICT }
}

# --- Graphs ---------------------------------------------------------------

graph_descriptors {
  name: "G0"
  type: "FABRIC"
  instances { mesh { mesh_descriptor: "M0" mesh_id: 0 } }
  instances { mesh { mesh_descriptor: "M1" mesh_id: 1 } }
  instances { mesh { mesh_descriptor: "M2" mesh_id: 2 } }
  instances { mesh { mesh_descriptor: "M2" mesh_id: 3 } }

  # Horizontal connections
  connections {
    nodes { mesh { mesh_descriptor: "M0" mesh_id: 0 device_id: 1 } }
    nodes { mesh { mesh_descriptor: "M1" mesh_id: 1 device_id: 0 } }
    channels { count: 2 }
    routing_direction : [ E, W ]
  }
  connections {
    nodes { mesh { mesh_descriptor: "M0" mesh_id: 0 device_id: 3 } }
    nodes { mesh { mesh_descriptor: "M2" mesh_id: 2 device_id: 0 } }
    channels { count: 2 }
    routing_direction : [ E, W ]
  }
  connections {
    nodes { mesh { mesh_descriptor: "M2" mesh_id: 2 device_id: 0 } }
    nodes { mesh { mesh_descriptor: "M2" mesh_id: 3 device_id: 0 } }
    channels { count: 2 }
    routing_direction : [ E, W ]
  }

  # Vertical connections
  connections {
    nodes { mesh { mesh_descriptor: "M1" mesh_id: 1 device_id: 0 } }
    nodes { mesh { mesh_descriptor: "M2" mesh_id: 2 device_id: 0 } }
    channels { count: 2 }
    routing_direction : [ S, N ]
  }
  connections {
    nodes { mesh { mesh_descriptor: "M1" mesh_id: 1 device_id: 1 } }
    nodes { mesh { mesh_descriptor: "M2" mesh_id: 3 device_id: 0 } }
    channels { count: 2 }
    routing_direction : [ S, N ]
  }
}

# --- Instantiation ----------------------------------------------------------
top_level_instance { graph { graph_descriptor: "G0" graph_id: 0 } }
